
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/dataflow/06airflow.html">
      
      
        <link rel="prev" href="03kafka.html">
      
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.8">
    
    
      
        <title>Airflow - IABD</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Airflow - IABD" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/dataflow/06airflow.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/dataflow/06airflow.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Airflow - IABD" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/dataflow/06airflow.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#orquestacion-de-flujos-apache-airflow" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="IABD" class="md-header__button md-logo" aria-label="IABD" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IABD
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Airflow
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo día"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Cambiar a modo día" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="IABD" class="md-nav__button md-logo" aria-label="IABD" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    IABD
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../sa/index.html">Sistemas de almacenamiento</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/01nosql.html" class="md-nav__link">
        Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/02mongo.html" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/03modelado.html" class="md-nav__link">
        Modelado de datos NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/05agregaciones.html" class="md-nav__link">
        Agregaciones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/06replicacion.html" class="md-nav__link">
        Replicación y Particionado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/07pymongo.html" class="md-nav__link">
        MongoDB y Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../hadoop/index.html">Ecosistema Hadoop</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ecosistema Hadoop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/01arq.html" class="md-nav__link">
        Arquitecturas Big Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/02etl.html" class="md-nav__link">
        Ingesta de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/03hadoop.html" class="md-nav__link">
        Hadoop
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04hdfs.html" class="md-nav__link">
        HDFS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04formatos.html" class="md-nav__link">
        Formatos de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/05flume.html" class="md-nav__link">
        Sqoop y Flume
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/06hive.html" class="md-nav__link">
        Hive
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../cloud/index.html">Datos en el cloud</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Datos en el cloud
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/01cloud.html" class="md-nav__link">
        Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/02aws.html" class="md-nav__link">
        AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/03s3.html" class="md-nav__link">
        S3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/04computacion.html" class="md-nav__link">
        EC2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/05emr.html" class="md-nav__link">
        EMR
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/06datos.html" class="md-nav__link">
        RDS y DynamoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/07athena.html" class="md-nav__link">
        Athena
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../spark/index.html">Spark</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Spark
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spark/01spark.html" class="md-nav__link">
        Ecosistema
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spark/01rdd.html" class="md-nav__link">
        RDD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spark/02dataframeAPI.html" class="md-nav__link">
        DataFrames API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spark/02agregaciones.html" class="md-nav__link">
        Agregaciones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spark/02catalog.html" class="md-nav__link">
        Spark JDBC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spark/03streaming.html" class="md-nav__link">
        Streaming I
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spark/03join-window.html" class="md-nav__link">
        Streaming II
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">Flujo de datos</a>
          
            <label for="__nav_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Flujo de datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="04nifi1.html" class="md-nav__link">
        Nifi I
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="05nifi2.html" class="md-nav__link">
        Nifi II
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02kafka.html" class="md-nav__link">
        Kafka I
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="03kafka.html" class="md-nav__link">
        Kafka II
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Airflow
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="06airflow.html" class="md-nav__link md-nav__link--active">
        Airflow
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-de-datos" class="md-nav__link">
    Pipeline de datos
  </a>
  
    <nav class="md-nav" aria-label="Pipeline de datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dag" class="md-nav__link">
    DAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#orquestacion-de-flujos-de-trabajo" class="md-nav__link">
    Orquestación de flujos de trabajo
  </a>
  
    <nav class="md-nav" aria-label="Orquestación de flujos de trabajo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#herramientas" class="md-nav__link">
    Herramientas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apache-airflow" class="md-nav__link">
    Apache Airflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#componentes" class="md-nav__link">
    Componentes
  </a>
  
    <nav class="md-nav" aria-label="Componentes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dags" class="md-nav__link">
    DAGs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#planificacion" class="md-nav__link">
    Planificación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tareas" class="md-nav__link">
    Tareas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasando-datos-entre-tareas" class="md-nav__link">
    Pasando datos entre tareas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#puesta-en-marcha" class="md-nav__link">
    Puesta en marcha
  </a>
  
    <nav class="md-nav" aria-label="Puesta en marcha">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interfaz-web" class="md-nav__link">
    Interfaz web
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hola-airflow" class="md-nav__link">
    Hola Airflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-1-de-csv-a-json" class="md-nav__link">
    Caso 1: De CSV a JSON
  </a>
  
    <nav class="md-nav" aria-label="Caso 1: De CSV a JSON">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#definicion-del-dag" class="md-nav__link">
    Definición del DAG
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencias-entre-tareas" class="md-nav__link">
    Dependencias entre tareas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejecucion" class="md-nav__link">
    Ejecución
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#probando-desde-el-cli" class="md-nav__link">
    Probando desde el CLI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-2-de-mariadb-a-s3" class="md-nav__link">
    Caso 2: De MariaDB a S3
  </a>
  
    <nav class="md-nav" aria-label="Caso 2: De MariaDB a S3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conectando-con-la-bd" class="md-nav__link">
    Conectando con la BD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistiendo-en-s3" class="md-nav__link">
    Persistiendo en S3
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definiendo-el-dag" class="md-nav__link">
    Definiendo el DAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-3-de-mariadb-a-s3-mejorado" class="md-nav__link">
    Caso 3: De MariaDB a S3 mejorado
  </a>
  
    <nav class="md-nav" aria-label="Caso 3: De MariaDB a S3 mejorado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usando-proveedores" class="md-nav__link">
    Usando proveedores
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-variables" class="md-nav__link">
    Utilizando variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-parametros" class="md-nav__link">
    Utilizando parámetros
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-xcom" class="md-nav__link">
    Uso de XCOM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-en-uno" class="md-nav__link">
    Todo en uno
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        PIA FP
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-de-datos" class="md-nav__link">
    Pipeline de datos
  </a>
  
    <nav class="md-nav" aria-label="Pipeline de datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dag" class="md-nav__link">
    DAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#orquestacion-de-flujos-de-trabajo" class="md-nav__link">
    Orquestación de flujos de trabajo
  </a>
  
    <nav class="md-nav" aria-label="Orquestación de flujos de trabajo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#herramientas" class="md-nav__link">
    Herramientas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apache-airflow" class="md-nav__link">
    Apache Airflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#componentes" class="md-nav__link">
    Componentes
  </a>
  
    <nav class="md-nav" aria-label="Componentes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dags" class="md-nav__link">
    DAGs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#planificacion" class="md-nav__link">
    Planificación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tareas" class="md-nav__link">
    Tareas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasando-datos-entre-tareas" class="md-nav__link">
    Pasando datos entre tareas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#puesta-en-marcha" class="md-nav__link">
    Puesta en marcha
  </a>
  
    <nav class="md-nav" aria-label="Puesta en marcha">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interfaz-web" class="md-nav__link">
    Interfaz web
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hola-airflow" class="md-nav__link">
    Hola Airflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-1-de-csv-a-json" class="md-nav__link">
    Caso 1: De CSV a JSON
  </a>
  
    <nav class="md-nav" aria-label="Caso 1: De CSV a JSON">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#definicion-del-dag" class="md-nav__link">
    Definición del DAG
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencias-entre-tareas" class="md-nav__link">
    Dependencias entre tareas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejecucion" class="md-nav__link">
    Ejecución
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#probando-desde-el-cli" class="md-nav__link">
    Probando desde el CLI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-2-de-mariadb-a-s3" class="md-nav__link">
    Caso 2: De MariaDB a S3
  </a>
  
    <nav class="md-nav" aria-label="Caso 2: De MariaDB a S3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conectando-con-la-bd" class="md-nav__link">
    Conectando con la BD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistiendo-en-s3" class="md-nav__link">
    Persistiendo en S3
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definiendo-el-dag" class="md-nav__link">
    Definiendo el DAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-3-de-mariadb-a-s3-mejorado" class="md-nav__link">
    Caso 3: De MariaDB a S3 mejorado
  </a>
  
    <nav class="md-nav" aria-label="Caso 3: De MariaDB a S3 mejorado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usando-proveedores" class="md-nav__link">
    Usando proveedores
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-variables" class="md-nav__link">
    Utilizando variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-parametros" class="md-nav__link">
    Utilizando parámetros
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-xcom" class="md-nav__link">
    Uso de XCOM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-en-uno" class="md-nav__link">
    Todo en uno
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="orquestacion-de-flujos-apache-airflow">Orquestación de flujos: Apache Airflow<a class="headerlink" href="#orquestacion-de-flujos-apache-airflow" title="Permanent link">&para;</a></h1>
<h2 id="pipeline-de-datos">Pipeline de datos<a class="headerlink" href="#pipeline-de-datos" title="Permanent link">&para;</a></h2>
<p>En la sesión sobre <a href="../hadoop/02etl.html">Ingesta de datos</a> estudiamos en qué consiste un <a href="../hadoop/02etl.html#pipeline-de-datos">pipeline de datos</a> entendiéndolo como el conjunto de pasos y las tecnologías involucradas en un proceso de movimiento o procesamiento de datos.</p>
<p>Por ejemplo, si queremos almacenar en un lago de datos las temperaturas que obtenemos de la AEMET para posteriormente crear un cuadro de mandos donde realizar algún tipo de predicción se entiende que deberemos realizar una petición REST, recuperar los datos y seleccionar los datos específicos que nos interesan y finalmente persistir los datos en el <em>data lake</em> (por ejemplo, en <em>S3</em>), para posteriormente poder leer dichos datos desde una herramienta de cuadro de mandos, como pueda ser <em>Tableau</em> o <em>PowerBI</em>.</p>
<h3 id="dag">DAG<a class="headerlink" href="#dag" title="Permanent link">&para;</a></h3>
<p>Estos pasos siguen un orden determinado que no podemos alterar (es decir, no puedo almacenar los datos que no he recibido previamente). Este orden se puede representar mediante un grafo dirigido, donde los nodos representan las tareas mientras que las dependencias se representan mediante aristas que van de un nodo a otro.</p>
<figure style="align: center">
    <img alt="Representación de un pipeline de datos mediante un grafo dirigido" src="images/01dp-grafo.png">
    <figcaption>Representación de un pipeline de datos mediante un grafo dirigido</figcaption>
</figure>

<p>Este tipo de grafos se conocen como <a href="https://es.wikipedia.org/wiki/Grafo_acíclico_dirigido">grafos acíclicos dirigidos</a> (<em>directed acyclic graph - DAG</em>), ya que contiene aristas dirigidas (las relaciones van en un único sentido) y no contiene ciclos (bucles). La propiedad acíclica es muy importante, ya que nos evita bloqueos por dependencias circulares entre tareas.</p>
<figure style="float: right">
    <img alt="Representación de DAG" src="images/06dag.png">
    <figcaption>Representación de DAG</figcaption>
</figure>

<p>Si nos fijamos en el grafo de la figura lateral, tenemos una grafo que define cuatro tareas (A, B, C y D), donde una vez ha finalizado la tarea A, la B y C se pueden realizar de forma paralela, y hasta que no hayan acabado esas dos, no comenzará la tarea D.</p>
<p>Así pues, el grafo define las dependencias entre las tareas y condiciona la ejecución de una o más tareas a la finalización de las que la preceden. Lo que no hace es grafo es saber lo que se realiza dentro de las tareas, sólo le importa el orden de ejecución, la cantidad de reintentos, si tiene un duración de caducidad (<em>timeout</em>), etc...</p>
<h2 id="orquestacion-de-flujos-de-trabajo">Orquestación de flujos de trabajo<a class="headerlink" href="#orquestacion-de-flujos-de-trabajo" title="Permanent link">&para;</a></h2>
<p>La planificación de los DAG antiguamente se realizaba mediante tareas cron que ejecutaban algún script que lanzaba el pipeline de datos. Conforme crecía la cantidad de pipelines era necesaria utilizar alguna herramienta que permita planificar y monitorizar los pipelines.</p>
<p>Las soluciones de orquestación de datos se utilizan hoy en día para:</p>
<ul>
<li>limpieza, organización y persistencia en un <em>data lakehouse</em></li>
<li>cálculo de KPIs</li>
<li>preparación de datos y entrenamiento de modelos IA.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Orquestación vs Automatización</p>
<p>Conviene no confundir automatización, entendida como configurar una tarea para que se ejecute por sí sola, con la orquestación, donde tenemos múltiples tareas interrelacionadas con dependencias entre ellas.</p>
</div>
<h3 id="herramientas">Herramientas<a class="headerlink" href="#herramientas" title="Permanent link">&para;</a></h3>
<figure style="float: right;">
    <img src="images/01dp-wms-tools.png" width="300">
    <figcaption>Herramientas para el trabajo con flujos de datos</figcaption>
</figure>

<p>Las principales herramientas para la orquestación de flujos (<em>workflow management systems - WMS</em>) de datos son:</p>
<ul>
<li><a href="https://airflow.apache.org">Apache Airflow</a>: estándar <em>de facto</em> como herramienta de orquestación de flujos de datos, los cuales se definen mediante <em>Python</em> y ofrece un interfaz gráfico para su monitorización.</li>
<li><a href="https://nifi.apache.org">Apache Nifi</a>: ofrece un interfaz gráfico muy amigable para la definición de los flujos, así como un conjunto de conectores ya predefinidos para interactuar tanto con las fuentes de datos como los diferentes destinos.</li>
<li><a href="https://oozie.apache.org">Apache Oozie</a>: centrada en su uso dentro del ecosistema <em>Hadoop</em> definiendo los flujos mediante XML. Actualmente se encuentra en desuso.</li>
</ul>
<p>Existen otras herramientas tan o más válidas como pueden ser <a href="https://argoproj.github.io">Argo</a>, <a href="https://luigi.readthedocs.io">Luigi</a>, <a href="https://www.prefect.io/">Prefect</a> o <a href="https://dagster.io/">Dagster</a>.</p>
<h2 id="apache-airflow">Apache Airflow<a class="headerlink" href="#apache-airflow" title="Permanent link">&para;</a></h2>
<figure style="float: right;">
    <img src="images/06airflow-logo.png" width="300">
    <figcaption>Logo de Airflow</figcaption>
</figure>

<p><a href="https://airflow.apache.org/"><em>Apache Airflow</em></a> es un <em>framework</em> orientado a procesamiento <em>batch</em> para construir <em>pipelines</em> de datos, facilitando su planificación mediante código <em>Python</em>. Funciona como un orquestador de flujos, situándose en medio de los procesos de datos y coordinando cuándo y cómo los datos viajan de un lugar a otro.</p>
<p>A día de hoy (mayo de 2023) es la plataforma de orquestación <em>open-source</em> más popular, siendo la versión 2.5.3 la última disponible.</p>
<p>Nació como un proyecto interno en <em>Airbnb</em> a finales de 2014, con el propósito de solucionar la complejidad de los flujos de trabajo mediante una autoría programativa y planificando las tareas mediante un interfaz gráfico sencillo.</p>
<p>Para ello, definiremos un pipeline con su propia configuración y planificación dentro de un <em>script Python</em>, lo que otorga gran flexibilidad a la hora de definir los DAGs (grafos acíclicos dirigidos), permitiendo generar tareas opcionales que dependen de ciertas condiciones o incluso definir DAGs a partir de metadatos externos o ficheros de configuración.</p>
<figure style="align: center">
    <img alt="Arquitectura de Airflow" src="images/06airflow-pipeline.png">
    <figcaption>Pipeline con Airflow</figcaption>
</figure>

<p>Como las tareas pueden ejecutar cualquier operación que podamos codificar en <em>Python</em>, existen muchísimas extensiones que permiten ejecutar tareas en una gran variedad de sistemas, ya sean bases de datos externas, tecnologías <em>big data</em>, servicios <em>cloud</em>, etc... permitiendo definir complejos flujos de datos entre múltiples sistemas.</p>
<p>Las principales ventajas de utilizar <em>Airflow</em> son:</p>
<ul>
<li>poder crear <em>pipelines</em> mediante <em>Python</em>, permitiendo solucionar casi cualquier problema.</li>
<li>amplia comunidad que ya ha desarrollado múltiples extension que facilitan la integración de <em>Airflow</em> con diferentes tipos de bases de datos, servicios cloud, etc... </li>
<li>semántica rica para la planificación de los <em>pipelines</em>.</li>
<li>características avanzadas como el <em>backfilling</em> para la ejecución de tareas que han fallado o el reprocesado de datos históricos, permitiendo regenerar cualquier conjunto de datos tras haber hecho cambios en nuestro código.</li>
<li>interfaz gráfico rico que facilita la monitorización y depuración de los resultados de los grafos ejecutados.</li>
</ul>
<p>Finalmente, al tratarse de un producto <em>open source</em> ya existen diferentes empresas que ofrecen una solución gestionada en el cloud con soporte, como puede ser <a href="https://www.astronomer.io/">Astronomer</a>, el cual tiene su propia certificación y <a href="https://academy.astronomer.io/">plataforma educativa</a> o <a href="https://aws.amazon.com/es/managed-workflows-for-apache-airflow/">AWS Managed Workflows for Apache Airflow (MWAA)</a></p>
<h2 id="componentes">Componentes<a class="headerlink" href="#componentes" title="Permanent link">&para;</a></h2>
<p>A nivel de arquitectura, <em>Airflow</em> se organiza en los siguientes componentes:</p>
<ul>
<li>El planificador (<strong><em>scheduler</em></strong>): parsea los DAGS, comprueba los intervalos de planificación y si se cumplen, planifica su ejecución pasándoselos a los <em>workers</em>.</li>
<li>Los trabajadores (<strong><em>workers</em></strong>): recoge las tareas planificadas para ejecución y las ejecuta. Son los componentes encargados realmente de realizar el trabajo.</li>
<li>El servidor web (<strong><em>webserver</em></strong>): visualiza los DAGs parseados por el planificador y ofrece un interfaz a los usuarios para ejecutar, depurar y monitorizar los flujos, así como sus resultados.</li>
<li>Una carpeta con los ficheros <em>Python</em> con la definición de los flujos, a la cual acceden el planificador y los trabajadores.</li>
<li>Una base de datos con metadatos (<em>metastore</em>).</li>
</ul>
<figure style="align: center">
    <img alt="Arquitectura de Airflow" src="images/06airflow-arch.png">
    <figcaption>Arquitectura de Airflow - airflow.apache.org</figcaption>
</figure>

<p>Vamos a explicar en un poco de más detalle como se comunican estos componentes paso a paso:</p>
<ol>
<li>El usuario codifica un DAG en Python y lo almacena en la carpeta con la definición de los flujos.</li>
<li>El planificador lee el DAG y<ol>
<li>Extrae las tareas, dependencias e intervalo de ejecución.</li>
<li>Comprueba si se cumple el intervalo de planificación desde la última que leyó el DAG. Si es así, las tareas del DAG se planifican para su ejecución.</li>
<li>Para cada tarea, comprueba las dependencias (<em>upstream tasks</em>) de las tareas que ya han finalizado. Si las hay, las añade a la cola de ejecución.</li>
<li>El planificador espera un momento y vuelve a comenzar con el paso 1.</li>
</ol>
</li>
<li>Una vez que las tareas se encolan, la consumen un <em>pool</em> de trabajadores que ejecutan en paralelo las tareas y guardan su resultado. Estos resultados se almacenan en el <em>metastore</em></li>
<li>El usuario monitoriza la ejecución del DAG y el progreso del resultado de las tareas (junto con sus logs) mediante el interfaz gráfico del servidor web de Airflow.</li>
</ol>
<figure style="align: center">
    <img alt="Interacción de los componentes de Airflow" src="images/06airflow-components.png">
    <figcaption>Interacción de los componentes de Airflow</figcaption>
</figure>

<p><em>Airflow</em> envía las tareas a los <em>workers</em> tan pronto como es posible, por lo que no hay garantías que todas las tareas de un DAG se ejecuten en el mismo <em>worker</em> en la misma máquina.</p>
<h3 id="dags">DAGs<a class="headerlink" href="#dags" title="Permanent link">&para;</a></h3>
<p>Los DAGs se diseñan para ejecutarse muchas veces, y muchas de esas ejecuciones se pueden realizar en paralelo. Además, los DAGs se parametrizan, incluyendo siempre un intervalo de datos.</p>
<p>Conforme vayamos creando nuestro DAGs es muy común que se vayan complicando. Para ello, podemos reutilizar DAGs creando DAGs unos dentro de otros a modo de módulos (<em>subdag</em>), así como grupos de tareas (<code>TaskGroups</code>) para agruparlos visualmente en el interfaz gráfico.</p>
<p><em>Airflow</em> por sí mismo es agnóstico de lo que está ejecutando, de manera que orquesta y ejecuta cualquier funcionalidad que ofrecen los proveedores, un comando mediante <em>shell</em> o cualquier operador de <em>Python</em>.</p>
<h3 id="planificacion">Planificación<a class="headerlink" href="#planificacion" title="Permanent link">&para;</a></h3>
<div class="admonition tip inline end">
<p class="admonition-title">Formato crontab</p>
<p>Las expresiones <em>crontab</em> utilizan el formato minuto, hora, dia del mes, mes, dia de la semana.
Así pues, el valor <code>@yearly</code> es similar a <code>0 0 1 1 *</code>, ya que significa que se ejecuta de forma anual el 1 de Enero (<code>1 1</code>) a medianoche (<code>0 0</code>) cualquier día de la semana <code>*</code>.</p>
</div>
<p>Una vez hemos definido la estructura de nuestro pipeline como un DAG, <em>Airflow</em> nos permite definir el intervalo de planificación de cada DAG, determinando cuando se ejecutará el <em>pipeline</em>. </p>
<p>De esta manera, podemos decirle a <em>Airflow</em> que ejecute el DAG cada hora, día, semana, etc... o mediante intervalos de planificación más complejos basados en expresiones <em>Cron</em>:</p>
<table>
<thead>
<tr>
<th>Valor de planificación</th>
<th>Expresión Cron</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@once</code></td>
<td></td>
</tr>
<tr>
<td><code>@hourly</code></td>
<td><code>0 * * * *</code></td>
</tr>
<tr>
<td><code>@daily</code></td>
<td><code>0 0 * * *</code></td>
</tr>
<tr>
<td><code>@weekly</code></td>
<td><code>0 0 * * 0</code></td>
</tr>
<tr>
<td><code>@monthly</code></td>
<td><code>0 0 1 * *</code></td>
</tr>
<tr>
<td><code>@yearly</code></td>
<td><code>0 0 1 1 *</code></td>
</tr>
</tbody>
</table>
<h4 id="ejecutor">Ejecutor<a class="headerlink" href="#ejecutor" title="Permanent link">&para;</a></h4>
<p>El <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/index.html">ejecutor</a> es el proceso responsable de lanzar las tareas a partir de la planificación del DAG. Para ello, espera que el planificador le notifique que el DAG está listo para su ejecución.</p>
<p>De hecho, el ejecutor corre dentro del proceso del planificador, lo que implica que sólo pueda haber un modo de ejecución por cluster.</p>
<p><em>Airflow</em> dispone principalmente de dos tipos de ejecutores:</p>
<ul>
<li>Ejecutores locales: <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/sequential.html"><em>SequentialExecutor</em></a> (por defecto) y <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/local.html"><em>LocalExecutor</em></a> (mejor para pequeños clústers ya que permite la paralelización de los procesos). </li>
<li>Ejecutores remotos: permiten la ejecución de múltiples DAGs de forma paralela mediante un red de nodos <em>workers</em>, por ejemplo, mediante <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/celery.html"><em>CeleryExecutor</em></a> para arquitecturas en clúster o <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/kubernetes.html"><em>KubernetesExecutor</em></a> si utilizamos <em>Kubernetes</em> como orquestador de contenedores.</li>
</ul>
<h3 id="tareas">Tareas<a class="headerlink" href="#tareas" title="Permanent link">&para;</a></h3>
<p>Todo DAG ejecuta una o más tareas (todas heredan de la clase <code>BaseOperator</code>). Podemos considerar las tareas como la unidad de ejecución de <em>Airflow</em>. Destacan tres tipos de tareas:</p>
<ul>
<li><strong>Operadores</strong>: tareas predefinidas (a modo de plantillas) que podemos encadenar para construir la mayoría de nuestros DAGs. Pueden ejecutarse de forma local o remota. <em>Airflow</em> tiene varios tipos de <a href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/index.html">operadores ya predefinidos</a>, como son los operadores <em>bash</em>, el operador <em>python</em> o los operadores para interactuar con bases de datos. </li>
<li><strong>Sensores</strong>: subclase de los operadores centrada en la escucha de eventos externos.</li>
<li>Un <strong>flujo de tareas</strong> decoradas con <code>@task</code></li>
</ul>
<p>Internamente, los conceptos de tarea y operador son intercambiables, pero conviene separa ambos conceptos teniendo en cuenta que los Operadores y los Sensores son plantillas, y cuando invocamos uno en un DAG, entonces estamos creado una Tarea.</p>
<h4 id="dependencias">Dependencias<a class="headerlink" href="#dependencias" title="Permanent link">&para;</a></h4>
<p>Las tareas tienen dependencias que se declaran unas sobre otras, mediante los operadores <code>&gt;&gt;</code> y <code>&lt;&lt;</code>, dependiendo de si indicamos primero las dependencias antes o después:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">primera_tarea</span> <span class="o">&gt;&gt;</span> <span class="p">[</span><span class="n">segunda_tarea</span><span class="p">,</span> <span class="n">tercera_tarea</span><span class="p">]</span>
<span class="linenos" data-linenos="2 "></span><span class="n">cuarta_tarea</span> <span class="o">&lt;&lt;</span> <span class="n">tercera_tarea</span>
</code></pre></div>
<p>Esto mismo se puede definir mediante los métodos <code>set_upstream</code> y <code>set_downstream</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">primera_tarea</span><span class="o">.</span><span class="n">set_downstream</span><span class="p">([</span><span class="n">segunda_tarea</span><span class="p">,</span> <span class="n">tercera_tarea</span><span class="p">])</span>
<span class="linenos" data-linenos="2 "></span><span class="n">cuarta_tarea</span><span class="o">.</span><span class="n">set_upstream</span><span class="p">(</span><span class="n">tercera_tarea</span><span class="p">)</span>
</code></pre></div>
<p>Estas dependencias definen los nodos del grafo y cómo sabe Airflow el orden en el que debe ejecutar las tareas. Por defecto, una tarea esperará a que todas las tareas previas (<em>upstream</em>) hayan finalizado exitosamente antes de ejecutarse (aunque esto puede personalizarse mediante características como <em>Branching</em>, <em>LatestOnly</em> y reglas de <em>Trigger</em>).</p>
<h3 id="pasando-datos-entre-tareas">Pasando datos entre tareas<a class="headerlink" href="#pasando-datos-entre-tareas" title="Permanent link">&para;</a></h3>
<p>Por defecto, los nodos de un DAG no transmiten información de uno a otro, pero en algún caso concreto puede ser necesario que un nodo necesite cierta información de alguno de sus predecesores.</p>
<p>Para pasar datos entre las tareas disponemos de tres opciones:</p>
<ul>
<li><strong><em>XComs</em></strong> (<em>Cross-communications</em>), un sistema para que las tareas puedan hacer <em>push</em> y <em>pull</em> de una pequeña cantidad de metadatos.</li>
<li>Cargar y descargar archivos grandes desde servicios de almacenamiento (como pueda ser S3 o un NAS)</li>
<li>Utilizar el API <em>TaskFlow</em> que automáticamente pasa los datos entre tareas implícitamente mediante <em>XComs</em>.</li>
</ul>
<h2 id="puesta-en-marcha">Puesta en marcha<a class="headerlink" href="#puesta-en-marcha" title="Permanent link">&para;</a></h2>
<p>En nuestra máquina virtual ya tenemos instalada la versión 2.5 de <em>Apache Airflow</em>, la cual hemos instalado mediante <code>pip</code> en <code>/opt/airflow-2.5.0</code>. Puedes encontrar más información sobre su instalación en la <a href="https://airflow.apache.org/docs/apache-airflow/stable/installation/installing-from-pypi.html">documentación oficial</a>.</p>
<p>Para arrancarlo, ejecutaremos en dos terminales diferentes los comandos para arrancar tanto el servidor web como el planificador:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>webserver
<span class="linenos" data-linenos="2 "></span>airflow<span class="w"> </span>scheduler
</code></pre></div>
<p>Si queremos crear un nuevo usuario, podemos hacerlo a través del comando <a href="https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/security/webserver.html#web-authentication"><code>airflow users create</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>users<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span>--username<span class="w"> </span>airflow<span class="w"> </span><span class="se">\</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span>--firstname<span class="w"> </span>IA<span class="w"> </span><span class="se">\</span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span>--lastname<span class="w"> </span>BD<span class="w"> </span><span class="se">\</span>
<span class="linenos" data-linenos="5 "></span><span class="w">    </span>--role<span class="w"> </span>Admin<span class="w"> </span><span class="se">\</span>
<span class="linenos" data-linenos="6 "></span><span class="w">    </span>--email<span class="w"> </span>iabd@s8a.com
</code></pre></div>
<p>A continuación nos pedirá que introduzcamos la contraseña, que en nuestro caso, hemos puesto <code>airflow</code>.</p>
<div class="admonition info">
<p class="admonition-title">Airflow en Docker</p>
<p>Para ejecutar <em>Airflow</em> dentro de <em>Docker</em> se recomienda seguir las instrucciones de la <a href="https://airflow.apache.org/docs/docker-stack/index.html">documentación oficial</a>.</p>
<p>Para facilitar su uso, se adjunto el archivo <a href="resources/airflow/docker-compose.yml">docker-compose.yml</a> que hemos empleado en clase.</p>
<p>En un entorno de producción, en vez de tener todos los contenedores en una máquina, deberíamos repartirlo en diferentes máquinas, o incluso mejor, optar por el despliegue en un <a href="https://airflow.apache.org/docs/helm-chart/stable/index.html">cluster de <em>Kubernetes</em></a>.</p>
</div>
<h3 id="interfaz-web">Interfaz web<a class="headerlink" href="#interfaz-web" title="Permanent link">&para;</a></h3>
<p>Al entrar a <code>http://localhost:8080/</code>, tras introducir  el usuario <code>airflow</code> y contraseña <code>airflow</code> podemos ver el listado de DAGs cargados en <em>Airflow</em>:</p>
<figure style="align: center">
    <img alt="Interfaz web Airflow" src="images/06airflow-webserver-ui.png">
    <figcaption>Interfaz web Airflow</figcaption>
</figure>

<p>En esta pantalla podemos ver las definiciones de nuestros grafos, sus metadatos y estadísticas sobre las ejecuciones previas (si las hubiera). Además, en la parte superior disponemos de diferentes opciones de seguridad y herramientas comunes de administración, como puede ser preconfigurar el acceso a recursos centrales como almacenes de datos mediante la configuración de conexiones (<em>Admin ⇨ Connections</em>) así como limitar la concurrencia (<em>Admin ⇨ Pools</em>).</p>
<h2 id="hola-airflow">Hola Airflow<a class="headerlink" href="#hola-airflow" title="Permanent link">&para;</a></h2>
<p>Para probar <em>Airflow</em>, vamos a ejecutar uno de los ejemplos instalados, en concreto <code>example_bash_operator</code>.</p>
<p>Si entramos a nuestro flujo, podemos lanzarlo mediante el <em>slider</em> situado a la izquierda (<em>pause/unpause DAG</em>) así como provocar una ejecución mediante los botones situado a la derecha (el play para hacer un <em>trigger</em> del DAG). En la siguiente imagen podemos ver la vista de grafo donde podemos observar las diferentes tareas y dependencias:</p>
<figure style="align: center">
    <img alt="Interfaz web Airflow" src="images/06airflow-example-bash-operator-graph.png">
    <figcaption>Interfaz del grafo example-bash-operator</figcaption>
</figure>

<p>Si pulsamos sobre la opción de <em>Source</em> podemos ver el código <em>Python</em> que define el DAG:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="n">dag_id</span><span class="o">=</span><span class="s2">&quot;example_bash_operator&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="n">schedule</span><span class="o">=</span><span class="s2">&quot;0 0 * * *&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="n">start_date</span><span class="o">=</span><span class="n">pendulum</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">dagrun_timeout</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">),</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> <span class="s2">&quot;example2&quot;</span><span class="p">],</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;example_key&quot;</span><span class="p">:</span> <span class="s2">&quot;example_value&quot;</span><span class="p">},</span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">run_this_last</span> <span class="o">=</span> <span class="n">EmptyOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="11 "></span>        <span class="n">task_id</span><span class="o">=</span><span class="s2">&quot;run_this_last&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span>    <span class="c1"># [START howto_operator_bash]</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">run_this</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="16 "></span>        <span class="n">task_id</span><span class="o">=</span><span class="s2">&quot;run_after_loop&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span>        <span class="n">bash_command</span><span class="o">=</span><span class="s2">&quot;echo 1&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="18 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="19 "></span>    <span class="c1"># [END howto_operator_bash]</span>
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span>    <span class="n">run_this</span> <span class="o">&gt;&gt;</span> <span class="n">run_this_last</span>
<span class="linenos" data-linenos="22 "></span>
<span class="linenos" data-linenos="23 "></span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<span class="linenos" data-linenos="24 "></span>        <span class="n">task</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="25 "></span>            <span class="n">task_id</span><span class="o">=</span><span class="s2">&quot;runme_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
<span class="linenos" data-linenos="26 "></span>            <span class="n">bash_command</span><span class="o">=</span><span class="s1">&#39;echo &quot;{{ task_instance_key_str }}&quot; &amp;&amp; sleep 1&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="27 "></span>        <span class="p">)</span>
<span class="linenos" data-linenos="28 "></span>        <span class="n">task</span> <span class="o">&gt;&gt;</span> <span class="n">run_this</span>
<span class="linenos" data-linenos="29 "></span>
<span class="linenos" data-linenos="30 "></span>    <span class="c1"># [START howto_operator_bash_template]</span>
<span class="linenos" data-linenos="31 "></span>    <span class="n">also_run_this</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="32 "></span>        <span class="n">task_id</span><span class="o">=</span><span class="s2">&quot;also_run_this&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="33 "></span>        <span class="n">bash_command</span><span class="o">=</span><span class="s1">&#39;echo &quot;ti_key={{ task_instance_key_str }}&quot;&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="34 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="35 "></span>    <span class="c1"># [END howto_operator_bash_template]</span>
<span class="linenos" data-linenos="36 "></span>    <span class="n">also_run_this</span> <span class="o">&gt;&gt;</span> <span class="n">run_this_last</span>
<span class="linenos" data-linenos="37 "></span>
<span class="linenos" data-linenos="38 "></span><span class="c1"># [START howto_operator_bash_skip]</span>
<span class="linenos" data-linenos="39 "></span><span class="n">this_will_skip</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="40 "></span>    <span class="n">task_id</span><span class="o">=</span><span class="s2">&quot;this_will_skip&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="41 "></span>    <span class="n">bash_command</span><span class="o">=</span><span class="s1">&#39;echo &quot;hello world&quot;; exit 99;&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="42 "></span>    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="linenos" data-linenos="43 "></span><span class="p">)</span>
<span class="linenos" data-linenos="44 "></span><span class="c1"># [END howto_operator_bash_skip]</span>
<span class="linenos" data-linenos="45 "></span><span class="n">this_will_skip</span> <span class="o">&gt;&gt;</span> <span class="n">run_this_last</span>
</code></pre></div>
<p>Sin entrar todavía en detalle en el código podemos ver como utiliza los operadores <a href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/bash/index.html"><code>BashOperator</code></a> y <a href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/empty/index.html"><code>EmptyOperator</code></a>. El operador <em>bash</em> ejecuta una operación de línea de comandos (en este ejemplo estamos realizando operaciones <code>echo</code>) y el operador vacío sirve para crear un nodo final común.</p>
<p>Una vez lanzado, si cambiamos a la vista de <em>Grid</em> (antes se conocía como la vista de árbol), podemos ver todas las ejecuciones actuales e históricas. Esta vista es la más útil en el día a día, ya que nos permite obtener una visión general de cómo está funcionando el DAG así como visualizar las tareas que fallan y analizar su motivo.</p>
<figure style="align: center">
    <img alt="Interfaz grid del example-bash-operator" src="images/06airflow-example-bash-operator-grid.png">
    <figcaption>Interfaz grid del example-bash-operator</figcaption>
</figure>

<p>Podemos observar en el panel lateral de la izquierda como tenemos varias ejecuciones realizadas exitosamente (cada columna de cuadrados en verde es una ejecución, y cada cuadrado en sí representa el estado de una tarea). Si pulsamos sobre uno de los cuadrados, podemos obtener información sobre el estado de dicha ejecución (tanto del grafo completo como de las tareas individuales) y dependiendo de la instalación, tenemos la posibilidad de resetear el estado de una tarea para que pueda volver a ejecutarse:</p>
<figure style="align: center">
    <img alt="Interfaz del estado de una ejecución del example-bash-operator" src="images/06airflow-example-bash-operator-state.png">
    <figcaption>Interfaz del estado de una ejecución del example-bash-operator</figcaption>
</figure>

<p>Por defecto, <em>Airflow</em> puede gestionar los fallos en las tareas mediante varios reintentos (opcionalmente podemos indicar un tiempo de espera entre cada intento), lo que puede facilitar la recuperación de fallos intermitentes. Si los reintentos no ayudan, Airflow registrará la tarea como fallida, y opcionalmente notificará (si así lo hemos configurado) del fallo. De esta manera, depurar fallos en las tareas es un proceso bastante directo, ya que la vista de <em>grid</em> nos permite analizar las tareas que han fallado y navegar por sus logs. Además, esta misma vista permite limpiar el estado de las tareas para volver a ejecutarla (la tarea en cuestión y todas las tareas que dependan de ella), lo que facilita volver a ejecutar cualquier tarea tras haber corregido el fallo en el código fuente.</p>
<div class="admonition tip">
<p class="admonition-title">Quitando los ejemplos</p>
<p>Si no queremos que nos aparezcan todos los grafos de ejemplo, hemos de modificar la variable de entorno <code>AIRFLOW__CORE__LOAD_EXAMPLES</code>.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nb">export</span><span class="w"> </span><span class="nv">AIRFLOW__CORE__LOAD_EXAMPLES</span><span class="o">=</span>False
</code></pre></div>
<p>En la máquina virtual, si no queremos fijar la variable de entorno, podemos modificar en el archivo <code>airflow.cfg</code> la propiedad <code>load_examples = False</code> y a continuación resetear el <em>metastore</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>db<span class="w"> </span>reset
</code></pre></div>
<p>En <em>Docker</em> modificaremos la propiedad <code>AIRFLOW__CORE__LOAD_EXAMPLES</code> a <code>false</code> y volveremos a crear los contenedores:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>AIRFLOW__CORE__LOAD_EXAMPLES: &#39;false&#39;
</code></pre></div>
</div>
<h2 id="caso-1-de-csv-a-json">Caso 1: De CSV a JSON<a class="headerlink" href="#caso-1-de-csv-a-json" title="Permanent link">&para;</a></h2>
<p>Vamos a crear nuestro primer grafo, y para ello, vamos a realizar un ejemplo muy sencillo para leer un fichero con datos en formato CSV y transformarlo a JSON.</p>
<p>Se adjunta el siguiente <a href="resources/airflow/datos-faker.csv">archivo</a> en formato CSV generado mediante <a href="https://faker.readthedocs.io/">Faker</a> que contiene datos de personas:</p>
<div class="highlight"><span class="filename">datos-faker.csv</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span>nombre,edad,calle,ciudad,provincia,cp,longitud,latitud
<span class="linenos" data-linenos="2 "></span>Amaro Gómez Berrocal,45,Alameda de Clementina Luque 370,Palencia,Granada,07784,17.978258,64.777519
<span class="linenos" data-linenos="3 "></span>Consuelo Lerma Camino,38,Acceso Genoveva Lobato 3,Ciudad,Lugo,31271,-54.709984,85.6336715
<span class="linenos" data-linenos="4 "></span>Francisco Javier Palacio-Carbó,43,Rambla de Dora Ángel 7,Sevilla,Valladolid,09521,-68.691636,-30.530751
<span class="linenos" data-linenos="5 "></span>...
</code></pre></div>
<p>Antes de crear nuestro primer DAG, vamos a crear la función para leer el archivo CSV y pasarlo a JSON haciendo uso de <em>Pandas</em> (las rutas pueden variar entre la máquina virtual y Dropbox). Para ello, crea el siguiente script dentro de la carpeta <code>/opt/airflow-2.5.0/dags</code> y coloca los datos en <code>/opt/airflow-2.5.0/data</code> (si es la primera vez, es probable que tengas que crear dichas carpetas en la máquina virtual):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="k">def</span> <span class="nf">csvToJson</span><span class="p">():</span>
<span class="linenos" data-linenos="4 "></span>    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/opt/airflow-2.5.0/data/datos-faker.csv&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="linenos" data-linenos="6 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;nombre&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="7 "></span>    <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="s1">&#39;/opt/airflow-2.5.0/data/datos-airflow.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="definicion-del-dag">Definición del DAG<a class="headerlink" href="#definicion-del-dag" title="Permanent link">&para;</a></h3>
<p>A continuación vamos a definir un diccionario con las propiedades del DAG, como son el propietario, fecha de inicio, cantidad de reintentos y retraso entre cada reintento:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="linenos" data-linenos="2 "></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="linenos" data-linenos="3 "></span>
<span class="linenos" data-linenos="4 "></span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos="5 "></span>    <span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="s1">&#39;aitor-medrano&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="6 "></span>    <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
<span class="linenos" data-linenos="7 "></span>    <span class="s1">&#39;retries&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="8 "></span>    <span class="s1">&#39;retry_delay&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="linenos" data-linenos="9 "></span><span class="p">}</span>
</code></pre></div>
<p>A continuación definimos propiamente el DAG con sus tareas. Para ello, creamos un objeto <a href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/dag/index.html#airflow.models.dag.DAG"><code>DAG</code></a> donde vamos a definir su identificador, pasarle el diccionario que acabamos de crear y configurar su planificación.</p>
<p>Para configurar la planificación completaremos el atributo <code>schedule_interval</code>, ya sea mediante <a href="https://docs.python.org/3/library/datetime.html#datetime.timedelta"><code>timedelta</code></a> para definir su periodicidad o haciendo uso de expresiones <em>crontab</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">airflow.operators.bash_operator</span> <span class="kn">import</span> <span class="n">BashOperator</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">airflow.operators.python_operator</span> <span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;HolaAirflow-CSV&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>         <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>         <span class="n">schedule_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>      <span class="c1"># &#39;0 * * * *&#39;,</span>
<span class="linenos" data-linenos=" 8 "></span>         <span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">imprime_iniciando</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;iniciando&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>                               <span class="n">bash_command</span><span class="o">=</span><span class="s1">&#39;echo &quot;Leyendo el csv...&quot;&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">csvJson</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;csv2json&#39;</span><span class="p">,</span> <span class="n">python_callable</span><span class="o">=</span><span class="n">csvToJson</span><span class="p">)</span>
</code></pre></div>
<p>A continuación, definimos la tarea <code>imprime_iniciando</code> mediante un operador <em>bash</em> que imprime una cadena para saber que se está ejecutando. El objetivo de esta tarea sólo es didáctica, para demostrar como conectar las tareas. La siguiente tarea <code>csvJson</code> utiliza el operador <em>Python</em> para llamar a la función que hemos definido previamente, encargada de transformar un archivo CSV a JSON.</p>
<div class="admonition warning inline end">
<p class="admonition-title">Inicio del DAG</p>
<p>El inicio real de un DAG es <code>start_date</code> + <code>schedule_interval</code>. 
Es decir, si planificar un DAG con hoy como valor de <code>start_date</code> y en <code>schedule_interval</code> le ponemos como valor <code>daily</code>, realmente el DAG no se ejecutará hasta mañana.</p>
</div>
<h3 id="dependencias-entre-tareas">Dependencias entre tareas<a class="headerlink" href="#dependencias-entre-tareas" title="Permanent link">&para;</a></h3>
<p>Y finalmente configuramos las dependencias entre las tareas, de manera que primero imprimimos un mensaje informativo y a continuación realizamos el cambio de formato:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">imprime_iniciando</span> <span class="o">&gt;&gt;</span> <span class="n">csvJson</span>
</code></pre></div>
<p>Tal como hemos visto en el apartado de <a href="#dependencias">Dependencias</a> también la podríamos haber definido así (son todas equivalentes):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">imprime_iniciando</span><span class="o">.</span><span class="n">set_downstream</span><span class="p">(</span><span class="n">csvJson</span><span class="p">)</span>
<span class="linenos" data-linenos="2 "></span><span class="n">csvJson</span><span class="o">.</span><span class="n">set_upstream</span><span class="p">(</span><span class="n">imprime_iniciando</span><span class="p">)</span>
<span class="linenos" data-linenos="3 "></span><span class="n">csvJson</span> <span class="o">&lt;&lt;</span> <span class="n">imprime_iniciando</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Sé consistente</p>
<p>Independientemente de la forma que te guste más, siempre debes utilizar la misma y ser consistente. En mi caso, utilizaré siempre el operador de desplazamiento de bits a la derecha (<code>&gt;&gt;</code>)</p>
</div>
<h3 id="ejecucion">Ejecución<a class="headerlink" href="#ejecucion" title="Permanent link">&para;</a></h3>
<p>Una vez tenemos todo el archivo codificado (en mi caso lo he llamado <a href="resources/airflow/01csv2json.py">01csv2json.py</a>) lo colocaremos en la carpeta <code>/opt/airflow-2.5.0/dags</code> (la cual está configurada mediante la propiedad <code>dags_folder</code>).</p>
<p>Si ahora arrancamos <em>airflow</em> podremos ver como aparece el DAG y podemos ejecutarlo y ver su estado:</p>
<figure style="align: center">
    <img alt="Ejecución de HolaAirflow.CSV" src="images/06airflow-csv2json.gif">
    <figcaption>Ejecución de HolaAirflow.CSV</figcaption>
</figure>

<h3 id="probando-desde-el-cli">Probando desde el CLI<a class="headerlink" href="#probando-desde-el-cli" title="Permanent link">&para;</a></h3>
<p>Además del interfaz gráfico, podemos utilizar el CLI para interactuar con Airflow. Por ejemplo, para mostrar todos los <em>DAGs</em> desplegados utilizaremos el comando <code>airflow dags list</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>dags<span class="w"> </span>list
<span class="linenos" data-linenos="2 "></span><span class="c1"># dag_id          | filepath      | owner         | paused</span>
<span class="linenos" data-linenos="3 "></span><span class="c1"># ================+===============+===============+=======</span>
<span class="linenos" data-linenos="4 "></span><span class="c1"># HolaAirflow-CSV | 01read-csv.py | aitor-medrano | False</span>
</code></pre></div>
<p>Si queremos ver todas las tareas de nuestro DAG, ahora usaremos <code>airflow tasks list</code> y le pasamos el nombre del DAG:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>tasks<span class="w"> </span>list<span class="w"> </span>HolaAirflow-CSV
<span class="linenos" data-linenos="2 "></span><span class="c1"># csv2json</span>
<span class="linenos" data-linenos="3 "></span><span class="c1"># iniciando</span>
</code></pre></div>
<p>Y si queremos ver sus representación jerárquica:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>tasks<span class="w"> </span>list<span class="w"> </span>HolaAirflow-CSV<span class="w"> </span>--tree
<span class="linenos" data-linenos="2 "></span><span class="c1"># &lt;Task(BashOperator): iniciando&gt;</span>
<span class="linenos" data-linenos="3 "></span><span class="c1">#     &lt;Task(PythonOperator): csv2json&gt;</span>
</code></pre></div>
<p>Para probarlo, podemos realizar pruebas de las tareas de forma independiente, mediante <code>airflow tasks test</code>, donde podemos ver el operador ejecutado, así como su salida y estado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>airflow<span class="w"> </span>tasks<span class="w"> </span><span class="nb">test</span><span class="w"> </span>HolaAirflow-CSV<span class="w"> </span>iniciando
<span class="linenos" data-linenos=" 2 "></span><span class="c1"># [2023-04-30 07:46:18,079] {dagbag.py:538} INFO - Filling up the DagBag from /opt/***/dags</span>
<span class="linenos" data-linenos=" 3 "></span><span class="c1"># [2023-04-30 07:46:19,483] {taskinstance.py:1087} INFO - Dependencies all met for &lt;TaskInstance: HolaAirflow-CSV.iniciando __***_temporary_run_2023-04-30T07:46:18.644346+00:00__ [None]&gt;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="c1"># [2023-04-30 07:46:19,500] {taskinstance.py:1087} INFO - Dependencies all met for &lt;TaskInstance: HolaAirflow-CSV.iniciando __***_temporary_run_2023-04-30T07:46:18.644346+00:00__ [None]&gt;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="c1"># [2023-04-30 07:46:19,500] {taskinstance.py:1283} INFO - </span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># --------------------------------------------------------------------------------</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># [2023-04-30 07:46:19,500] {taskinstance.py:1284} INFO - Starting attempt 1 of 2</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># [2023-04-30 07:46:19,500] {taskinstance.py:1285} INFO - </span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># --------------------------------------------------------------------------------</span>
<span class="hll"><span class="linenos" data-linenos="10 "></span><span class="c1"># [2023-04-30 07:46:19,503] {taskinstance.py:1304} INFO - Executing &lt;Task(BashOperator): iniciando&gt; on 2023-04-30T07:46:18.644336+00:00</span>
</span><span class="linenos" data-linenos="11 "></span><span class="c1"># [2023-04-30 07:46:19,764] {taskinstance.py:1513} INFO - Exporting the following env vars:</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># AIRFLOW_CTX_DAG_OWNER=aitor-medrano</span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># AIRFLOW_CTX_DAG_ID=HolaAirflow-CSV</span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># AIRFLOW_CTX_TASK_ID=iniciando</span>
<span class="linenos" data-linenos="15 "></span><span class="c1"># AIRFLOW_CTX_EXECUTION_DATE=2023-04-30T07:46:18.644336+00:00</span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># AIRFLOW_CTX_TRY_NUMBER=1</span>
<span class="linenos" data-linenos="17 "></span><span class="c1"># AIRFLOW_CTX_DAG_RUN_ID=__***_temporary_run_2023-04-30T07:46:18.644346+00:00__</span>
<span class="linenos" data-linenos="18 "></span><span class="c1"># [2023-04-30 07:46:19,766] {subprocess.py:63} INFO - Tmp dir root location: /tmp</span>
<span class="hll"><span class="linenos" data-linenos="19 "></span><span class="c1"># [2023-04-30 07:46:19,767] {subprocess.py:75} INFO - Running command: [&#39;/bin/bash&#39;, &#39;-c&#39;, &#39;echo &quot;Leyendo el csv...&quot;&#39;]</span>
</span><span class="linenos" data-linenos="20 "></span><span class="c1"># [2023-04-30 07:46:19,786] {subprocess.py:86} INFO - Output:</span>
<span class="linenos" data-linenos="21 "></span><span class="c1"># [2023-04-30 07:46:19,789] {subprocess.py:93} INFO - Leyendo el csv...</span>
<span class="linenos" data-linenos="22 "></span><span class="c1"># [2023-04-30 07:46:19,789] {subprocess.py:97} INFO - Command exited with return code 0</span>
<span class="hll"><span class="linenos" data-linenos="23 "></span><span class="c1"># [2023-04-30 07:46:20,001] {taskinstance.py:1327} INFO - Marking task as SUCCESS. dag_id=HolaAirflow-CSV, task_id=iniciando, execution_date=20230430T074618, start_date=, end_date=20230430T074620</span>
</span></code></pre></div>
<p>O probar todo el DAG mediante <code>airflow dags test</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>airflow<span class="w"> </span>dags<span class="w"> </span><span class="nb">test</span><span class="w"> </span>HolaAirflow-CSV
<span class="linenos" data-linenos=" 2 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:18,119<span class="o">]</span><span class="w"> </span><span class="o">{</span>dagbag.py:538<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Filling<span class="w"> </span>up<span class="w"> </span>the<span class="w"> </span>DagBag<span class="w"> </span>from<span class="w"> </span>/opt/airflow-2.5.0/dags
<span class="linenos" data-linenos=" 3 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:18,843<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3651<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>dagrun<span class="w"> </span>id:<span class="w"> </span>HolaAirflow-CSV
<span class="linenos" data-linenos=" 4 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:18,872<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3668<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>created<span class="w"> </span>dagrun<span class="w"> </span>&lt;DagRun<span class="w"> </span>HolaAirflow-CSV<span class="w"> </span>@<span class="w"> </span><span class="m">2023</span>-04-30T07:51:18.119560+00:00:<span class="w"> </span>manual__2023-04-30T07:51:18.119560+00:00,<span class="w"> </span>state:running,<span class="w"> </span>queued_at:<span class="w"> </span>None.<span class="w"> </span>externally<span class="w"> </span>triggered:<span class="w"> </span>False&gt;
<span class="linenos" data-linenos=" 5 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:18,895<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3618<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>*****************************************************
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:18,896<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3622<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Running<span class="w"> </span>task<span class="w"> </span>iniciando
</span><span class="linenos" data-linenos=" 7 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,237<span class="o">]</span><span class="w"> </span><span class="o">{</span>taskinstance.py:1513<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Exporting<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>env<span class="w"> </span>vars:
<span class="linenos" data-linenos=" 8 "></span><span class="nv">AIRFLOW_CTX_DAG_OWNER</span><span class="o">=</span>aitor-medrano
<span class="linenos" data-linenos=" 9 "></span><span class="nv">AIRFLOW_CTX_DAG_ID</span><span class="o">=</span>HolaAirflow-CSV
<span class="linenos" data-linenos="10 "></span><span class="nv">AIRFLOW_CTX_TASK_ID</span><span class="o">=</span>iniciando
<span class="linenos" data-linenos="11 "></span><span class="nv">AIRFLOW_CTX_EXECUTION_DATE</span><span class="o">=</span><span class="m">2023</span>-04-30T07:51:18.119560+00:00
<span class="linenos" data-linenos="12 "></span><span class="nv">AIRFLOW_CTX_TRY_NUMBER</span><span class="o">=</span><span class="m">1</span>
<span class="linenos" data-linenos="13 "></span><span class="nv">AIRFLOW_CTX_DAG_RUN_ID</span><span class="o">=</span>manual__2023-04-30T07:51:18.119560+00:00
<span class="linenos" data-linenos="14 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,239<span class="o">]</span><span class="w"> </span><span class="o">{</span>subprocess.py:63<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Tmp<span class="w"> </span>dir<span class="w"> </span>root<span class="w"> </span>location:<span class="w"> </span>/tmp
<span class="linenos" data-linenos="15 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,239<span class="o">]</span><span class="w"> </span><span class="o">{</span>subprocess.py:75<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Running<span class="w"> </span>command:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/bin/bash&#39;</span>,<span class="w"> </span><span class="s1">&#39;-c&#39;</span>,<span class="w"> </span><span class="s1">&#39;echo &quot;Leyendo el csv...&quot;&#39;</span><span class="o">]</span>
<span class="linenos" data-linenos="16 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,263<span class="o">]</span><span class="w"> </span><span class="o">{</span>subprocess.py:86<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Output:
<span class="linenos" data-linenos="17 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,273<span class="o">]</span><span class="w"> </span><span class="o">{</span>subprocess.py:93<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Leyendo<span class="w"> </span>el<span class="w"> </span>csv...
<span class="linenos" data-linenos="18 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,274<span class="o">]</span><span class="w"> </span><span class="o">{</span>subprocess.py:97<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Command<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="k">return</span><span class="w"> </span>code<span class="w"> </span><span class="m">0</span>
<span class="linenos" data-linenos="19 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,330<span class="o">]</span><span class="w"> </span><span class="o">{</span>taskinstance.py:1327<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Marking<span class="w"> </span>task<span class="w"> </span>as<span class="w"> </span>SUCCESS.<span class="w"> </span><span class="nv">dag_id</span><span class="o">=</span>HolaAirflow-CSV,<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span>iniciando,<span class="w"> </span><span class="nv">execution_date</span><span class="o">=</span>20230430T075118,<span class="w"> </span><span class="nv">start_date</span><span class="o">=</span>,<span class="w"> </span><span class="nv">end_date</span><span class="o">=</span>20230430T075119
<span class="linenos" data-linenos="20 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,354<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3626<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>iniciando<span class="w"> </span>ran<span class="w"> </span>successfully!
<span class="linenos" data-linenos="21 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,358<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3618<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>*****************************************************
<span class="hll"><span class="linenos" data-linenos="22 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,358<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3622<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Running<span class="w"> </span>task<span class="w"> </span>csv2json
</span><span class="linenos" data-linenos="23 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,392<span class="o">]</span><span class="w"> </span><span class="o">{</span>taskinstance.py:1513<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Exporting<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>env<span class="w"> </span>vars:
<span class="linenos" data-linenos="24 "></span><span class="nv">AIRFLOW_CTX_DAG_OWNER</span><span class="o">=</span>aitor-medrano
<span class="linenos" data-linenos="25 "></span><span class="nv">AIRFLOW_CTX_DAG_ID</span><span class="o">=</span>HolaAirflow-CSV
<span class="linenos" data-linenos="26 "></span><span class="nv">AIRFLOW_CTX_TASK_ID</span><span class="o">=</span>csv2json
<span class="linenos" data-linenos="27 "></span><span class="nv">AIRFLOW_CTX_EXECUTION_DATE</span><span class="o">=</span><span class="m">2023</span>-04-30T07:51:18.119560+00:00
<span class="linenos" data-linenos="28 "></span><span class="nv">AIRFLOW_CTX_TRY_NUMBER</span><span class="o">=</span><span class="m">1</span>
<span class="linenos" data-linenos="29 "></span><span class="nv">AIRFLOW_CTX_DAG_RUN_ID</span><span class="o">=</span>manual__2023-04-30T07:51:18.119560+00:00
<span class="linenos" data-linenos="30 "></span>Amaro<span class="w"> </span>Gómez<span class="w"> </span>Berrocal
<span class="linenos" data-linenos="31 "></span>Consuelo<span class="w"> </span>Lerma<span class="w"> </span>Camino
<span class="linenos" data-linenos="32 "></span>...
<span class="linenos" data-linenos="33 "></span>Epifanio<span class="w"> </span>Vigil-Belmonte
<span class="linenos" data-linenos="34 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,546<span class="o">]</span><span class="w"> </span><span class="o">{</span>python.py:177<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Done.<span class="w"> </span>Returned<span class="w"> </span>value<span class="w"> </span>was:<span class="w"> </span>None
<span class="linenos" data-linenos="35 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,564<span class="o">]</span><span class="w"> </span><span class="o">{</span>taskinstance.py:1327<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Marking<span class="w"> </span>task<span class="w"> </span>as<span class="w"> </span>SUCCESS.<span class="w"> </span><span class="nv">dag_id</span><span class="o">=</span>HolaAirflow-CSV,<span class="w"> </span><span class="nv">task_id</span><span class="o">=</span>csv2json,<span class="w"> </span><span class="nv">execution_date</span><span class="o">=</span>20230430T075118,<span class="w"> </span><span class="nv">start_date</span><span class="o">=</span>,<span class="w"> </span><span class="nv">end_date</span><span class="o">=</span>20230430T075119
<span class="linenos" data-linenos="36 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,581<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3626<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>csv2json<span class="w"> </span>ran<span class="w"> </span>successfully!
<span class="linenos" data-linenos="37 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,581<span class="o">]</span><span class="w"> </span><span class="o">{</span>dag.py:3629<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>*****************************************************
<span class="linenos" data-linenos="38 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,586<span class="o">]</span><span class="w"> </span><span class="o">{</span>dagrun.py:606<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>Marking<span class="w"> </span>run<span class="w"> </span>&lt;DagRun<span class="w"> </span>HolaAirflow-CSV<span class="w"> </span>@<span class="w"> </span><span class="m">2023</span>-04-30T07:51:18.119560+00:00:<span class="w"> </span>manual__2023-04-30T07:51:18.119560+00:00,<span class="w"> </span>state:running,<span class="w"> </span>queued_at:<span class="w"> </span>None.<span class="w"> </span>externally<span class="w"> </span>triggered:<span class="w"> </span>False&gt;<span class="w"> </span>successful
<span class="linenos" data-linenos="39 "></span><span class="o">[</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19,595<span class="o">]</span><span class="w"> </span><span class="o">{</span>dagrun.py:672<span class="o">}</span><span class="w"> </span>INFO<span class="w"> </span>-<span class="w"> </span>DagRun<span class="w"> </span>Finished:<span class="w"> </span><span class="nv">dag_id</span><span class="o">=</span>HolaAirflow-CSV,<span class="w"> </span><span class="nv">execution_date</span><span class="o">=</span><span class="m">2023</span>-04-30T07:51:18.119560+00:00,<span class="w"> </span><span class="nv">run_id</span><span class="o">=</span>manual__2023-04-30T07:51:18.119560+00:00,<span class="w"> </span><span class="nv">run_start_date</span><span class="o">=</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:18.119560+00:00,<span class="w"> </span><span class="nv">run_end_date</span><span class="o">=</span><span class="m">2023</span>-04-30<span class="w"> </span><span class="m">07</span>:51:19.586563+00:00,<span class="w"> </span><span class="nv">run_duration</span><span class="o">=</span><span class="m">1</span>.467003,<span class="w"> </span><span class="nv">state</span><span class="o">=</span>success,<span class="w"> </span><span class="nv">external_trigger</span><span class="o">=</span>False,<span class="w"> </span><span class="nv">run_type</span><span class="o">=</span>manual,<span class="w"> </span><span class="nv">data_interval_start</span><span class="o">=</span><span class="m">2023</span>-04-30T07:51:18.119560+00:00,<span class="w"> </span><span class="nv">data_interval_end</span><span class="o">=</span><span class="m">2023</span>-04-30T07:56:18.119560+00:00,<span class="w"> </span><span class="nv">dag_hash</span><span class="o">=</span>None
</code></pre></div>
<p>Si en vez de probar, queremos lanzar un DAG, usaremos el comando <code>aiflow dags trigger</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>dags<span class="w"> </span>trigger<span class="w"> </span>HolaAirflow-CSV
</code></pre></div>
<h2 id="caso-2-de-mariadb-a-s3">Caso 2: De MariaDB a S3<a class="headerlink" href="#caso-2-de-mariadb-a-s3" title="Permanent link">&para;</a></h2>
<p>En este caso de uso, vamos a interactuar con una base de datos para recopilar datos y persistirlos en formato Parquet, para a continuar, subir dicho archivo a S3.</p>
<p>Así pues, lo primero que tenemos que dejar claro es que cada tarea debe ser atómica, de manera que si no se consigue acceder a la base de datos, no necesitamos conectar con S3. Además, las tareas siempre deben ser idempotentes, de manera que da igual la cantidad de veces que las ejecutemos, que el resultado siempre debe ser el mismo.</p>
<p>Así pues, vamos a crear una función que realice la lectura de los datos y otra que los persista en S3.</p>
<h3 id="conectando-con-la-bd">Conectando con la BD<a class="headerlink" href="#conectando-con-la-bd" title="Permanent link">&para;</a></h3>
<p>Así pues, empezamos con la función de lectura de datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">def</span> <span class="nf">consultaMariaDB</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="n">user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;adminadmin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;rdsiabd.cypxda1kh3tc.us-east-1.rds.amazonaws.com&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>        <span class="n">database</span><span class="o">=</span><span class="s2">&quot;retail_db&quot;</span>
<span class="linenos" data-linenos="11 "></span>    <span class="p">)</span>    
<span class="linenos" data-linenos="12 "></span>    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;select customer_fname, customer_lname, customer_zipcode from customers&quot;</span><span class="p">,</span><span class="n">conn</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="s1">&#39;/tmp/customers.parquet&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------Datos creados------&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Problemas con librerías</p>
<p>Si Airflow te da error, comprueba si la máquina virtual tiene instaladas las librerías para trabajar con MySQL:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip3<span class="w"> </span>install<span class="w"> </span>mysql-connector
<span class="linenos" data-linenos="2 "></span>pip3<span class="w"> </span>install<span class="w"> </span>mysql-connector-python
</code></pre></div>
</div>
<h3 id="persistiendo-en-s3">Persistiendo en S3<a class="headerlink" href="#persistiendo-en-s3" title="Permanent link">&para;</a></h3>
<div class="admonition info inline end">
<p class="admonition-title">Credenciales</p>
<p>Recuerda copiar las credencias de AWS Academy y copiarlas en <code>~/.aws/credentials</code>.</p>
</div>
<p>A continuación, creamos una función que mediante <em>boto3</em> transfiera el archivo recién creado a S3 (suponemos que ya tenemos creado el bucket con permisos para escribir en él):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">def</span> <span class="nf">envioS3</span><span class="p">():</span>
<span class="linenos" data-linenos="2 "></span>    <span class="n">s3r</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="3 "></span>
<span class="linenos" data-linenos="4 "></span>    <span class="n">nombreBucket</span> <span class="o">=</span> <span class="s2">&quot;iabd-s8a&quot;</span>
<span class="linenos" data-linenos="5 "></span>    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3r</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">nombreBucket</span><span class="p">,</span> <span class="s1">&#39;customers.parquet&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="6 "></span>    <span class="n">bucket</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s1">&#39;/tmp/customers.parquet&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="definiendo-el-dag">Definiendo el DAG<a class="headerlink" href="#definiendo-el-dag" title="Permanent link">&para;</a></h3>
<p>A continuación, ya podemos definir los parámetros por defecto y el propio DAG:</p>
<div class="highlight"><span class="filename">02db2s3.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="s1">&#39;aitor-medrano&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="s1">&#39;retries&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="s1">&#39;retry_delay&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="linenos" data-linenos=" 6 "></span><span class="p">}</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;dag-mariadb-s3&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>         <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>         <span class="n">schedule_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>      
<span class="linenos" data-linenos="11 "></span>        <span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">recuperaDatos</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;QueryMariaDB&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span>        <span class="n">python_callable</span><span class="o">=</span><span class="n">consultaMariaDB</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">persisteDatos</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;PersistDataS3&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span>        <span class="n">python_callable</span><span class="o">=</span><span class="n">envioS3</span><span class="p">)</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="n">recuperaDatos</span> <span class="o">&gt;&gt;</span> <span class="n">persisteDatos</span>
</code></pre></div>
<p>Tras copiar el DAG (nosotros lo hemos nombrado <a href="resources/airflow/02db2s3.py">02db2s3.py</a>) a la carpeta <code>$AIRFLOW_HOME/dags</code>, ya podemos probar su funcionamiento.</p>
<h2 id="caso-3-de-mariadb-a-s3-mejorado">Caso 3: De MariaDB a S3 mejorado<a class="headerlink" href="#caso-3-de-mariadb-a-s3-mejorado" title="Permanent link">&para;</a></h2>
<p>Vamos a repetir el mismo caso de uso, pero mejorando el código y añadiendo nueva funcionalidad.</p>
<h3 id="usando-proveedores">Usando proveedores<a class="headerlink" href="#usando-proveedores" title="Permanent link">&para;</a></h3>
<p><em>Apache Airflow</em> se puede extender mediante el uso de <a href="https://airflow.apache.org/docs/apache-airflow-providers/index.html">proveedores</a>, entendidos como paquetes adicionales que podemos instalar para ofrecer un servicio externo. Existen <a href="https://airflow.apache.org/docs/#providers-packages-docs-apache-airflow-providers-index-html">múltiples proveedores</a>, casi tanto como sistemas externos con los que podemos interactuar.</p>
<p>Así pues, vamos a utilizar un proveedor para que, en vez de dejar los datos de la conexión en el propio código, almacenemos las credenciales en una <em>Connection</em>, entendida como un conjunto de parámetros (usuario, contraseña, URL,...) a los que se le asocia un identificador.</p>
<p>Para ello, primero hemos instalar sus librerías como un proveedor de servicios, en nuestro caso, las de <em>MySQL</em> y <em>Amazon</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip3<span class="w"> </span>install<span class="w"> </span>apache-airflow-providers-mysql
<span class="linenos" data-linenos="2 "></span>pip3<span class="w"> </span>install<span class="w"> </span>apache-airflow-providers-amazon
</code></pre></div>
<p>A continuación, podemos crear la conexión desde <em>Admin ⇨ Connections</em>:</p>
<figure style="align: center">
    <img alt="Creando una conexión en Airflow" src="images/06airflow-mysql.png" width="600px">
    <figcaption>Creando una conexión en Airflow</figcaption>
</figure>

<p>O desde el terminal:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>airflow<span class="w"> </span>connections<span class="w"> </span>add<span class="w"> </span><span class="s1">&#39;mariaDBid&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span>--conn-uri<span class="w"> </span><span class="s1">&#39;mysql://admin:adminadmin@rdsiabd.cypxda1kh3tc.us-east-1.rds.amazonaws.com:3306/retail_db&#39;</span>
</code></pre></div>
<p>Para utilizar el proveedor, hemos de emplear un <a href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/hooks/index.html">Hook</a>, entendido como un interfaz de alto nivel que nos facilitar interactuar con el proveedor sin necesidad de conocer su propia API.</p>
<p>Para utilizar el <em>Hook</em>, lo haremos a través del identificador de conexión que acabamos de crear. Así pues, cambiamos la función <code>consultaMariaDB</code> para acceder a la conexión almacenada mediante <a href="https://airflow.apache.org/docs/apache-airflow/1.10.6/_api/airflow/hooks/mysql_hook/index.html"><code>MySqlHook</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">airflow.hooks.mysql_hook</span> <span class="kn">import</span> <span class="n">MySqlHook</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="k">def</span> <span class="nf">consultaMariaDBHook</span><span class="p">():</span>
<span class="hll"><span class="linenos" data-linenos="4 "></span>    <span class="n">mysql_hook</span> <span class="o">=</span> <span class="n">MySqlHook</span><span class="p">(</span><span class="n">mysql_conn_id</span><span class="o">=</span><span class="s1">&#39;MariaDBid&#39;</span><span class="p">)</span>
</span><span class="linenos" data-linenos="5 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql_hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>
<span class="linenos" data-linenos="6 "></span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;select customer_fname, customer_lname, customer_zipcode from customers, conn)</span>
<span class="linenos" data-linenos="7 "></span>    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="s1">&#39;customers.parquet&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="8 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------Datos creados------&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Y volvemos a hacer lo mismo con S3 y el <a href="https://airflow.apache.org/docs/apache-airflow/1.10.11/_api/airflow/hooks/S3_hook/index.html">S3Hook</a>. Primero creamos la conexión a AWS, teniendo en cuenta que el token de sesión lo hemos de poner en el campo <em>Extra</em> con la propiedad <code>{"aws_session_token":"&lt;token de sesión&gt;"}</code>:</p>
<figure style="align: center">
    <img alt="Creando una conexión en Airflow" src="images/06airflow-aws.png" width="600px">
    <figcaption>Creando una conexión en Airflow</figcaption>
</figure>

<p>Y a continuación la usamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">airflow.providers.amazon.aws.hooks.s3</span> <span class="kn">import</span> <span class="n">S3Hook</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">def</span> <span class="nf">envioS3Hook</span><span class="p">():</span>
<span class="hll"><span class="linenos" data-linenos=" 4 "></span>    <span class="n">s3_hook</span> <span class="o">=</span> <span class="n">S3Hook</span><span class="p">(</span><span class="n">aws_conn_id</span><span class="o">=</span><span class="s1">&#39;AWSid&#39;</span><span class="p">)</span>
</span><span class="linenos" data-linenos=" 5 "></span>    <span class="n">s3_hook</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;/tmp/customers.parquet&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="n">key</span><span class="o">=</span><span class="s1">&#39;customers.parquet&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="n">bucket_name</span><span class="o">=</span><span class="s1">&#39;iabd-s8a&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos" data-linenos="10 "></span>    <span class="p">)</span>
</code></pre></div>
<p>Como hemos renombrado las funciones, cambiamos el <em>callable</em> de cada operador:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;dag-mariadb-s3&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 2 "></span>         <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>         <span class="n">schedule_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>      
<span class="linenos" data-linenos=" 4 "></span>        <span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">recuperaDatos</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;QueryMariaDB&#39;</span><span class="p">,</span>
<span class="hll"><span class="linenos" data-linenos=" 7 "></span>        <span class="n">python_callable</span><span class="o">=</span><span class="n">consultaMariaDBHook</span><span class="p">)</span>
</span><span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">persisteDatos</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;PersistDataS3&#39;</span><span class="p">,</span>
<span class="hll"><span class="linenos" data-linenos="10 "></span>        <span class="n">python_callable</span><span class="o">=</span><span class="n">envioS3Hook</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="utilizando-variables">Utilizando variables<a class="headerlink" href="#utilizando-variables" title="Permanent link">&para;</a></h3>
<p>Cuando definimos las propiedades del DAG, podemos definir <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/variables.html">variables</a> a las cuales podemos acceder desde todos los operadores y evitar duplicar código.</p>
<p>Por ejemplo, en vez de indicar que los datos se persistan y carguen desde <code>/tmp/customers.parquet</code> podemos definir una variable y luego acceder a ella desde los operadores.</p>
<p>El primer paso es definir la variable en <em>Admin ⇨ Variables</em>:</p>
<figure style="align: center">
    <img alt="Creando una variable en Airflow" src="images/06airflow-variable.png" width="600px">
    <figcaption>Creando una variable en Airflow</figcaption>
</figure>

<p>A continuación, modificamos nuestro DAG para acceder a la variable utilizando <code>Variable.get()</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">airflow.models</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="k">def</span> <span class="nf">consultaMariaDBHookVar</span><span class="p">():</span>
<span class="linenos" data-linenos="4 "></span>    <span class="n">mysql_hook</span> <span class="o">=</span> <span class="n">MySqlHook</span><span class="p">(</span><span class="n">mysql_conn_id</span><span class="o">=</span><span class="s1">&#39;MySQLid&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql_hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>
<span class="linenos" data-linenos="6 "></span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;select customer_fname, customer_lname, customer_zipcode from customers&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="hll"><span class="linenos" data-linenos="7 "></span>    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">Variable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;customers_parquet_filename&quot;</span><span class="p">))</span>
</span><span class="linenos" data-linenos="8 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------Datos creados------&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="utilizando-parametros">Utilizando parámetros<a class="headerlink" href="#utilizando-parametros" title="Permanent link">&para;</a></h3>
<p>Si no queremos definir variable a nivel de Airflow, podemos definir <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/params.html">parámetros</a> a nivel de DAG. De esta manera, acotamos el alcance del valor.</p>
<p>Podemos definir parámetros tanto a nivel de DAG como de tarea mediante la propiedad <code>params</code> con un valor o como un diccionario, y posteriormente, podemos acceder mediante plantillas o través del contexto:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;dag-mariadb-s3-param&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 2 "></span>         <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>         <span class="n">schedule_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="hll"><span class="linenos" data-linenos=" 4 "></span>         <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;customers_parquet_filename_param&quot;</span><span class="p">:</span> <span class="s2">&quot;/tmp/customers.parquet&quot;</span><span class="p">},</span>      
</span><span class="linenos" data-linenos=" 5 "></span>        <span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">recuperaDatos</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;QueryMariaDB&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>         <span class="n">python_callable</span><span class="o">=</span><span class="n">consultaMariaDBHookParam</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="k">def</span> <span class="nf">consultaMariaDBHookParam</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">):</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">mysql_hook</span> <span class="o">=</span> <span class="n">MySqlHook</span><span class="p">(</span><span class="n">mysql_conn_id</span><span class="o">=</span><span class="s1">&#39;MySQLid&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql_hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;select customer_fname, customer_lname, customer_zipcode from customers&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="hll"><span class="linenos" data-linenos="14 "></span>    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;customers_parquet_filename_param&quot;</span><span class="p">])</span>
</span><span class="linenos" data-linenos="15 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------Datos creados------&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="uso-de-xcom">Uso de XCOM<a class="headerlink" href="#uso-de-xcom" title="Permanent link">&para;</a></h3>
<p>Vamos a suponer que la primera tarea define el nombre con el que almacenar el archivo en S3. Para ello, necesitamos que se pasen datos de una tarea a otra. Como ya habíamos comentado, hemos de emplear XCOM.</p>
<p>Para ello, necesitamos pasar una instancia de tareas (<em>task instance</em>) como parámetro a la función llamándola <code>ti</code> y luego utilizar <code>xcom_push</code> para guardar una clave/valor:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">def</span> <span class="nf">consultaMariaDBHookXCom</span><span class="p">(</span><span class="n">ti</span><span class="p">):</span>
<span class="linenos" data-linenos="2 "></span>    <span class="n">mysql_hook</span> <span class="o">=</span> <span class="n">MySqlHook</span><span class="p">(</span><span class="n">mysql_conn_id</span><span class="o">=</span><span class="s1">&#39;MySQLid&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="3 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql_hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>
<span class="linenos" data-linenos="4 "></span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;select customer_fname, customer_lname, customer_zipcode from customers&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span>    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/tmp/customers.parquet&#39;</span>
<span class="hll"><span class="linenos" data-linenos="6 "></span>    <span class="n">ti</span><span class="o">.</span><span class="n">xcom_push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
</span><span class="linenos" data-linenos="7 "></span>    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="linenos" data-linenos="8 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------Datos creados------&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Del mismo modo, en el segundo operador, volvemos a definir <code>ti</code> como parámetro de la función y recuperamos el valor mediante <code>xcom_pull</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">def</span> <span class="nf">envioS3HookXCom</span><span class="p">(</span><span class="n">ti</span><span class="p">):</span>
<span class="linenos" data-linenos="2 "></span>    <span class="n">s3_hook</span> <span class="o">=</span> <span class="n">S3Hook</span><span class="p">(</span><span class="n">aws_conn_id</span><span class="o">=</span><span class="s1">&#39;AWSid&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="3 "></span>    <span class="n">s3_hook</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
<span class="hll"><span class="linenos" data-linenos="4 "></span>        <span class="n">filename</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="n">task_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;QueryMariaDB&#39;</span><span class="p">]),</span>
</span><span class="linenos" data-linenos="5 "></span>        <span class="n">key</span><span class="o">=</span><span class="s1">&#39;customers.parquet&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="6 "></span>        <span class="n">bucket_name</span><span class="o">=</span><span class="s1">&#39;iabd-s8a&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="7 "></span>        <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos" data-linenos="8 "></span>    <span class="p">)</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Devolviendo valores</p>
<p>Si nuestras funciones de <em>Python</em> hacen un <code>return</code> de un valor, realmente está almacenándolo en un <em>XCom</em> cuya clave es <code>return_value</code>.</p>
</div>
<!--
### Limpiando los datos

Nos damos cuenta que los datos que recuperamos de la BD no están bien, y creamos una tarea...

bd >> [limpiarDatos,S3sucio]
limpiarDatos >> S3limpio
-->

<h3 id="todo-en-uno">Todo en uno<a class="headerlink" href="#todo-en-uno" title="Permanent link">&para;</a></h3>
<p>Ya existen proveedores que directamente transfieren información desde una fuente SQL y la almacenan en S3. </p>
<p>Por ejemplo, con el proveedor que ya hemos instalado previamente, podemos utilizar el operador <a href="https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/_api/airflow/providers/amazon/aws/transfers/sql_to_s3/index.html#airflow.providers.amazon.aws.transfers.sql_to_s3.FILE_FORMAT"><code>SqlToS3Operator</code></a> el cual nos ahorra mucho código:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">airflow.providers.amazon.aws.transfers.sql_to_s3</span> <span class="kn">import</span> <span class="n">SqlToS3Operator</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">sql2s3_task</span> <span class="o">=</span> <span class="n">SqlToS3Operator</span><span class="p">(</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="n">task_id</span><span class="o">=</span><span class="s2">&quot;sql_to_s3_task&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">sql_conn_id</span><span class="o">=</span><span class="s1">&#39;MariaDBid&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">aws_conn_id</span><span class="o">=</span><span class="s1">&#39;AWSid&#39;</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">query</span><span class="o">=</span><span class="s1">&#39;select customer_fname, customer_lname, customer_zipcode from customers&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">s3_bucket</span><span class="o">=</span><span class="s1">&#39;iabd-s8a&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">s3_key</span><span class="o">=</span><span class="s1">&#39;customers.parquet&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span><span class="p">)</span>
</code></pre></div>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://airflow.apache.org/docs/">Documentación oficial de Apache Airflow</a></li>
<li><a href="https://www.bizety.com/2023/01/02/data-pipeline-tools-airflow-beam-oozie-azkaban-and-luigi/">Data Pipeline Tools: Airflow, Beam, Oozie, Azkaban, and Luigi</a></li>
<li><a href="https://learning.oreilly.com/library/view/data-pipelines-with/9781617296901/">Data Pipelines with Apache Airflow</a>, de <em>Julian de Ruiter</em> y <em>Bas Harenslak</em></li>
<li>Webinar <a href="https://www.youtube.com/watch?v=GIztRAHc3as">Introduction to Apache Airflow</a></li>
</ul>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<ol>
<li>(<abbr title="Gestiona sistemas de almacenamiento y el amplio ecosistema alrededor de ellos facilitando el procesamiento de grandes cantidades de datos sin fallos y de forma rápida.">RA5075.2</abbr> / <abbr title="Se ha probado la tolerancia a fallos de los sistemas.">CE5.2c</abbr> / 1p) Realiza el caso de uso 1 y prueba el DAG tanto a nivel de interfaz web como mediante el CLI, y copia el código fuente y añade comentarios al código.</li>
</ol>
<p>Si quieres probar, en vez de realizar los ejecicios guiados 2 y 3, puedes realizar la actividad 4 que conlleva más investigación:</p>
<ol start="2">
<li>(<abbr title="Realiza el seguimiento de la monitorización de un sistema, asegurando la fiabilidad y estabilidad de los servicios que se proveen">RA5075.4</abbr> / <abbr title="Se han aplicado herramientas de monitorización eficiente de los recursos.">CE5.4a</abbr> y <abbr title="Se ha comprobado que las herramientas usadas ofrecen un rendimiento elevado con rapidez.">CE5.4d</abbr> / 0.5p) Realiza el caso de uso 2, añadiendo comentarios al código y ejecútalo únicamente desde el interfaz web.</li>
<li>(<abbr title="Realiza el seguimiento de la monitorización de un sistema, asegurando la fiabilidad y estabilidad de los servicios que se proveen">RA5075.4</abbr> / <abbr title="Se han aplicado herramientas de monitorización eficiente de los recursos.">CE5.4a</abbr> y <abbr title="Se ha comprobado la fiabilidad de los datos según respuestas.">CE5.4e</abbr> / 1.5p) Realiza el caso de uso 3, añadiendo comentarios al código y ejecútalo desde el CLI y comprueba su estado desde el interfaz web.</li>
<li>(<abbr title="Realiza el seguimiento de la monitorización de un sistema, asegurando la fiabilidad y estabilidad de los servicios que se proveen">RA5075.4</abbr> / <abbr title="Se han aplicado herramientas de monitorización eficiente de los recursos.">CE5.4a</abbr>, <abbr title="Se ha comprobado que las herramientas usadas ofrecen un rendimiento elevado con rapidez.">CE5.4d</abbr> y <abbr title="Se ha comprobado la fiabilidad de los datos según respuestas.">CE5.4e</abbr> / 2p) Realiza el <a href="05nifi2.html#caso-7-de-aemet-a-mongodb-y-s3">caso de uso 7 de la sesión de <em>Nifi</em></a> donde leemos datos de AEMET y terminamos guardando los datos en S3.</li>
</ol>
<p>Para la siguiente actividad, copia el siguiente fragmento de código.</p>
<ol start="5">
<li>
<p>(<abbr title="Aplica técnicas de análisis de datos que integran, procesan y analizan la información, adaptando e implementando sistemas que las utilicen.">RA5074.1</abbr> / <abbr title="Se han establecido objetivos y prioridades, secuenciación y organización del tiempo de realización.">CE4.1e</abbr> / 1p) Explica que realiza el siguiente DAG y añade comentarios explicando qué hace cada fragmento, destacando para qué utiliza XCom:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">airflow.operators.bash</span> <span class="kn">import</span> <span class="n">BashOperator</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">uniform</span>
<span class="linenos" data-linenos=" 6 "></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span><span class="p">}</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">def</span> <span class="nf">_training_model</span><span class="p">(</span><span class="n">ti</span><span class="p">):</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model</span><span class="se">\&#39;</span><span class="s1">s accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">ti</span><span class="o">.</span><span class="n">xcom_push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;model_accuracy&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span><span class="k">def</span> <span class="nf">_choose_best_model</span><span class="p">(</span><span class="n">ti</span><span class="p">):</span>
<span class="linenos" data-linenos="18 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;choose best model&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="19 "></span>    <span class="n">accuracies</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;model_accuracy&#39;</span><span class="p">,</span> <span class="n">task_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;training_model_A&#39;</span><span class="p">,</span> <span class="s1">&#39;training_model_B&#39;</span><span class="p">,</span> <span class="s1">&#39;training_model_C&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="20 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">accuracies</span><span class="p">)</span>
<span class="linenos" data-linenos="21 "></span>
<span class="linenos" data-linenos="22 "></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">&#39;xcom_dag&#39;</span><span class="p">,</span> <span class="n">schedule_interval</span><span class="o">=</span><span class="s1">&#39;@daily&#39;</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span> <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
<span class="linenos" data-linenos="23 "></span>    <span class="n">downloading_data</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="24 "></span>        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;downloading_data&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="25 "></span>        <span class="n">bash_command</span><span class="o">=</span><span class="s1">&#39;sleep 3&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="26 "></span>        <span class="n">do_xcom_push</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos" data-linenos="27 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="28 "></span>
<span class="linenos" data-linenos="29 "></span>    <span class="n">training_model_task</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="30 "></span>        <span class="n">PythonOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="31 "></span>            <span class="n">task_id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;training_model_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="32 "></span>            <span class="n">python_callable</span><span class="o">=</span><span class="n">_training_model</span>
<span class="linenos" data-linenos="33 "></span>        <span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]]</span>
<span class="linenos" data-linenos="34 "></span>
<span class="linenos" data-linenos="35 "></span>    <span class="n">choose_model</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
<span class="linenos" data-linenos="36 "></span>        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;choose_model&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="37 "></span>        <span class="n">python_callable</span><span class="o">=</span><span class="n">_choose_best_model</span>
<span class="linenos" data-linenos="38 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="39 "></span>
<span class="linenos" data-linenos="40 "></span>    <span class="n">downloading_data</span> <span class="o">&gt;&gt;</span> <span class="n">training_model_task</span> <span class="o">&gt;&gt;</span> <span class="n">choose_model</span>
</code></pre></div>
</li>
</ol>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        <a href='https://ko-fi.com/T6T8GWT9N' title='Invítame a un café en ko-fi.com' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi2.png?v=3' border='0' alt='Invítame a un café en ko-fi.com' /></a>
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Me encantan estos apuntes" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="Los apuntes son mejorables" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Gracias por tu tiempo. Si quieres me puedes <a href='https://ko-fi.com/T6T8GWT9N'>invitar a un café en ko-fi</a>.
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              ¡Gracias por tu colaboración! Ayúdame a mejorar los apuntes enviándome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Pie" >
        
          
          <a href="03kafka.html" class="md-footer__link md-footer__link--prev" aria-label="Anterior: Kafka II" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Anterior
              </span>
              <div class="md-ellipsis">
                Kafka II
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.footer", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow", "content.code.copy"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>