
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Apuntes sobre Spark Streaming, estudiando el join entre DataFrames batch y streaming, así como el uso de ventanas de tamaño fijo (tumbling) o deslizante (sliding) y marcas de aguas (watermarking).">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/spark/03join-window.html">
      
      
        <link rel="prev" href="03streaming.html">
      
      
        <link rel="next" href="../dataflow/index.html">
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.3">
    
    
      
        <title>Spark Streaming Avanzado - IABD</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.c4a75a56.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Spark Streaming Avanzado - IABD" >
      
        <meta  property="og:description"  content="Apuntes sobre Spark Streaming, estudiando el join entre DataFrames batch y streaming, así como el uso de ventanas de tamaño fijo (tumbling) o deslizante (sliding) y marcas de aguas (watermarking)." >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/spark/03join-window.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/spark/03join-window.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Spark Streaming Avanzado - IABD" >
      
        <meta  name="twitter:description"  content="Apuntes sobre Spark Streaming, estudiando el join entre DataFrames batch y streaming, así como el uso de ventanas de tamaño fijo (tumbling) o deslizante (sliding) y marcas de aguas (watermarking)." >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/spark/03join-window.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spark-streaming-ii" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="IABD" class="md-header__button md-logo" aria-label="IABD" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IABD
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spark Streaming Avanzado
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo día"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Cambiar a modo día" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="IABD" class="md-nav__button md-logo" aria-label="IABD" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    IABD
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../sa/index.html">Sistemas de almacenamiento</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/01nosql.html" class="md-nav__link">
        Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/02mongo.html" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/03modelado.html" class="md-nav__link">
        Modelado de datos NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/05agregaciones.html" class="md-nav__link">
        Agregaciones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/06replicacion.html" class="md-nav__link">
        Replicación y Particionado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/07pymongo.html" class="md-nav__link">
        MongoDB y Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../hadoop/index.html">Ecosistema Hadoop</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ecosistema Hadoop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/01arq.html" class="md-nav__link">
        Arquitecturas Big Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/02etl.html" class="md-nav__link">
        Ingesta de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/03hadoop.html" class="md-nav__link">
        Hadoop
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04hdfs.html" class="md-nav__link">
        HDFS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04formatos.html" class="md-nav__link">
        Formatos de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/05flume.html" class="md-nav__link">
        Sqoop y Flume
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/06hive.html" class="md-nav__link">
        Hive
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../cloud/index.html">Datos en el cloud</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Datos en el cloud
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/01cloud.html" class="md-nav__link">
        Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/02aws.html" class="md-nav__link">
        AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/03s3.html" class="md-nav__link">
        S3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/04computacion.html" class="md-nav__link">
        EC2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/05emr.html" class="md-nav__link">
        EMR
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/06datos.html" class="md-nav__link">
        RDS y DynamoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/07athena.html" class="md-nav__link">
        Athena
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">Spark</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Spark
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01spark.html" class="md-nav__link">
        Ecosistema
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01rdd.html" class="md-nav__link">
        RDD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02dataframeAPI.html" class="md-nav__link">
        DataFrames API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02agregaciones.html" class="md-nav__link">
        Agregaciones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02catalog.html" class="md-nav__link">
        Spark JDBC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="03streaming.html" class="md-nav__link">
        Streaming I
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Streaming II
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="03join-window.html" class="md-nav__link md-nav__link--active">
        Streaming II
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#windowing" class="md-nav__link">
    Windowing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-5-trabajando-con-ventanas" class="md-nav__link">
    Caso 5: Trabajando con ventanas
  </a>
  
    <nav class="md-nav" aria-label="Caso 5: Trabajando con ventanas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ventanas-deslizantes" class="md-nav__link">
    Ventanas deslizantes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-6-bolsa-i" class="md-nav__link">
    Caso 6: Bolsa I
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#watermarking" class="md-nav__link">
    Watermarking
  </a>
  
    <nav class="md-nav" aria-label="Watermarking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modo-update" class="md-nav__link">
    Modo update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modo-append" class="md-nav__link">
    Modo append
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-7-bolsa-ii" class="md-nav__link">
    Caso 7: Bolsa II
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datos-duplicados" class="md-nav__link">
    Datos duplicados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#joins-en-streaming" class="md-nav__link">
    Joins en streaming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-8-join-entre-kafka-y-mariadb" class="md-nav__link">
    Caso 8: Join entre Kafka y MariaDB
  </a>
  
    <nav class="md-nav" aria-label="Caso 8: Join entre Kafka y MariaDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lectura-en-streaming" class="md-nav__link">
    Lectura en streaming
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lectura-estatica" class="md-nav__link">
    Lectura estática
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#join" class="md-nav__link">
    Join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistencia-en-base-de-datos" class="md-nav__link">
    Persistencia en base de datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../dataflow/index.html">Flujo de datos</a>
          
            <label for="__nav_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Flujo de datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataflow/04nifi1.html" class="md-nav__link">
        Nifi I
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataflow/05nifi2.html" class="md-nav__link">
        Nifi II
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataflow/02kafka.html" class="md-nav__link">
        Kafka I
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataflow/03kafka.html" class="md-nav__link">
        Kafka II
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        PIA FP
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#windowing" class="md-nav__link">
    Windowing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-5-trabajando-con-ventanas" class="md-nav__link">
    Caso 5: Trabajando con ventanas
  </a>
  
    <nav class="md-nav" aria-label="Caso 5: Trabajando con ventanas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ventanas-deslizantes" class="md-nav__link">
    Ventanas deslizantes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-6-bolsa-i" class="md-nav__link">
    Caso 6: Bolsa I
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#watermarking" class="md-nav__link">
    Watermarking
  </a>
  
    <nav class="md-nav" aria-label="Watermarking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modo-update" class="md-nav__link">
    Modo update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modo-append" class="md-nav__link">
    Modo append
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-7-bolsa-ii" class="md-nav__link">
    Caso 7: Bolsa II
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datos-duplicados" class="md-nav__link">
    Datos duplicados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#joins-en-streaming" class="md-nav__link">
    Joins en streaming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-8-join-entre-kafka-y-mariadb" class="md-nav__link">
    Caso 8: Join entre Kafka y MariaDB
  </a>
  
    <nav class="md-nav" aria-label="Caso 8: Join entre Kafka y MariaDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lectura-en-streaming" class="md-nav__link">
    Lectura en streaming
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lectura-estatica" class="md-nav__link">
    Lectura estática
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#join" class="md-nav__link">
    Join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistencia-en-base-de-datos" class="md-nav__link">
    Persistencia en base de datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="spark-streaming-ii">Spark Streaming II<a class="headerlink" href="#spark-streaming-ii" title="Permanent link">&para;</a></h1>
<h2 id="windowing"><em>Windowing</em><a class="headerlink" href="#windowing" title="Permanent link">&para;</a></h2>
<p>Al realizar agregaciones basadas en el tiempo, es importante aclarar el concepto de ventana temporal (<em>windowing</em>). Una ventana temporal puede durar una semana, una hora, un minuto o incluso un segundo.</p>
<p>Estas ventanas permiten acotar los datos sobre un flujo que en principio no tiene un inicio ni un fin predefinidos.</p>
<p>Existen diferentes tipos de ventanas temporales:</p>
<ul>
<li>de tamaño fijo (<em>fixed/tumbling window</em>): divide los flujos de datos en segmentos fijos, con un tamaño de ventana, un tiempo de inicio y uno de finalización. En este tipo, cada dato se asigna a una única ventana, de manera que es fácil realizar agregaciones como la suma, el máximo o la media.</li>
<li>deslizantes (<em>sliding</em>): cada ventana tiene una longitud y un intervalo de deslizamiento. Si el intervalo tiene el mismo tamaño que la ventana, actúa igual que una ventana de tamaño fijo. En la imagen podemos ver un intervalo de deslizamiento más pequeño que el tamaño de la ventana, lo que implica que un dato puede llegar a más de una ventana. Como las ventana deslizantes se solapan, la agregaciones de datos producen resultados más precisos que con ventanas de tamaño fijo.</li>
<li>de sesión (<em>session</em>): se utiliza para analizar el comportamiento de usuario de un sitio web. No tienen un tamaño definido, sino que se define por la duración de la navegación del usuario.</li>
</ul>
<figure style="align: center;">
    <img src="images/03streaming-windowing.jpg">
    <figcaption>Tipos de ventanas temporales</figcaption>
</figure>

<h2 id="caso-5-trabajando-con-ventanas">Caso 5: Trabajando con ventanas<a class="headerlink" href="#caso-5-trabajando-con-ventanas" title="Permanent link">&para;</a></h2>
<p>Vamos a basarnos en el caso 1, donde leíamos datos desde un <em>socket</em> y contábamos las apariciones de las palabras.</p>
<p>Antes de nada, en un terminal, vamos a lanzar el servidor de <em>sockets</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>nc<span class="w"> </span>-lk<span class="w"> </span><span class="m">9999</span>
</code></pre></div>
<p>Volvemos a nuestro cuaderno de Jupyter, y del código del caso 1 vamos a modificar algunos aspectos para agrupar los datos recibidos en una ventana fija de dos minutos. Al leer los datos, indicaremos que queremos obtener el <em>timestamp</em> de cada dato:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Streaming Window IABD WordCount&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">dfLineas</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="10 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="11 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="12 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;9999&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="13 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;includeTimestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span>\
<span class="linenos" data-linenos="14 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
<p>Si obtenemos el esquema de los datos que leemos, ahora tendremos el campo <code>value</code> con el texto leído, y el campo <code>timestamp</code> con la marca de tiempo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">dfLineas</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="2 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="3 "></span><span class="c1">#  |-- value: string (nullable = true)</span>
<span class="linenos" data-linenos="4 "></span><span class="c1">#  |-- timestamp: timestamp (nullable = true)</span>
</code></pre></div>
<p>Al prepara el <em>DataFrame</em> con las palabras, vamos a incluir también el <em>timestamp</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">explode</span><span class="p">,</span> <span class="n">split</span>
<span class="linenos" data-linenos="2 "></span><span class="n">dfPalabras</span> <span class="o">=</span> <span class="n">dfLineas</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<span class="linenos" data-linenos="3 "></span>    <span class="n">explode</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">dfLineas</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;palabra&#39;</span><span class="p">),</span>
<span class="hll"><span class="linenos" data-linenos="4 "></span>    <span class="n">dfLineas</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span></code></pre></div>
<p>Y ahora es cuando trabajamos con las ventanas. Para ello, haremos uso de la función <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.window.html"><code>window</code></a> para agrupar las palabras con una ventana fija de 2 minutos, agrupando tanto la ventana temporal fija como cada palabra, para obtener su cantidad como dato agregado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowedCounts</span> <span class="o">=</span> <span class="n">dfPalabras</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>
<span class="hll"><span class="linenos" data-linenos="3 "></span>    <span class="n">window</span><span class="p">(</span><span class="n">dfPalabras</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;2 minutes&quot;</span><span class="p">),</span> <span class="n">dfPalabras</span><span class="o">.</span><span class="n">palabra</span>
</span><span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Finalmente, realizamos la consulta (vamos a indicar que no trunque los datos para poder visualizar toda la información de la ventana):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">palabrasQuery</span> <span class="o">=</span> <span class="n">windowedCounts</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;truncate&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>\
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>Introducimos la siguientes frases:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>Hola Mundo
<span class="linenos" data-linenos="2 "></span>Hola desde el Severo
</code></pre></div>
<p>Y obtenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">1</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos="12 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">2</span>
<span class="linenos" data-linenos="13 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos="14 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="19 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="20 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="21 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="22 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Para cada palabra introducida dentro de la misma ventana temporal (en nuestro caso la hemos definido de 2 minutos, nos cuenta sus ocurrencias).</p>
<p>Si nos esperamos un par de minutos y enviamos <code>Severo Ochoa y el Mundo</code>, obtenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">3</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">y</span>      <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="18 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Podemos observar como las palabras de esta última frase han entrado en una ventana diferente, y por tanto, al agruparse se cuentan desde 0.</p>
<h3 id="ventanas-deslizantes">Ventanas deslizantes<a class="headerlink" href="#ventanas-deslizantes" title="Permanent link">&para;</a></h3>
<p>Ya hemos visto como funcionan las ventanas fijas. Con las ventanas deslizantes, vamos a poder recoger datos en más de una ventana a la vez:</p>
<figure style="align: center;">
    <img src="images/03streaming-slideWindow.jpg">
    <figcaption>Ventana deslizante</figcaption>
</figure>

<p>Centrándonos en el mismo ejemplo, únicamente vamos a modificar el fragmento de código donde agrupamos los datos, para que manteniendo una ventana de 2 minutos, ahora tenga un deslizamiento de un minuto:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowedCounts</span> <span class="o">=</span> <span class="n">words_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>
<span class="hll"><span class="linenos" data-linenos="3 "></span>    <span class="n">window</span><span class="p">(</span><span class="n">words_df</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;2 minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;1 minute&quot;</span><span class="p">),</span> <span class="n">words_df</span><span class="o">.</span><span class="n">palabra</span>
</span><span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Al introducir <code>Hola Mundo</code>, ha duplicado los datos recibidos para darles cabida en las dos ventanas que van a cubrir cada instante temporal (realmente, la primera ventana no comienza en el minuto actual, es al revés, termina en el minuto posterior al actual):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">1</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>En el mismo instante, introducimos <code>Severo Ochoa</code>, lo que provoca que vuelta a realizar el mismo proceso, introduciendo ambas palabras en las dos ventanas existentes:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">2</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="hll"><span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Dentro de la misma ventana introducimos <code>Hola Mundo desde el Severo Ochoa</code>, obteniendo el tercer <em>micro-batch</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">3</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="19 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Finalmente, nos esperamos un poco para provocar entrar en otra ventana e introducimos <code>Segunda ventana</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">4</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="19 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="20 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="21 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="22 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="23 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Finalmente, introducimos <code>Segunda ventana Ochoa</code> para comprobar como rellena las dos últimas ventanas:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">5</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">3</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="19 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="20 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="21 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="22 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="23 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="24 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Autoevaluación</p>
<p>Si definimos una ventana temporal de tres minutos de duración, con un deslizamiento de un minuto, y lanzamos el primer mensaje a las 11:45:50, ¿cuantas ventanas se crearán y cuales serán sus rangos temporales? <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
</div>
<h2 id="caso-6-bolsa-i">Caso 6: Bolsa I<a class="headerlink" href="#caso-6-bolsa-i" title="Permanent link">&para;</a></h2>
<p>Para este caso de uso, vamos a suponer que recibimos un <a href="resources/entrada/bolsa1.json">fichero con eventos</a> sobre valores de un mercado financiero con el siguiente formato:</p>
<div class="highlight"><span class="filename">bolsa1.json</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:05:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:12:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:20:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">800</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:40:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">900</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="5 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:25:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="6 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:48:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="7 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:50:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Nuestro departamento de visualización nos pide que transformemos los datos recibidos para crear la siguiente estructura:</p>
<table>
<thead>
<tr>
<th>TInicio</th>
<th>TFin</th>
<th>Compras</th>
<th>Ventas</th>
<th>Neto</th>
</tr>
</thead>
<tbody>
<tr>
<td>9:00</td>
<td>9:15</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>9:15</td>
<td>9:30</td>
<td>1000</td>
<td>300</td>
<td>700</td>
</tr>
<tr>
<td>9:30</td>
<td>9:45</td>
<td>1500</td>
<td>700</td>
<td>800</td>
</tr>
<tr>
<td>9:45</td>
<td>10:00</td>
<td>1600</td>
<td>900</td>
<td>700</td>
</tr>
</tbody>
</table>
<p>Así pues, necesitamos agrupar los datos con una ventana fija de 15 minutos, e ir acumulando las cantidades (<code>Amount</code>), dependiendo de que el tipo (<code>Type</code>) sea una compra (<code>BUY</code>) o una venta (<code>SELL</code>) para luego calcular su valor neto como la diferencia de estos dos últimos.</p>
<p>Nuestro primer paso, será crear la conexión a <em>Spark</em> y la lectura de la carpeta donde irán llegando los ficheros de datos (recuerda crear la carpeta <code>entrada</code> antes de ejecutar la lectura):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Bolsa Streaming IABD&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 8 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># Definimos el esquema de los datos de entrada</span>
<span class="linenos" data-linenos="11 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span>
<span class="linenos" data-linenos="12 "></span><span class="n">bolsaSchema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;Amount&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;BrokerCode&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="linenos" data-linenos="17 "></span><span class="p">])</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="c1"># Configuramos la lectura de fichero en formato JSON</span>
<span class="linenos" data-linenos="20 "></span><span class="n">rawDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="21 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="22 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;entrada&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="23 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;maxFilesPerTrigger&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
<span class="linenos" data-linenos="24 "></span>        <span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">bolsaSchema</span><span class="p">)</span> \
<span class="linenos" data-linenos="25 "></span>        <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos="26 "></span>
<span class="linenos" data-linenos="27 "></span><span class="n">rawDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="28 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="29 "></span><span class="c1">#  |-- CreatedTime: string (nullable = true)</span>
<span class="linenos" data-linenos="30 "></span><span class="c1">#  |-- Type: string (nullable = true)</span>
<span class="linenos" data-linenos="31 "></span><span class="c1">#  |-- Amount: integer (nullable = true)</span>
<span class="linenos" data-linenos="32 "></span><span class="c1">#  |-- BrokerCode: string (nullable = true)</span>
</code></pre></div>
<p>El siguiente paso, es crear las columnas con la fecha en formato <em>timestamp</em> y las nuevas columnas <code>Compras</code> y <code>Ventas</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">to_timestamp</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">accionesDF</span> <span class="o">=</span> <span class="n">rawDF</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">),</span> <span class="s2">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;case when Type == &#39;BUY&#39; then Amount else 0 end&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;case when Type == &#39;SELL&#39; then Amount else 0 end&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">accionesDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">#  |-- CreatedTime: timestamp (nullable = true)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">#  |-- Type: string (nullable = true)</span>
<span class="linenos" data-linenos="10 "></span><span class="c1">#  |-- Amount: integer (nullable = true)</span>
<span class="linenos" data-linenos="11 "></span><span class="c1">#  |-- BrokerCode: string (nullable = true)</span>
<span class="linenos" data-linenos="12 "></span><span class="c1">#  |-- Compras: integer (nullable = true)</span>
<span class="linenos" data-linenos="13 "></span><span class="c1">#  |-- Ventas: integer (nullable = true)</span>
</code></pre></div>
<p>Si queremos ver el resultado e intentamos realizar <code>accionesDF.show()</code>, nos dará un error al no haber realizado un <em>start</em> del streaming. Para probarlo como si fuera un proceso batch sólo tenemos que cambiar el método <code>readStream</code> de la lectura por <code>read</code> y ya funcionará:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">rawDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
<span class="linenos" data-linenos=" 2 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">...</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">accionesDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># +-------------------+----+------+----------+-------+------+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># |        CreatedTime|Type|Amount|BrokerCode|Compras|Ventas|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># +-------------------+----+------+----------+-------+------+</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># |2022-05-09 10:05:00| BUY|   500|       AME|    500|     0|</span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># |2022-05-09 10:12:00| BUY|   300|       AME|    300|     0|</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># |2022-05-09 10:20:00| BUY|   800|       AME|    800|     0|</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># |2022-05-09 10:40:00| BUY|   900|       AME|    900|     0|</span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># |2022-05-09 10:25:00|SELL|   400|       AME|      0|   400|</span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># |2022-05-09 10:48:00|SELL|   600|       AME|      0|   600|</span>
<span class="linenos" data-linenos="15 "></span><span class="c1"># |2022-05-09 10:50:00|SELL|   100|       AME|      0|   100|</span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># +-------------------+----+------+----------+-------+------+</span>
</code></pre></div>
<p>Una vez hemos comprobado que tenemos preparados los datos con el formato y contenido adecuados, vamos a agruparlos con una ventana de 15 minutos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">windowDF</span> <span class="o">=</span> <span class="n">accionesDF</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>  <span class="c1"># col(&quot;BrokerCode&quot;),</span>
<span class="linenos" data-linenos=" 4 "></span>         <span class="n">window</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">),</span> <span class="s2">&quot;15 minutes&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 6 "></span>         <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">salidaDF</span> <span class="o">=</span> <span class="n">windowDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;window.start&quot;</span><span class="p">,</span> <span class="s2">&quot;window.end&quot;</span><span class="p">,</span> <span class="s2">&quot;Compras&quot;</span><span class="p">,</span> <span class="s2">&quot;Ventas&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="n">bolsaWriterQuery</span> <span class="o">=</span> <span class="n">salidaDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="11 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="12 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="13 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="n">bolsaWriterQuery</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Y tras volver a poner <code>readStream</code> y arrancarlo, obtenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">+-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos="2 "></span><span class="o">|</span>              <span class="n">start</span><span class="o">|</span>                <span class="n">end</span><span class="o">|</span><span class="n">Compras</span><span class="o">|</span><span class="n">Ventas</span><span class="o">|</span>
<span class="linenos" data-linenos="3 "></span><span class="o">+-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos="4 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>    <span class="mi">800</span><span class="o">|</span>     <span class="mi">0</span><span class="o">|</span>
<span class="linenos" data-linenos="5 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>    <span class="mi">800</span><span class="o">|</span>   <span class="mi">400</span><span class="o">|</span>
<span class="linenos" data-linenos="6 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>    <span class="mi">900</span><span class="o">|</span>     <span class="mi">0</span><span class="o">|</span>
<span class="linenos" data-linenos="7 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>      <span class="mi">0</span><span class="o">|</span>   <span class="mi">700</span><span class="o">|</span>
<span class="linenos" data-linenos="8 "></span><span class="o">+-------------------+-------------------+-------+------+</span>
</code></pre></div>
<p>Estos datos se parecen a la información que queríamos, pero únicamente esta sumando los datos de cada ventana, sin acumularlos con todos los datos anteriores. A día de hoy, la única forma de sumar todos los datos agregados es utilizar las <a href="../hadoop/06hive.html#consultas-de-agregación">funciones ventana</a> (similares a las que vimos al trabajar con <em>Hive</em>) dentro de un proceso <em>batch</em>.</p>
<p>Así pues, vamos a almacenar los datos en un fichero en formato Parquet, para que luego desde un proceso Batch realizar los cálculos que nos faltan. Pero antes necesitamos introducir el concepto de marca de agua.</p>
<h2 id="watermarking">Watermarking<a class="headerlink" href="#watermarking" title="Permanent link">&para;</a></h2>
<p>Cuando los datos llegan tarde a nuestro sistema (se generan en la ventana N, pero llegan a <em>Spark</em> en la ventana N+M), <em>Spark</em> gestiona todas las ventanas y actualiza los cálculos. Estos cálculos, como hemos comentado, son el estado de las transformaciones y se almacenan en los diferentes ejecutores del clúster de <em>Spark</em>.</p>
<p>¿Qué sucede con un dato que se genera a las 12:04 pero llega a <em>Spark</em> a las 12:11, si nuestras ventanas tienen un tamaño de 10 minutos con un deslizamiento de 5 minutos? Al mantener el estado, <em>Spark</em> puede modificar la ventana de las 12:00 a las 12:10 y actualizar los cálculos:</p>
<figure style="align: center;">
    <img src="images/03streaming-latedata.png">
    <figcaption>Gestión de datos tardíos</figcaption>
</figure>

<p>El problema es que estos cálculos se almacenan para todos los datos, con lo cual el estado crece ininterrumpidamente. Para definir que las ventanas expiren, necesitamos conocer el concepto de <strong>marca de agua</strong> (<em>watermark</em>), el cual va a permitir indicar el tiempo que el sistema debe esperar a datos que llegan tarde, de manera que si exceden la marca de agua, los datos se desechan. Al definir las marcas de agua, <em>Spark Streaming</em> realiza un seguimiento de los tiempos de los eventos de los datos e intenta limpiar los datos caducados de los ejecutores.</p>
<p>La decisión de la definición de la marca de agua pertenece a negocio, y debe responder a:</p>
<ul>
<li>¿Cuál es el máximo retraso posible/aceptable?</li>
<li>¿Cuándo dejan los datos de ser relevantes?</li>
</ul>
<p>Una vez tenemos claro el rango temporal en el que los datos son aceptables, los definimos antes de agrupar y utilizando las mismas columnas de agrupación (en nuestro caso, por la columna <code>timestamp</code>) mediante el método <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.withWatermark.html">withWatermark</a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowedCounts</span> <span class="o">=</span> <span class="n">dfPalabras</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="n">dfPalabras</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;30 minutes&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>
<span class="linenos" data-linenos="5 "></span>        <span class="n">window</span><span class="p">(</span><span class="n">dfPalabras</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;2 minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;1 minute&quot;</span><span class="p">),</span> <span class="n">dfPalabras</span><span class="o">.</span><span class="n">palabra</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">)</span>
</code></pre></div>
<p>De esta manera, si llega una palabra con un retraso de más de 30 minutos, se desechará. Además, el estado de la ventana se limpiará cuando pasen esos 30 minutos, de manera que su tamaño siempre estará limitado por el <em>timestamp</em> de los datos recibidos en los última media hora.</p>
<p>Si utilizamos marcas de agua para limitar el estado de la ventana, es importante tener en cuenta que si el modo de salida es completo, no se limpiará el estado, es decir, es como si no utilizásemos marcas de agua.</p>
<h3 id="modo-update">Modo <em>update</em><a class="headerlink" href="#modo-update" title="Permanent link">&para;</a></h3>
<p>En cambio, mediante el modo <em>update</em> sí que se limpia la ventana de estado, realizando operaciones de tipo <em>upsert</em>, por ejemplo con un <em>sink</em> que sí soporte las modificaciones, como cualquiera base de datos. Aunque hay que tener cuidado si nuestro <em>sink</em> es de tipo fichero, ya que no puede modificar los ficheros JSON/Parquet y creará archivos duplicados.</p>
<p>Veamos un ejemplo donde definimos una marca de agua de 10 minutos sobre una ventana también de 10 minutos sobre la columna <em>timestamp</em> con <em>triggers</em> cada 5 minutos:</p>
<figure style="align: center;">
    <img src="images/03streaming-watermark-update-mode.png">
    <figcaption>Marca de agua - modo update</figcaption>
</figure>

<p>La línea punteada en azul representa el mayor evento leído, el cual va a definir la marca de agua (tiempo del mayor evento menos 10 minutos)</p>
<p>Cuando llega el dato <em>dog</em> de las 12:14, fija la marca de agua a las 12:04 para el siguiente trigger. Todo lo que sea anterior a las 12:04 se desechará y lo posterior, se tratará (por ejemplo, al llegar <em>cat</em> a las 12:09) y se contabiliza en las dos ventanas posibles.</p>
<p>Sin embargo, cuando llega <em>owl</em> a las 12:21, fija la marca de agua a las 12:11, y por tanto limpia la ventana que va de las 12:00 a las 12:10, y todos los datos posteriores que llegan anteriores a la marca de agua como <em>donkey</em> a las 12:04 se descartan por llegar demasiado tarde.</p>
<p>Tras cada trigger, por el modo <em>update</em>, los cálculos (filas en lila) se escriben en el destino.</p>
<h3 id="modo-append">Modo <em>append</em><a class="headerlink" href="#modo-append" title="Permanent link">&para;</a></h3>
<p>Anteriormente hemos comentado que no podíamos utilizar el modo <em>append</em> con la agregaciones, ya que <em>Spark</em> necesita saber que los registros no se actualizarán o modificarán en el futuro. En cambio, al definir una marca de agua, ahora sí que podremos hacerlo. Para ello, sólo emitirá el resultado una vez ha finalizado una ventana y no pueda aceptar nuevos eventos tardíos.</p>
<p>Supongamos que nuestra marca de agua es de treinta minutos, teniendo un ventana de estado actual de 10:00 a 10:30, con un tamaño de ventana de 15 minutos. Si nos llega un mensaje a las 10:45, nuestra ventana de estado pasará a ser de 10:15 a 10:45, y a la ventana de 10:00 a 10:15 ya no podrá llegar ningún mensaje, de manera que puede mostrar los cálculos y realizar el <em>append</em> de dichos datos.</p>
<p>Si el retraso de la marca de agua no es crítica para nuestro sistema, mediante <em>watermarking</em> y el modo de salida <em>append</em>, podemos utilizar un <em>sink</em> de tipo fichero.</p>
<p>Si retomamos el mismo ejemplo de antes, pero ahora con el modo <em>append</em>, y nos fijamos en los pasos finales, cuando la marca de agua pasaba a ser a las 12:11 provocaba que caducase la ventana de las 12:00 a las 12:10. En el siguiente trigger es cuando dichos datos se persisten en el <em>sink</em>:</p>
<figure style="align: center;">
    <img src="images/03streaming-watermark-append-mode.png">
    <figcaption>Marca de agua - modo append</figcaption>
</figure>

<!--
<https://github.com/PacktPublishing/Apache-Spark-Streaming-with-Python-and-PySpark-v>
<https://github.com/jleetutorial/python-spark-streaming>  
-->

<h2 id="caso-7-bolsa-ii">Caso 7: Bolsa II<a class="headerlink" href="#caso-7-bolsa-ii" title="Permanent link">&para;</a></h2>
<p>Ahora que ya hemos visto el concepto de marca de agua, podemos crear un marco para que los valores que lleguen tarde se descarten y poder almacenar la información en fichero en formato Parquet con el modo de salida <em>append</em>.</p>
<p>Así pues, cuando agrupamos los datos, vamos a definir una marca de agua de 30 minutos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowDF</span> <span class="o">=</span> <span class="n">accionesDF</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="s2">&quot;30 minutes&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>  <span class="c1"># col(&quot;BrokerCode&quot;),</span>
<span class="linenos" data-linenos="5 "></span>         <span class="n">window</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">),</span> <span class="s2">&quot;15 minutes&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos="7 "></span>         <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">))</span>
</code></pre></div>
<p>Y posteriormente ya podemos almacenar los datos en un fichero:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">bolsaWriterQuery</span> <span class="o">=</span> <span class="n">salidaDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">&quot;BolsaWQuery&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;salida&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="7 "></span>    <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="s2">&quot;1 minute&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="8 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>Si vamos a la carpeta, tendremos diferentes fichero. Si creamos un <a href="resources/entrada/bolsa2.json">nuevo fichero</a> con un dato que se salga de la marca de agua, los datos antiguos <em>caducarán</em> y se persistirán en disco:</p>
<div class="highlight"><span class="filename">bolsa2.json</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 12:50:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Así pues, si ahora los cargamos mediante un proceso <em>batch</em>, podremos ver los datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">rawBolsaDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
<span class="linenos" data-linenos=" 2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;salida&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">rawBolsaDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># +-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># |              start|                end|Compras|Ventas|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># +-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># |2022-05-09 10:00:00|2022-05-09 10:15:00|    800|     0|</span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># |2022-05-09 10:15:00|2022-05-09 10:30:00|    800|   400|</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># |2022-05-09 10:45:00|2022-05-09 11:00:00|      0|   700|</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># |2022-05-09 10:30:00|2022-05-09 10:45:00|    900|     0|</span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># +-------------------+-------------------+-------+------+</span>
</code></pre></div>
<p>Ahora ya podemos hacer uso de las funciones ventanas, y calcular el total acumulado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">ventanaTotal</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="p">,</span> <span class="n">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">salidaDF</span> <span class="o">=</span> <span class="n">rawBolsaDF</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">ventanaTotal</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">ventanaTotal</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 8 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Neto&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;Compras - Ventas&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="n">salidaDF</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># +-------------------+-------------------+-------+------+----+</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># |start              |end                |Compras|Ventas|Neto|</span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># +-------------------+-------------------+-------+------+----+</span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># |2022-05-09 10:00:00|2022-05-09 10:15:00|800    |0     |800 |</span>
<span class="linenos" data-linenos="15 "></span><span class="c1"># |2022-05-09 10:15:00|2022-05-09 10:30:00|1600   |400   |1200|</span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># |2022-05-09 10:30:00|2022-05-09 10:45:00|1600   |1100  |500 |</span>
<span class="linenos" data-linenos="17 "></span><span class="c1"># |2022-05-09 10:45:00|2022-05-09 11:00:00|2500   |1100  |1400|</span>
<span class="linenos" data-linenos="18 "></span><span class="c1"># +-------------------+-------------------+-------+------+----+</span>
</code></pre></div>
<h2 id="datos-duplicados">Datos duplicados<a class="headerlink" href="#datos-duplicados" title="Permanent link">&para;</a></h2>
<p>Aunque <em>Spark Streaming</em> asegura la fiabilidad de los datos mediante la entrega de mensajes <em>exactly-one</em>, es posible que desde nuestras fuentes de datos nos envíen un dato más de una vez (por problemas con la red o fallos de transmisión).</p>
<p>Dentro de <em>Structured Streaming</em> podemos gestionar los datos duplicados tanto con marcas de agua como sin ellas. Debes tener en cuenta que si no utilizamos <em>watermarking</em>, el estado de <em>Spark</em> necesite almacenar de manera ilimitada todos los datos, lo que puede llevar a un problema de falta de memoria.</p>
<p>Para evitar los registros duplicados, los diferentes eventos deberían tener un identificador único y pasárselo como parámetro al método <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.dropDuplicates.html"><code>dropDuplicates</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">streamingDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="c1"># Sin marcas de agua</span>
<span class="linenos" data-linenos="4 "></span><span class="n">streamingDF</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="c1"># Mediante marca de agua, eliminamos tanto por el identificador como por la ventana temporal</span>
<span class="linenos" data-linenos="7 "></span><span class="n">streamingDF</span> \
<span class="linenos" data-linenos="8 "></span>  <span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;ts&quot;</span><span class="p">,</span> <span class="s2">&quot;10 minutes&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="9 "></span>  <span class="o">.</span><span class="n">dropDuplicates</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Procesamiento con estado (<a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#arbitrary-stateful-operations"><em>Stateful operations</em></a>)</p>
<p>Si necesitamos realizar operaciones avanzadas que requieren realizar un seguimiento sobre diferentes eventos dentro de una misma sesión (por ejemplo, ver si ha llegado más de 3 veces una temperatura superior a X grados), podemos utilizar las funciones <code>mapGroupWithState</code> y <code>flatMapGroupsWithState</code> (solo disponibles a día de hoy mediante <em>Java</em> y <em>Scala</em>), que permiten definir una función de usuario a aplicar sobre el estado.</p>
</div>
<h2 id="joins-en-streaming">Joins en streaming<a class="headerlink" href="#joins-en-streaming" title="Permanent link">&para;</a></h2>
<p>Una de las cosas más <em>curiosas</em> que podemos hacer con un <em>DataFrame</em> en <em>streaming</em> es realizar un <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#join-operations"><em>join</em></a> con otro <em>DataFrame</em> estático u otro en <em>streaming</em>, es decir, con datos que todavía no existen.</p>
<p>Realizar un <em>join</em> es una operación compleja y la parte divertida es que no todos los datos están disponibles en el momento de realizar el <em>join</em>, por lo tanto su resultado se genera de forma incremental tras cada <em>trigger</em>, de forma similar a como se generan las agregaciones.</p>
<p>Unir un stream con un DataFrame estático es una operación sin estado, ya que Spark no necesita mantener el estado y sólo está uniendo los datos de un único micro-batch.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">estaticoDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos="2 "></span><span class="n">streamingDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos="3 "></span><span class="n">streamingDF</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">estaticoDF</span><span class="p">,</span> <span class="s2">&quot;claveAjena&quot;</span><span class="p">)</span>  <span class="c1"># inner join entre streaming y estático</span>
<span class="linenos" data-linenos="4 "></span><span class="n">streamingDF</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">estaticoDF</span><span class="p">,</span> <span class="s2">&quot;claveAjena&quot;</span><span class="p">,</span> <span class="s2">&quot;left_outer&quot;</span><span class="p">)</span>  <span class="c1"># left outer join con estático</span>
</code></pre></div>
<p>En cambio, unir dos <em>DataFrames</em> en streaming sí que es una operación con estado, ya que Spark necesita almacenar los datos de ambos en el almacenamiento del estado y comprobar continuamente si hay relación entre los nuevos datos que llegan en cada micro-batch. Dado que los <em>DataFrames</em> en stream no tienen un final definido, <em>Spark Structured Streaming</em> debe mantener todos los datos recogidos de ambos <em>DataFrames</em> de un <em>join</em>, ya que pueden llegar futuros datos que sí cumplan la relación. Para evitar que el estado se quede sin memoria disponible, podemos utilizar marcas de agua en ambos <em>DataFrames</em> e incluir una restricción basada en el tiempo de evento definido en la condición de <em>join</em>.</p>
<p>Supongamos que queremos unir un flujo de impresiones de anuncios (cuando se muestra un anuncio) con otro flujo de los clicks que los usuarios realizan sobre los anuncios para correlacionarlos y monetizar los clicks:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">impresiones</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">clicks</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># Le asignamos una marca de agua a las columnas de tiempos de eventos</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">impresionesConMarcaAgua</span> <span class="o">=</span> <span class="n">impresiones</span><span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;impresionTime&quot;</span><span class="p">,</span> <span class="s2">&quot;2 hours&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">clicksConMarcaAgua</span> <span class="o">=</span> <span class="n">clicks</span><span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;clickTime&quot;</span><span class="p">,</span> <span class="s2">&quot;3 hours&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># Join con restricciones temporales</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># Los clicks solo se pueden recibir una vez impreso el anuncio y hasta una hora después</span>
<span class="linenos" data-linenos="12 "></span><span class="n">impresionesConMarcaAgua</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos" data-linenos="13 "></span>  <span class="n">clicksConMarcaAgua</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span>  <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos" data-linenos="15 "></span><span class="s2">    clickAnuncioId = impresionAnuncioId AND</span>
<span class="linenos" data-linenos="16 "></span><span class="s2">    clickTime &gt;= impresionTime AND</span>
<span class="linenos" data-linenos="17 "></span><span class="s2">    clickTime &lt;= impresionTime + interval 1 hour</span>
<span class="linenos" data-linenos="18 "></span><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="19 "></span><span class="p">)</span>
</code></pre></div>
<div class="admonition caution">
<p class="admonition-title">Limpieza</p>
<p>Conviene recordar que la limpieza de los registros del estado que quedan fuera de la marca de agua puede realizar tan pronto como cambie la marca o se puede retrasar debido a optimizaciones de Spark. Así pues, Spark no garantiza que los registros que están fuera de la marca de agua se ignoren por completo, sino que lo que estén dentro nunca se descartarán.</p>
</div>
<p>El soporte que hay para los diferentes tipos de join depende de los tipos de <em>DataFrames</em>:</p>
<table>
<thead>
<tr>
<th>Izquierda + Derecha</th>
<th>Inner Join</th>
<th>Left Join</th>
<th>Right Join</th>
<th>Full Outer</th>
</tr>
</thead>
<tbody>
<tr>
<td>Estático + Streaming</td>
<td>Sí</td>
<td>No</td>
<td>Sí</td>
<td>No</td>
</tr>
<tr>
<td>Streaming + Streaming</td>
<td>Sí</td>
<td>Condicional. Debe especificar marca de agua en el lado derecho y restricción temporal</td>
<td>Condicional. Debe especificar marca de agua en el lado izquierdo y restricción temporal</td>
<td>Condicional. Debe especificar marca de agua en un lado y restricción temporal</td>
</tr>
</tbody>
</table>
<p>En todos los casos que se indican restricciones temporales, opcionalmente se puede especificar marca de agua en el otro lado para facilitar la limpieza del estado.</p>
<h2 id="caso-8-join-entre-kafka-y-mariadb">Caso 8: Join entre Kafka y MariaDB<a class="headerlink" href="#caso-8-join-entre-kafka-y-mariadb" title="Permanent link">&para;</a></h2>
<p>En este caso de uso a leer datos de <em>Kafka</em> y unir la información recibida con una fuente de datos estática como puede ser <em>MariaDB</em>.</p>
<p>Vamos a simular que recibimos información sobre usuarios que han realizado login en una aplicación externa y hemos de cruzar sus datos con una base de datos que centraliza todos los usuarios de nuestra empresa.</p>
<p>Para ello, en <em>MariaDB</em> vamos a crear una base de datos y una tabla con información sobre usuarios:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="o">`</span><span class="n">spark</span><span class="o">`</span><span class="w"> </span><span class="cm">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span><span class="p">;</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">usuarios</span><span class="w"> </span><span class="p">(</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="n">nombre</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="n">ultimoLogin</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">usuarios_PK</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span>
<span class="linenos" data-linenos="10 "></span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span>
<span class="linenos" data-linenos="11 "></span><span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span><span class="p">;</span>
<span class="linenos" data-linenos="12 "></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">usuarios</span><span class="p">;</span>
</code></pre></div>
<p>En esta tabla, almacenamos los datos centralizados de los usuarios de nuestra empresa:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">usuarios</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">ultimoLogin</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Aitor Medrano&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-13 13:36:58.0&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Pedro Casas&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-14 13:46:58.0&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Laura García&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-15 13:56:58.0&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="5 "></span><span class="w">    </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Mª Josep Vidal&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-16 14:06:58.0&#39;</span><span class="p">);</span>
</code></pre></div>
<p>Mediante <em>Kafka</em>, vamos a recibir los datos de los usuarios que entran a nuestras aplicaciones desde un topic llamado <code>usuariosk</code> con mensaje con el siguiente formato:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-17 12:15:00&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-18 12:15:00&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-19 12:15:00&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-20 12:15:00&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Una vez que crucemos los datos, si el usuario ya existía en nuestra base de datos (coinciden <code>id</code> y <code>login_id</code>) modificaremos la fecha de su <code>ultimoLogin</code>.</p>
<p>Una vez tenemos claro los datos de entrada, arrancamos Kafka y creamos el <em>topic</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>zookeeper-server-start.sh<span class="w"> </span>./config/zookeeper.properties
<span class="linenos" data-linenos="2 "></span>kafka-server-start.sh<span class="w"> </span>./config/server.properties
<span class="linenos" data-linenos="3 "></span>kafka-topics.sh<span class="w"> </span>--create<span class="w"> </span>--topic<span class="w"> </span>usuariosk<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
</code></pre></div>
<h3 id="lectura-en-streaming">Lectura en streaming<a class="headerlink" href="#lectura-en-streaming" title="Permanent link">&para;</a></h3>
<p>Vamos a comenzar con el fragmento de código que realiza la lectura desde <em>Kafka</em>, creando la sesión <em>Spark</em> y leyendo del topic <code>usuariosk</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 2 "></span>    <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[3]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;IABD Kafka join MariaDB&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span>
<span class="linenos" data-linenos="10 "></span><span class="n">kafkaSchema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;login_id&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="linenos" data-linenos="13 "></span><span class="p">])</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="n">kafkaDF</span> <span class="o">=</span> <span class="n">spark</span> \
<span class="linenos" data-linenos="16 "></span>    <span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="17 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;kafka&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="18 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;kafka.bootstrap.servers&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd-virtualbox:9092&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="19 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;usuariosk&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="20 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;startingOffsets&quot;</span><span class="p">,</span> <span class="s2">&quot;earliest&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="21 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos="22 "></span>
<span class="linenos" data-linenos="23 "></span><span class="c1"># Pasamos el value de Kafka a string y luego a JSON</span>
<span class="linenos" data-linenos="24 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">from_json</span><span class="p">,</span> <span class="n">col</span>
<span class="linenos" data-linenos="25 "></span><span class="n">valueDF</span> <span class="o">=</span> <span class="n">kafkaDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">from_json</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">),</span> <span class="n">kafkaSchema</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos="26 "></span>
<span class="linenos" data-linenos="27 "></span><span class="c1"># Cast del campo login_time a tipo fecha</span>
<span class="linenos" data-linenos="28 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">to_timestamp</span>
<span class="linenos" data-linenos="29 "></span><span class="n">loginDF</span> <span class="o">=</span> <span class="n">valueDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;value.*&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="30 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">),</span> <span class="s2">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">))</span>
</code></pre></div>
<p>Así pues, <code>loginDF</code> es un <em>DataFrame</em> que realiza <em>streaming</em> sobre <em>Kafka</em>.</p>
<h3 id="lectura-estatica">Lectura estática<a class="headerlink" href="#lectura-estatica" title="Permanent link">&para;</a></h3>
<p>El segundo paso es crear otro <em>DataFrame</em> que obtenga los datos desde MariaDB (en esta caso un <em>DataFrame</em> estático, sin <em>streaming</em>) haciendo uso del acceso a base de datos relacionales mediante JDBC, tal como vimos en una <a href="02catalog.html#conectando-con-bases-de-datos">sesión anterior</a>.</p>
<p>Con el driver JDBC ya cargado en <em>Spark</em>, realizamos la lectura de los datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">jdbcDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;jdbc&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">,</span> <span class="s2">&quot;com.mysql.cj.jdbc.Driver&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;jdbc:mysql://localhost&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;dbtable&quot;</span><span class="p">,</span> <span class="s2">&quot;spark.usuarios&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="7 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="8 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
<h3 id="join">Join<a class="headerlink" href="#join" title="Permanent link">&para;</a></h3>
<p>Finalmente, un vez leídos los datos desde MariaDB, ya podemos hacer el <em>join</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">joinExpr</span> <span class="o">=</span> <span class="n">loginDF</span><span class="o">.</span><span class="n">login_id</span> <span class="o">==</span> <span class="n">jdbcDF</span><span class="o">.</span><span class="n">id</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="hll"><span class="linenos" data-linenos=" 4 "></span><span class="n">joinDF</span> <span class="o">=</span> <span class="n">loginDF</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jdbcDF</span><span class="p">,</span> <span class="n">joinExpr</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">loginDF</span><span class="o">.</span><span class="n">login_id</span><span class="p">)</span>
</span><span class="linenos" data-linenos=" 5 "></span><span class="n">joinDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1">#  |-- login_time: timestamp (nullable = true)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">#  |-- id: decimal(20,0) (nullable = true)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">#  |-- nombre: string (nullable = true)</span>
<span class="linenos" data-linenos="10 "></span><span class="c1">#  |-- ultimoLogin: timestamp (nullable = true)</span>
</code></pre></div>
<p>Y sobre el <em>join</em>, elegimos que columnas enviamos a la consola cada minuto:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">resultadoDF</span> <span class="o">=</span> <span class="n">joinDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;nombre&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;ultimoLogin&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">queryWriter</span> <span class="o">=</span> <span class="n">resultadoDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="s2">&quot;1 minute&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 8 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="n">queryWriter</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Una vez lanzado, creamos un productor de <em>Kafka</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">kafka</span><span class="o">-</span><span class="n">console</span><span class="o">-</span><span class="n">producer</span><span class="o">.</span><span class="n">sh</span> <span class="o">--</span><span class="n">topic</span> <span class="n">usuariosk</span> <span class="o">--</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">server</span> <span class="n">iabd</span><span class="o">-</span><span class="n">virtualbox</span><span class="p">:</span><span class="mi">9092</span>
</code></pre></div>
<p>y le enviamos datos de entrada a la aplicación:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-17 12:15:00&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Si vamos a la consola de <em>Spark</em>, veremos como ha creado el join:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>-------------------------------------------<span class="w">                                     </span>
<span class="linenos" data-linenos="2 "></span>Batch:<span class="w"> </span><span class="m">1</span>
<span class="linenos" data-linenos="3 "></span>-------------------------------------------
<span class="linenos" data-linenos="4 "></span>+---+-------------+-------------------+-------------------+
<span class="linenos" data-linenos="5 "></span><span class="p">|</span><span class="w"> </span>id<span class="p">|</span><span class="w">       </span>nombre<span class="p">|</span><span class="w">        </span>ultimoLogin<span class="p">|</span><span class="w">         </span>login_time<span class="p">|</span>
<span class="linenos" data-linenos="6 "></span>+---+-------------+-------------------+-------------------+
<span class="linenos" data-linenos="7 "></span><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="p">|</span>Aitor<span class="w"> </span>Medrano<span class="p">|</span><span class="m">2022</span>-05-16<span class="w"> </span><span class="m">13</span>:36:58<span class="p">|</span><span class="m">2022</span>-05-17<span class="w"> </span><span class="m">12</span>:15:00<span class="p">|</span>
<span class="linenos" data-linenos="8 "></span>+---+-------------+-------------------+-------------------+
</code></pre></div>
<h3 id="persistencia-en-base-de-datos">Persistencia en base de datos<a class="headerlink" href="#persistencia-en-base-de-datos" title="Permanent link">&para;</a></h3>
<p>Si quisiéramos guardar los datos con los últimos <em>logins</em>, podemos hacer uso del <em>sink</em> <code>foreachBatch</code> para crear una función que se invocará con cada <em>batch</em>. Así pues, en cada <em>batch</em> podríamos persistir los datos en una nueva tabla (a día de hoy no podemos realizar una operación de <em>update</em> a partir de un <em>DataFrame</em>, es decir, no permite <em>upserts</em>), por ejemplo, a la tabla <code>usuariosNuevos</code>.</p>
<p>Si queremos preparar el <em>DataFrame</em> para que tenga la misma estructura que la otra tabla que hemos utiliza cuando creamos el resultado, podemos hacer:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">resultadoDF</span> <span class="o">=</span> <span class="n">joinDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;nombre&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ultimoLogin))</span>
<span class="linenos" data-linenos="2 "></span><span class="n">resultadoDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="3 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="4 "></span><span class="c1">#  |-- id: decimal(20,0) (nullable = true)</span>
<span class="linenos" data-linenos="5 "></span><span class="c1">#  |-- nombre: string (nullable = true)</span>
<span class="linenos" data-linenos="6 "></span><span class="c1">#  |-- ultimoLogin: timestamp (nullable = true)</span>
</code></pre></div>
<p>Necesitamos crear una función que se invocará con cada <em>batch</em>. Para ello, usaremos el <em>sink</em> de tipo <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.ss/api/pyspark.sql.streaming.DataStreamWriter.foreachBatch.html">foreachBatch</a> al cual le pasaremos una función que recibirá como parámetro los datos leídos en el micro-batch así como un identificador del <em>batch</em>. En dicha función, en nuestro caso, vamos a persistir los datos en una nueva tabla donde se añadirán todos los registros resultantes del <em>join
</em>:</p>
<div class="highlight"><pre><span></span><code><span class="hll"><span class="linenos" data-linenos=" 1 "></span><span class="k">def</span> <span class="nf">guardarMysql</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_df</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">):</span>
</span><span class="linenos" data-linenos=" 2 "></span>    <span class="n">batch_df</span>
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;batchId&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="n">batchId</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;jdbc&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">,</span> <span class="s2">&quot;com.mysql.cj.jdbc.Driver&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;jdbc:mysql://localhost&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos=" 7 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;dbtable&quot;</span><span class="p">,</span> <span class="s2">&quot;spark.usuariosNuevos&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos=" 8 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 9 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="10 "></span>        <span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>        <span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span><span class="n">queryWriter</span> <span class="o">=</span> <span class="n">resultadoDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="14 "></span>  <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="15 "></span>  <span class="o">.</span><span class="n">foreachBatch</span><span class="p">(</span><span class="n">guardarMysql</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="16 "></span>  <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span><span class="n">queryWriter</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li>Documentación oficial sobre <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html">Spark Structured Streaming</a></li>
<li><a href="https://learning.oreilly.com/library/view/stream-processing-with/9781491944233/">Stream Processing with Apache Spark</a></li>
<li><a href="https://link.springer.com/book/10.1007/978-1-4842-7383-8">Beginning Apache Spark 3: With DataFrame, Spark SQL, Structured Streaming, and Spark Machine Learning Library</a></li>
<li><a href="https://www.packtpub.com/product/real-time-stream-processing-using-apache-spark-3-for-python-developers-video/9781803246543">Real-Time Stream Processing Using Apache Spark 3 for Python Developers</a></li>
</ul>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<ol>
<li>Realiza el caso de uso 5, tanto con ventanas fijas como deslizantes.</li>
<li>Realiza los casos de uso que trabajan los conceptos de ventanas y <em>watermarking</em>, es decir, los casos de uso 6 y 7.</li>
<li>Realiza el caso de uso 8. Además, modifícalo para crear una ventana temporal de 15 minutos y envía nuevos datos de usuarios que entran al sistema que provoquen la limpieza del estado.</li>
</ol>
<!--

Darle la vuelta a algún ejercicio más parecido a un caso real
Podemos coger el de Bizum, y envíar datos tardíos.
-->

<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Se crearán tres ventanas, del minuto 11:43:00 al minuto 11:46:00, del minuto 11:44:00 al minuto 11:47:00 y finalmente del minuto 11:45:00 al minuto 11:48:00&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        <a href='https://ko-fi.com/T6T8GWT9N' title='Invítame a un café en ko-fi.com' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi2.png?v=3' border='0' alt='Invítame a un café en ko-fi.com' /></a>
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Me encantan estos apuntes" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="Los apuntes son mejorables" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Gracias por tu tiempo. Si quieres me puedes <a href='https://ko-fi.com/T6T8GWT9N'>invitar a un café en ko-fi</a>.
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              ¡Gracias por tu colaboración! Ayúdame a mejorar los apuntes enviándome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Pie" >
        
          
          <a href="03streaming.html" class="md-footer__link md-footer__link--prev" aria-label="Anterior: Streaming I" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Anterior
                </span>
                Streaming I
              </div>
            </div>
          </a>
        
        
          
          <a href="../dataflow/index.html" class="md-footer__link md-footer__link--next" aria-label="Siguiente: Flujos de datos" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Siguiente
                </span>
                Flujos de datos
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.footer", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow", "content.code.copy"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.efa0ade1.min.js"></script>
      
    
  </body>
</html>