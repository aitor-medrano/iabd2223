
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Analítica de datos con Spark Streaming. Uso de fuentes de datos y sinks. Ingesta en streaming desde/hacia Kafka, uso de ventanas de tamaño fijo (tumbling) o deslizante (sliding) y marcas de aguas (watermarking). Join entre DataFrames batch y streaming.">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/spark/03streaming.html">
      
      
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.3">
    
    
      
        <title>Analítica de datos con Spark Streaming - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6b71719e.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Analítica de datos con Spark Streaming - Inteligencia Artificial y Big Data" >
      
        <meta  property="og:description"  content="Analítica de datos con Spark Streaming. Uso de fuentes de datos y sinks. Ingesta en streaming desde/hacia Kafka, uso de ventanas de tamaño fijo (tumbling) o deslizante (sliding) y marcas de aguas (watermarking). Join entre DataFrames batch y streaming." >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/spark/03streaming.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/spark/03streaming.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Analítica de datos con Spark Streaming - Inteligencia Artificial y Big Data" >
      
        <meta  name="twitter:description"  content="Analítica de datos con Spark Streaming. Uso de fuentes de datos y sinks. Ingesta en streaming desde/hacia Kafka, uso de ventanas de tamaño fijo (tumbling) o deslizante (sliding) y marcas de aguas (watermarking). Join entre DataFrames batch y streaming." >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/spark/03streaming.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spark-streaming" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Analítica de datos con Spark Streaming
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo día"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Cambiar a modo día" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../sa/index.html">Sistemas de almacenamiento</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Sistemas de almacenamiento" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/01nosql.html" class="md-nav__link">
        S18.- Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/02mongo.html" class="md-nav__link">
        S19.- MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/03modelado.html" class="md-nav__link">
        S21.- Modelado de datos NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/05agregaciones.html" class="md-nav__link">
        S25.- Agregaciones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/06replicacion.html" class="md-nav__link">
        S28.- Replicación y Particionado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sa/07pymongo.html" class="md-nav__link">
        S30.- MongoDB y Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../hadoop/index.html">Ecosistema Hadoop</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ecosistema Hadoop" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ecosistema Hadoop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/01arq.html" class="md-nav__link">
        S36.- Arquitecturas Big Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/02etl.html" class="md-nav__link">
        S36.- Ingesta de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/03hadoop.html" class="md-nav__link">
        S38.- Hadoop
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04hdfs.html" class="md-nav__link">
        S39.- HDFS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04formatos.html" class="md-nav__link">
        S39.- Formatos de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/05flume.html" class="md-nav__link">
        S43.- Sqoop y Flume
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/06hive.html" class="md-nav__link">
        S45.- Hive
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../cloud/index.html">Datos en el cloud</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Datos en el cloud" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Datos en el cloud
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/01cloud.html" class="md-nav__link">
        S33.- Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/02aws.html" class="md-nav__link">
        S33.- AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/03s3.html" class="md-nav__link">
        S40.- S3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/04computacion.html" class="md-nav__link">
        S44.- EC2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/05emr.html" class="md-nav__link">
        S44.- EMR
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/06datos.html" class="md-nav__link">
        S46.- RDS y DynamoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/07athena.html" class="md-nav__link">
        S46.- Athena
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">Spark</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Spark" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Spark
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01spark.html" class="md-nav__link">
        S56.- Ecosistema
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01rdd.html" class="md-nav__link">
        S60.- RDD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02dataframeAPI.html" class="md-nav__link">
        S62.- DataFrames API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02agregaciones.html" class="md-nav__link">
        S64.- Agregaciones
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        PIA FP
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#streaming-en-spark" class="md-nav__link">
    Streaming en Spark
  </a>
  
    <nav class="md-nav" aria-label="Streaming en Spark">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dstream" class="md-nav__link">
    DStream
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#structured-streaming" class="md-nav__link">
    Structured Streaming
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-1-hola-spark-streaming" class="md-nav__link">
    Caso 1: Hola Spark Streaming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elementos" class="md-nav__link">
    Elementos
  </a>
  
    <nav class="md-nav" aria-label="Elementos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fuentes-de-datos" class="md-nav__link">
    Fuentes de Datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sinks" class="md-nav__link">
    Sinks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modos-de-salida" class="md-nav__link">
    Modos de salida
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformaciones" class="md-nav__link">
    Transformaciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#triggers" class="md-nav__link">
    Triggers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-2-facturas" class="md-nav__link">
    Caso 2: Facturas
  </a>
  
    <nav class="md-nav" aria-label="Caso 2: Facturas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cargando-los-datos" class="md-nav__link">
    Cargando los datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proyectando" class="md-nav__link">
    Proyectando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guardando-el-resultado" class="md-nav__link">
    Guardando el resultado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refinando" class="md-nav__link">
    Refinando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitorizacion" class="md-nav__link">
    Monitorización
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tolerancia-a-fallos" class="md-nav__link">
    Tolerancia a fallos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-3-consumiendo-kafka" class="md-nav__link">
    Caso 3: Consumiendo Kafka
  </a>
  
    <nav class="md-nav" aria-label="Caso 3: Consumiendo Kafka">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#leyendo-datos" class="md-nav__link">
    Leyendo datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprobando-el-resultado" class="md-nav__link">
    Comprobando el resultado
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-4-produciendo-a-kafka" class="md-nav__link">
    Caso 4: Produciendo a Kafka
  </a>
  
    <nav class="md-nav" aria-label="Caso 4: Produciendo a Kafka">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creando-las-notificaciones" class="md-nav__link">
    Creando las notificaciones
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-5-windowing" class="md-nav__link">
    Caso 5: Windowing
  </a>
  
    <nav class="md-nav" aria-label="Caso 5: Windowing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ventana-fija" class="md-nav__link">
    Ventana fija
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ventanas-deslizantes" class="md-nav__link">
    Ventanas deslizantes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-6-bolsa-i" class="md-nav__link">
    Caso 6: Bolsa I
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#watermarking" class="md-nav__link">
    Watermarking
  </a>
  
    <nav class="md-nav" aria-label="Watermarking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modo-update" class="md-nav__link">
    Modo update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modo-append" class="md-nav__link">
    Modo append
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-7-bolsa-ii" class="md-nav__link">
    Caso 7: Bolsa II
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#join" class="md-nav__link">
    Join
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-8-join-entre-kafka-y-mariadb" class="md-nav__link">
    Caso 8: Join entre Kafka y MariaDB
  </a>
  
    <nav class="md-nav" aria-label="Caso 8: Join entre Kafka y MariaDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lectura-en-streaming" class="md-nav__link">
    Lectura en streaming
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lectura-estatica" class="md-nav__link">
    Lectura estática
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#join_1" class="md-nav__link">
    Join
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datos-duplicados" class="md-nav__link">
    Datos duplicados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="spark-streaming">Spark Streaming<a class="headerlink" href="#spark-streaming" title="Permanent link">&para;</a></h1>
<p>Aunque ya estudiamos el concepto de <em>Streaming</em> en la sesión sobre <a href="../hadoop/02etl.html">Ingesta de Datos</a> no viene mal recordar que cuando el procesamiento se realiza en <em>streaming</em>:</p>
<ul>
<li>Los datos se generan de manera continuada desde una o más fuentes de datos.</li>
<li>Las fuentes de datos, por lo general, envían los datos de forma simultánea.</li>
<li>Los datos se reciben en pequeños fragmentos (del orden de KB).</li>
</ul>
<p>Vamos a considerar un <em>stream</em> como un flujo de datos continuo e ilimitado, sin un final definido que aporta datos a nuestros sistemas cada segundo.</p>
<p>El desarrollo de aplicaciones que trabajan con datos en <em>streaming</em> suponen un mayor reto que las aplicaciones <em>batch</em>, dada la impredecibilidad de los datos, tanto su ritmo de llegada como su orden.</p>
<p>Uno de los casos de uso más comunes del procesamiento en streaming es realizar algún calculo agregado sobre los datos que llegan y resumirlos/sintetizarlos en un destino externo para que luego ya sea un aplicación web o un motor de analítica de datos los consuma.</p>
<p>Las principales herramientas para el tratamiento de datos en streaming son <a href="https://samza.apache.org/">Apache Samza</a>, <a href="https://flink.apache.org/">Apache Flink</a>, <a href="https://kafka.apache.org/">Apache Kafka</a> (de manera conjunta con Kafka Streams) y por supuesto, <a href="https://spark.apache.org/">Apache Spark</a>.</p>
<h2 id="streaming-en-spark"><em>Streaming</em> en <em>Spark</em><a class="headerlink" href="#streaming-en-spark" title="Permanent link">&para;</a></h2>
<p><em>Spark Streaming</em> es una extensión del núcleo de <em>Spark</em> que permite el procesamiento de flujos de datos en vivo ofreciendo tolerancia a fallos, un alto rendimiento y altamente escalable.</p>
<p>Los datos se pueden ingestar desde diversas fuentes de datos, como <em>Kafka</em>, <em>sockets</em> TCP, etc.. y se pueden procesar mediante funciones de alto nivel, ya sea mediante el uso de RDD y algoritmos <em>MapReduce</em>, o utilizando <em>DataFrames</em> y la sintaxis SQL. Finalmente, los datos procesados se almacenan en sistemas de ficheros, bases de datos o cuadros de mandos.</p>
<figure style="align: center;">
    <img src="images/03streaming-arch.png">
    <figcaption>Streaming con Spark</figcaption>
</figure>

<p>De hecho, podemos utilizar tanto <em>Spark MLlib</em> y sus algoritmos de <em>machine learning</em> como el procesamiento de grafos en los flujos de datos.</p>
<p>Spark dispone dos soluciones para trabajar con datos en <em>streaming</em>:</p>
<ul>
<li><a href="https://spark.apache.org/docs/latest/streaming-programming-guide.html"><em>Spark DStream</em></a>: más antigua, conocida como la primera generación,  basada en RDDs</li>
<li><a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html"><em>Spark Structured Streaming</em></a> basada en el uso de <em>DataFrames</em> y diseñada para construir aplicaciones que puedan reaccionar a los datos en tiempo real.</li>
</ul>
<p>Vamos a presentar ambas soluciones, pero en este sesión nos centraremos principalmente en <em>Spark Structured Streaming</em>.</p>
<h3 id="dstream">DStream<a class="headerlink" href="#dstream" title="Permanent link">&para;</a></h3>
<p><a href="https://spark.apache.org/docs/latest/streaming-programming-guide.html"><em>Spark DStream</em></a> (<em>Discretized Stream</em>), como ya hemos comentado, es la primera versión y actualmente no se recomienda su uso.</p>
<p>Funciona mediante un modelo de <em>micro-batching</em> para dividir los flujos de entrada de datos en fragmentos que son procesados por el núcleo de Spark. Este planteamiento tenía mucho sentido cuando el principal modelo de programación de Spark eran los RDD, ya que cada fragmento recibido se representaba mediante un RDD.</p>
<p>Así pues, <em>Spark DStream</em> recibe los datos de entrada en flujos y los divide en <em>batches</em>, por ejemplo en bloques cada N segundos, los cuales procesa <em>Spark</em> mediante RDD para generar los flujos de resultados procesados:</p>
<figure style="align: center;">
    <img src="images/03streaming-flow.png">
    <figcaption>DStream por dentro</figcaption>
</figure>

<h3 id="structured-streaming">Structured Streaming<a class="headerlink" href="#structured-streaming" title="Permanent link">&para;</a></h3>
<p><a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html"><em>Spark Structured Streaming</em></a> es la segunda generación de motor para el tratamiento de datos en <em>streaming</em>, y fue diseñado para ser más rápido, escalable y con mayor tolerancia a los errores que <em>DStream</em>, ya que utiliza el motor de Spark SQL.</p>
<p>Además, podemos expresar los procesos en streaming de la misma manera que realizaríamos un proceso <em>batch</em> con datos estáticos. El motor de Spark SQL se encarga de ejecutar los datos de forma continua e incremental, y actualizar el resultado final como datos streaming. Para ello, podemos utilizar el API de Java, Scala, Python o R para expresar las agregaciones, ventanas de eventos, joins de <em>stream</em> a <em>batch</em>, etc.... Finalmente, el sistema asegura la tolerancia de fallos mediante la entrega de cada mensaje una sola vez (<strong><em>exactly-once</em></strong>) a través de <em>checkpoints</em> y logs.</p>
<p>Los pasos esenciales a realizar al codificar una aplicación en streaming consiste en especificar uno o más fuentes de datos, ofreciendo la lógica para manipular los flujos de entrada de datos mediante transformaciones de <em>DataFrames</em>, definir el <em>trigger</em> que provoca la lectura y el modo de salida, y finalmente indicar el destino de los datos (<em>data sink</em>) donde escribir los resultados.</p>
<figure style="align: center;">
    <img src="images/03streaming-fases.jpg">
    <figcaption>Elementos para procesar datos en Streaming</figcaption>
</figure>

<p>Debido a que tanto el modo de salida como el trigger tienen valores por defecto, es posible que no tengamos que indicarlos ni configurarlos, lo que reduce el desarrollo de procesos a un bucle infinito de leer, transformar y enviar al destino (<em>read + transform + sink</em>). Cada una de las iteraciones de ese bucle infinito se conoce como un <strong><em>micro-batch</em></strong>, las cuales tienen unas latencias situadas alrededor de los 100 ms. Desde Spark 2.3 existe un nuevo modo de procesamiento de baja latencia conocido como <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#continuous-processing">Procesamiento Continuo</a>, que puede obtener latencias de 1ms. Al tratarse todavía de un tecnología en fase de experimentación, queda fuera de la presente sesión.</p>
<h2 id="caso-1-hola-spark-streaming">Caso 1: Hola Spark Streaming<a class="headerlink" href="#caso-1-hola-spark-streaming" title="Permanent link">&para;</a></h2>
<p>Para ver nuestro primer caso de uso, vamos a realizar un proceso de contar palabras sobre un flujo continuo de datos que proviene de un socket.</p>
<p>Para ello, en un terminal, abrimos un <em>listener</em> de Netcat en el puerto 9999:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>nc<span class="w"> </span>-lk<span class="w"> </span><span class="m">9999</span>
</code></pre></div>
<p>Tras arrancar <em>Netcat</em>, ya podemos crear nuestra aplicación <em>Spark</em> (vamos a indicar que cree 2 hilos, lo cual es el mínimo necesario para realizar <em>streaming</em>, uno para recibir y otro para procesar):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Streaming s8a WordCount&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># Creamos un flujo de escucha sobre netcat en localhost:9999 (read)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">lineasDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="10 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="11 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="12 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;9999&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="13 "></span>        <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="c1"># Leemos las líneas y las pasamos a palabras.</span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># Sobre ellas, realizamos la agrupación count (transformación)</span>
<span class="linenos" data-linenos="17 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">explode</span><span class="p">,</span> <span class="n">split</span>
<span class="linenos" data-linenos="18 "></span><span class="n">palabrasDF</span> <span class="o">=</span> <span class="n">lineasDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">explode</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">lineasDF</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;palabra&#39;</span><span class="p">))</span>
<span class="linenos" data-linenos="19 "></span><span class="n">cantidadDF</span> <span class="o">=</span> <span class="n">palabrasDF</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;palabra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span><span class="c1"># Mostramos las palabras por consola (sink)</span>
<span class="linenos" data-linenos="22 "></span><span class="n">wordCountQuery</span> <span class="o">=</span> <span class="n">cantidadDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="23 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="24 "></span>        <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="25 "></span>        <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos="26 "></span>
<span class="linenos" data-linenos="27 "></span><span class="c1"># dejamos Spark a la escucha</span>
<span class="linenos" data-linenos="28 "></span><span class="n">wordCountQuery</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Conforme escribamos en el terminal de <em>Netcat</em> irán apareciendo en la consola de <em>Spark</em> los resultados:</p>
<figure style="align: center;">
    <img src="images/03streaming-wc.gif">
    <figcaption>Ejecución de Streaming WordCount</figcaption>
</figure>

<p>Al ejecutar la consulta, <em>Spark</em> crea un proceso a la escucha de manera ininterrumpida de nuevos datos. Mientras no lleguen datos, Spark queda a la espera, de manera que cuando llegue algún dato al flujo de entrada, se creará un nuevo <em>micro-batch</em>, lo que lanzará un nuevo <em>job</em> de Spark.</p>
<p>Si queremos detenerlo, podemos hacerlo de forma explícita:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">wordCountQuery</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div>
<p>O configurar la <em>SparkSession</em> para que detenga el <em>streaming</em> al finalizar el proceso:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos="2 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Streaming WordCount&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="3 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="4 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</code></pre></div>
<p>Por defecto, Spark utiliza 200 particiones para barajar los datos. Como no tenemos muchos datos, para obtener un mejor rendimiento, podemos reducir su cantidad:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos="2 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Streaming WordCount&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="4 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="5 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</code></pre></div>
<h2 id="elementos">Elementos<a class="headerlink" href="#elementos" title="Permanent link">&para;</a></h2>
<p>La idea básica al trabajar los datos en <em>streaming</em> es como una tabla de entrada de tamaño ilimitado, y conforme llegan nuevos datos, tratarlos como un nuevo conjunto de filas que se adjuntan a la tabla.</p>
<figure style="align: center;">
    <img src="images/03streaming-datatable.png">
    <figcaption>Datos como registros</figcaption>
</figure>

<p>A continuación vamos a repasar los elementos principales de un flujo en streaming, los cuales son la fuente de datos, las operaciones en <em>streaming</em> mediante las transformaciones, los modos de salida, trigger y los <em>sink</em> de datos.</p>
<div class="admonition info">
<p class="admonition-title">Hablemos del tiempo</p>
<p><figure style="float: right;">
    <img src="images/03streaming-event-vs-processing.jpg" width="300">
    <figcaption>Eventos vs Procesamiento</figcaption>
</figure></p>
<p>Existen dos tipos de tiempo, el tiempo del evento (<em>event time</em>) que representa cuando se crea el dato y el de procesado (<em>processing time</em>), que representa el momento en el que el motor de procesamiento/analítica de datos procesa el dato.
Por ejemplo, si nos centramos en un escenario IoT, el tiempo del evento es cuando se toma el dato del sensor, y el de procesamiento cuando nuestro motor de <em>streaming</em> realiza la transformación/agregación sobre los datos del sensor.</p>
<p>A la hora de trabajar con los datos, hemos de realizarlo siempre con el tiempo de los eventos, ya que representan el instante en el que se crean los datos. En un estado ideal, los datos llegan y se procesan casi de forma instantánea, pero la realidad es otra, y la latencia existente provoca la necesidad de descartar el tiempo de procesamiento.</p>
<p>Para manejar los flujos de entrada ajenos a un flujo constante, una práctica muy común es dividr los datos en trozos utilizando el tiempo inicial y final como límites de una ventana temporal.</p>
</div>
<h3 id="fuentes-de-datos">Fuentes de Datos<a class="headerlink" href="#fuentes-de-datos" title="Permanent link">&para;</a></h3>
<p>Mientras que en el procesamiento <em>batch</em> las fuentes de datos son <em>dataset</em> estáticos que residen en un almacenamiento como pueda ser un sistema local, HDFS o S3, al hablar de procesamiento en <em>streaming</em> las fuentes de datos generan los datos de forma continuada, por lo que necesitamos otro tipo de fuentes.</p>
<p><em>Structured Streaming</em> ofrece un conjunto predefinido de <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#input-sources">fuentes de datos</a> que se leen a partir de un <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.streaming.DataStreamReader.html">DataStreamReader</a>. Los tipos existentes son:</p>
<ul>
<li>
<p><ins>Fichero</ins>: permite leer ficheros desde un directorio como un flujo de datos, con soporte para ficheros de texto, CSV, JSON, Parquet, etc...</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="c1"># Lee todos los ficheros csv de un directorio</span>
<span class="linenos" data-linenos="2 "></span><span class="n">esquemaUsuario</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">()</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;nombre&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;edad&quot;</span><span class="p">,</span> <span class="s2">&quot;integer&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="4 "></span><span class="n">csvDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;sep&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">esquemaUsuario</span><span class="p">)</span> \
<span class="linenos" data-linenos="7 "></span>    <span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="s2">&quot;/path/al/directorio&quot;</span><span class="p">)</span>  <span class="c1"># equivalente a format(&quot;csv&quot;).load(&quot;/path/al/directorio&quot;)</span>
</code></pre></div>
<p>Podemos configurar otras opciones como <code>maxFilesPerTrigger</code> con la cantidad de archivos a cargar en cada <em>trigger</em>, así como la política de lectura cuando su número sea mayor de uno mediante la propiedad booleana <code>latestFirst</code>.</p>
</li>
<li>
<p><ins>Kafka</ins>: para leer datos desde brokers <em>Kafka</em> (versiones 0.10 o superiores). Realizaremos un ejemplo en las siguientes secciones.</p>
</li>
<li>
<p><ins>Socket</ins>: lee texto UTF8 desde una conexión <em>socket</em> (es el que hemos utilizado en el caso de uso 1). Sólo se debe utilizar para pruebas ya que no ofrece garantía de tolerancia de fallos de punto a punto.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">socketDF</span> <span class="o">=</span> <span class="n">spark</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p><ins>Rate</ins>: Genera datos indicando una cantidad de filas por segundo, donde cada fila contiene un <em>timestamp</em> y el valor de un contador secuencial (la primera fila contiene el 0). Esta fuente también se utiliza para la realización de pruebas y <em>benchmarking</em>.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">socketDF</span> <span class="o">=</span> <span class="n">spark</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;rate&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;rowsPerSecond&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p><ins>Tabla</ins> (desde <em>Spark 3.1</em>): Almacena los datos en una tabla temporal de SparkSQL, la cual podemos utilizar tanto para cargar como para persistir los cálculos realizados. Más información en la <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#streaming-table-apis">documentación oficial</a>.</p>
</li>
</ul>
<h3 id="sinks"><em>Sinks</em><a class="headerlink" href="#sinks" title="Permanent link">&para;</a></h3>
<p>De la misma manera, también tenemos un conjunto de <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#output-sinks"><em>Sinks</em></a> predefinidos como destino de los datos:</p>
<ul>
<li>
<p><ins>Fichero</ins>: Podemos almacenar los resultados en un sistema de archivos, HDFS o S3, con soporte para los formatos CSV, JSON, ORC y Parquet.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="c1"># Otros valores pueden ser &quot;json&quot;, &quot;csv&quot;, etc...</span>
<span class="linenos" data-linenos="2 "></span><span class="n">writeStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span> \        
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/al/directorio&quot;</span><span class="p">)</span> \ 
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p><ins>Kafka</ins>: Envía los datos a un clúster de <em>Kafka</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">writeStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;kafka&quot;</span><span class="p">)</span> \        
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;kafka.bootstrap.servers&quot;</span><span class="p">,</span> <span class="s2">&quot;host1:port1,host2:port2&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;topic&quot;</span><span class="p">,</span> <span class="s2">&quot;miTopic&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p><ins>Foreach</ins> y <ins>ForeachBatch</ins>: permiten realizar operaciones y escribir lógica sobre la salida de una consulta de streaming, ya sea a nivel de fila (<em>foreach</em>) como a nivel de micro-batch (<em>foreachBatch</em>). Más información en la <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#using-foreach-and-foreachbatch">documentación oficial</a>.</p>
</li>
<li>
<p><ins>Consola</ins>: se emplea para pruebas y depuración y permite mostrar el resultado por consola.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">writeStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \        
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>Admite las opciones <code>numRows</code> para indicar las filas a mostrar y <code>truncate</code> para truncar los datos si las filas son muy largas.</p>
</li>
<li>
<p><ins>Memoria</ins>: se emplea para pruebas y depuración, ya que sólo permite un volumen pequeño de datos para evitar un problema de falta de memoria en el driver para almacenar la salida. Los datos se almacenan en una tabla temporal a la cual podemos acceder desde <em>SparkSQL</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">writeStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span> \  
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">&quot;nombreTabla&quot;</span><span class="p">)</span>  
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
</li>
</ul>
<h3 id="modos-de-salida">Modos de salida<a class="headerlink" href="#modos-de-salida" title="Permanent link">&para;</a></h3>
<p>El <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#output-modes">modo de salida</a> determina como salen los datos a un sumidero de datos. Existen tres opciones:</p>
<ul>
<li>Añadir (<em><code>append</code></em>): para insertar los datos, cuando sabemos que no vamos a modificar ninguna salida anterior, y que cada <em>batch</em> únicamente escribirá nuevos registros. Es el modo por defecto.</li>
<li>Modificar (<em><code>update</code></em>): similar a un <em>upsert</em>, donde veremos solo registros que, bien son nuevos, bien son valores antiguos que debemos modificar.</li>
<li>Completa (<em><code>complete</code></em>): para sobrescribir completamente el resultado, de manera que siempre recibimos la salida completa.</li>
</ul>
<p>En el caso 1 hemos utilizado el modo de salida completa, de manera que con cada dato nuevo, se mostraba como resultado todas las palabras y su cantidad. Si hubiésemos elegido el modo <em>update</em>, en cada micro-batch solo se mostraría el resultado acumulado de cada <em>batch</em>.</p>
<p>Por ejemplo, si introducimos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>Spark en el Severo Ochoa
<span class="linenos" data-linenos="2 "></span>El Severo Ochoa está en Elche
</code></pre></div>
<p>Dependiendo del modo de salida, al introducir la segunda frase con la siguiente consulta:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Complete</label><label for="__tabbed_1_2">Update</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">wordCountQuery</span> <span class="o">=</span> <span class="n">cantidadDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>Aparece la cuenta de todas las palabras:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>+---------+-----+
<span class="linenos" data-linenos=" 2 "></span>|  palabra|count|
<span class="linenos" data-linenos=" 3 "></span>+---------+-----+
<span class="linenos" data-linenos=" 4 "></span>|    Spark|    1|
<span class="linenos" data-linenos=" 5 "></span>|    Elche|    1|
<span class="linenos" data-linenos=" 6 "></span>|    Ochoa|    2|
<span class="linenos" data-linenos=" 7 "></span>|       El|    1|
<span class="linenos" data-linenos=" 8 "></span>|       en|    2|
<span class="linenos" data-linenos=" 9 "></span>|Streaming|    1|
<span class="linenos" data-linenos="10 "></span>|     está|    1|
<span class="linenos" data-linenos="11 "></span>|   Severo|    2|
<span class="linenos" data-linenos="12 "></span>|       el|    1|
<span class="linenos" data-linenos="13 "></span>+---------+-----+
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">wordCountQuery</span> <span class="o">=</span> <span class="n">cantidadDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>Sólo aparecen las palabras del segundo micro-batch:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>+-------+-----+
<span class="linenos" data-linenos=" 2 "></span>|palabra|count|
<span class="linenos" data-linenos=" 3 "></span>+-------+-----+
<span class="linenos" data-linenos=" 4 "></span>|     El|    1|
<span class="linenos" data-linenos=" 5 "></span>|  Ochoa|    2|
<span class="linenos" data-linenos=" 6 "></span>|  Elche|    1|
<span class="linenos" data-linenos=" 7 "></span>| Severo|    2|
<span class="linenos" data-linenos=" 8 "></span>|   está|    1|
<span class="linenos" data-linenos=" 9 "></span>|     en|    2|
<span class="linenos" data-linenos="10 "></span>+-------+-----+
</code></pre></div>
</div>
</div>
</div>
<p>Con este ejemplo, el modo <em>append</em> no tiene sentido (ya que para contar las palabras necesitamos las anteriores), y <em>Spark</em> es tan listo que cuando realizamos agregaciones no permite su uso y lanza una excepción del tipo <code>AnalysisException</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>AnalysisException:<span class="w"> </span>Append<span class="w"> </span>output<span class="w"> </span>mode<span class="w"> </span>not<span class="w"> </span>supported<span class="w"> </span>when<span class="w"> </span>there<span class="w"> </span>are<span class="w"> </span>streaming<span class="w"> </span>aggregations<span class="w"> </span>on<span class="w"> </span>streaming<span class="w"> </span>DataFrames/DataSets<span class="w"> </span>without<span class="w"> </span>watermark<span class="p">;</span>
<span class="linenos" data-linenos="2 "></span>Aggregate<span class="w"> </span><span class="o">[</span>palabra#59<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>palabra#59,<span class="w"> </span>count<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w"> </span>AS<span class="w"> </span>count#63L<span class="o">]</span>
</code></pre></div>
<p>Si dejase, solo deberían aparecer las palabra <code>El</code>, <code>está</code> y <code>Elche</code>, ya que son los elementos que no existían previamente.</p>
<p>En resumen, el modo <code>append</code> es sólo para inserciones, <code>update</code> para modificaciones e inserciones y finalmente <code>complete</code> sobrescribe los resultados previos.</p>
<p>Además, no todos los tipos de salida se pueden aplicar siempre, va a depender del tipo de operaciones que realicemos. Volveremos a tratarlos cuando veamos las marcas de agua en el apartado <a href="#watermarking">Watermarking</a>.</p>
<h3 id="transformaciones">Transformaciones<a class="headerlink" href="#transformaciones" title="Permanent link">&para;</a></h3>
<p>Dentro de <em>Spark Structured Streaming</em> tenemos dos tipos de transformaciones:</p>
<ul>
<li>Sin estado (<em>stateless</em>): los datos de cada <em>micro-batch</em> son independientes de los anteriores, y por tanto, podemos realizar las transformaciones <code>select</code>, <code>filter</code>, <code>map</code>, <code>flatMap</code>, <code>explode</code>. Es importante destacar que estas transformaciones no soportan el modo de salida <em>complete</em>, por lo que sólo podemos utilizar los modos <em>append</em> o <em>update</em>.</li>
<li>
<p>Con estado (<em>stateful</em>): aquellas que implica realizar agrupaciones, agregaciones, <em>windowing</em> y/o <em>joins</em>, ya que mantienen el estado entre los diferentes <em>micro-batches</em>. Destacar que un abuso del estado puede causar problemas de falta de memoria, ya que el estado se almacena en la memoria de los ejecutores (<em>executors</em>). Por ello, <em>Spark</em> ofrece dos tipos de operaciones con estado:</p>
<ul>
<li>Gestionadas (<em>managed</em>): <em>Spark</em> gestiona el estado y libera la memoria conforme sea necesario.</li>
<li>Sin gestionar (<em>unmanaged</em>): permite que el desarrollador defina las políticas de limpieza del estado (y su liberación de memoria), por ejemplo, a partir de políticas basadas en el tiempo. A día de hoy sólo están disponibles mediante <em>Java</em> o <em>Spark</em>.</li>
</ul>
</li>
</ul>
<p>Además, hay que tener en cuenta que no todas las operaciones que realizamos con <em>DataFrames</em> están soportadas al trabajar en <em>streaming</em>, como pueden ser <code>limit</code>, <code>distinct</code>, <code>cube</code> o <code>sort</code> (podemos ordenar en algunos casos después de haber realizado una agregación), ya que los datos no están acotados y provocará una excepción del tipo <code>AnalysisException</code>.</p>
<h3 id="triggers">Triggers<a class="headerlink" href="#triggers" title="Permanent link">&para;</a></h3>
<p>Un <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#triggers">trigger</a> define el intervalo (<em>timing</em>) temporal de procesamiento de los datos en <em>streaming</em>, indicando si la consulta se ejecutará como un <em>micro-batch</em> mediante un intervalo fijo o con una consulta con procesamiento continuo.</p>
<p>Así pues, un trigger es un mecanismo para que el motor de Spark SQL determine cuando ejecutar la computación en <em>streaming</em>.</p>
<p>Los posibles tipos son:</p>
<ul>
<li><em>Sin especificar</em>, de manera que cada micro-batch se va a ejecutar tan pronto como lleguen datos.</li>
<li><em>Por intervalo de tiempo</em>. Si indicamos un intervalo de un minuto, una vez finalizado un job, si no ha pasado un minuto, se esperará a ejecutarse. Si el micro-batch tardase más de un minuto, el siguiente se ejecutaría inmediatamente. Así pues, de esta manera, Spark permite colectar datos de entrada y procesarlos de manera conjunta (en vez de procesar individualmente cada registro de entrada).</li>
<li><em>Un intervalo</em>, de manera que funciona como un proceso <em>batch</em> estándar, creando un único proceso <em>micro-batch</em>.</li>
<li><em>Continuo</em>, para permitir latencias del orden de milisegundos mediante <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#continuous-processing">Continuous Processing</a>. Se trata de una opción experimental desde la versión 2.3 de Spark.</li>
</ul>
<h2 id="caso-2-facturas">Caso 2: Facturas<a class="headerlink" href="#caso-2-facturas" title="Permanent link">&para;</a></h2>
<p>En este caso de uso vamos a poner en práctica algunos de los conceptos que acabamos de ver.</p>
<p>Vamos a suponer que tenemos un empresa compuesta de diferentes sucursales. Cada una de ellas, cada 5 minutos genera un fichero con los datos de las facturas (<a href="resources/invoices.zip"><em>invoices.zip</em></a>) que han generado. Cada una de las facturas contiene una o más líneas de factura, las cuales queremos separar en facturas simples.</p>
<p>Así pues, vamos a partir de documentos JSON con la siguiente estructura:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nt">&quot;CashierID&quot;</span><span class="p">:</span><span class="s2">&quot;OAS134&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nt">&quot;CustomerCardNo&quot;</span><span class="p">:</span><span class="s2">&quot;4629185211&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="nt">&quot;TotalAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nt">&quot;NumberOfItems&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="nt">&quot;TaxableAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="nt">&quot;CGST&quot;</span><span class="p">:</span><span class="mf">277.85</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="nt">&quot;SGST&quot;</span><span class="p">:</span><span class="mf">277.85</span><span class="p">,</span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nt">&quot;CESS&quot;</span><span class="p">:</span><span class="mf">13.8925</span><span class="p">,</span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="nt">&quot;InvoiceLineItems&quot;</span><span class="p">:[</span>
<span class="linenos" data-linenos="18 "></span><span class="w">        </span><span class="p">{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;458&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Wine glass&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1644.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">3288.0</span><span class="p">},</span>
<span class="linenos" data-linenos="19 "></span><span class="w">        </span><span class="p">{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;283&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Portable Lamps&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">},</span>
<span class="linenos" data-linenos="20 "></span><span class="w">        </span><span class="p">{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;498&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Carving knifes&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1424.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2848.0</span><span class="p">},</span>
<span class="linenos" data-linenos="21 "></span><span class="w">        </span><span class="p">{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;523&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Oil-lamp clock&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1371.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2742.0</span><span class="p">}]}</span>
</code></pre></div>
<p>Y a partir de él, generaremos 4 documentos (uno por cada línea de factura) con la siguiente estructura:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;458&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Wine glass&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1644.0</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">3288.0</span>
<span class="linenos" data-linenos="14 "></span><span class="p">}</span>
</code></pre></div>
<h3 id="cargando-los-datos">Cargando los datos<a class="headerlink" href="#cargando-los-datos" title="Permanent link">&para;</a></h3>
<p>Las facturas que nos envían las colocan en una carpeta a la que tenemos acceso (para este ejercicio, podemos descargar los archivos y colocarlos en la carpeta <code>entrada</code>), de manera que primero crearemos la sesión y realizaremos la lectura desde dicha carpeta. Es importante destacar que para que funcione la inferencia de la estructura del documento, debemos disponer de algún archivo en nuestra carpeta de <code>entrada</code> y activar la propiedad <code>spark.sql.streaming.schemaInference</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Streaming de Ficheros&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 8 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.streaming.schemaInference&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 9 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="n">raw_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="12 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="13 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;entrada&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="14 "></span>        <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span><span class="n">raw_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="17 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="18 "></span><span class="c1">#  |-- CESS: double (nullable = true)</span>
<span class="linenos" data-linenos="19 "></span><span class="c1">#  |-- CGST: double (nullable = true)</span>
<span class="linenos" data-linenos="20 "></span><span class="c1">#  |-- CashierID: string (nullable = true)</span>
<span class="linenos" data-linenos="21 "></span><span class="c1">#  |-- CreatedTime: long (nullable = true)</span>
<span class="linenos" data-linenos="22 "></span><span class="c1">#  |-- CustomerCardNo: string (nullable = true)</span>
<span class="linenos" data-linenos="23 "></span><span class="c1">#  |-- CustomerType: string (nullable = true)</span>
<span class="linenos" data-linenos="24 "></span><span class="c1">#  |-- DeliveryAddress: struct (nullable = true)</span>
<span class="linenos" data-linenos="25 "></span><span class="c1">#  |    |-- AddressLine: string (nullable = true)</span>
<span class="linenos" data-linenos="26 "></span><span class="c1">#  |    |-- City: string (nullable = true)</span>
<span class="linenos" data-linenos="27 "></span><span class="c1">#  |    |-- ContactNumber: string (nullable = true)</span>
<span class="linenos" data-linenos="28 "></span><span class="c1">#  |    |-- PinCode: string (nullable = true)</span>
<span class="linenos" data-linenos="29 "></span><span class="c1">#  |    |-- State: string (nullable = true)</span>
<span class="linenos" data-linenos="30 "></span><span class="c1">#  |-- DeliveryType: string (nullable = true)</span>
<span class="linenos" data-linenos="31 "></span><span class="c1">#  |-- InvoiceLineItems: array (nullable = true)</span>
<span class="linenos" data-linenos="32 "></span><span class="c1">#  |    |-- element: struct (containsNull = true)</span>
<span class="linenos" data-linenos="33 "></span><span class="c1">#  |    |    |-- ItemCode: string (nullable = true)</span>
<span class="linenos" data-linenos="34 "></span><span class="c1">#  |    |    |-- ItemDescription: string (nullable = true)</span>
<span class="linenos" data-linenos="35 "></span><span class="c1">#  |    |    |-- ItemPrice: double (nullable = true)</span>
<span class="linenos" data-linenos="36 "></span><span class="c1">#  |    |    |-- ItemQty: long (nullable = true)</span>
<span class="linenos" data-linenos="37 "></span><span class="c1">#  |    |    |-- TotalValue: double (nullable = true)</span>
<span class="linenos" data-linenos="38 "></span><span class="c1">#  |-- InvoiceNumber: string (nullable = true)</span>
<span class="linenos" data-linenos="39 "></span><span class="c1">#  |-- NumberOfItems: long (nullable = true)</span>
<span class="linenos" data-linenos="40 "></span><span class="c1">#  |-- PaymentMethod: string (nullable = true)</span>
<span class="linenos" data-linenos="41 "></span><span class="c1">#  |-- PosID: string (nullable = true)</span>
<span class="linenos" data-linenos="42 "></span><span class="c1">#  |-- SGST: double (nullable = true)</span>
<span class="linenos" data-linenos="43 "></span><span class="c1">#  |-- StoreID: string (nullable = true)</span>
<span class="linenos" data-linenos="44 "></span><span class="c1">#  |-- TaxableAmount: double (nullable = true)</span>
<span class="linenos" data-linenos="45 "></span><span class="c1">#  |-- TotalAmount: double (nullable = true)</span>
</code></pre></div>
<p>Aunque en este caso hemos realizado la inferencia de la estructura de los datos de entrada, lo normal es indicar el esquema de los datos.</p>
<h3 id="proyectando">Proyectando<a class="headerlink" href="#proyectando" title="Permanent link">&para;</a></h3>
<p>El siguiente paso es seleccionar los datos que nos interesan. Para ello, tras revisar la estructura de salida que deseamos, realizamos una selección de las columnas y utilizaremos la función <code>explode</code> para desenrollar el array de facturas <code>InvoiceLineItems</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">explode_df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;InvoiceNumber&quot;</span><span class="p">,</span> <span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="s2">&quot;StoreID&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 2 "></span>                                 <span class="s2">&quot;PosID&quot;</span><span class="p">,</span> <span class="s2">&quot;CustomerType&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>                                 <span class="s2">&quot;PaymentMethod&quot;</span><span class="p">,</span> <span class="s2">&quot;DeliveryType&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span>                                 <span class="s2">&quot;explode(InvoiceLineItems) as LineItem&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">explode_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1">#  |-- InvoiceNumber: string (nullable = true)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">#  |-- CreatedTime: long (nullable = true)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">#  |-- StoreID: string (nullable = true)</span>
<span class="linenos" data-linenos="10 "></span><span class="c1">#  |-- PosID: string (nullable = true)</span>
<span class="linenos" data-linenos="11 "></span><span class="c1">#  |-- CustomerType: string (nullable = true)</span>
<span class="linenos" data-linenos="12 "></span><span class="c1">#  |-- PaymentMethod: string (nullable = true)</span>
<span class="linenos" data-linenos="13 "></span><span class="c1">#  |-- DeliveryType: string (nullable = true)</span>
<span class="linenos" data-linenos="14 "></span><span class="c1">#  |-- LineItem: struct (nullable = true)</span>
<span class="linenos" data-linenos="15 "></span><span class="c1">#  |    |-- ItemCode: string (nullable = true)</span>
<span class="linenos" data-linenos="16 "></span><span class="c1">#  |    |-- ItemDescription: string (nullable = true)</span>
<span class="linenos" data-linenos="17 "></span><span class="c1">#  |    |-- ItemPrice: double (nullable = true)</span>
<span class="linenos" data-linenos="18 "></span><span class="c1">#  |    |-- ItemQty: long (nullable = true)</span>
<span class="linenos" data-linenos="19 "></span><span class="c1">#  |    |-- TotalValue: double (nullable = true)</span>
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Direcciones de las facturas</p>
<p>Cuando el tipo de entrega no es <code>TAKEAWAY</code>, tendremos rellenada la dirección de los pedidos. En ese caso, podemos asignar los campos y aunque haya documentos que no tengan dichos elementos, nuestro pipeline funcionará para ambos casos.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">explode_df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;InvoiceNumber&quot;</span><span class="p">,</span> <span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="s2">&quot;StoreID&quot;</span><span class="p">,</span> <span class="s2">&quot;PosID&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="2 "></span>    <span class="s2">&quot;CustomerType&quot;</span><span class="p">,</span> <span class="s2">&quot;PaymentMethod&quot;</span><span class="p">,</span> <span class="s2">&quot;DeliveryType&quot;</span><span class="p">,</span> <span class="s2">&quot;DeliveryAddress.City&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="3 "></span>    <span class="s2">&quot;DeliveryAddress.State&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="4 "></span>    <span class="s2">&quot;DeliveryAddress.PinCode&quot;</span><span class="p">,</span> <span class="s2">&quot;explode(InvoiceLineItems) as LineItem&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Tras ello, vamos a renombrar los campos para quitar los campos anidados (creando columnas nuevas con el nombre deseando y eliminando la columna <code>LineItem</code>):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">limpio_df</span> <span class="o">=</span> <span class="n">explode_df</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ItemCode&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;LineItem.ItemCode&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ItemDescription&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;LineItem.ItemDescription&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ItemPrice&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;LineItem.ItemPrice&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ItemQty&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;LineItem.ItemQty&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;TotalValue&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;LineItem.TotalValue&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 8 "></span>    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;LineItem&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">limpio_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="11 "></span><span class="c1">#  |-- InvoiceNumber: string (nullable = true)</span>
<span class="linenos" data-linenos="12 "></span><span class="c1">#  |-- CreatedTime: long (nullable = true)</span>
<span class="linenos" data-linenos="13 "></span><span class="c1">#  |-- StoreID: string (nullable = true)</span>
<span class="linenos" data-linenos="14 "></span><span class="c1">#  |-- PosID: string (nullable = true)</span>
<span class="linenos" data-linenos="15 "></span><span class="c1">#  |-- CustomerType: string (nullable = true)</span>
<span class="linenos" data-linenos="16 "></span><span class="c1">#  |-- PaymentMethod: string (nullable = true)</span>
<span class="linenos" data-linenos="17 "></span><span class="c1">#  |-- DeliveryType: string (nullable = true)</span>
<span class="linenos" data-linenos="18 "></span><span class="c1">#  |-- ItemCode: string (nullable = true)</span>
<span class="linenos" data-linenos="19 "></span><span class="c1">#  |-- ItemDescription: string (nullable = true)</span>
<span class="linenos" data-linenos="20 "></span><span class="c1">#  |-- ItemPrice: double (nullable = true)</span>
<span class="linenos" data-linenos="21 "></span><span class="c1">#  |-- ItemQty: long (nullable = true)</span>
<span class="linenos" data-linenos="22 "></span><span class="c1">#  |-- TotalValue: double (nullable = true)</span>
</code></pre></div>
<h3 id="guardando-el-resultado">Guardando el resultado<a class="headerlink" href="#guardando-el-resultado" title="Permanent link">&para;</a></h3>
<p>Una vez tenemos el proceso de transformación de datos, sólo nos queda crear el <em>WriterQuery</em> para escribir el resultado del flujo de datos. En este caso, vamos a almacenarlo también como ficheros en la carpeta <code>salida</code> en formato <em>JSON</em> a intervalos de un minuto:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">facturaWriterQuery</span> <span class="o">=</span> <span class="n">limpio_df</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">&quot;Facturas Writer&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;salida&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="7 "></span>    <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="s2">&quot;1 minute&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="8 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<h3 id="refinando">Refinando<a class="headerlink" href="#refinando" title="Permanent link">&para;</a></h3>
<p>Una vez que vemos que todo funciona, podemos realizar unos ajustes de configuración.</p>
<p>Por ejemplo, vamos a configurar que sólo consuma un fichero cada vez. Para ello, en el <em>reader</em> configuramos la opción <code>maxFilesPerTrigger</code>, la cual permite limitar la cantidad de ficheros de cada micro-batch.</p>
<p>Otras opciones que se usan de manera conjunta son <code>cleanSource</code> y <code>sourceArchiveDir</code>, que permiten archivar los ficheros procesados de forma automática. La opción <code>cleanSource</code> puede tomar los valores <code>archive</code> o <code>delete</code>. Si decidimos archivar, mediante <code>sourceArchiveDir</code> indicamos el destino donde se moverán.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">raw_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;entrada&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;maxFilesPerTrigger&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;cleanSource&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
<p>Hay que tener en cuenta, que tanto archivar como eliminar van a impactar negativamente en el rendimiento de cada micro-batch. Nosotros hemos de limpiar el directorio de entrada, eso es un hecho. Si ejecutamos <em>micro-batch</em> largos, podemos usar la opción <code>cleanSource</code>. En cambio, si nuestros <em>batches</em> son muy cortos y el utilizar <code>cleanSource</code> no es factible por la demora que introduce, debemos crear un proceso de limpieza separado que se ejecute cada X horas y que limpie nuestro directorio de entrada.</p>
<h3 id="monitorizacion">Monitorización<a class="headerlink" href="#monitorizacion" title="Permanent link">&para;</a></h3>
<p>Una vez hemos realizado una consulta, podemos obtener <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#managing-streaming-queries">información</a> sobre la misma de forma programativa:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">facturaWriterQuery</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span> <span class="c1"># muestra una explicación detalla del plan de ejecución</span>
<span class="linenos" data-linenos=" 2 "></span><span class="c1"># == Physical Plan ==</span>
<span class="linenos" data-linenos=" 3 "></span><span class="c1"># *(1) Project [InvoiceNumber#314, CreatedTime#308L, StoreID#319, PosID#317, CustomerType#310, PaymentMethod#316, DeliveryType#312, _extract_City#339 AS City#52, _extract_State#340 AS State#53, _extract_PinCode#341 AS PinCode#54, LineItem#55.ItemCode AS ItemCode#67, LineItem#55.ItemDescription AS ItemDescription#81, LineItem#55.ItemPrice AS ItemPrice#96, LineItem#55.ItemQty AS ItemQty#112L, LineItem#55.TotalValue AS TotalValue#129]</span>
<span class="linenos" data-linenos=" 4 "></span><span class="c1"># ...</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">facturaWriterQuery</span><span class="o">.</span><span class="n">recentProgress</span> <span class="c1"># muestra una lista de los últimos progresos de la consulta</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># [{&#39;id&#39;: &#39;3b6d37cf-6a3c-405e-a715-1dc787f34b00&#39;,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1">#   &#39;runId&#39;: &#39;3dc7c478-626a-4558-87ea-4912da55114d&#39;,</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">#   &#39;name&#39;: &#39;Facturas Writer&#39;,</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">#   &#39;timestamp&#39;: &#39;2022-05-11T08:20:49.058Z&#39;,</span>
<span class="linenos" data-linenos="10 "></span><span class="c1">#   &#39;batchId&#39;: 0,</span>
<span class="linenos" data-linenos="11 "></span><span class="c1">#   &#39;numInputRows&#39;: 500,</span>
<span class="linenos" data-linenos="12 "></span><span class="c1">#   &#39;inputRowsPerSecond&#39;: 0.0,</span>
<span class="linenos" data-linenos="13 "></span><span class="c1">#   &#39;processedRowsPerSecond&#39;: 113.55893708834887,</span>
<span class="linenos" data-linenos="14 "></span><span class="c1">#   &#39;durationMs&#39;: {&#39;addBatch&#39;: 2496,</span>
<span class="linenos" data-linenos="15 "></span><span class="c1"># ...</span>
<span class="linenos" data-linenos="16 "></span><span class="n">facturaWriterQuery</span><span class="o">.</span><span class="n">lastProgress</span> <span class="c1"># muestra el último progreso</span>
<span class="linenos" data-linenos="17 "></span><span class="c1"># {&#39;id&#39;: &#39;3b6d37cf-6a3c-405e-a715-1dc787f34b00&#39;,</span>
<span class="linenos" data-linenos="18 "></span><span class="c1">#  &#39;runId&#39;: &#39;3dc7c478-626a-4558-87ea-4912da55114d&#39;,</span>
<span class="linenos" data-linenos="19 "></span><span class="c1">#  &#39;name&#39;: &#39;Facturas Writer&#39;,</span>
<span class="linenos" data-linenos="20 "></span><span class="c1">#  &#39;timestamp&#39;: &#39;2022-05-11T08:33:00.001Z&#39;,</span>
<span class="linenos" data-linenos="21 "></span><span class="c1">#  &#39;batchId&#39;: 3,</span>
<span class="linenos" data-linenos="22 "></span><span class="c1">#  &#39;numInputRows&#39;: 0,</span>
<span class="linenos" data-linenos="23 "></span><span class="c1">#  &#39;inputRowsPerSecond&#39;: 0.0,</span>
<span class="linenos" data-linenos="24 "></span><span class="c1">#  &#39;processedRowsPerSecond&#39;: 0.0,</span>
<span class="linenos" data-linenos="25 "></span><span class="c1">#  &#39;durationMs&#39;: {&#39;latestOffset&#39;: 5, &#39;triggerExecution&#39;: 8},</span>
<span class="linenos" data-linenos="26 "></span><span class="c1"># ...</span>
</code></pre></div>
<p>Estas mismas estadísticas las podemos obtener de forma gráfica. Al ejecutar procesos en Streaming, si accedemos a Spark UI, ahora podremos ver la pestaña <em>Structured Streaming</em> con información detallada de la cantidad datos de entrada, tiempo procesado y duración de los micro-batches:</p>
<figure style="align: center;">
    <img src="images/03streaming-ui.png" width="500">
    <figcaption>Spark UI en Structured Streaming</figcaption>
</figure>

<p>Además, podemos iniciar tantas consultas como queramos en una única sesión de Spark, las cuales se ejecutarán de forma concurrente utilizando los recursos del clúster de Spark.</p>
<h2 id="tolerancia-a-fallos">Tolerancia a fallos<a class="headerlink" href="#tolerancia-a-fallos" title="Permanent link">&para;</a></h2>
<p>Un aplicación en <em>streaming</em> se espera que se ejecute de forma ininterrumpida mediante un bucle infinito de micro-batches.</p>
<p>Realmente, un escenario de ejecución infinita no es posible, ya que la aplicación se detendrá por:</p>
<ul>
<li>un fallo, ya sea por un dato mal formado o un error de red.</li>
<li>mantenimiento del sistema, para actualizar la aplicación o el hardware donde corre.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Tipos de entrega</p>
<p>Cuando los datos llegar a un motor de <em>streaming</em> de datos, este es responsable de su procesado. Para tratar la tolerancia a fallos, existen tres escenarios posibles:</p>
<p><figure style="float: right">
    <img src="images/03streaming-delivery.jpg" width="300">
    <figcaption>Tipos de entrega de mensajes</figcaption>
</figure></p>
<ul>
<li>Una vez como mucho (<em>at most once</em>): no se entrega más de una copia de un dato. Es decir, puede darse el caso de que no llegue, pero no habrá repetidos.</li>
<li>Una vez al menos (<em>at least once</em>): en este caso no habrá pérdidas, pero un dato puede llegar más de una vez. </li>
<li>Una vez exacta (<em>exactly once</em>): se garantiza que cada dato se entrega una única vez, sin pérdidas ni duplicados.</li>
</ul>
</div>
<p>Por ello, una aplicación <em>Spark Streaming</em> se debe reiniciar de forma transparente para mantener la característica de <strong><em>exactly-once</em></strong> la cual implica que:</p>
<ol>
<li>No se pierde ningún registro</li>
<li>No crea registros duplicados.</li>
</ol>
<p>Para ello, <em>Spark Structured Streaming</em> mantiene el estado de los micro-batches mediante <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#recovering-from-failures-with-checkpointing"><em>checkpoints</em></a> que se almacenan en la carpeta indicada por la opción <code>checkpointLocation</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">facturaWriterQuery</span> <span class="o">=</span> <span class="n">limpio_df</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">&quot;Facturas Writer&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;salida&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="7 "></span>    <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="s2">&quot;1 minute&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="8 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>La localización de esta carpeta debería ser un sistema de archivo confiable y tolerante a fallos, como HDFS o Amazon S3.</p>
<p>Esta carpeta contiene dos elementos:</p>
<ul>
<li>Posición de lectura, que realiza la misma función que los <em>offset</em> en Kafka, y representa el inicio y el final del rango de datos procesados por el actual <em>micro-batch</em>, de manera que Spark conoce el progreso exacto del procesamiento. Una vez ha finalizado el <em>micro-batch</em>, Spark realiza un <em>commit</em> para indicar que se han procesado los datos de forma exitosa.</li>
<li>Información del estado, que contiene los datos intermedios del <em>micro-batch</em>, como la cantidad total de palabras contadas.</li>
</ul>
<p>De esta manera, Spark mantiene toda la información necesaria para reiniciar un micro-batch que no ha finalizado. Sin embargo, la capacidad de reiniciarse no tiene por qué garantizar la política <em>exactly-once</em>. Para ello, es necesario cumplir los siguientes requisitos:</p>
<ol>
<li>Reiniciar la aplicación con el mismo <code>checkpointLocation</code>. Si se elimina la carpeta o se ejecuta la misma consulta sobre otro directorio de <em>checkpoint</em> es como si realizásemos una consulta desde 0.</li>
<li>Utilizar una fuente de datos que permita volver a leer los datos incompletos del <em>micro-batch</em>, por ejemplo, tanto los ficheros de texto como <em>Kafka</em> permiten volver a leer los datos desde un punto determinado. Sin embargo, los datos que provienen de un socket no permite volver a leerlos.</li>
<li>Asegurar que la lógica de aplicación, dados los mismos datos de entrada, produce siempre el mismo resultado (aplicación determinista). Si por ejemplo, nuestra lógica de aplicación utilizará alguna dependencia basada en fechas o el tiempo, ya no obtendríamos el mismo resultado.</li>
<li>El destino (<em>sink</em>) debe ser capaz de identificar los elementos duplicados e ignorarlos o actualizar la copia antigua con el mismo registro, es decir, son idempotentes.</li>
</ol>
<h2 id="caso-3-consumiendo-kafka">Caso 3: Consumiendo <em>Kafka</em><a class="headerlink" href="#caso-3-consumiendo-kafka" title="Permanent link">&para;</a></h2>
<p>Cuando el tiempo de procesamiento debe ser inferior del orden de minutos, trabajar con ficheros deja de ser una opción.</p>
<p>Para este caso, vamos a simular el caso anterior, pero en vez de ficheros, vamos a cargar los datos desde <a href="https://spark.apache.org/docs/latest/structured-streaming-kafka-integration.html"><em>Kafka</em></a> y seguiremos generando los datos en un sistema de archivos.</p>
<figure style="align: center;">
    <img src="images/03spark-caso3.png" width="600">
    <figcaption>Arquitectura caso 3</figcaption>
</figure>

<p>FIXME: corregir</p>
<p>Antes de comenzar, necesitamos configurar el paquete <code>spark-sql-kafka</code> en <em>Spark</em>. Para ello, lo configuraremos en el archivo <code>spark-defaults.conf</code> que tenemos en <code>/opt/spark-3.3.1/conf</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>spark.jars.packages     org.apache.spark:spark-sql-kafka-0-10_2.12:3.2.1
</code></pre></div>
<p>Una vez configurado, ya podemos arrancar <code>pyspark</code> y crear la sesión y el <em>DataFrame</em> de lectura:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Kafka Streaming&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[3]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">kafkaDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="hll"><span class="linenos" data-linenos=" 9 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;kafka&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos="10 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;kafka.bootstrap.servers&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd-virtualbox:9092&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos="11 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;facturas&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos="12 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;startingOffsets&quot;</span><span class="p">,</span> <span class="s2">&quot;earliest&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="13 "></span>        <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
<p>De esta manera nos subscribimos al topic <code>facturas</code> y realizamos la lectura desde el inicio.</p>
<p>Antes de poder ejecutar el <em>reader</em>, hemos de arrancar Kafka y crear el topic <code>facturas</code>. Para ello, una vez estamos en la carpeta de instalación de Kafka (en nuestro caso <code>/opt/kafka_2.13-2.8.1</code>), ejecutaremos los siguientes comandos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>zookeeper-server-start.sh<span class="w"> </span>./config/zookeeper.properties
<span class="linenos" data-linenos="2 "></span>kafka-server-start.sh<span class="w"> </span>./config/server.properties
<span class="linenos" data-linenos="3 "></span>kafka-topics.sh<span class="w"> </span>--create<span class="w"> </span>--topic<span class="w"> </span>facturas<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
</code></pre></div>
<p>Si mostramos el esquema tenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">kafkaDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="2 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="3 "></span><span class="c1">#  |-- key: binary (nullable = true)</span>
<span class="linenos" data-linenos="4 "></span><span class="c1">#  |-- value: binary (nullable = true)</span>
<span class="linenos" data-linenos="5 "></span><span class="c1">#  |-- topic: string (nullable = true)</span>
<span class="linenos" data-linenos="6 "></span><span class="c1">#  |-- partition: integer (nullable = true)</span>
<span class="linenos" data-linenos="7 "></span><span class="c1">#  |-- offset: long (nullable = true)</span>
<span class="linenos" data-linenos="8 "></span><span class="c1">#  |-- timestamp: timestamp (nullable = true)</span>
<span class="linenos" data-linenos="9 "></span><span class="c1">#  |-- timestampType: integer (nullable = true)</span>
</code></pre></div>
<p>Donde podemos ver que cada mensaje tiene una <code>key</code> y un <code>value</code>, así como otros campos relativos a <em>Kafka</em> que <em>Spark</em> utilizará para gestionar la tolerancia a fallos.</p>
<p>Es importante destacar que el campo <code>value</code> es de tipo binario, por lo que necesitamos pasarlo a formato JSON.</p>
<h3 id="leyendo-datos">Leyendo datos<a class="headerlink" href="#leyendo-datos" title="Permanent link">&para;</a></h3>
<p>Para poder leer los datos, necesitamos indicar el esquema del campo <code>value</code>. Para ello, primero definimos el esquema:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">ArrayType</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">esquema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;InvoiceNumber&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="n">LongType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;StoreID&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;PosID&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CashierID&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CustomerType&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CustomerCardNo&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;TotalAmount&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;NumberOfItems&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;PaymentMethod&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CGST&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;SGST&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CESS&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;DeliveryType&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;DeliveryAddress&quot;</span><span class="p">,</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="18 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;AddressLine&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="19 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;City&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="20 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="21 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;PinCode&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="22 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ContactNumber&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="linenos" data-linenos="23 "></span>    <span class="p">])),</span>
<span class="linenos" data-linenos="24 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;InvoiceLineItems&quot;</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="25 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemCode&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="26 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemDescription&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="27 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemPrice&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="28 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemQty&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
<span class="linenos" data-linenos="29 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;TotalValue&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">())</span>
<span class="linenos" data-linenos="30 "></span>    <span class="p">]))),</span>
<span class="linenos" data-linenos="31 "></span><span class="p">])</span>
</code></pre></div>
<p>Una vez que tenemos el esquema, necesitamos realizar un <em>casting</em> de la columna para cargarla como si fuese un <em>string</em> y deserializar los datos a formato JSON mediante <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.from_json.html"><code>from_json</code></a>:</p>
<div class="admonition tip">
<p class="admonition-title">Kafka Source - CSV y Avro</p>
<p>Si los datos estuviesen en formato <em>CSV</em> usaremos <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.from_csv.html"><code>from_csv</code></a> o si el formato fuese <em>Avro</em> utilizaríamos <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.avro.functions.from_avro.html"><code>from_avro</code></a>).</p>
<p>Más información sobre <em>Avro</em> y <em>Spark</em> en la <a href="https://spark.apache.org/docs/latest/sql-data-sources-avro.html">documentación oficial</a>.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">from_json</span><span class="p">,</span> <span class="n">col</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">valueDF</span> <span class="o">=</span> <span class="n">kafkaDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">from_json</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">),</span> <span class="n">esquema</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">valueDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos=" 4 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos=" 5 "></span><span class="c1">#  |-- value: struct (nullable = true)</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1">#  |    |-- InvoiceNumber: string (nullable = true)</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1">#  |    |-- CreatedTime: long (nullable = true)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">#  |    |-- StoreID: string (nullable = true)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">#  |    |-- PosID: string (nullable = true)</span>
<span class="linenos" data-linenos="10 "></span><span class="c1">#  |    |-- CashierID: string (nullable = true)</span>
<span class="linenos" data-linenos="11 "></span><span class="c1">#  |    |-- CustomerType: string (nullable = true)</span>
<span class="linenos" data-linenos="12 "></span><span class="c1">#  |    |-- CustomerCardNo: string (nullable = true)</span>
<span class="linenos" data-linenos="13 "></span><span class="c1">#  |    |-- TotalAmount: double (nullable = true)</span>
<span class="linenos" data-linenos="14 "></span><span class="c1">#  |    |-- NumberOfItems: integer (nullable = true)</span>
<span class="linenos" data-linenos="15 "></span><span class="c1">#  |    |-- PaymentMethod: string (nullable = true)</span>
<span class="linenos" data-linenos="16 "></span><span class="c1">#  |    |-- CGST: double (nullable = true)</span>
<span class="linenos" data-linenos="17 "></span><span class="c1">#  |    |-- SGST: double (nullable = true)</span>
<span class="linenos" data-linenos="18 "></span><span class="c1">#  |    |-- CESS: double (nullable = true)</span>
<span class="linenos" data-linenos="19 "></span><span class="c1">#  |    |-- DeliveryType: string (nullable = true)</span>
<span class="linenos" data-linenos="20 "></span><span class="c1">#  |    |-- DeliveryAddress: struct (nullable = true)</span>
<span class="linenos" data-linenos="21 "></span><span class="c1">#  |    |    |-- AddressLine: string (nullable = true)</span>
<span class="linenos" data-linenos="22 "></span><span class="c1">#  |    |    |-- City: string (nullable = true)</span>
<span class="linenos" data-linenos="23 "></span><span class="c1">#  |    |    |-- State: string (nullable = true)</span>
<span class="linenos" data-linenos="24 "></span><span class="c1">#  |    |    |-- PinCode: string (nullable = true)</span>
<span class="linenos" data-linenos="25 "></span><span class="c1">#  |    |    |-- ContactNumber: string (nullable = true)</span>
<span class="linenos" data-linenos="26 "></span><span class="c1">#  |    |-- InvoiceLineItems: array (nullable = true)</span>
<span class="linenos" data-linenos="27 "></span><span class="c1">#  |    |    |-- element: struct (containsNull = true)</span>
<span class="linenos" data-linenos="28 "></span><span class="c1">#  |    |    |    |-- ItemCode: string (nullable = true)</span>
<span class="linenos" data-linenos="29 "></span><span class="c1">#  |    |    |    |-- ItemDescription: string (nullable = true)</span>
<span class="linenos" data-linenos="30 "></span><span class="c1">#  |    |    |    |-- ItemPrice: double (nullable = true)</span>
<span class="linenos" data-linenos="31 "></span><span class="c1">#  |    |    |    |-- ItemQty: integer (nullable = true)</span>
<span class="linenos" data-linenos="32 "></span><span class="c1">#  |    |    |    |-- TotalValue: double (nullable = true)</span>
</code></pre></div>
<p>De la misma manera que hicimos en el caso anterior, vamos a realizar la operación <code>explode</code> para desenrollar las líneas de facturas (en este caso, con los campos de dirección incluidos) y luego renombramos los campos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kc">fr</span><span class="err">om</span><span class="w"> </span><span class="err">pyspark.sql.</span><span class="kc">fun</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">ns</span><span class="w"> </span><span class="err">impor</span><span class="kc">t</span><span class="w"> </span><span class="err">expr</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="err">explodeDF</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">valueDF.selec</span><span class="kc">t</span><span class="err">Expr(</span><span class="s2">&quot;value.InvoiceNumber&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value.CreatedTime&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="s2">&quot;value.StoreID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value.PosID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value.CustomerType&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="s2">&quot;value.PaymentMethod&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value.DeliveryType&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value.DeliveryAddress.City&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="s2">&quot;value.DeliveryAddress.State&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value.DeliveryAddress.PinCode&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="s2">&quot;explode(value.InvoiceLineItems) as LineItem&quot;</span><span class="err">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="err">limpioDF</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">explodeDF</span><span class="w"> </span><span class="err">\</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="err">.wi</span><span class="kc">t</span><span class="err">hColum</span><span class="kc">n</span><span class="err">(</span><span class="s2">&quot;ItemCode&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">expr(</span><span class="s2">&quot;LineItem.ItemCode&quot;</span><span class="err">))</span><span class="w"> </span><span class="err">\</span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="err">.wi</span><span class="kc">t</span><span class="err">hColum</span><span class="kc">n</span><span class="err">(</span><span class="s2">&quot;ItemDescription&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">expr(</span><span class="s2">&quot;LineItem.ItemDescription&quot;</span><span class="err">))</span><span class="w"> </span><span class="err">\</span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="err">.wi</span><span class="kc">t</span><span class="err">hColum</span><span class="kc">n</span><span class="err">(</span><span class="s2">&quot;ItemPrice&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">expr(</span><span class="s2">&quot;LineItem.ItemPrice&quot;</span><span class="err">))</span><span class="w"> </span><span class="err">\</span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="err">.wi</span><span class="kc">t</span><span class="err">hColum</span><span class="kc">n</span><span class="err">(</span><span class="s2">&quot;ItemQty&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">expr(</span><span class="s2">&quot;LineItem.ItemQty&quot;</span><span class="err">))</span><span class="w"> </span><span class="err">\</span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="err">.wi</span><span class="kc">t</span><span class="err">hColum</span><span class="kc">n</span><span class="err">(</span><span class="s2">&quot;TotalValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">expr(</span><span class="s2">&quot;LineItem.TotalValue&quot;</span><span class="err">))</span><span class="w"> </span><span class="err">\</span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="err">.drop(</span><span class="s2">&quot;LineItem&quot;</span><span class="err">)</span>
</code></pre></div>
<h3 id="comprobando-el-resultado">Comprobando el resultado<a class="headerlink" href="#comprobando-el-resultado" title="Permanent link">&para;</a></h3>
<p>Y finalmente creamos la consulta de <em>streaming</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">facturaWriterQuery</span>  <span class="o">=</span> <span class="n">limpioDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos=" 2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">&quot;Facturas Kafka Writer&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;salida&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="s2">&quot;1 minute&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 8 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="n">facturaWriterQuery</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Una vez lanzado, volvemos a un terminal y creamos un productor:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>kafka-console-producer.sh<span class="w"> </span>--topic<span class="w"> </span>facturas<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
</code></pre></div>
<p>Y sobre el terminal, le pegamos una factura:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span><span class="nt">&quot;CashierID&quot;</span><span class="p">:</span><span class="s2">&quot;OAS134&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerCardNo&quot;</span><span class="p">:</span><span class="s2">&quot;4629185211&quot;</span><span class="p">,</span><span class="nt">&quot;TotalAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span><span class="nt">&quot;NumberOfItems&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span><span class="nt">&quot;TaxableAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span><span class="nt">&quot;CGST&quot;</span><span class="p">:</span><span class="mf">277.85</span><span class="p">,</span><span class="nt">&quot;SGST&quot;</span><span class="p">:</span><span class="mf">277.85</span><span class="p">,</span><span class="nt">&quot;CESS&quot;</span><span class="p">:</span><span class="mf">13.8925</span><span class="p">,</span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span><span class="nt">&quot;InvoiceLineItems&quot;</span><span class="p">:[{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;458&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Wine glass&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1644.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">3288.0</span><span class="p">},{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;283&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Portable Lamps&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">},{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;498&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Carving knifes&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1424.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2848.0</span><span class="p">},{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;523&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Oil-lamp clock&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1371.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2742.0</span><span class="p">}]}</span>
</code></pre></div>
<p>Si nos vamos a la carpeta <code>salida</code>, veremos que ha creado un fichero con tantos documentos como líneas de factura tiene el documento anterior:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;458&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Wine glass&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1644.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">3288.0</span><span class="p">}</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;283&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Portable Lamps&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">}</span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;498&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Carving knifes&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1424.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2848.0</span><span class="p">}</span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;523&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Oil-lamp clock&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1371.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2742.0</span><span class="p">}</span>
</code></pre></div>
<p>Si nos dedicamos a pegar diferentes facturas (tienes más en <a href="resources/facturasKafka.json"><code>facturasKafka.json</code></a>), cada minuto se generará un nuevo archivo.</p>
<div class="admonition caution">
<p class="admonition-title">Limpieza</p>
<p>Recuerda que si quieres volver a ejecutar el código, debes eliminar la carpeta <code>chk-point-dir</code> así como la carpeta de <code>salida</code>.</p>
</div>
<h2 id="caso-4-produciendo-a-kafka">Caso 4: Produciendo a <em>Kafka</em><a class="headerlink" href="#caso-4-produciendo-a-kafka" title="Permanent link">&para;</a></h2>
<p>Vamos a plantear que en vez de los ficheros de datos que generábamos con las líneas de las facturas, queremos crear un documento que contenga:</p>
<ul>
<li>código del cliente: <code>CustomerCardNo</code></li>
<li>cantidad total: <code>TotalAmount</code></li>
<li>puntos de fidelidad obtenidos: <code>EarnedLoyaltyPoints</code>, el cual se obtiene a partir de <code>TotalAmount</code> * <code>0.2</code></li>
</ul>
<figure style="align: center;">
    <img src="images/03spark-caso4.png" width="600">
    <figcaption>Arquitectura caso 4</figcaption>
</figure>

<p>Además, este documento que generamos lo queremos enviar a un nuevo <em>topic</em> de Kafka (<code>notificaciones</code>) para que lo consuma otra aplicación, indicando como clave el número de factura (<code>InvoiceNumber</code>) y como valor el documento creado.</p>
<p>Comenzamos de la misma forma que el caso anterior, creando los recursos de Kafka en diferentes terminales:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>zookeeper-server-start.sh<span class="w"> </span>./config/zookeeper.properties
<span class="linenos" data-linenos="2 "></span>kafka-server-start.sh<span class="w"> </span>./config/server.properties
<span class="linenos" data-linenos="3 "></span>kafka-topics.sh<span class="w"> </span>--create<span class="w"> </span>--topic<span class="w"> </span>facturas<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
<span class="linenos" data-linenos="4 "></span>kafka-topics.sh<span class="w"> </span>--create<span class="w"> </span>--topic<span class="w"> </span>notificaciones<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
</code></pre></div>
<p>A continuación, en nuestro cuaderno <em>Jupyter</em>, creamos la sesión y conectamos con Kafka:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Kafka Streaming Sink&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[3]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">kafkaDFS</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="hll"><span class="linenos" data-linenos=" 9 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;kafka&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos="10 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;kafka.bootstrap.servers&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd-virtualbox:9092&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos="11 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;facturas&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos="12 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;startingOffsets&quot;</span><span class="p">,</span> <span class="s2">&quot;earliest&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos="13 "></span>        <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
<p>Y volvemos a definir el esquema:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">ArrayType</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">esquema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;InvoiceNumber&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="n">LongType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;StoreID&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;PosID&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CashierID&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CustomerType&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CustomerCardNo&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;TotalAmount&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;NumberOfItems&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;PaymentMethod&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CGST&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;SGST&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CESS&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;DeliveryType&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;DeliveryAddress&quot;</span><span class="p">,</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="18 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;AddressLine&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="19 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;City&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="20 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="21 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;PinCode&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="22 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ContactNumber&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="linenos" data-linenos="23 "></span>    <span class="p">])),</span>
<span class="linenos" data-linenos="24 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;InvoiceLineItems&quot;</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="25 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemCode&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="26 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemDescription&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="27 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemPrice&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">()),</span>
<span class="linenos" data-linenos="28 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ItemQty&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
<span class="linenos" data-linenos="29 "></span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;TotalValue&quot;</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">())</span>
<span class="linenos" data-linenos="30 "></span>    <span class="p">]))),</span>
<span class="linenos" data-linenos="31 "></span><span class="p">])</span>
</code></pre></div>
<h3 id="creando-las-notificaciones">Creando las notificaciones<a class="headerlink" href="#creando-las-notificaciones" title="Permanent link">&para;</a></h3>
<p>Una vez hemos recuperado los datos con el esquema, vamos a elegir las columnas que necesitamos y posteriormente vamos a transformar el <em>DataFrame</em> para crear <strong>solo dos columnas</strong> (este es el requisito de los mensajes de <em>Kafka</em>), una formada por la clave que llamaremos <code>key</code> y que contendrá el campo <code>InvoiceNumber</code>, y otra columna que llamaremos <code>value</code> y contendrá el documento JSON serializado con los campos que nos interesan enviar al <em>topic</em> de <code>notificaciones</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">from_json</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">valueDF</span> <span class="o">=</span> <span class="n">kafkaDFS</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">from_json</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">),</span> <span class="n">esquema</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">notificationDF</span> <span class="o">=</span> <span class="n">valueDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;value.InvoiceNumber&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span>        <span class="s2">&quot;value.CustomerCardNo&quot;</span><span class="p">,</span> <span class="s2">&quot;value.TotalAmount&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;LoyaltyPoints&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;TotalAmount * 0.2&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># Transformamos las cuatro columnas en lo que espera Kafka, un par de (key, value)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">kafkaTargetDF</span> <span class="o">=</span> <span class="n">notificationDF</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;InvoiceNumber as key&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span><span class="w">        </span><span class="sd">&quot;&quot;&quot;to_json(named_struct(</span>
<span class="linenos" data-linenos="11 "></span><span class="sd">        &#39;CustomerCardNo&#39;, CustomerCardNo,</span>
<span class="linenos" data-linenos="12 "></span><span class="sd">        &#39;TotalAmount&#39;, TotalAmount,</span>
<span class="linenos" data-linenos="13 "></span><span class="sd">        &#39;EarnedLoyaltyPoints&#39;, TotalAmount * 0.2)) as value&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<p>La función <code>named_struct</code> crea un mapa formado por múltiples pares de (clave, valor), los cuales recibe de forma secuencial. Pues ver ejemplos de su uso de la mano de <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.to_json.html"><code>to_json</code></a> en la <a href="https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html#json-functions">documentación oficial</a>.</p>
<div class="admonition tip">
<p class="admonition-title">Kafka Sink - CSV y Avro</p>
<p>Del mismo modo que hemos explicado antes, si queremos trabajar con CSV podemos utilizar la función <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.to_csv.html"><code>to_csv</code></a>. En cambio, si el formato de nuestros datos fuera <em>Avro</em> utilizaríamos la función <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.avro.functions.to_avro.html"><code>to_avro</code></a>.</p>
</div>
<p>Finalmente, lanzamos la consulta, destacando que para indicar el <em>topic</em> ahora utilizaremos la opción <code>topic</code> (en vez de <code>subscribe</code> que utilizamos en el <em>reader</em>) :</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">notificacionWriterQuery</span> <span class="o">=</span> <span class="n">kafkaTargetDF</span> \
<span class="linenos" data-linenos=" 2 "></span>    <span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">&quot;Notificaciones Writer&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;kafka&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;kafka.bootstrap.servers&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd-virtualbox:9092&quot;</span><span class="p">)</span> \
</span><span class="hll"><span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;topic&quot;</span><span class="p">,</span> <span class="s2">&quot;notificaciones&quot;</span><span class="p">)</span> \
</span><span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 8 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 9 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="n">notificacionWriterQuery</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Para comprobar que funciona correctamente, una vez lanzada la consulta, volvemos a un terminal y creamos un consumidor que quede a la escucha del <em>topic</em> <code>notificaciones</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>kafka-console-consumer.sh<span class="w"> </span>--topic<span class="w"> </span>notificaciones<span class="w"> </span>--from-beginning<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
</code></pre></div>
<p>Y tras ello, lanzamos un productor al <em>topic</em> <code>facturas</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>kafka-console-producer.sh<span class="w"> </span>--topic<span class="w"> </span>facturas<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
</code></pre></div>
<p>Y sobre el terminal, le pegamos una factura al productor:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;InvoiceNumber&quot;</span><span class="p">:</span><span class="s2">&quot;51402977&quot;</span><span class="p">,</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="mi">1595688900348</span><span class="p">,</span><span class="nt">&quot;StoreID&quot;</span><span class="p">:</span><span class="s2">&quot;STR7188&quot;</span><span class="p">,</span><span class="nt">&quot;PosID&quot;</span><span class="p">:</span><span class="s2">&quot;POS956&quot;</span><span class="p">,</span><span class="nt">&quot;CashierID&quot;</span><span class="p">:</span><span class="s2">&quot;OAS134&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerType&quot;</span><span class="p">:</span><span class="s2">&quot;PRIME&quot;</span><span class="p">,</span><span class="nt">&quot;CustomerCardNo&quot;</span><span class="p">:</span><span class="s2">&quot;4629185211&quot;</span><span class="p">,</span><span class="nt">&quot;TotalAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span><span class="nt">&quot;NumberOfItems&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="nt">&quot;PaymentMethod&quot;</span><span class="p">:</span><span class="s2">&quot;CARD&quot;</span><span class="p">,</span><span class="nt">&quot;TaxableAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span><span class="nt">&quot;CGST&quot;</span><span class="p">:</span><span class="mf">277.85</span><span class="p">,</span><span class="nt">&quot;SGST&quot;</span><span class="p">:</span><span class="mf">277.85</span><span class="p">,</span><span class="nt">&quot;CESS&quot;</span><span class="p">:</span><span class="mf">13.8925</span><span class="p">,</span><span class="nt">&quot;DeliveryType&quot;</span><span class="p">:</span><span class="s2">&quot;TAKEAWAY&quot;</span><span class="p">,</span><span class="nt">&quot;InvoiceLineItems&quot;</span><span class="p">:[{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;458&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Wine glass&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1644.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">3288.0</span><span class="p">},{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;283&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Portable Lamps&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2236.0</span><span class="p">},{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;498&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Carving knifes&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1424.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2848.0</span><span class="p">},{</span><span class="nt">&quot;ItemCode&quot;</span><span class="p">:</span><span class="s2">&quot;523&quot;</span><span class="p">,</span><span class="nt">&quot;ItemDescription&quot;</span><span class="p">:</span><span class="s2">&quot;Oil-lamp clock&quot;</span><span class="p">,</span><span class="nt">&quot;ItemPrice&quot;</span><span class="p">:</span><span class="mf">1371.0</span><span class="p">,</span><span class="nt">&quot;ItemQty&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;TotalValue&quot;</span><span class="p">:</span><span class="mf">2742.0</span><span class="p">}]}</span>
</code></pre></div>
<p>Y veremos como el consumidor nos muestra el documento con las diferentes notificaciones:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;CustomerCardNo&quot;</span><span class="p">:</span><span class="s2">&quot;4629185211&quot;</span><span class="p">,</span><span class="nt">&quot;TotalAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span><span class="nt">&quot;EarnedLoyaltyPoints&quot;</span><span class="p">:</span><span class="mf">2222.8</span><span class="p">}</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="nt">&quot;CustomerCardNo&quot;</span><span class="p">:</span><span class="s2">&quot;2762345282&quot;</span><span class="p">,</span><span class="nt">&quot;TotalAmount&quot;</span><span class="p">:</span><span class="mf">8272.0</span><span class="p">,</span><span class="nt">&quot;EarnedLoyaltyPoints&quot;</span><span class="p">:</span><span class="mf">1654.4</span><span class="p">}</span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="nt">&quot;CustomerCardNo&quot;</span><span class="p">:</span><span class="s2">&quot;2599848717&quot;</span><span class="p">,</span><span class="nt">&quot;TotalAmount&quot;</span><span class="p">:</span><span class="mf">3374.0</span><span class="p">,</span><span class="nt">&quot;EarnedLoyaltyPoints&quot;</span><span class="p">:</span><span class="mf">674.8000000000001</span><span class="p">}</span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="nt">&quot;CustomerCardNo&quot;</span><span class="p">:</span><span class="s2">&quot;4629185211&quot;</span><span class="p">,</span><span class="nt">&quot;TotalAmount&quot;</span><span class="p">:</span><span class="mf">11114.0</span><span class="p">,</span><span class="nt">&quot;EarnedLoyaltyPoints&quot;</span><span class="p">:</span><span class="mf">2222.8</span><span class="p">}</span>
</code></pre></div>
<p>Más información en la <a href="https://spark.apache.org/docs/latest/structured-streaming-kafka-integration.html">documentación oficial</a> sobre integración de <em>Kafka</em> con <em>Spark Streaming</em>.</p>
<h2 id="caso-5-windowing">Caso 5: Windowing<a class="headerlink" href="#caso-5-windowing" title="Permanent link">&para;</a></h2>
<p>Al realizar agregaciones basadas en el tiempo, es importante aclarar el concepto de ventana temporal (<em>windowing</em>). Una ventana temporal puede durar una semana, una hora, un minuto o incluso un segundo.</p>
<p>Estas ventanas permiten acotar los datos sobre un flujo que en principio no tiene un inicio ni un fin predefinidos.</p>
<p>Existen diferentes tipos de ventanas temporales:</p>
<ul>
<li>de tamaño fijo (<em>fixed/tumbling window</em>): divide los flujos de datos en segmentos fijos, con un tamaño de ventana, un tiempo de inicio y uno de finalización. En este tipo, cada dato se asigna a una única ventana, de manera que es fácil realizar agregaciones como la suma, el máximo o la media.</li>
<li>deslizantes (<em>sliding</em>): cada ventana tiene una longitud y un intervalo de deslizamiento. Si el intervalo tiene el mismo tamaño que la ventana, actúa igual que una ventana de tamaño fijo. En la imagen podemos ver un intervalo de deslizamiento más pequeño que el tamaño de la ventana, lo que implica que un dato puede llegar a más de una ventana. Como las ventana deslizantes se solapan, la agregaciones de datos producen resultados más precisos que con ventanas de tamaño fijo.</li>
<li>de sesión (<em>session</em>): se utiliza para analizar el comportamiento de usuario de un sitio web. No tienen un tamaño definido, sino que se define por la duración de la navegación del usuario.</li>
</ul>
<figure style="align: center;">
    <img src="images/03streaming-windowing.jpg">
    <figcaption>Tipos de ventanas temporales</figcaption>
</figure>

<h3 id="ventana-fija">Ventana fija<a class="headerlink" href="#ventana-fija" title="Permanent link">&para;</a></h3>
<p>Del código del caso 1, vamos a modificar algunos aspectos para agrupar los datos recibidos en una ventana de dos minutos. Al leer los datos, vamos a indicar que queremos obtener el <em>timestamp</em> de cada dato:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">lines_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;9999&quot;</span><span class="p">)</span> \
<span class="hll"><span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;includeTimestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span>\
</span><span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
<p>Cuando preparamos el dataframe con las palabras, vamos a incluir también el <em>timestamp</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">explode</span><span class="p">,</span> <span class="n">split</span>
<span class="linenos" data-linenos="2 "></span><span class="n">words_df</span> <span class="o">=</span> <span class="n">lines_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<span class="linenos" data-linenos="3 "></span>    <span class="n">explode</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">lines_df</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;palabra&#39;</span><span class="p">),</span>
<span class="hll"><span class="linenos" data-linenos="4 "></span>    <span class="n">lines_df</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span></code></pre></div>
<p>Y con las palabras, utilizando la función <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.window.html"><code>window</code></a> con una ventana fija de 2 minutos, agrupamos tanto la ventana temporal como cada palabra para obtener su cantidad:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowedCounts</span> <span class="o">=</span> <span class="n">words_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>
<span class="hll"><span class="linenos" data-linenos="3 "></span>    <span class="n">window</span><span class="p">(</span><span class="n">words_df</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;2 minutes&quot;</span><span class="p">),</span> <span class="n">words_df</span><span class="o">.</span><span class="n">palabra</span>
</span><span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Finalmente, realizamos la consulta (vamos a indicar que no trunque los datos para poder visualizar toda la información de la ventana)</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">word_count_query</span> <span class="o">=</span> <span class="n">windowedCounts</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;truncate&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>\
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>Tras ejecutar el servidor de <em>sockets</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>nc<span class="w"> </span>-lk<span class="w"> </span><span class="m">9999</span>
</code></pre></div>
<p>Introducimos la siguientes frases:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>Hola Mundo
<span class="linenos" data-linenos="2 "></span>Hola desde el Severo
</code></pre></div>
<p>Y obtenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">1</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos="12 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">2</span>
<span class="linenos" data-linenos="13 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos="14 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="19 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="20 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="21 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="22 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Para cada palabra introducida dentro de la misma ventana temporal (en nuestro caso la hemos definido de 2 minutos, nos cuenta sus ocurrencias).</p>
<p>Si nos esperamos un par de minutos y enviamos <code>Severo Ochoa y el Mundo</code>, obtenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">3</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">y</span>      <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="18 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Podemos observar como las palabras de esta última frase han entrado en una ventana diferente, y por tanto, al agruparse se cuentan desde 0.</p>
<h3 id="ventanas-deslizantes">Ventanas deslizantes<a class="headerlink" href="#ventanas-deslizantes" title="Permanent link">&para;</a></h3>
<p>Ya hemos visto como funcionan las ventanas fijas. Con las ventanas deslizantes, vamos a poder recoger datos en más de una ventana a la vez:</p>
<figure style="align: center;">
    <img src="images/03streaming-slideWindow.jpg">
    <figcaption>Ventana deslizante</figcaption>
</figure>

<p>Centrándonos en el mismo ejemplo, únicamente vamos a modificar el fragmento de código donde agrupamos los datos, para que manteniendo una ventana de 2 minutos, ahora tenga un deslizamiento de un minuto:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowedCounts</span> <span class="o">=</span> <span class="n">words_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>
<span class="hll"><span class="linenos" data-linenos="3 "></span>    <span class="n">window</span><span class="p">(</span><span class="n">words_df</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;2 minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;1 minute&quot;</span><span class="p">),</span> <span class="n">words_df</span><span class="o">.</span><span class="n">palabra</span>
</span><span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Al introducir <code>Hola Mundo</code>, ha duplicado los datos recibidos para darles cabida en las dos ventanas que van a cubrir cada instante temporal:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">1</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>En el mismo instante, introducimos <code>Severo Ochoa</code>, lo que provoca que vuelta a realizar el mismo proceso, introduciendo ambas palabras en las dos ventanas existentes:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">2</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="hll"><span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Dentro de la misma ventana introducimos <code>Hola Mundo desde el Severo Ochoa</code>, obteniendo el tercer <em>micro-batch</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">3</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="19 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Finalmente, nos esperamos un poco para provocar entrar en otra ventana e introducimos <code>Segunda ventana</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">4</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="19 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="20 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="21 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="22 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="23 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<p>Finalmente, introducimos <code>Segunda ventana Ochoa</code> para comprobar como rellena las dos últimas ventanas:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">Batch</span><span class="p">:</span> <span class="mi">5</span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">-------------------------------------------</span>
<span class="linenos" data-linenos=" 4 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">palabra</span><span class="o">|</span><span class="n">count</span><span class="o">|</span>
<span class="linenos" data-linenos=" 6 "></span><span class="o">+------------------------------------------+-------+-----+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="10 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="11 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="12 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="13 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="14 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Severo</span> <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="linenos" data-linenos="15 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">desde</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="16 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">el</span>     <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
<span class="linenos" data-linenos="17 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Hola</span>   <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="18 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">3</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="19 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="20 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Mundo</span>  <span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
<span class="hll"><span class="linenos" data-linenos="21 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">ventana</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="22 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Ochoa</span>  <span class="o">|</span><span class="mi">1</span>    <span class="o">|</span>
</span><span class="hll"><span class="linenos" data-linenos="23 "></span><span class="o">|</span><span class="p">{</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">17</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">Segunda</span><span class="o">|</span><span class="mi">2</span>    <span class="o">|</span>
</span><span class="linenos" data-linenos="24 "></span><span class="o">+------------------------------------------+-------+-----+</span>
</code></pre></div>
<h2 id="caso-6-bolsa-i">Caso 6: Bolsa I<a class="headerlink" href="#caso-6-bolsa-i" title="Permanent link">&para;</a></h2>
<p>Para este caso de uso, vamos a suponer que recibimos un fichero con eventos sobre valores de un mercado financiero con el siguiente formato:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:05:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:12:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:20:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">800</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:40:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">900</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="5 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:25:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="6 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:48:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="7 "></span><span class="p">{</span><span class="nt">&quot;CreatedTime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-09 10:50:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;Amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;BrokerCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AME&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Nuestro departamento de visualización nos pide que transformemos los datos recibidos para crear la siguiente estructura:</p>
<table>
<thead>
<tr>
<th>TInicio</th>
<th>TFin</th>
<th>Compras</th>
<th>Ventas</th>
<th>Neto</th>
</tr>
</thead>
<tbody>
<tr>
<td>9:00</td>
<td>9:15</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>9:15</td>
<td>9:30</td>
<td>1000</td>
<td>300</td>
<td>700</td>
</tr>
<tr>
<td>9:30</td>
<td>9:45</td>
<td>1500</td>
<td>700</td>
<td>800</td>
</tr>
<tr>
<td>9:45</td>
<td>10:00</td>
<td>1600</td>
<td>900</td>
<td>700</td>
</tr>
</tbody>
</table>
<p>Así pues, necesitamos agrupar los datos con una ventana fija de 15 minutos, e ir acumulando las cantidades (<code>Amount</code>), dependiendo de que el tipo (<code>Type</code>) sea una compra (<code>BUY</code>) o una venta (<code>SELL</code>) para luego calcular su valor neto como la diferencia de estos dos últimos.</p>
<p>Nuestro primer paso, será crear la conexión a Spark y la lectura de la carpeta donde irán llegando los ficheros de datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 4 "></span>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Bolsa Streaming s8a&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>        <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 8 "></span>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># Definimos el esquema de los datos de entrada</span>
<span class="linenos" data-linenos="11 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span>
<span class="linenos" data-linenos="12 "></span><span class="n">bolsaSchema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;Amount&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;BrokerCode&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="linenos" data-linenos="17 "></span><span class="p">])</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="c1"># Configuramos la lectura de fichero en formato JSON</span>
<span class="linenos" data-linenos="20 "></span><span class="n">rawDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="21 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="22 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;entrada&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="23 "></span>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;maxFilesPerTrigger&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
<span class="linenos" data-linenos="24 "></span>        <span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">bolsaSchema</span><span class="p">)</span> \
<span class="linenos" data-linenos="25 "></span>        <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos="26 "></span>
<span class="linenos" data-linenos="27 "></span><span class="n">rawDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="28 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="29 "></span><span class="c1">#  |-- CreatedTime: string (nullable = true)</span>
<span class="linenos" data-linenos="30 "></span><span class="c1">#  |-- Type: string (nullable = true)</span>
<span class="linenos" data-linenos="31 "></span><span class="c1">#  |-- Amount: integer (nullable = true)</span>
<span class="linenos" data-linenos="32 "></span><span class="c1">#  |-- BrokerCode: string (nullable = true)</span>
</code></pre></div>
<p>El siguiente paso, es crear las columnas con la fecha en formato <em>timestamp</em> y las nuevas columnas <code>Compras</code> y <code>Ventas</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">to_timestamp</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">accionesDF</span> <span class="o">=</span> <span class="n">rawDF</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">),</span> <span class="s2">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;case when Type == &#39;BUY&#39; then Amount else 0 end&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;case when Type == &#39;SELL&#39; then Amount else 0 end&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">accionesDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">#  |-- CreatedTime: timestamp (nullable = true)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">#  |-- Type: string (nullable = true)</span>
<span class="linenos" data-linenos="10 "></span><span class="c1">#  |-- Amount: integer (nullable = true)</span>
<span class="linenos" data-linenos="11 "></span><span class="c1">#  |-- BrokerCode: string (nullable = true)</span>
<span class="linenos" data-linenos="12 "></span><span class="c1">#  |-- Compras: integer (nullable = true)</span>
<span class="linenos" data-linenos="13 "></span><span class="c1">#  |-- Ventas: integer (nullable = true)</span>
</code></pre></div>
<p>Si queremos ver el resultado e intentamos realizar <code>accionesDF.show()</code>, nos dará un error al no haber realizar un <em>start</em> del streaming. Para probarlo como si fuera un proceso batch sólo tenemos que cambiar el método <code>readStream</code> de la lectura por <code>read</code> y ya funcionará:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">rawDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
<span class="linenos" data-linenos=" 2 "></span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 3 "></span>        <span class="o">...</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">accionesDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># +-------------------+----+------+----------+-------+------+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># |        CreatedTime|Type|Amount|BrokerCode|Compras|Ventas|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># +-------------------+----+------+----------+-------+------+</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># |2022-05-09 10:05:00| BUY|   500|       AME|    500|     0|</span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># |2022-05-09 10:12:00| BUY|   300|       AME|    300|     0|</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># |2022-05-09 10:20:00| BUY|   800|       AME|    800|     0|</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># |2022-05-09 10:40:00| BUY|   900|       AME|    900|     0|</span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># |2022-05-09 10:25:00|SELL|   400|       AME|      0|   400|</span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># |2022-05-09 10:48:00|SELL|   600|       AME|      0|   600|</span>
<span class="linenos" data-linenos="15 "></span><span class="c1"># |2022-05-09 10:50:00|SELL|   100|       AME|      0|   100|</span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># +-------------------+----+------+----------+-------+------+</span>
</code></pre></div>
<p>Una vez hemos comprobado que hemos preparado los datos con el formato y contenido adecuados, vamos a agruparlos con una ventana de 15 minutos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">windowDF</span> <span class="o">=</span> <span class="n">accionesDF</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>  <span class="c1"># col(&quot;BrokerCode&quot;),</span>
<span class="linenos" data-linenos=" 4 "></span>         <span class="n">window</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">),</span> <span class="s2">&quot;15 minutes&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 6 "></span>         <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">salidaDF</span> <span class="o">=</span> <span class="n">windowDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;window.start&quot;</span><span class="p">,</span> <span class="s2">&quot;window.end&quot;</span><span class="p">,</span> <span class="s2">&quot;Compras&quot;</span><span class="p">,</span> <span class="s2">&quot;Ventas&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="n">bolsaWriterQuery</span> <span class="o">=</span> <span class="n">salidaDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="11 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="12 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="13 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="n">bolsaWriterQuery</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Y tras volver a poner <code>readStream</code> y arrancarlo, obtenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">+-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos="2 "></span><span class="o">|</span>              <span class="n">start</span><span class="o">|</span>                <span class="n">end</span><span class="o">|</span><span class="n">Compras</span><span class="o">|</span><span class="n">Ventas</span><span class="o">|</span>
<span class="linenos" data-linenos="3 "></span><span class="o">+-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos="4 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>    <span class="mi">800</span><span class="o">|</span>     <span class="mi">0</span><span class="o">|</span>
<span class="linenos" data-linenos="5 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>    <span class="mi">800</span><span class="o">|</span>   <span class="mi">400</span><span class="o">|</span>
<span class="linenos" data-linenos="6 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>    <span class="mi">900</span><span class="o">|</span>     <span class="mi">0</span><span class="o">|</span>
<span class="linenos" data-linenos="7 "></span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span>      <span class="mi">0</span><span class="o">|</span>   <span class="mi">700</span><span class="o">|</span>
<span class="linenos" data-linenos="8 "></span><span class="o">+-------------------+-------------------+-------+------+</span>
</code></pre></div>
<p>Estos datos se parecen a la información que queríamos, pero únicamente esta sumando los datos de cada ventana, sin acumularlos con todos los datos anteriores. A día de hoy, la única forma de sumar todos los datos agregados es utilizar las <a href="../hadoop/06hive.html#consultas-de-agregación">funciones ventana</a> (similares a las que vimos al trabajar con <em>Hive</em>) dentro de un proceso <em>batch</em>.</p>
<p>Así pues, vamos a almacenar los datos en un fichero en formato Parquet, para que luego desde un proceso Batch realizar los cálculos que nos faltan. Pero antes necesitamos introducir el concepto de marca de agua.</p>
<h2 id="watermarking">Watermarking<a class="headerlink" href="#watermarking" title="Permanent link">&para;</a></h2>
<p>Cuando los datos llegan tarde a nuestro sistema (se generan en la ventana N, pero llegan a <em>Spark</em> en la ventana N+M), <em>Spark</em> gestiona todas las ventanas y actualiza los cálculos. Estos cálculos, como hemos comentado, son el estado de las transformaciones y se almacenan en los diferentes ejecutores del clúster de <em>Spark</em>.</p>
<p>¿Qué sucede con un dato que se genera a las 12:04 pero llega a Spark a las 12:11, si nuestras ventanas tienen un tamaño de 10 minutos? Como se mantiene el estado, Spark puede modificar la ventana de las 12:00 a las 12:10 y actualizar los cálculos:</p>
<figure style="align: center;">
    <img src="images/03streaming-latedata.png">
    <figcaption>Gestión de datos tardíos</figcaption>
</figure>

<p>El problema es que estos cálculos se almacenan para todos los datos, con lo cual el estado crece ininterrumpidamente. Para definir que las ventanas expiren, necesitamos conocer el concepto de <strong>marca de agua</strong> (<em>watermark</em>), el cual va a permitir indicar el tiempo que el sistema debe esperar a datos que llegan tarde, de manera que si exceden la marca de agua, los datos se desechan. Al definir las marcas de agua, <em>Spark Streaming</em> realiza un seguimiento de los tiempos de los eventos de los datos e intenta limpiar los datos caducados de los ejecutores.</p>
<p>La decisión de la definición de la marca de agua pertenece a negocio, y debe responder a:</p>
<ul>
<li>¿Cuál es el máximo retraso posible/aceptable?</li>
<li>¿Cuándo dejan los datos de ser relevantes?</li>
</ul>
<p>Una vez tenemos claro el rango temporal en el que los datos son aceptables, los definimos antes de agrupar y utilizando las mismas columnas de agrupación (en nuestro caso, por la columna <code>timestamp</code>) mediante el método <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.withWatermark.html">withWatermark</a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowedCounts</span> <span class="o">=</span> <span class="n">words_df</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="n">words_df</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;30 minutes&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>
<span class="linenos" data-linenos="5 "></span>        <span class="n">window</span><span class="p">(</span><span class="n">words_df</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;2 minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;1 minute&quot;</span><span class="p">),</span> <span class="n">words_df</span><span class="o">.</span><span class="n">palabra</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">)</span>
</code></pre></div>
<p>De esta manera, si llega una palabra con un retraso de más de 30 minutos, se desechará. Además, el estado de la ventana se limpiará cuando pasen esos 30 minutos, de manera que su tamaño siempre estará limitado por el <em>timestamp</em> de los datos recibidos en los última media hora.</p>
<p>Si utilizamos marcas de agua para limitar el estado de la ventana, es importante tener en cuenta que si el modo de salida es completo, no se limpiará el estado, es decir, es como si no utilizásemos marcas de agua.</p>
<h3 id="modo-update">Modo <em>update</em><a class="headerlink" href="#modo-update" title="Permanent link">&para;</a></h3>
<p>En cambio, mediante el modo <em>update</em> sí que se limpia la ventana de estado, realizando operaciones de tipo <em>upsert</em>, por ejemplo con un <em>sink</em> que sí soporte las modificaciones, como cualquiera base de datos. Aunque hay que tener cuidado si nuestro <em>sink</em> es de tipo fichero, ya que no puede modificar los ficheros JSON/Parquet y creará archivos duplicados.</p>
<p>Veamos un ejemplo donde definimos una marca de agua de 10 minutos sobre una ventana también de 10 minutos sobre la columna <em>timestamp</em> con <em>triggers</em> cada 5 minutos:</p>
<figure style="align: center;">
    <img src="images/03streaming-watermark-update-mode.png">
    <figcaption>Marca de agua - modo update</figcaption>
</figure>

<p>La línea punteada en azul representa el mayor evento leído, el cual va a definir la marca de agua (tiempo del mayor evento menos 10 minutos)</p>
<p>Cuando llega el dato <em>dog</em> de las 12:14, fija la marca de agua a las 12:04 para el siguiente trigger. Todo lo que sea anterior a las 12:04 se desechará y lo posterior, se tratará (por ejemplo, al llegar <em>cat</em> a las 12:09) y se contabiliza en las dos ventanas posibles.</p>
<p>Sin embargo, cuando llega <em>owl</em> a las 12:21, fija la marca de agua a las 12:11, y por tanto limpia la ventana que va de las 12:00 a las 12:10, y todos los datos posteriores que llegan anteriores a la marca de agua como <em>donkey</em> a las 12:04 se descartan por llegar demasiado tarde.</p>
<p>Tras cada trigger, por el modo <em>update</em>, los cálculos (filas en lila) se escriben en el destino.</p>
<h3 id="modo-append">Modo <em>append</em><a class="headerlink" href="#modo-append" title="Permanent link">&para;</a></h3>
<p>Aunque anteriormente comentamos que no podíamos utilizar el modo <em>append</em> con la agregaciones, ya que <em>Spark</em> necesita saber que los registros no se actualizarán o modificarán en el futuro. Al definir una marca de agua, ahora sí que podremos hacerlo. Para ello, sólo emitirá el resultado una vez ha finalizado una ventana y no pueda tener aceptar nuevos eventos tardíos.</p>
<p>Supongamos que nuestra marca de agua es de treinta minutos, teniendo un ventana de estado actual de 10:00 a 10:30, con un tamaño de ventana de 15 minutos. Si nos llega un mensaje a las 10:45, nuestra ventana de estado pasará a ser de 10:15 a 10:45, y a la ventana de 10:00 a 10:15 ya no podrá llegar ningún mensaje, de manera que puede mostrar los cálculos y realizar el <em>append</em> de dichos datos.</p>
<p>Si el retraso de la marca de agua no es crítica para nuestro sistema, mediante <em>watermarking</em> y el modo de salida <em>append</em>, podemos utilizar un <em>sink</em> de tipo fichero.</p>
<p>Si retomamos el mismo ejemplo de antes, pero ahora con el modo <em>append</em>, y nos fijamos en los pasos finales, cuando la marca de agua pasaba a ser a las 12:11 provocaba que caducase la ventana de las 12:00 a las 12:10. En el siguiente trigger es cuando dichos datos se persisten en el <em>sink</em>:</p>
<figure style="align: center;">
    <img src="images/03streaming-watermark-append-mode.png">
    <figcaption>Marca de agua - modo append</figcaption>
</figure>

<!--
<https://github.com/PacktPublishing/Apache-Spark-Streaming-with-Python-and-PySpark-v>
<https://github.com/jleetutorial/python-spark-streaming>  
-->

<h2 id="caso-7-bolsa-ii">Caso 7: Bolsa II<a class="headerlink" href="#caso-7-bolsa-ii" title="Permanent link">&para;</a></h2>
<p>Ahora que ya hemos visto el concepto de marca de agua, podemos crear un marco para que los valores que lleguen tarde se descarten y poder almacenar la información en fichero en formato Parquet con el modo de salida <em>append</em>.</p>
<p>Así pues, cuando agrupamos los datos, vamos a definir una marca de agua de 30 minutos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">window</span><span class="p">,</span> <span class="nb">sum</span>
<span class="linenos" data-linenos="2 "></span><span class="n">windowDF</span> <span class="o">=</span> <span class="n">accionesDF</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">,</span> <span class="s2">&quot;30 minutes&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span>  <span class="c1"># col(&quot;BrokerCode&quot;),</span>
<span class="linenos" data-linenos="5 "></span>         <span class="n">window</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CreatedTime&quot;</span><span class="p">),</span> <span class="s2">&quot;15 minutes&quot;</span><span class="p">))</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos="7 "></span>         <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">))</span>
</code></pre></div>
<p>Y posteriormente ya podemos almacenar los datos en un fichero:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">bolsaWriterQuery</span> <span class="o">=</span> <span class="n">salidaDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">&quot;BolsaWQuery&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;salida&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="7 "></span>    <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="s2">&quot;1 minute&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="8 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
<p>Si vamos a la carpeta, tendremos diferentes fichero. Si creamos un nuevo fichero con un dato que se salga de la marca de agua, los datos antiguos <em>caducarán</em> y se persistirán en disco. Así pues, si ahora los cargamos mediante un proceso <em>batch</em>, podremos ver los datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">rawBolsaDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
<span class="linenos" data-linenos=" 2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;salida&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">rawBolsaDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># +-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># |              start|                end|Compras|Ventas|</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># +-------------------+-------------------+-------+------+</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># |2022-05-09 10:00:00|2022-05-09 10:15:00|    800|     0|</span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># |2022-05-09 10:15:00|2022-05-09 10:30:00|    800|   400|</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># |2022-05-09 10:45:00|2022-05-09 11:00:00|      0|   700|</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># |2022-05-09 10:30:00|2022-05-09 10:45:00|    900|     0|</span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># +-------------------+-------------------+-------+------+</span>
</code></pre></div>
<p>Ahora ya podemos hacer uso de las funciones ventanas, y calcular el total acumulado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">ventanaTotal</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="p">,</span> <span class="n">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">salidaDF</span> <span class="o">=</span> <span class="n">rawBolsaDF</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Compras&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">ventanaTotal</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Ventas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">ventanaTotal</span><span class="p">))</span> \
<span class="linenos" data-linenos=" 8 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;Neto&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;Compras - Ventas&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="n">salidaDF</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># +-------------------+-------------------+-------+------+----+</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># |start              |end                |Compras|Ventas|Neto|</span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># +-------------------+-------------------+-------+------+----+</span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># |2022-05-09 10:00:00|2022-05-09 10:15:00|800    |0     |800 |</span>
<span class="linenos" data-linenos="15 "></span><span class="c1"># |2022-05-09 10:15:00|2022-05-09 10:30:00|1600   |400   |1200|</span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># |2022-05-09 10:30:00|2022-05-09 10:45:00|1600   |1100  |500 |</span>
<span class="linenos" data-linenos="17 "></span><span class="c1"># |2022-05-09 10:45:00|2022-05-09 11:00:00|2500   |1100  |1400|</span>
<span class="linenos" data-linenos="18 "></span><span class="c1"># +-------------------+-------------------+-------+------+----+</span>
</code></pre></div>
<h2 id="join">Join<a class="headerlink" href="#join" title="Permanent link">&para;</a></h2>
<p>Una de las cosas más <em>curiosas</em> que podemos hacer con un <em>DataFrame</em> en <em>streaming</em> es realizar un <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#join-operations"><em>join</em></a> con otro <em>DataFrame</em> estático u otro en <em>streaming</em>, es decir, con datos que todavía no existen.</p>
<p>Realizar un <em>join</em> es una operación compleja y la parte divertida es que no todos los datos están disponibles en el momento de realizar el <em>join</em>, por lo tanto su resultado se genera de forma incremental tras cada <em>trigger</em>, de forma similar a como se generan las agregaciones.</p>
<p>Unir un stream con un DataFrame estático es una operación sin estado, ya que Spark no necesita mantener el estado y sólo está uniendo los datos de un único micro-batch.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">estaticoDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos="2 "></span><span class="n">streamingDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos="3 "></span><span class="n">streamingDF</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">estaticoDF</span><span class="p">,</span> <span class="s2">&quot;claveAjena&quot;</span><span class="p">)</span>  <span class="c1"># inner join entre streaming y estático</span>
<span class="linenos" data-linenos="4 "></span><span class="n">streamingDF</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">estaticoDF</span><span class="p">,</span> <span class="s2">&quot;claveAjena&quot;</span><span class="p">,</span> <span class="s2">&quot;left_outer&quot;</span><span class="p">)</span>  <span class="c1"># left outer join con estático</span>
</code></pre></div>
<p>En cambio, unir dos <em>DataFrames</em> en streaming sí que es una operación con estado, ya que Spark necesita almacenar los datos de ambos en el almacenamiento del estado y comprobar continuamente si hay relación entre los nuevos datos que llegan en cada micro-batch. Dado que los <em>DataFrames</em> en stream no tienen un final definido, <em>Spark Structured Streaming</em> debe mantener todos los datos recogidos de ambos <em>DataFrames</em> de un <em>join</em>, ya que pueden llegar futuros datos que sí cumplan la relación. Para evitar que el estado se quede sin memoria disponible, podemos utilizar marcas de agua en ambos <em>DataFrames</em> e incluir una restricción basada en el tiempo de evento definido en la condición de <em>join</em>.</p>
<p>Supongamos que queremos unir un flujo de impresiones de anuncios (cuando se muestra un anuncio) con otro flujo de los clicks que los usuarios realizan sobre los anuncios para correlacionarlos y monetizar los clicks:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">impresiones</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">clicks</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># Le asignamos una marca de agua a las columnas de tiempos de eventos</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">impresionesConMarcaAgua</span> <span class="o">=</span> <span class="n">impresiones</span><span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;impresionTime&quot;</span><span class="p">,</span> <span class="s2">&quot;2 hours&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">clicksConMarcaAgua</span> <span class="o">=</span> <span class="n">clicks</span><span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;clickTime&quot;</span><span class="p">,</span> <span class="s2">&quot;3 hours&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># Join con restricciones temporales</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># Los clicks solo se pueden recibir una vez impreso el anuncio y hasta una hora después</span>
<span class="linenos" data-linenos="12 "></span><span class="n">impresionesConMarcaAgua</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos" data-linenos="13 "></span>  <span class="n">clicksConMarcaAgua</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span>  <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos" data-linenos="15 "></span><span class="s2">    clickAnuncioId = impresionAnuncioId AND</span>
<span class="linenos" data-linenos="16 "></span><span class="s2">    clickTime &gt;= impresionTime AND</span>
<span class="linenos" data-linenos="17 "></span><span class="s2">    clickTime &lt;= impresionTime + interval 1 hour</span>
<span class="linenos" data-linenos="18 "></span><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="19 "></span><span class="p">)</span>
</code></pre></div>
<div class="admonition caution">
<p class="admonition-title">Limpieza</p>
<p>Conviene recordar que la limpieza de los registros del estado que quedan fuera de la marca de agua puede realizar tan pronto como cambie la marca o se puede retrasar debido a optimizaciones de Spark. Así pues, Spark no garantiza que los registros que están fuera de la marca de agua se ignoren por completo, sino que lo que estén dentro nunca se descartarán.</p>
</div>
<p>El soporte que hay para los diferentes tipos de join depende de los tipos de <em>DataFrames</em>:</p>
<table>
<thead>
<tr>
<th>Izquierda + Derecha</th>
<th>Inner Join</th>
<th>Left Join</th>
<th>Right Join</th>
<th>Full Outer</th>
</tr>
</thead>
<tbody>
<tr>
<td>Estático + Streaming</td>
<td>Sí</td>
<td>No</td>
<td>Sí</td>
<td>No</td>
</tr>
<tr>
<td>Streaming + Streaming</td>
<td>Sí</td>
<td>Condicional. Debe especificar marca de agua en el lado derecho y restricción temporal</td>
<td>Condicional. Debe especificar marca de agua en el lado izquierdo y restricción temporal</td>
<td>Condicional. Debe especificar marca de agua en un lado y restricción temporal</td>
</tr>
</tbody>
</table>
<p>En todos los casos que se indican restricciones temporales, opcionalmente se puede especificar marca de agua en el otro lado para facilitar la limpieza del estado.</p>
<h2 id="caso-8-join-entre-kafka-y-mariadb">Caso 8: Join entre Kafka y MariaDB<a class="headerlink" href="#caso-8-join-entre-kafka-y-mariadb" title="Permanent link">&para;</a></h2>
<p>En este caso de uso a leer datos de <em>Kafka</em> y unir la información recibida con una fuente de datos estática como puede ser <em>MariaDB</em>.</p>
<p>Vamos a simular que recibimos información sobre usuarios que han realizado login en una aplicación externa y hemos de cruzar sus datos con una base de datos que centraliza todos los usuarios de nuestra empresa.</p>
<p>Para ello, en <em>MariaDB</em> vamos a crear una base de datos y una tabla con información sobre usuarios:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="o">`</span><span class="n">spark</span><span class="o">`</span><span class="w"> </span><span class="cm">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span><span class="p">;</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">usuarios</span><span class="w"> </span><span class="p">(</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="n">nombre</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="n">ultimoLogin</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">usuarios_PK</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span>
<span class="linenos" data-linenos="10 "></span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span>
<span class="linenos" data-linenos="11 "></span><span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span><span class="p">;</span>
<span class="linenos" data-linenos="12 "></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">usuarios</span><span class="p">;</span>
</code></pre></div>
<p>En esta tabla, almacenamos los datos centralizados de los usuarios de nuestra empresa:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">usuarios</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">ultimoLogin</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Aitor Medrano&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-13 13:36:58.0&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Pedro Casas&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-14 13:46:58.0&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Laura García&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-15 13:56:58.0&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="5 "></span><span class="w">    </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Mª Josep Vidal&#39;</span><span class="p">,</span><span class="s1">&#39;2022-05-16 14:06:58.0&#39;</span><span class="p">);</span>
</code></pre></div>
<p>Mediante <em>Kafka</em>, vamos a recibir los datos de los usuarios que entran a nuestras aplicaciones desde un topic llamado <code>usuariosk</code> con mensaje con el siguiente formato:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-17 12:15:00&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-18 12:15:00&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-19 12:15:00&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-20 12:15:00&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Una vez que crucemos los datos, si el usuario ya existía en nuestra base de datos (coinciden <code>id</code> y <code>login_id</code>) modificaremos la fecha de su <code>ultimoLogin</code>.</p>
<p>Una vez tenemos claro los datos de entrada, arrancamos Kafka y creamos el <em>topic</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>zookeeper-server-start.sh<span class="w"> </span>./config/zookeeper.properties
<span class="linenos" data-linenos="2 "></span>kafka-server-start.sh<span class="w"> </span>./config/server.properties
<span class="linenos" data-linenos="3 "></span>kafka-topics.sh<span class="w"> </span>--create<span class="w"> </span>--topic<span class="w"> </span>usuariosk<span class="w"> </span>--bootstrap-server<span class="w"> </span>iabd-virtualbox:9092
</code></pre></div>
<h3 id="lectura-en-streaming">Lectura en streaming<a class="headerlink" href="#lectura-en-streaming" title="Permanent link">&para;</a></h3>
<p>Vamos a comenzar con el fragmento de código que realiza la lectura desde <em>Kafka</em>, creando la sesión <em>Spark</em> y leyendo del topic <code>usuariosk</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos" data-linenos=" 2 "></span>    <span class="o">.</span><span class="n">builder</span> \
<span class="linenos" data-linenos=" 3 "></span>    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[3]&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 4 "></span>    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;s8a Kafka join MariaDB&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 6 "></span>    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 7 "></span>    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">kafkaSchema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;login_id&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="linenos" data-linenos="12 "></span><span class="p">])</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="n">kafkaDF</span> <span class="o">=</span> <span class="n">spark</span> \
<span class="linenos" data-linenos="15 "></span>    <span class="o">.</span><span class="n">readStream</span> \
<span class="linenos" data-linenos="16 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;kafka&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="17 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;kafka.bootstrap.servers&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd-virtualbox:9092&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="18 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;usuariosk&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="19 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;startingOffsets&quot;</span><span class="p">,</span> <span class="s2">&quot;earliest&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="20 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="linenos" data-linenos="21 "></span>
<span class="linenos" data-linenos="22 "></span><span class="c1"># Pasamos el value de Kafka a string y luego a JSON</span>
<span class="linenos" data-linenos="23 "></span><span class="n">valueDF</span> <span class="o">=</span> <span class="n">kafkaDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">from_json</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">),</span> <span class="n">kafkaSchema</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos="24 "></span>
<span class="linenos" data-linenos="25 "></span><span class="c1"># Cast del campo login_time a tipo fecha</span>
<span class="linenos" data-linenos="26 "></span><span class="n">loginDF</span> <span class="o">=</span> <span class="n">valueDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;value.*&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="27 "></span>    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">),</span> <span class="s2">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">))</span>
</code></pre></div>
<p>Así pues, <code>loginDF</code> es un <em>DataFrame</em> que realiza <em>streaming</em> sobre Kafka.</p>
<h3 id="lectura-estatica">Lectura estática<a class="headerlink" href="#lectura-estatica" title="Permanent link">&para;</a></h3>
<p>FIXME: reescribir</p>
<p>El segundo paso es crear otro <em>DataFrame</em> que obtenga los datos desde MariaDB (en esta caso un <em>DataFrame</em> estático, sin <em>streaming</em>). Para ello, primero hemos de copiar el <a href="resources/mysql-connector-j-8.0.31.jar">driver JDBC de Mysql</a> en nuestro sistema (en mi caso lo he hecho en <code>/opt/spark-3.2.0/conf</code> y configurar en <code>spark-defaults.conf</code> que vamos a emplear dicho <em>driver</em> JDBC:</p>
<div class="highlight"><span class="filename">spark-defaults.conf</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span>spark.driver.extraClassPath<span class="w"> </span><span class="o">=</span><span class="w"> </span>/opt/spark-3.2.0/conf/mysql-connector-java-5.1.49-bin.jar
<span class="linenos" data-linenos="2 "></span>spark.executor.extraClassPath<span class="w"> </span><span class="o">=</span><span class="w"> </span>/opt/spark-3.2.0/conf/mysql-connector-java-5.1.49-bin.jar
</code></pre></div>
<p>Con el driver JDBC ya cargado en <em>Spark</em>, realizamos la lectura de los datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">jdbcDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
<span class="linenos" data-linenos="2 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;jdbc&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="3 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">,</span> <span class="s2">&quot;com.mysql.jdbc.Driver&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="4 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;jdbc:mysql://localhost&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="5 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;dbtable&quot;</span><span class="p">,</span> <span class="s2">&quot;spark.usuarios&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="6 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="7 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;iabd&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="8 "></span>    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
<h3 id="join_1">Join<a class="headerlink" href="#join_1" title="Permanent link">&para;</a></h3>
<p>Finalmente, un vez leídos los datos desde MariaDB, ya podemos hacer el <em>join</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">joinExpr</span> <span class="o">=</span> <span class="n">loginDF</span><span class="o">.</span><span class="n">login_id</span> <span class="o">==</span> <span class="n">jdbcDF</span><span class="o">.</span><span class="n">id</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">joinDF</span> <span class="o">=</span> <span class="n">loginDF</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jdbcDF</span><span class="p">,</span> <span class="n">joinExpr</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
<span class="linenos" data-linenos=" 5 "></span>    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">loginDF</span><span class="o">.</span><span class="n">login_id</span><span class="p">)</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">joinDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">#  |-- login_time: timestamp (nullable = true)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">#  |-- id: decimal(20,0) (nullable = true)</span>
<span class="linenos" data-linenos="10 "></span><span class="c1">#  |-- nombre: string (nullable = true)</span>
<span class="linenos" data-linenos="11 "></span><span class="c1">#  |-- ultimoLogin: timestamp (nullable = true)</span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span><span class="n">resultadoDF</span> <span class="o">=</span> <span class="n">joinDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;nombre&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;ultimoLogin))</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="n">queryWriter</span> <span class="o">=</span> <span class="n">resultadoDF</span><span class="o">.</span><span class="n">writeStream</span> \
<span class="linenos" data-linenos="16 "></span>    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="17 "></span>    <span class="o">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="18 "></span>    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;checkpointLocation&quot;</span><span class="p">,</span> <span class="s2">&quot;chk-point-dir&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="19 "></span>    <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="s2">&quot;1 minute&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="20 "></span>    <span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos" data-linenos="21 "></span>
<span class="linenos" data-linenos="22 "></span><span class="n">queryWriter</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Una vez lanzado, creamos un productor de <em>Kafka</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">kafka</span><span class="o">-</span><span class="n">console</span><span class="o">-</span><span class="n">producer</span><span class="o">.</span><span class="n">sh</span> <span class="o">--</span><span class="n">topic</span> <span class="n">usuariosk</span> <span class="o">--</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">server</span> <span class="n">iabd</span><span class="o">-</span><span class="n">virtualbox</span><span class="p">:</span><span class="mi">9092</span>
</code></pre></div>
<p>y le enviamos datos de entrada a la aplicación:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;login_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;login_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-05-17 12:15:00&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Si vamos a la consola de <em>Spark</em>, veremos como ha creado el join:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>-------------------------------------------<span class="w">                                     </span>
<span class="linenos" data-linenos="2 "></span>Batch:<span class="w"> </span><span class="m">1</span>
<span class="linenos" data-linenos="3 "></span>-------------------------------------------
<span class="linenos" data-linenos="4 "></span>+---+-------------+-------------------+-------------------+
<span class="linenos" data-linenos="5 "></span><span class="p">|</span><span class="w"> </span>id<span class="p">|</span><span class="w">       </span>nombre<span class="p">|</span><span class="w">        </span>ultimoLogin<span class="p">|</span><span class="w">         </span>login_time<span class="p">|</span>
<span class="linenos" data-linenos="6 "></span>+---+-------------+-------------------+-------------------+
<span class="linenos" data-linenos="7 "></span><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="p">|</span>Aitor<span class="w"> </span>Medrano<span class="p">|</span><span class="m">2022</span>-05-16<span class="w"> </span><span class="m">13</span>:36:58<span class="p">|</span><span class="m">2022</span>-05-17<span class="w"> </span><span class="m">12</span>:15:00<span class="p">|</span>
<span class="linenos" data-linenos="8 "></span>+---+-------------+-------------------+-------------------+
</code></pre></div>
<p>Si queremos preparar el <em>DataFrame</em> para que tenga la misma estructura que nuestra base de datos cuando creamos el resultado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">resultadoDF</span> <span class="o">=</span> <span class="n">joinDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;nombre&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;login_time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ultimoLogin))</span>
<span class="linenos" data-linenos="2 "></span><span class="n">resultadoDF</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="linenos" data-linenos="3 "></span><span class="c1"># root</span>
<span class="linenos" data-linenos="4 "></span><span class="c1">#  |-- id: decimal(20,0) (nullable = true)</span>
<span class="linenos" data-linenos="5 "></span><span class="c1">#  |-- nombre: string (nullable = true)</span>
<span class="linenos" data-linenos="6 "></span><span class="c1">#  |-- ultimoLogin: timestamp (nullable = true)</span>
</code></pre></div>
<h2 id="datos-duplicados">Datos duplicados<a class="headerlink" href="#datos-duplicados" title="Permanent link">&para;</a></h2>
<p>Aunque <em>Spark Streaming</em> asegura la fiabilidad de los datos mediante la entrega de mensajes <em>exactly-one</em>, es posible que desde nuestras fuentes de datos nos envíen un dato más de una vez (por problemas con la red o fallos de transmisión).</p>
<p>Dentro de <em>Structured Streaming</em> podemos gestionar los datos duplicados tanto con marcas de agua como sin ellas. Debes tener en cuenta que si no utilizamos <em>watermarking</em>, el estado de <em>Spark</em> necesite almacenar de manera ilimitada todos los datos, lo que puede llevar a un problema de falta de memoria.</p>
<p>Para evitar los registros duplicados, los diferente eventos deberían tener un identificador único:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">streamingDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span> <span class="o">...</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="c1"># Sin marcas de agua</span>
<span class="linenos" data-linenos="4 "></span><span class="n">streamingDF</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="c1"># Mediante marca de agua, eliminamos tanto por el identificador como la ventana temporal</span>
<span class="linenos" data-linenos="7 "></span><span class="n">streamingDF</span> \
<span class="linenos" data-linenos="8 "></span>  <span class="o">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">&quot;ts&quot;</span><span class="p">,</span> <span class="s2">&quot;10 minutes&quot;</span><span class="p">)</span> \
<span class="linenos" data-linenos="9 "></span>  <span class="o">.</span><span class="n">dropDuplicates</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Procesamiento con estado (<a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#arbitrary-stateful-operations"><em>Stateful operations</em></a>)</p>
<p>Si necesitamos realizar operaciones avanzadas que requiere realizar un seguimiento sobre diferentes eventos dentro de una misma sesión (por ejemplo, ver si ha llegado más de 3 veces una temperatura superior a X grados), podemos utilizar las funciones <code>mapGroupWithState</code> y <code>flatMapGroupsWithState</code> (solo disponibles a día de hoy mediante <em>Java</em> y <em>Scala</em>), que permiten definir una función de usuario a aplicar sobre el estado.</p>
</div>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li>Documentación oficial sobre <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html">Spark Structured Streaming</a></li>
<li><a href="https://link.springer.com/book/10.1007/978-1-4842-7383-8">Beginning Apache Spark 3: With DataFrame, Spark SQL, Structured Streaming, and Spark Machine Learning Library</a></li>
<li><a href="https://www.packtpub.com/product/real-time-stream-processing-using-apache-spark-3-for-python-developers-video/9781803246543">Real-Time Stream Processing Using Apache Spark 3 for Python Developers</a></li>
</ul>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Realiza el caso de uso 1 e introduce datos para generar 5 <em>micro-batchs</em>. Accede al Spark UI y comprueba los <em>jobs</em> y <em>stages</em> creados, y justifica su cantidad.</p>
</li>
<li>
<p>Realiza el caso de uso 2, realizando capturas de la carpeta <code>salida</code> tras la colocación de los datos de cada archivo de facturas en la carpeta de <code>entrada</code>. Previamente, configura el <em>reader</em> para que tras cargar cada archivo, lo elimine. Finalmente muestra un resumen de las estadísticas tanto del plan de ejecución como de los últimos progresos.</p>
</li>
<li>
<p>Realiza los casos de uso 3 y 4 en un único cuaderno <em>Jupyter</em>, de manera que sólo haya un <em>reader</em>, pero creando dos <em>WriterQuery</em>. Hay dos aspectos que debes tener en cuenta:</p>
<ol>
<li>
<p>En vez de indicar en cada escritor que espere a que finalice:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">facturaWriterQuery</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
<span class="linenos" data-linenos="2 "></span><span class="n">notificacionWriterQuery</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div>
<p>Le diremos a <em>Spark</em> que espere que termine alguno de ellos mediante <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.streaming.StreamingQueryManager.awaitAnyTermination.html">awaitAnyTermination</a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">spark</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">awayAnyTermination</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>Deberás configurar diferentes carpetas para <code>checkpointLocation</code> (cada <em>WriterQuery</em> debe tener su propia carpeta para los <em>checkpoints</em>)</p>
</li>
</ol>
</li>
<li>
<p>(opcional) El archivo <a href="resources/bizums.zip">bizums.zip</a> contiene una simulación de datos de <em>bizum</em> que llegan a nuestra cuenta. Crea una aplicación de <em>Spark Streaming</em> que muestre para cada persona, cual es <em>bizum</em> más alto.</p>
<p>Para ello, disponemos de un <em>script</em> <em>Python</em> que, al ejecutarlo, se encarga de simular el envío de <em>bizums</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>python3<span class="w"> </span>Bizums.py
</code></pre></div>
<p>El formato de estos datos es CSV formado por el <code>Nombre;Cantidad;Concepto</code> (dos nombres en mayúsculas y en minúsculas son de la misma persona). Un ejemplo de un <em>bizum</em> recibido sería similar a:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>Aitor;25;Cena restaurante
</code></pre></div>
<p>Muestra el resultado completo por consola.</p>
</li>
<li>
<p>Realiza el caso de uso 5, tanto con ventanas fijas como deslizantes.</p>
</li>
<li>Realiza los casos de uso que trabajan los conceptos de ventanas y <em>watermarking</em>, es decir, los casos de uso 6 y 7.</li>
<li>(opcional) Realiza el caso de uso 8. Además, modifícalo para crear una ventana temporal de 15 minutos y envía nuevos datos de usuarios que entran al sistema que provoquen la limpieza del estado.</li>
</ol>
<!--

(opcional) coger el dataset de iot de ventanas deslizantes de 15 minutos, y utilizar Kafka para leer los datos, mostrar temperatura máxima de los últimos 5 minutos

https://blog.coeo.com/databricks-structured-streaming-part2

https://www.mongodb.com/docs/spark-connector/master/python/write-to-mongodb/
-->


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        <a href='https://ko-fi.com/T6T8GWT9N' title='Invítame a un café en ko-fi.com' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi2.png?v=3' border='0' alt='Invítame a un café en ko-fi.com' /></a>
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Me encantan estos apuntes" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="Los apuntes son mejorables" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Gracias por tu tiempo. Si quieres me puedes <a href='https://ko-fi.com/T6T8GWT9N'>invitar a un café en ko-fi</a>.
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              ¡Gracias por tu colaboración! Ayúdame a mejorar los apuntes enviándome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        <label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.footer", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow", "content.code.copy"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ba449ae6.min.js"></script>
      
    
  </body>
</html>