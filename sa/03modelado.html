
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="asdf">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/sa/03modelado.html">
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.6">
    
    
      
        <title>Modelado NoSQL - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Modelado NoSQL - Inteligencia Artificial y Big Data" >
      
        <meta  property="og:description"  content="asdf" >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/03modelado.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/sa/03modelado.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Modelado NoSQL - Inteligencia Artificial y Big Data" >
      
        <meta  name="twitter:description"  content="asdf" >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/03modelado.png" >
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#relacionando-documentos" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Modelado NoSQL
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          UF1 - Toma de decisiones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="UF1 - Toma de decisiones" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          UF1 - Toma de decisiones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">UT2.- Sistemas de almacenamiento</a>
          
            <label for="__nav_2_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT2.- Sistemas de almacenamiento" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          UT2.- Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01nosql.html" class="md-nav__link">
        S18.- Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02mongo.html" class="md-nav__link">
        S24.- MongoDB
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        UT7.- PIAFP Lara
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#relacionando-documentos" class="md-nav__link">
    Relacionando documentos
  </a>
  
    <nav class="md-nav" aria-label="Relacionando documentos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencias-manuales" class="md-nav__link">
    Referencias manuales
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dbref" class="md-nav__link">
    DBRef
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datos-embebidos" class="md-nav__link">
    Datos embebidos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relaciones" class="md-nav__link">
    Relaciones
  </a>
  
    <nav class="md-nav" aria-label="Relaciones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1:1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1n" class="md-nav__link">
    1:N
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nm" class="md-nav__link">
    N:M
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jerarquicas" class="md-nav__link">
    Jerárquicas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patrones" class="md-nav__link">
    Patrones
  </a>
  
    <nav class="md-nav" aria-label="Patrones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#duplicidad-caducidad-e-integridad" class="md-nav__link">
    Duplicidad, caducidad e integridad
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-pattern" class="md-nav__link">
    Attribute Pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extended-reference-pattern" class="md-nav__link">
    Extended Reference Pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subset-pattern" class="md-nav__link">
    Subset Pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#computed-pattern" class="md-nav__link">
    Computed Pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bucket-pattern" class="md-nav__link">
    Bucket Pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-versioning-pattern" class="md-nav__link">
    Schema Versioning Pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tree-pattern" class="md-nav__link">
    Tree Pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#polymorphic-pattern" class="md-nav__link">
    Polymorphic Pattern
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validacion-de-esquemas" class="md-nav__link">
    Validación de esquemas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Modelado NoSQL</h1>

<p>things you need to keep in the back of your mind before you model:</p>
<p>The document model lets, and encourages, you to keep information that is used together inside one single document.
Atomicity, consistency, isolation, and durability (ACID) can be implemented by leveraging the document model, which is preferred, or by using MongoDB transactions.
Making early decisions and compromises about very large datasets will help make the data more manageable. For example, deleting or archiving documents after a given period of time may reduce the resources needed for the project.
Using a distributed system, like MongoDB, means that data can be written and read on servers all over the world. Carefully planning the location of the servers will improve performance and resilience of the applications.</p>
<ol>
<li>
<p>Definir la carga (<em>workload</em>):</p>
<ul>
<li>Comprender para qué operaciones estamos modelando</li>
<li>Cuantificar y calificar las operaciones de lectura y escritura</li>
<li>Listar las operaciones más importantes</li>
</ul>
<p>Diferentes cargas pueden provocar diferentes soluciones de modelado.</p>
</li>
<li>
<p>Modelar las relaciones</p>
<ul>
<li>de forma similar a los modelos relacionales, las relaciones 1:1, 1:M y N:M.</li>
<li>Las relaciones 1:1 normalmente se modelan con un documento embebido</li>
<li>las relaciones 1:M y N:M mediante un array de documentos o referencias a documentos de otra colección.</li>
<li>El hecho de decidir si utilizar un documento embebido o crear un enlace entre diferentes documentos es la decisión más crítica a la hora de modelar.</li>
</ul>
</li>
<li>
<p>Reconocer y Aplicar patrones de diseño</p>
<ul>
<li>Ofrecen transformaciones sobre el esquema, que se centran en el rendimiento, mantenimiento o simplificación de los requisitos.</li>
</ul>
</li>
</ol>
<p>MongoDB es una base de datos documental, no relacional, donde el esquema no se debe basar en el uso de claves ajenas/joins, ya que no existen.</p>
<p>A la hora de diseñar un esquema, si nos encontramos que el esquema esta en 3FN o si cuando hacemos consultas (recordad que no hay joins) estamos teniendo que realizar varias consultas de manera programativa (primero acceder a una tabla, con ese _id ir a otra tabla, etc…​.) es que no estamos siguiendo el enfoque adecuado.</p>
<p>MongoDB no soporta transacciones, ya que su enfoque distribuido dificultaría y penalizaría el rendimiento. En cambio, sí que asegura que las operaciones sean atómicas. Los posibles enfoques para solucionar la falta de transacciones son:</p>
<ol>
<li>Restructurar el código para que toda la información esté contenida en un único documento.</li>
<li>Implementar un sistema de bloqueo por software (semáforo, etc…​).</li>
<li>Tolerar un grado de inconsistencia en el sistema.</li>
</ol>
<p>Dependiendo del tipo de relación entre dos documentos, normalizaremos los datos para minimizar la redundancia pero manteniendo en la medida de lo posible que mediante operaciones atómicas se mantenga la integridad de los datos. Para ello, bien crearemos referencias entre dos documentos o embeberemos un documento dentro de otro.</p>
<h2 id="relacionando-documentos">Relacionando documentos<a class="headerlink" href="#relacionando-documentos" title="Permanent link">&para;</a></h2>
<p>Las aplicaciones que emplean MongoDB utilizan dos técnicas para relacionar documentos:</p>
<ul>
<li>Referencias <em>Manuales</em></li>
<li>Uso de <em>DBRef</em></li>
</ul>
<h3 id="referencias-manuales">Referencias manuales<a class="headerlink" href="#referencias-manuales" title="Permanent link">&para;</a></h3>
<p>De manera similar a una base de datos relacional, se almacena el campo <code>_id</code> de un documento en otro documento a modo de clave ajena. De este modo, la aplicación realiza una segunda consulta para obtener los datos relacionados. Estas referencias son sencillas y suficientes para la mayoría de casos de uso.</p>
<figure style="align: center;">
    <img src="images/03data-model-normalized.png" width="500px">
    <figcaption>Referencias manuales</figcaption>
</figure>

<p>Por ejemplo, si nos basamos en el gráfico anterior, podemos conseguir referenciar manualmente estos objetos del siguiente modo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">var</span><span class="w"> </span><span class="nx">idUsuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">();</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">usuario</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">idUsuario</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;123xyz&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="p">});</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">contacto</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="nx">usuario_id</span><span class="o">:</span><span class="w"> </span><span class="nx">idUsuario</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="nx">telefono</span><span class="o">:</span><span class="w">  </span><span class="s2">&quot;123 456 7890&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;xyz@ejemplo.com&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>FIXME: Para relacionar los dos documentos, haremos uso de la operación <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/"><code>$lookup</code></a> para hacer el <em>join</em>, o haremos una segunda consulta para la segunda colección.</p>
<p>FIXME: poner código</p>
<h3 id="dbref">DBRef<a class="headerlink" href="#dbref" title="Permanent link">&para;</a></h3>
<p>Son referencias de un documento a otro mediante el valor del campo <code>_id</code>, el nombre de la colección y, opcionalmente, el nombre de la base de datos. Estos objetos siguen una convención para representar un documento mediante la notación <code>{ "$ref" : &lt;nombreColeccion&gt;, "$id" : &lt;valorCampo_id&gt;, "$db" : &lt;nombreBaseDatos&gt; }</code>.</p>
<p>Al incluir estos nombres, las <em>DBRef</em> permite referenciar documentos localizados en diferentes colecciones.</p>
<p>Así pues, si reescribimos el código anterior mediante <em>DBRef</em> tendríamos que el contacto queda de la siguiente manera:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">contacto</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="nx">usuario_id</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DBRef</span><span class="p">(</span><span class="s2">&quot;usuario&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">idUsuario</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="nx">telefono</span><span class="o">:</span><span class="w">  </span><span class="s2">&quot;123-456-7890&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;xyz@example.com&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>De manera similar a las referencias manuales, mediante consultas adicionales se obtendrán los documentos referenciados.</p>
<p>Muchos drivers (incluido el de Python, mediante la clase <a href="https://pymongo.readthedocs.io/en/stable/api/bson/dbref.html">DBRef</a>) contienen métodos auxiliares que realizan las consultas con referencias DBRef automáticamennte.</p>
<p>Desde la propia documentación de <em>MongoDB</em> recomiendan el uso de referencias manuales y el uso de <code>$lookup</code>, a no ser que dispongamos documentos de una colección que referencian a documentos que se encuentran en varias colecciones diferentes.</p>
<h2 id="datos-embebidos">Datos embebidos<a class="headerlink" href="#datos-embebidos" title="Permanent link">&para;</a></h2>
<p>En cambio, si dentro de un documento almacenamos los datos mediante sub-documentos, ya sea dentro de un atributo o un array, podremos obtener todos los datos mediante un único acceso, sin necesidad de claves ajenas ni comprobaciones de integridad referencial.</p>
<figure style="align: center;">
    <img src="images/03data-model-denormalized.png" width="500px">
    <figcaption>Datos embebidos</figcaption>
</figure>

<p>Generalmente, emplearemos datos embebidos cuando tengamos:</p>
<ul>
<li>relaciones "contiene" entre entidades, entre relaciones de documentos "uno a uno" o "uno a pocos".</li>
<li>relaciones "uno a muchos" entre entidades. En estas relaciones los documentos hijo (o "muchos") siempre aparecen dentro del contexto del padre o del documento "uno".</li>
</ul>
<p>Los datos embebidos ofrecen mejor rendimiento al permitir obtener los datos mediante una única operación, así como modificar datos relacionados en una sola operación atómica de escritura.</p>
<p>Un aspecto a tener en cuenta es que un documento BSON puede contener un máximo de 16MB. Si quisiéramos que un atributo contenga más información, tendríamos que utilizar el API de GridFS.</p>
<h2 id="relaciones">Relaciones<a class="headerlink" href="#relaciones" title="Permanent link">&para;</a></h2>
<p>Vamos a estudiar en detalle cada uno de los tipos de relaciones, para intentar clarificar cuando es conveniente utilizar referencias o datos embebidos.</p>
<h3 id="11">1:1<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<p>Cuando existe una relación 1:1, como pueda ser entre Persona y Curriculum, o Persona y Direccion hay que embeber un documento dentro del otro, como parte de un atributo.</p>
<p>Ejemplo relación 1:1 - Persona/Dirección</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Aitor&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="nx">edad</span><span class="o">:</span><span class="w"> </span><span class="mf">38</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="nx">direccion</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="w">    </span><span class="nx">calle</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Mayor&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="w">    </span><span class="nx">ciudad</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Elx&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="7 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="8 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>La principal ventaja de este planteamiento es que mediante una única consulta podemos obtener tanto los detalles del usuario como su dirección.</p>
<p>Un par de aspectos que nos pueden llevar a no embeberlos son:</p>
<p>la frecuencia de acceso. Si a uno de ellos se accede raramente, puede que convenga tenerlos separados para liberar memoria.</p>
<p>el tamaño de los elementos. Si hay uno que es mucho más grande que el otro, o uno lo modificamos muchas más veces que el otro, para que cada vez que hagamos un cambio en un documento no tengamos que modificar el otro será mejor separarlos en documentos separados.</p>
<p>Pero siempre teniendo en cuenta la atomicidad de los datos, ya que si necesitamos modificar los dos documentos al mismo tiempo, tendremos que embeber uno dentro del otro.</p>
<h3 id="1n">1:N<a class="headerlink" href="#1n" title="Permanent link">&para;</a></h3>
<p>Vamos a distinguir dos tipos:</p>
<ul>
<li><strong>1 a muchos</strong>, como puede ser entre Editorial y Libro. Para este tipo de relación es mejor usar referencias entre los documentos colocando la referencia en el lado del muchos:</li>
</ul>
<p>Ejemplo relación 1:N - Editorial</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;O&#39;Reilly&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="nx">pais</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;EE.UU.&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Ejemplo relación 1:N - Libro</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1234</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;MongoDB: The Definitive Guide&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="nx">autor</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;Kristina Chodorow&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Mike Dirolf&quot;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="nx">numPaginas</span><span class="o">:</span><span class="w"> </span><span class="mf">216</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="nx">editorial_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1235</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;50 Tips and Tricks for MongoDB Developer&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="nx">autor</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Kristina Chodorow&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="nx">numPaginas</span><span class="o">:</span><span class="w"> </span><span class="mf">68</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="nx">editorial_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><strong>1 a pocos</strong>, como por ejemplo, dentro de un blog, la relación entre Mensaje y Comentario. En este caso, la mejor solución es crear un array dentro de la entidad 1 ( en nuestro caso, Mensaje). De este modo, el Mensaje contiene un array de Comentario:</li>
</ul>
<p>Ejemplo relación 1:N - Mensaje/Comentario</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;La broma asesina&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;http://es.wikipedia.org/wiki/Batman:_The_Killing_Joke&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="nx">texto</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;La dualidad de Batman y Joker&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="nx">comentarios</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="nx">autor</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Bruce Wayne&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">      </span><span class="nx">fecha</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2015-04-01T09:31:32Z&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">      </span><span class="nx">comentario</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;A mi me encantó&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">      </span><span class="nx">autor</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Bruno Díaz&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">      </span><span class="nx">fecha</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2015-04-03T10:07:28Z&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">      </span><span class="nx">comentario</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;El mejor&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Hay que tener siempre en mente la restricción de los 16 MB de BSON. Si vamos a embeber muchos documentos y estos son grandes, hay que vigilar no llegar a dicho tamaño.
En ocasiones las relaciones 1 a muchos se traducen en documentos embebidos cuando la información que nos interesa es la que contiene en un momento determinado. Por ejemplo, dentro de Pedido, el precio de los productos debe embeberse, ya que si en un futuro se modifica el precio de un producto determinado debido a una oferta, el pedido realizado no debe modificar su precio total.</p>
<p>Del mismo modo, al almacenar la dirección de una persona, también es conveniente embeberla. No queremos que la dirección de envío de un pedido se modique si un usuario modifica sus datos personales.</p>
<h3 id="nm">N:M<a class="headerlink" href="#nm" title="Permanent link">&para;</a></h3>
<p>Más que relaciones muchos a muchos, suelen ser relaciones pocos a pocos, como por ejemplo, Libro y Autor, o Profesor y Estudiante.</p>
<p>Supongamos que tenemos libros de la siguiente manera y autores con la siguiente estructura:</p>
<p>Ejemplo relación N:N - Libro</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;La historia interminable&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="nx">anyo</span><span class="o">:</span><span class="w"> </span><span class="mf">1979</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Ejemplo relación N:M - Autor</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Michael Ende&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="nx">pais</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Alemania&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Podemos resolver estas relaciones de tres maneras:</p>
<ol>
<li>
<p>Siguiendo un enfoque relacional, empleando un documento como la entidad que agrupa con referencias manuales a los dos documentos.</p>
<p>Ejemplo relación N:M - Autor/Libro</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="nx">autor_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="nx">libro_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Este enfoque se desaconseja porque necesita tres consultas para obtener toda la información.</p>
</li>
<li>
<p>Mediante 2 documentos, cada uno con un array que contenga los ids del otro documento (2 Way Embedding). Hay que tener cuidado porque podemos tener problemas de inconsistencia de datos si no actualizamos correctamente.</p>
<p>Ejemplo relación N:N - Libro referencia a Autor</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;La historia interminable&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="nx">anyo</span><span class="o">:</span><span class="w"> </span><span class="mf">1979</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="nx">autores</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="p">},{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Momo&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="nx">anyo</span><span class="o">:</span><span class="w"> </span><span class="mf">1973</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="nx">autores</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Ejemplo relación N:M - Autor referencia a Libro</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Michael Ende&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="nx">pais</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Alemania&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="nx">libros</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Embeber un documento dentro de otro (One Way Embedding). Por ejemplo:</p>
<p>Ejemplo relación N:M - Autor embebido en Libro</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;La historia interminable&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nx">anyo</span><span class="o">:</span><span class="w"> </span><span class="mf">1979</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nx">autores</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="nx">nombre</span><span class="o">:</span><span class="s2">&quot;Michael Ende&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pais</span><span class="o">:</span><span class="s2">&quot;Alemania&quot;</span><span class="p">}]</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="p">},{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Momo&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="nx">anyo</span><span class="o">:</span><span class="w"> </span><span class="mf">1973</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nx">autores</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="nx">nombre</span><span class="o">:</span><span class="s2">&quot;Michael Ende&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pais</span><span class="o">:</span><span class="s2">&quot;Alemania&quot;</span><span class="p">}]</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>En principio este enfoque no se recomienda porque el documento puede crecer mucho y provocar anomalías de modificaciones donde la información no es consistente. Si se opta por esta solución, hay que tener en cuenta que si un documento depende de otro para su creación (por ejemplo, si metemos los profesores dentro de los estudiantes, no vamos a poder dar de alta a profesores sin haber dado de alta previamente a un alumno).</p>
</li>
</ol>
<p>A modo de resumen, en las relaciones N:M, hay que establecer el tamaño de N y M. Si N como máximo vale 3 y M 500000, entonces deberíamos seguir un enfoque de embeber la N dentro de la M (One Way Embedding).</p>
<p>En cambio, si N vale 3 y M vale 5, entonces podemos hacer que ambos embeban al otro documento (Two Way Embedding).</p>
<div class="admonition tip">
<p class="admonition-title">Rendimiento e Integridad</p>
<p>A modo de resumen, embeber documentos ofrece un mejor rendimiento que referenciar, ya que con una única operación (ya sea una lectura o una escritura) podemos acceder a varios documentos.</p>
</div>
<p>Más información en <a href="http://docs.mongodb.org/manual/applications/data-models-relationships/">http://docs.mongodb.org/manual/applications/data-models-relationships/</a></p>
<h2 id="jerarquicas">Jerárquicas<a class="headerlink" href="#jerarquicas" title="Permanent link">&para;</a></h2>
<p>Si tenemos que modelar alguna entidad que tenga hijos y nos importa las relaciones padre-hijos (categoría-subcategoría), podemos tanto embeber un array con los hijos de un documento (children), como embeber un array con los padres de un documento (ancestors)</p>
<p>Más información en <a href="http://docs.mongodb.org/manual/applications/data-models-tree-structures/">http://docs.mongodb.org/manual/applications/data-models-tree-structures/</a></p>
<h2 id="patrones">Patrones<a class="headerlink" href="#patrones" title="Permanent link">&para;</a></h2>
<p><a href="https://www.mongodb.com/blog/post/building-with-patterns-a-summary">https://www.mongodb.com/blog/post/building-with-patterns-a-summary</a></p>
<p><a href="https://www.mongodb.com/developer/products/mongodb/schema-design-anti-pattern-summary/">https://www.mongodb.com/developer/products/mongodb/schema-design-anti-pattern-summary/</a></p>
<figure style="align: center;">
    <img src="images/03patterns.png">
    <figcaption>Patrones y Casos de Uso - mongodb.com</figcaption>
</figure>

<h3 id="duplicidad-caducidad-e-integridad">Duplicidad, caducidad e integridad<a class="headerlink" href="#duplicidad-caducidad-e-integridad" title="Permanent link">&para;</a></h3>
<h3 id="attribute-pattern">Attribute Pattern<a class="headerlink" href="#attribute-pattern" title="Permanent link">&para;</a></h3>
<h3 id="extended-reference-pattern">Extended Reference Pattern<a class="headerlink" href="#extended-reference-pattern" title="Permanent link">&para;</a></h3>
<p>In this case, the Extended Reference Pattern will easily take care of the additional queries our application is making. To implement the pattern we can modify the inventory item documents by adding frequently-accessed order data directly to them. This will result in lowering the number of related queries on the orders collection, since the relevant data about the orders will now be part of the inventory item documents.</p>
<h3 id="subset-pattern">Subset Pattern<a class="headerlink" href="#subset-pattern" title="Permanent link">&para;</a></h3>
<h3 id="computed-pattern">Computed Pattern<a class="headerlink" href="#computed-pattern" title="Permanent link">&para;</a></h3>
<p>En vez de calcular un dato agregado en cada lectura, en una colección aparte se guardan los datos calculados, de manera que cuando llega un nuevo registro, se recalcula este valor y se modifica el documento oportuno.</p>
<p>Tiene sentido en aplicaciones donde hay muchas más lecturas que escrituras.</p>
<p>The Computed Pattern allows your application to calculate values at write time. In this case, the sum of the number of views would be calculated in a rolling fashion by book genre.</p>
<h3 id="bucket-pattern">Bucket Pattern<a class="headerlink" href="#bucket-pattern" title="Permanent link">&para;</a></h3>
<p>Agrupar los datos por fecha o categoría para reducir la cantidad de documentos o el tamaño de los mismos.</p>
<p>The Bucket pattern allows us to record data in hour interval documents, which can then be stored in yearly collections. This makes it easy to store, analyze, and purge the data within the given time requirements.</p>
<h3 id="schema-versioning-pattern">Schema Versioning Pattern<a class="headerlink" href="#schema-versioning-pattern" title="Permanent link">&para;</a></h3>
<p>Añade un atributo schema_version para indicar que versión del esquema cumplen los datos.
Permite evitar downtime al realizar la actualización del esquema</p>
<p>This pattern allows for the application to quickly identify which document structure it is dealing with, the old one or the new. This helps to minimize downtime for the application user, while allowing the database to smoothly transition to the new schema.</p>
<h3 id="tree-pattern">Tree Pattern<a class="headerlink" href="#tree-pattern" title="Permanent link">&para;</a></h3>
<p>Representación de datos jerárquicos.</p>
<p>Referencias de hijos, padre, array de <em>ancestors</em>, <em>materilized paths</em>.</p>
<h3 id="polymorphic-pattern">Polymorphic Pattern<a class="headerlink" href="#polymorphic-pattern" title="Permanent link">&para;</a></h3>
<p>The problem states that bodegas sell a variety of items from different categories, with different purposes and properties. In this case, the Polymorphic Pattern will be the best candidate to catalog this set of goods.</p>
<div class="admonition note">
<p class="admonition-title">Otros patrones</p>
</div>
<p>asdf</p>
<h2 id="validacion-de-esquemas">Validación de esquemas<a class="headerlink" href="#validacion-de-esquemas" title="Permanent link">&para;</a></h2>
<p>Aunque los esquemas son dinámicos y podemos añadir nuevos campos confome evoluciona nuestro modelo, podemos validar los esquemas para:</p>
<ul>
<li>asegurar la existencia de un campo</li>
<li>asegurar que un campo está rellenado (no nulo)</li>
<li>asegurar el tipo de datos de un campo</li>
<li>restringir entre un conjunto de valores</li>
</ul>
<p>Para ello se utiliza el operador <a href="https://www.mongodb.com/docs/manual/reference/operator/query/jsonSchema/#json-schema"><code>$jsonSchema</code></a>. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="err">$jso</span><span class="kc">n</span><span class="err">Schema</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">     </span><span class="err">required</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;major&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gpa&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;address&quot;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">     </span><span class="err">proper</span><span class="kc">t</span><span class="err">ies</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">        </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">           </span><span class="err">bso</span><span class="kc">n</span><span class="err">Type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">           </span><span class="err">descrip</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;must be a string and is required&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="err">address</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">           </span><span class="err">bso</span><span class="kc">n</span><span class="err">Type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">           </span><span class="err">required</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;zipcode&quot;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">           </span><span class="err">proper</span><span class="kc">t</span><span class="err">ies</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">               </span><span class="nt">&quot;street&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">bso</span><span class="kc">n</span><span class="err">Type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">               </span><span class="nt">&quot;zipcode&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">bso</span><span class="kc">n</span><span class="err">Type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">           </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>De este modo, podemos validar un documento contra uno o más esquemas a la vez, lo que facilita la evolución de los esquemas a lo lago del tiempo.</p>
<p><a href="https://www.mongodb.com/docs/manual/core/schema-validation/specify-json-schema/#std-label-schema-validation-json">https://www.mongodb.com/docs/manual/core/schema-validation/specify-json-schema/#std-label-schema-validation-json</a></p>
<p><a href="https://www.mongodb.com/docs/manual/core/schema-validation/use-json-schema-query-conditions/#std-label-use-json-schema-query-conditions">https://www.mongodb.com/docs/manual/core/schema-validation/use-json-schema-query-conditions/#std-label-use-json-schema-query-conditions</a></p>
<p>FIXME: revisar la validación de los esquemas
<a href="https://www.mongodb.com/docs/manual/core/schema-validation/">https://www.mongodb.com/docs/manual/core/schema-validation/</a>
<a href="https://www.digitalocean.com/community/tutorials/how-to-use-schema-validation-in-mongodb">https://www.digitalocean.com/community/tutorials/how-to-use-schema-validation-in-mongodb</a></p>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<p>Vídeo <a href="https://www.youtube.com/watch?v=DUCvYbcgGsQ">A Complete Methodology of Data Modeling for MongoDB</a></p>
<p><a href="https://andreshevia.com/2020/10/18/diseno-de-modelos-de-datos-nosql/">https://andreshevia.com/2020/10/18/diseno-de-modelos-de-datos-nosql/</a></p>
<p><a href="https://www.mongodb.com/developer/products/mongodb/mongodb-schema-design-best-practices/">https://www.mongodb.com/developer/products/mongodb/mongodb-schema-design-best-practices/</a></p>
<p><a href="https://medium.com/geekculture/mongodb-data-modeling-matters-first-step-to-optimization-data-modeling-series-1-158be911ecb8">https://medium.com/geekculture/mongodb-data-modeling-matters-first-step-to-optimization-data-modeling-series-1-158be911ecb8</a></p>
<p><a href="https://www.mongodb.com/developer/products/mongodb/schema/tutorials/">https://www.mongodb.com/developer/products/mongodb/schema/tutorials/</a>
<a href="https://www.mongodb.com/developer/products/mongodb/schema-design-anti-pattern-summary/">https://www.mongodb.com/developer/products/mongodb/schema-design-anti-pattern-summary/</a></p>
<p><a href="https://www.mongodb.com/blog/post/performance-best-practices-mongodb-data-modeling-and-memory-sizing">https://www.mongodb.com/blog/post/performance-best-practices-mongodb-data-modeling-and-memory-sizing</a></p>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<ol>
<li>(1p) Estimación de la carga de trabajo en un proceso de ingesta de datos. (Metodología curso MongoDB University)</li>
<li>(2p) Ejercicios de modelado de relaciones 1:1, 1:N, N:M que impliquen documentos embebidos y/o relaciones</li>
<li>(1p) Consultas agregadas sobre documentos con o sin referencias a otras colecciones.</li>
</ol>
<!--

RDBMS Parent-Child Tables vs. MongoDB Nested Sub-Document or Array

A table has a relationship to other tables, relations like one-to-one, one-to-many, or many-to-many by linking attributes from both tables.

MongoDB can express the relationships between collections similarly. However, MongoDB has an additional feature, the ability to take the fields of child table and embed it with the parent table as a single collection.

This grouping leads to a data model with far fewer collections than the number of tables in the corresponding relational model.

----

RDBMS Join vs. MongoDB Embedding, Linking, or $lookup

Joins are used in a relational database to get data from two or more tables.

With MongoDB, there is a $lookup operator to perform the same link between collections.

Additionally, some relationships are also expressed by embedding the child table in the parent table. For these relationship, there is no need to use the $lookup keyword, as the data is already pre-joined in the document. The document model makes things much natural and queries so much simpler.

-->


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        ¿Ha sido útil está página?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Sí, ha sido util" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="La página es mejorable" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
                Gracias por tu colaboración!
              
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
                Gracias por tu colaboración! Ayúdame a mejorarla enviandome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
              
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  

<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input type="checkbox" class="md-toggle" id="__settings">
<div class="md-consent__settings">
  <ul class="task-list">
    
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        <label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);console.log(new FormData(form)),__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow"], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>