
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Acceso a MongoDB desde Python mediante la librería PyMongo">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/sa/07pymongo.html">
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.10">
    
    
      
        <title>PyMongo - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="PyMongo - Inteligencia Artificial y Big Data" >
      
        <meta  property="og:description"  content="Acceso a MongoDB desde Python mediante la librería PyMongo" >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/07pymongo.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/sa/07pymongo.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="PyMongo - Inteligencia Artificial y Big Data" >
      
        <meta  name="twitter:description"  content="Acceso a MongoDB desde Python mediante la librería PyMongo" >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/07pymongo.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hola-pymongo" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PyMongo
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo día"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Cambiar a modo día" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">UT2.- Sistemas de almacenamiento</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT2.- Sistemas de almacenamiento" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          UT2.- Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01nosql.html" class="md-nav__link">
        S18.- Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02mongo.html" class="md-nav__link">
        S19.- MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="03modelado.html" class="md-nav__link">
        S21.- Modelado de datos NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="05agregaciones.html" class="md-nav__link">
        S25.- Agregaciones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="06replicacion.html" class="md-nav__link">
        S28.- Replicación y Particionado
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          S30.- MongoDB y Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="07pymongo.html" class="md-nav__link md-nav__link--active">
        S30.- MongoDB y Python
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hola-pymongo" class="md-nav__link">
    Hola PyMongo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongoclient" class="md-nav__link">
    MongoClient
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#primeras-consultas" class="md-nav__link">
    Primeras consultas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agregaciones" class="md-nav__link">
    Agregaciones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trabajando-con-cursores" class="md-nav__link">
    Trabajando con cursores
  </a>
  
    <nav class="md-nav" aria-label="Trabajando con cursores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#limitando" class="md-nav__link">
    Limitando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordenando" class="md-nav__link">
    Ordenando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saltando" class="md-nav__link">
    Saltando
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crud" class="md-nav__link">
    CRUD
  </a>
  
    <nav class="md-nav" aria-label="CRUD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#insercion" class="md-nav__link">
    Inserción
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#borrado" class="md-nav__link">
    Borrado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modificacion" class="md-nav__link">
    Modificación
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operaciones-consistentes" class="md-nav__link">
    Operaciones consistentes
  </a>
  
    <nav class="md-nav" aria-label="Operaciones consistentes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preferencias-de-lectura" class="md-nav__link">
    Preferencias de lectura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escrituras-consistentes" class="md-nav__link">
    Escrituras consistentes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transacciones" class="md-nav__link">
    Transacciones
  </a>
  
    <nav class="md-nav" aria-label="Transacciones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tipos-de-api" class="md-nav__link">
    Tipos de API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hola-mundo-callback-api" class="md-nav__link">
    Hola Mundo Callback API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-pia-login" class="md-nav__link">
    Caso de uso - PIA: Login
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso - PIA: Login">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estructura" class="md-nav__link">
    Estructura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion" class="md-nav__link">
    Configuración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blueprints" class="md-nav__link">
    Blueprints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#login" class="md-nav__link">
    Login
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plantillas" class="md-nav__link">
    Plantillas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acceso-a-los-datos" class="md-nav__link">
    Acceso a los datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../hadoop/index.html">UT5.- Ecosistema Hadoop</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT5.- Ecosistema Hadoop" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          UT5.- Ecosistema Hadoop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/01arq.html" class="md-nav__link">
        S36.- Arquitecturas Big Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/02etl.html" class="md-nav__link">
        S36.- Ingesta de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/03hadoop.html" class="md-nav__link">
        S38.- Hadoop
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04hdfs.html" class="md-nav__link">
        S39.- HDFS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04formatos.html" class="md-nav__link">
        S39.- Formatos de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/05flume.html" class="md-nav__link">
        S43.- Sqoop y Flume
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/06hive.html" class="md-nav__link">
        S45.- Hive
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../cloud/index.html">UT6.- Datos en el cloud</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT6.- Datos en el cloud" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          UT6.- Datos en el cloud
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/01cloud.html" class="md-nav__link">
        S33.- Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/02aws.html" class="md-nav__link">
        S33.- AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/03s3.html" class="md-nav__link">
        S40.- S3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/04computacion.html" class="md-nav__link">
        S44.- EC2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/05emr.html" class="md-nav__link">
        S44.- EMR
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/06datos.html" class="md-nav__link">
        S46.- RDS y DynamoDB
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        UT7.- PIAFP Lara
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hola-pymongo" class="md-nav__link">
    Hola PyMongo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongoclient" class="md-nav__link">
    MongoClient
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#primeras-consultas" class="md-nav__link">
    Primeras consultas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agregaciones" class="md-nav__link">
    Agregaciones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trabajando-con-cursores" class="md-nav__link">
    Trabajando con cursores
  </a>
  
    <nav class="md-nav" aria-label="Trabajando con cursores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#limitando" class="md-nav__link">
    Limitando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordenando" class="md-nav__link">
    Ordenando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saltando" class="md-nav__link">
    Saltando
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crud" class="md-nav__link">
    CRUD
  </a>
  
    <nav class="md-nav" aria-label="CRUD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#insercion" class="md-nav__link">
    Inserción
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#borrado" class="md-nav__link">
    Borrado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modificacion" class="md-nav__link">
    Modificación
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operaciones-consistentes" class="md-nav__link">
    Operaciones consistentes
  </a>
  
    <nav class="md-nav" aria-label="Operaciones consistentes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preferencias-de-lectura" class="md-nav__link">
    Preferencias de lectura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escrituras-consistentes" class="md-nav__link">
    Escrituras consistentes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transacciones" class="md-nav__link">
    Transacciones
  </a>
  
    <nav class="md-nav" aria-label="Transacciones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tipos-de-api" class="md-nav__link">
    Tipos de API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hola-mundo-callback-api" class="md-nav__link">
    Hola Mundo Callback API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-pia-login" class="md-nav__link">
    Caso de uso - PIA: Login
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso - PIA: Login">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estructura" class="md-nav__link">
    Estructura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion" class="md-nav__link">
    Configuración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blueprints" class="md-nav__link">
    Blueprints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#login" class="md-nav__link">
    Login
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plantillas" class="md-nav__link">
    Plantillas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acceso-a-los-datos" class="md-nav__link">
    Acceso a los datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>S30.- MongoDB y Python</h1>

<p>Para acceder a MongoDB desde Python nos vamos a centrar en la librería <a href="https://pypi.org/project/pymongo/">PyMongo</a>.</p>
<p>Para instalar la librería mediante <code>pip</code> usaremos el comando (recuerda hacerlo dentro de un entorno virtual):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip install pymongo
</code></pre></div>
<p>Se recomienda consultar la <a href="https://pymongo.readthedocs.io/en/stable/">documentación</a> o el <a href="https://pymongo.readthedocs.io/en/stable/api/index.html">API</a> para cualquier duda o aclaración.</p>
<div class="admonition info">
<p class="admonition-title">Versión</p>
<p>En el momento de escribir los apuntes, estamos utilizando la versión 4.3.2 de PyMongo.</p>
</div>
<h2 id="hola-pymongo">Hola PyMongo<a class="headerlink" href="#hola-pymongo" title="Permanent link">&para;</a></h2>
<p>Un ejemplo básico podría ser similar a:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">cliente</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s1">&#39;mongodb://localhost:27017&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">iabd_db</span> <span class="o">=</span> <span class="n">cliente</span><span class="o">.</span><span class="n">iabd</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># Recuperamos las colecciones</span>
<span class="linenos" data-linenos=" 7 "></span><span class="nb">print</span><span class="p">(</span><span class="n">iabd_db</span><span class="o">.</span><span class="n">list_collection_names</span><span class="p">())</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">people_coll</span> <span class="o">=</span> <span class="n">iabd_db</span><span class="o">.</span><span class="n">people</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># Recuperamos una persona</span>
<span class="linenos" data-linenos="12 "></span><span class="n">persona</span> <span class="o">=</span> <span class="n">people_coll</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="linenos" data-linenos="13 "></span><span class="nb">print</span><span class="p">(</span><span class="n">persona</span><span class="p">)</span>
</code></pre></div>
<h2 id="mongoclient">MongoClient<a class="headerlink" href="#mongoclient" title="Permanent link">&para;</a></h2>
<p>A partir de la URI de conexión a MongoDB, hemos de instanciar la clase <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/mongo_client.html"><code>MongoClient</code></a>, ya sea pasándole una URI con la cadena de conexión, o mediante parámetros:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;mongodb+srv://usuario:contrasenya@host&quot;</span>
<span class="linenos" data-linenos="2 "></span><span class="n">cliente</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Parámetros adicionales</p>
<p>A la hora de crear el cliente, también podemos indicarle diferentes opciones de configuración:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">cliente200Retry</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">connectTimeoutMS</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">retryWrites</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Realmente, al crear la conexión se inicializa un pool de conexiones, de manera que se crean 100 conexiones, y en vez de crear y destruir una conexión por cada petición, se reutilizan, de manera que cada petición asigna y libera una conexión conforme necesidad. Por defecto, el tamaño del pool es de 100 conexiones.</p>
<figure style="align: center;">
    <img src="images/07connection-pool.png" width="500px">
    <figcaption>Pool de conexiones</figcaption>
</figure>

<p>Podemos obtener información de la conexión mediante la propiedad <code>state</code>. Por ejemplo, en nuestro caso, nos hemos conectado a <em>MongoAtlas</em> y de la salida del estado podemos ver los diferentes <em>hosts</em> que forman parte del conjunto de réplicas:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">cliente</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s1">&#39;mongodb+srv://iabd:iabdiabd@cluster0.dfaz5er.mongodb.net/&#39;</span><span class="p">)</span>
<span class="hll"><span class="linenos" data-linenos="2 "></span><span class="nb">print</span><span class="p">(</span><span class="n">cliente</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span class="linenos" data-linenos="3 "></span><span class="c1"># Database(MongoClient(host=[&#39;ac-opunia9-shard-00-01.dfaz5er.mongodb.net:27017&#39;, &#39;ac-opunia9-shard-00-02.dfaz5er.mongodb.net:27017&#39;, &#39;ac-opunia9-shard-00-00.dfaz5er.mongodb.net:27017&#39;], document_class=dict, tz_aware=False, connect=True, authsource=&#39;admin&#39;, replicaset=&#39;atlas-4wikkb-shard-0&#39;, tls=True), &#39;state&#39;)</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Conexión a un réplica</p>
<p>Si nos queremos conectar a un conjunto de réplicas e indicar los nodos a los que nos podemos conectar, podemos separar los <em>hosts</em> con comas e indicar finalmente con un parámetro el nombre del conjunto de réplicas:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s1">&#39;mongodb://usuario1:contra1@host1:puerto1,host2:puerto2/?replicaSet=nombreReplica&#39;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>A partir del cliente, podemos obtener información diversa. Por ejemplo, podemos recuperar un listado de las bases de datos mediante <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/mongo_client.html#pymongo.mongo_client.MongoClient.list_database_names"><code>list_database_names()</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nb">print</span><span class="p">(</span><span class="n">cliente</span><span class="o">.</span><span class="n">list_database_names</span><span class="p">())</span>
<span class="linenos" data-linenos="2 "></span><span class="c1"># [&#39;sample_airbnb&#39;, &#39;sample_analytics&#39;, &#39;sample_geospatial&#39;, &#39;sample_guides&#39;, &#39;sample_mflix&#39;, &#39;sample_restaurants&#39;, &#39;sample_supplies&#39;, &#39;sample_training&#39;, &#39;sample_weatherdata&#39;, &#39;admin&#39;, &#39;local&#39;]</span>
</code></pre></div>
<p>Para conectarnos a una base de datos en concreto, únicamente accederemos a ella como una propiedad del cliente:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">bd</span> <span class="o">=</span> <span class="n">cliente</span><span class="o">.</span><span class="n">sample_mflix</span>
<span class="linenos" data-linenos="2 "></span><span class="n">bd</span> <span class="o">=</span> <span class="n">cliente</span><span class="p">[</span><span class="s2">&quot;sample_mflix&quot;</span><span class="p">]</span> <span class="c1"># tb podemos acceder como si fuera un diccionario</span>
</code></pre></div>
<div class="admonition tip inline end">
<p class="admonition-title">Bases de datos y colecciones Lazy</p>
<p>Es conveniente tener en cuenta que tantos las colecciones como las bases de datos se crean y carga de forma perezosa, esto es, hasta que no realizamos una operación sobre ellas, no se accede realmente a ellas. Así pues, para crear realmente una colección, hemos de insertar un documento en ella.</p>
</div>
<p>Una vez tenemos la base de datos, el siguiente paso es obtener una colección:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">coleccion</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">movies</span>
<span class="linenos" data-linenos="2 "></span><span class="n">coleccion</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="s2">&quot;movies&quot;</span><span class="p">]</span> 
</code></pre></div>
<p>Si queremos obtener el nombre de todas las colecciones usaremos el método <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/database.html#pymongo.database.Database.list_collection_names"><code>list_collection_names()</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nb">print</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">list_collection_names</span><span class="p">())</span>
<span class="linenos" data-linenos="2 "></span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;movies&#39;</span><span class="p">,</span> <span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;theaters&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="admonition caution">
<p class="admonition-title">Tolerancia a fallos!</p>
<p>Al crear una conexión, conviene especificar el tamaño del <em>pool</em> y el <em>timeout</em> de las conexiones:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">db</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">URI</span><span class="p">,</span> <span class="n">maxPoolSize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">wtimeout</span><span class="o">=</span><span class="mi">2500</span><span class="p">)[</span><span class="n">nombreBD</span><span class="p">]</span>
</code></pre></div>
<p>Se recomienda siempre especificar un <code>wtimeout</code>, ya que cuando se realiza una escritura con mayoría de escrituras, si fallase algún nodo no se quedaría colgado esperando.</p>
<p>Si no encontrase el servidor, lanzará un <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/errors.html#pymongo.errors.ServerSelectionTimeoutError"><code>ServerSelectionTimeoutError</code></a> el cual deberíamos capturar.</p>
</div>
<h2 id="primeras-consultas">Primeras consultas<a class="headerlink" href="#primeras-consultas" title="Permanent link">&para;</a></h2>
<p>Finalmente, sobre una colección ya podemos realizar consultas y otras operaciones:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">movies</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">movies</span>
<span class="linenos" data-linenos="2 "></span><span class="n">movies</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({})</span>
<span class="linenos" data-linenos="3 "></span><span class="c1"># 23530</span>
<span class="linenos" data-linenos="4 "></span><span class="n">movies</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="linenos" data-linenos="5 "></span><span class="c1"># {&#39;_id&#39;: ObjectId(&#39;573a1390f29313caabcd4135&#39;), &#39;plot&#39;: &#39;Three men hammer on an anvil and pass a bottle of beer around.&#39;, &#39;genres&#39;: [&#39;Short&#39;], &#39;runtime&#39;: 1, &#39;cast&#39;: [&#39;Charles Kayser&#39;, &#39;John Ott&#39;], &#39;num_mflix_comments&#39;: 1, &#39;title&#39;: &#39;Blacksmith Scene&#39;, &#39;fullplot&#39;: &#39;A stationary ...&#39;, &#39;countries&#39;: [&#39;USA&#39;], &#39;released&#39;: datetime.datetime(1893, 5, 9, 0, 0), &#39;directors&#39;: [&#39;William K.L. Dickson&#39;], &#39;rated&#39;: &#39;UNRATED&#39;, &#39;awards&#39;: {&#39;wins&#39;: 1, &#39;nominations&#39;: 0, &#39;text&#39;: &#39;1 win.&#39;}, &#39;lastupdated&#39;: &#39;2015-08-26 00:03:50.133000000&#39;, &#39;year&#39;: 1893, &#39;imdb&#39;: {&#39;rating&#39;: 6.2, &#39;votes&#39;: 1189, &#39;id&#39;: 5}, &#39;type&#39;: &#39;movie&#39;, &#39;tomatoes&#39;: {&#39;viewer&#39;: {&#39;rating&#39;: 3.0, &#39;numReviews&#39;: 184, &#39;meter&#39;: 32}, &#39;lastUpdated&#39;: datetime.datetime(2015, 6, 28, 18, 34, 9)}}</span>
</code></pre></div>
<p>Por ejemplo, podemos filtrar las películas cuya actriz sea <code>Salma Hayek</code>. Al realizar la consulta, <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.find"><code>find</code></a> devuelve un <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/cursor.html#pymongo.cursor.Cursor"><code>cursor</code></a>, el cual podemos recorrer:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Consulta</label><label for="__tabbed_1_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="s2">&quot;Salma Hayek&quot;</span> <span class="p">}</span> <span class="p">)</span>
<span class="linenos" data-linenos="2 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
<span class="linenos" data-linenos="3 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(&#39;</span><span class="mi">573</span><span class="err">a</span><span class="mi">1399</span><span class="kc">f</span><span class="mi">29313</span><span class="err">caabceea</span><span class="mi">6</span><span class="err">d&#39;)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="err">&#39;awards&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="kc">n</span><span class="err">omi</span><span class="kc">nat</span><span class="err">io</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="kc">te</span><span class="err">x</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="w"> </span><span class="kc">n</span><span class="err">omi</span><span class="kc">nat</span><span class="err">io</span><span class="kc">n</span><span class="err">.&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;wi</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="err">&#39;cas</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;David</span><span class="w"> </span><span class="err">Arque</span><span class="kc">tte</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Joh</span><span class="kc">n</span><span class="w"> </span><span class="err">Hawkes&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Salma</span><span class="w"> </span><span class="err">Hayek&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Jaso</span><span class="kc">n</span><span class="w"> </span><span class="err">Wiles&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="err">&#39;cou</span><span class="kc">ntr</span><span class="err">ies&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;USA&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="err">...</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="err">&#39;wri</span><span class="kc">ters</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Rober</span><span class="kc">t</span><span class="w"> </span><span class="err">Rodriguez&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Tommy</span><span class="w"> </span><span class="err">Nix&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="err">&#39;year&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1994</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="p">{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(&#39;</span><span class="mi">573</span><span class="err">a</span><span class="mi">139</span><span class="err">a</span><span class="kc">f</span><span class="mi">29313</span><span class="err">caabce</span><span class="kc">f</span><span class="mi">0</span><span class="err">b</span><span class="mi">6</span><span class="err">&#39;)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="err">&#39;awards&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="kc">n</span><span class="err">omi</span><span class="kc">nat</span><span class="err">io</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="kc">te</span><span class="err">x</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">27</span><span class="w"> </span><span class="err">wi</span><span class="kc">ns</span><span class="w"> </span><span class="err">&amp;</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="kc">n</span><span class="err">omi</span><span class="kc">nat</span><span class="err">io</span><span class="kc">ns</span><span class="err">.&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;wi</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="err">&#39;cas</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Er</span><span class="kc">nest</span><span class="err">o</span><span class="w"> </span><span class="err">Gómez</span><span class="w"> </span><span class="err">Cruz&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;María</span><span class="w"> </span><span class="err">Rojo&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Salma</span><span class="w"> </span><span class="err">Hayek&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Bru</span><span class="kc">n</span><span class="err">o</span><span class="w"> </span><span class="err">Bichir&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="err">&#39;cou</span><span class="kc">ntr</span><span class="err">ies&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Mexico&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="err">...</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<p>Si queremos contar los documentos que cumplen un criterio, en vez de <code>find</code>, usaremos <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.count_documents"><code>count_documents</code></a> pasándole el criterio de filtrado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">cantidad</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="s2">&quot;Salma Hayek&quot;</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></div>
<p>Para seleccionar los campos que queremos recuperar, necesitamos pasar un segundo parámetro con la proyección:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Consulta</label><label for="__tabbed_2_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="s2">&quot;Salma Hayek&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">)</span>
<span class="linenos" data-linenos="2 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
<span class="linenos" data-linenos="3 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s1">&#39;573a1399f29313caabceea6d&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;cast&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;David Arquette&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;John Hawkes&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Salma Hayek&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Jason Wiles&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;title&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Roadracers&#39;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s1">&#39;573a139af29313caabcef0b6&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;cast&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Ernesto Gómez Cruz&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;María Rojo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Salma Hayek&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bruno Bichir&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;title&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Midaq Alley&#39;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">...</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<p>Como ya vimos al hacer consultas en sesiones anterior, si no queremos el campo <code>_id</code>, tenemos que indicarlo:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Consulta</label><label for="__tabbed_3_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="s2">&quot;Salma Hayek&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span> <span class="p">)</span>
<span class="linenos" data-linenos="2 "></span><span class="k">for</span> <span class="nb">zip</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
<span class="linenos" data-linenos="3 "></span>    <span class="nb">print</span><span class="p">(</span><span class="nb">zip</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="s1">&#39;cast&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;David Arquette&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;John Hawkes&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Salma Hayek&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Jason Wiles&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;title&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Roadracers&#39;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="s1">&#39;cast&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Ernesto Gèmez Cruz&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Marèa Rojo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Salma Hayek&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bruno Bichir&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;title&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Midaq Alley&#39;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Desperado&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cast&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Antonio Banderas&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Salma Hayek&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Joaquim de Almeida&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Cheech Marin&#39;</span><span class="p">]}</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="p">...</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">BSON</p>
<p>Cuando necesitemos pasar los documentos BSON a JSON, utilizaremos la función <code>dumps</code> que transforma el documento a JSON:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="s2">&quot;Salma Hayek&quot;</span> <span class="p">}</span> <span class="p">)</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">bson.json_util</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="nb">print</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="linenos" data-linenos=" 6 "></span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="sd">[</span>
<span class="linenos" data-linenos=" 8 "></span><span class="sd">    {</span>
<span class="linenos" data-linenos=" 9 "></span><span class="sd">        &quot;_id&quot;: {</span>
<span class="linenos" data-linenos="10 "></span><span class="sd">            &quot;$oid&quot;: &quot;573a1399f29313caabceea6d&quot;</span>
<span class="linenos" data-linenos="11 "></span><span class="sd">        },</span>
<span class="linenos" data-linenos="12 "></span><span class="sd">        &quot;plot&quot;: &quot;Cynical look at a 50&#39;s rebellious Rocker who has to confront his future, thugs with knives, and the crooked town sheriff.&quot;,</span>
<span class="linenos" data-linenos="13 "></span><span class="sd">        &quot;genres&quot;: [</span>
<span class="linenos" data-linenos="14 "></span><span class="sd">            &quot;Action&quot;,</span>
<span class="linenos" data-linenos="15 "></span><span class="sd">            &quot;Drama&quot;</span>
<span class="linenos" data-linenos="16 "></span><span class="sd">        ],</span>
<span class="linenos" data-linenos="17 "></span><span class="sd">        &quot;runtime&quot;: 95,</span>
<span class="linenos" data-linenos="18 "></span><span class="sd">        &quot;rated&quot;: &quot;R&quot;,</span>
<span class="linenos" data-linenos="19 "></span><span class="sd">        &quot;cast&quot;: [</span>
<span class="linenos" data-linenos="20 "></span><span class="sd">            &quot;David Arquette&quot;,</span>
<span class="linenos" data-linenos="21 "></span><span class="sd">            &quot;John Hawkes&quot;,</span>
<span class="linenos" data-linenos="22 "></span><span class="sd">            &quot;Salma Hayek&quot;,</span>
<span class="linenos" data-linenos="23 "></span><span class="sd">            &quot;Jason Wiles&quot;</span>
<span class="linenos" data-linenos="24 "></span><span class="sd">            ],</span>
<span class="linenos" data-linenos="25 "></span><span class="sd">        ...</span>
<span class="linenos" data-linenos="26 "></span><span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>
</div>
<h2 id="agregaciones">Agregaciones<a class="headerlink" href="#agregaciones" title="Permanent link">&para;</a></h2>
<p>Para realizar consultas mediante el <em>framework</em> de agregación, usaremos el método <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.aggregate"><code>aggregate</code></a>, el cual recibe un array con el pipeline:</p>
<p>Por ejemplo, vamos a recuperar el título y el casting de las películas dirigidas por <code>Sam Raimi</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Consulta</label><label for="__tabbed_4_2">Resultados</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">match_stage</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;directors&quot;</span><span class="p">:</span> <span class="s2">&quot;Sam Raimi&quot;</span> <span class="p">}</span> <span class="p">}</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">project_stage</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">match_stage</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">project_stage</span>
<span class="linenos" data-linenos=" 7 "></span><span class="p">]</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="hll"><span class="linenos" data-linenos=" 9 "></span><span class="n">sam_raimi_aggregation</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
</span><span class="linenos" data-linenos="10 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">sam_raimi_aggregation</span><span class="p">:</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="err">&#39;cas</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Bruce</span><span class="w"> </span><span class="err">Campbell&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">        </span><span class="err">&#39;Elle</span><span class="kc">n</span><span class="w"> </span><span class="err">Sa</span><span class="kc">n</span><span class="err">dweiss&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">        </span><span class="err">&#39;Richard</span><span class="w"> </span><span class="err">DeMa</span><span class="kc">n</span><span class="err">i</span><span class="kc">n</span><span class="err">cor&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="err">&#39;Be</span><span class="kc">ts</span><span class="err">y</span><span class="w"> </span><span class="err">Baker&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="err">&#39;</span><span class="kc">t</span><span class="err">i</span><span class="kc">tle</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;The</span><span class="w"> </span><span class="err">Evil</span><span class="w"> </span><span class="err">Dead&#39;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="p">{</span><span class="err">&#39;cas</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Bruce</span><span class="w"> </span><span class="err">Campbell&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="err">&#39;Sarah</span><span class="w"> </span><span class="err">Berry&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="err">&#39;Da</span><span class="kc">n</span><span class="w"> </span><span class="err">Hicks&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="err">&#39;Kassie</span><span class="w"> </span><span class="err">Wesley</span><span class="w"> </span><span class="err">DePaiva&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="err">&#39;</span><span class="kc">t</span><span class="err">i</span><span class="kc">tle</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Evil</span><span class="w"> </span><span class="err">Dead</span><span class="w"> </span><span class="err">II&#39;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">{</span><span class="err">&#39;cas</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Liam</span><span class="w"> </span><span class="err">Neeso</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Fra</span><span class="kc">n</span><span class="err">ces</span><span class="w"> </span><span class="err">McDorma</span><span class="kc">n</span><span class="err">d&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Coli</span><span class="kc">n</span><span class="w"> </span><span class="err">Friels&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Larry</span><span class="w"> </span><span class="err">Drake&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="err">&#39;</span><span class="kc">t</span><span class="err">i</span><span class="kc">tle</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Darkma</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<p>Otro ejemplo, donde recuperamos los directores y la valoración media de sus películas, ordenadas de mejor a peor:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Consulta</label><label for="__tabbed_5_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">unwind_stage</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s2">&quot;$directors&quot;</span> <span class="p">}</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">group_stage</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 4 "></span>        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span>            <span class="s2">&quot;director&quot;</span><span class="p">:</span> <span class="s2">&quot;$directors&quot;</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="s2">&quot;average_rating&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;$avg&quot;</span><span class="p">:</span> <span class="s2">&quot;$imdb.rating&quot;</span> <span class="p">}</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">}</span>
<span class="linenos" data-linenos="10 "></span><span class="n">sort_stage</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>    <span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;average_rating&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span>
<span class="linenos" data-linenos="12 "></span><span class="p">}</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># Creamos un pipeline con las tres fases</span>
<span class="linenos" data-linenos="15 "></span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">unwind_stage</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">group_stage</span><span class="p">,</span>
<span class="linenos" data-linenos="18 "></span>    <span class="n">sort_stage</span>
<span class="linenos" data-linenos="19 "></span><span class="p">]</span>
<span class="linenos" data-linenos="20 "></span>
<span class="hll"><span class="linenos" data-linenos="21 "></span><span class="n">director_ratings</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
</span><span class="linenos" data-linenos="22 "></span>
<span class="linenos" data-linenos="23 "></span><span class="k">for</span> <span class="n">director</span> <span class="ow">in</span> <span class="n">director_ratings</span><span class="p">:</span>
<span class="linenos" data-linenos="24 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">director</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;direc</span><span class="kc">t</span><span class="err">or&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Sara</span><span class="w"> </span><span class="err">Hirsh</span><span class="w"> </span><span class="err">Bordo&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;average_ra</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">g&#39;</span><span class="p">:</span><span class="w"> </span><span class="mf">9.4</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;direc</span><span class="kc">t</span><span class="err">or&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Kevi</span><span class="kc">n</span><span class="w"> </span><span class="err">Derek&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;average_ra</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">g&#39;</span><span class="p">:</span><span class="w"> </span><span class="mf">9.3</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;direc</span><span class="kc">t</span><span class="err">or&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Michael</span><span class="w"> </span><span class="err">Be</span><span class="kc">ns</span><span class="err">o</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;average_ra</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">g&#39;</span><span class="p">:</span><span class="w"> </span><span class="mf">9.0</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;direc</span><span class="kc">t</span><span class="err">or&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Sloboda</span><span class="kc">n</span><span class="w"> </span><span class="err">Sija</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;average_ra</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">g&#39;</span><span class="p">:</span><span class="w"> </span><span class="mf">8.95</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="p">{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;direc</span><span class="kc">t</span><span class="err">or&#39;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bozidar &#39;Bota&#39; Nikolic&quot;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;average_ra</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">g&#39;</span><span class="p">:</span><span class="w"> </span><span class="mf">8.9</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="err">...</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<p>O realizamos un <em>join</em> entre las películas y sus comentarios para recuperar una película por su identificador:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Consulta</label><label for="__tabbed_6_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">peliculaId</span> <span class="o">=</span> <span class="s2">&quot;573a13aef29313caabd2c349&quot;</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">peliculaId</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="10 "></span>    <span class="p">},</span> <span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>        <span class="s2">&quot;$lookup&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="12 "></span>            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;comments&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="13 "></span>            <span class="s2">&quot;localField&quot;</span><span class="p">:</span> <span class="s2">&quot;_id&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span>            <span class="s2">&quot;foreignField&quot;</span><span class="p">:</span> <span class="s2">&quot;movie_id&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="15 "></span>            <span class="s2">&quot;as&quot;</span><span class="p">:</span> <span class="s1">&#39;comentarios&#39;</span>
<span class="linenos" data-linenos="16 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="17 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="18 "></span><span class="p">]</span>
<span class="linenos" data-linenos="19 "></span>
<span class="linenos" data-linenos="20 "></span><span class="n">peliculaConComentarios</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="linenos" data-linenos="21 "></span><span class="nb">print</span><span class="p">(</span><span class="n">peliculaConComentarios</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(&#39;</span><span class="mi">573</span><span class="err">a</span><span class="mi">13</span><span class="err">ae</span><span class="kc">f</span><span class="mi">29313</span><span class="err">caabd</span><span class="mi">2</span><span class="err">c</span><span class="mi">349</span><span class="err">&#39;)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="err">&#39;awards&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="kc">n</span><span class="err">omi</span><span class="kc">nat</span><span class="err">io</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">            </span><span class="err">&#39;</span><span class="kc">te</span><span class="err">x</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Nomi</span><span class="kc">nate</span><span class="err">d</span><span class="w"> </span><span class="kc">f</span><span class="err">or</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">Oscar.</span><span class="w"> </span><span class="err">A</span><span class="kc">n</span><span class="err">o</span><span class="kc">t</span><span class="err">her</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="err">wi</span><span class="kc">ns</span><span class="w"> </span><span class="err">&amp;</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="kc">n</span><span class="err">omi</span><span class="kc">nat</span><span class="err">io</span><span class="kc">ns</span><span class="err">.&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">            </span><span class="err">&#39;wi</span><span class="kc">ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="err">&#39;cas</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Chris</span><span class="kc">t</span><span class="err">ia</span><span class="kc">n</span><span class="w"> </span><span class="err">Bale&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Michael</span><span class="w"> </span><span class="err">Cai</span><span class="kc">ne</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Liam</span><span class="w"> </span><span class="err">Neeso</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Ka</span><span class="kc">t</span><span class="err">ie</span><span class="w"> </span><span class="err">Holmes&#39;</span><span class="p">],</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="err">&#39;come</span><span class="kc">ntar</span><span class="err">ios&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(&#39;</span><span class="mi">5</span><span class="err">a</span><span class="mi">9427658</span><span class="err">b</span><span class="mi">0</span><span class="err">beebeb</span><span class="mi">696</span><span class="kc">f</span><span class="mi">672</span><span class="err">&#39;)</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 7 "></span><span class="w">                </span><span class="err">&#39;da</span><span class="kc">te</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">da</span><span class="kc">tet</span><span class="err">ime.da</span><span class="kc">tet</span><span class="err">ime(</span><span class="mi">1972</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">                </span><span class="err">&#39;email&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;do</span><span class="kc">nal</span><span class="err">d_sump</span><span class="kc">ter</span><span class="err">@gameo</span><span class="kc">ft</span><span class="err">hro</span><span class="kc">n</span><span class="err">.es&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">                </span><span class="err">&#39;movie_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(&#39;</span><span class="mi">573</span><span class="err">a</span><span class="mi">13</span><span class="err">ae</span><span class="kc">f</span><span class="mi">29313</span><span class="err">caabd</span><span class="mi">2</span><span class="err">c</span><span class="mi">349</span><span class="err">&#39;)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">                </span><span class="err">&#39;</span><span class="kc">na</span><span class="err">me&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Maes</span><span class="kc">ter</span><span class="w"> </span><span class="err">Luwi</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">                </span><span class="err">&#39;</span><span class="kc">te</span><span class="err">x</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;A</span><span class="kc">t</span><span class="err">que</span><span class="w"> </span><span class="err">...&#39;</span><span class="p">}],</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="err">&#39;cou</span><span class="kc">ntr</span><span class="err">ies&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;USA&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;UK&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="err">&#39;direc</span><span class="kc">t</span><span class="err">ors&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;Chris</span><span class="kc">t</span><span class="err">opher</span><span class="w"> </span><span class="err">Nola</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="err">&#39;</span><span class="kc">full</span><span class="err">plo</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Whe</span><span class="kc">n</span><span class="w"> </span><span class="err">...&quot;,</span>
<span class="linenos" data-linenos="15 "></span><span class="err">&#39;genres&#39;: [&#39;Action&#39;, &#39;Adventure&#39;],</span>
<span class="linenos" data-linenos="16 "></span><span class="err">&#39;imdb&#39;: {&#39;id&#39;: 372784, &#39;rating&#39;: 8.3, &#39;votes&#39;: 860733},</span>
<span class="linenos" data-linenos="17 "></span><span class="err">&#39;languages&#39;: [&#39;English&#39;, &#39;Urdu&#39;, &#39;Mandarin&#39;],</span>
<span class="linenos" data-linenos="18 "></span><span class="err">&#39;lastupdated&#39;: datetime.datetime(2015, 8, 31, 0, 1, 54, 590000),</span>
<span class="linenos" data-linenos="19 "></span><span class="err">&#39;metacritic&#39;: 70,</span>
<span class="linenos" data-linenos="20 "></span><span class="err">&#39;num_mflix_comments&#39;: 1,</span>
<span class="linenos" data-linenos="21 "></span><span class="err">&#39;plot&#39;: &#39;After training ....&#39;,</span>
<span class="linenos" data-linenos="22 "></span><span class="err">&#39;poster&#39;: &#39;https://m.media-amazon.com/images/M/MV5BZmUwNGU2ZmItMmRiNC00MjhlLTg5YWUtODMyNzkxODYzMmZlXkEyXkFqcGdeQXVyNTIzOTk5ODM@._V1_SY1000_SX677_AL_.jpg&#39;,</span>
<span class="linenos" data-linenos="23 "></span><span class="err">&#39;rated&#39;: &#39;PG-13&#39;,</span>
<span class="linenos" data-linenos="24 "></span><span class="err">&#39;released&#39;: datetime.datetime(2005, 6, 15, 0, 0),</span>
<span class="linenos" data-linenos="25 "></span><span class="err">&#39;runtime&#39;: 140,</span>
<span class="linenos" data-linenos="26 "></span><span class="err">&#39;title&#39;: &#39;Batman Begins&#39;,</span>
<span class="linenos" data-linenos="27 "></span><span class="err">&#39;type&#39;: &#39;movie&#39;,</span>
<span class="linenos" data-linenos="28 "></span><span class="err">&#39;writers&#39;: [&#39;Bob Kane (characters)&#39;,</span>
<span class="linenos" data-linenos="29 "></span><span class="err">            &#39;David S. Goyer (story)&#39;,</span>
<span class="linenos" data-linenos="30 "></span><span class="err">            &#39;Christopher Nolan (screenplay)&#39;,</span>
<span class="linenos" data-linenos="31 "></span><span class="err">            &#39;David S. Goyer (screenplay)&#39;],</span>
<span class="linenos" data-linenos="32 "></span><span class="err">&#39;year&#39;: 2005}</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="trabajando-con-cursores">Trabajando con cursores<a class="headerlink" href="#trabajando-con-cursores" title="Permanent link">&para;</a></h2>
<p>A continuación vamos a realizar algunas operaciones sobre los <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/cursor.html">cursores</a> con <em>PyMongo</em> y a comparar a cómo podemos realizar la misma operación mediante el motor de agregaciones.</p>
<h3 id="limitando">Limitando<a class="headerlink" href="#limitando" title="Permanent link">&para;</a></h3>
<p>Sobre el cursor podemos restringir la cantidad de resultados devueltos mediante el método <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/cursor.html#pymongo.cursor.Cursor.limit"><code>.limit()</code></a> equivalente a la agregación <code>$limit</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:3"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><input id="__tabbed_7_3" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">PyMongo</label><label for="__tabbed_7_2">Agregación</label><label for="__tabbed_7_3">Salida</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">limited_cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<span class="linenos" data-linenos="2 "></span>    <span class="p">{</span> <span class="s2">&quot;directors&quot;</span><span class="p">:</span> <span class="s2">&quot;Sam Raimi&quot;</span> <span class="p">},</span>
<span class="linenos" data-linenos="3 "></span>    <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="hll"><span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">limited_cursor</span><span class="p">:</span>
<span class="linenos" data-linenos="7 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="p">{</span> <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;directors&quot;</span><span class="p">:</span> <span class="s2">&quot;Sam Raimi&quot;</span> <span class="p">}</span> <span class="p">},</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="p">{</span> <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="hll"><span class="linenos" data-linenos=" 4 "></span>    <span class="p">{</span> <span class="s2">&quot;$limit&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
</span><span class="linenos" data-linenos=" 5 "></span><span class="p">]</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">limited_aggregation</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span> <span class="n">pipeline</span> <span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">limited_aggregation</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">        </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">            </span><span class="s2">&quot;Bruce Campbell&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">            </span><span class="s2">&quot;Ellen Sandweiss&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">            </span><span class="s2">&quot;Richard DeManincor&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">            </span><span class="s2">&quot;Betsy Baker&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The Evil Dead&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Evil Dead II&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">        </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">            </span><span class="s2">&quot;Bruce Campbell&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">            </span><span class="s2">&quot;Sarah Berry&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">            </span><span class="s2">&quot;Dan Hicks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">            </span><span class="s2">&quot;Kassie Wesley DePaiva&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="p">]</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="ordenando">Ordenando<a class="headerlink" href="#ordenando" title="Permanent link">&para;</a></h3>
<p>Para ordenar usaremos el método <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/cursor.html#pymongo.cursor.Cursor.sort"><code>.sort()</code></a> que además de los campos de ordenación, indicaremos si el criterio será ascendente (<code>ASCENDING</code>) o descendente (<code>DESCENDING</code>), de forma similar a como lo hacemos con la operación de agregación <code>$sort</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:3"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><input id="__tabbed_8_3" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">PyMongo</label><label for="__tabbed_8_2">Agregación</label><label for="__tabbed_8_3">Salida</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">DESCENDING</span><span class="p">,</span> <span class="n">ASCENDING</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="n">sorted_cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<span class="linenos" data-linenos="4 "></span>    <span class="p">{</span> <span class="s2">&quot;directors&quot;</span><span class="p">:</span> <span class="s2">&quot;Sam Raimi&quot;</span> <span class="p">},</span>
<span class="linenos" data-linenos="5 "></span>    <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="hll"><span class="linenos" data-linenos="6 "></span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">ASCENDING</span><span class="p">)</span>
</span><span class="linenos" data-linenos="7 "></span>
<span class="linenos" data-linenos="8 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">sorted_cursor</span><span class="p">:</span>
<span class="linenos" data-linenos="9 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="p">{</span> <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;directors&quot;</span><span class="p">:</span> <span class="s2">&quot;Sam Raimi&quot;</span> <span class="p">}</span> <span class="p">},</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="p">{</span> <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="hll"><span class="linenos" data-linenos=" 4 "></span>    <span class="p">{</span> <span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">ASCENDING</span> <span class="p">}</span> <span class="p">}</span>
</span><span class="linenos" data-linenos=" 5 "></span><span class="p">]</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">sorted_aggregation</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span> <span class="n">pipeline</span> <span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">sorted_aggregation</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="s2">&quot;Bruce Campbell&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">        </span><span class="s2">&quot;Ellen Sandweiss&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="s2">&quot;Richard DeManincor&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="s2">&quot;Betsy Baker&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The Evil Dead&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1981</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1987</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Evil Dead II&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="s2">&quot;Bruce Campbell&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">        </span><span class="s2">&quot;Sarah Berry&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">        </span><span class="s2">&quot;Dan Hicks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">        </span><span class="s2">&quot;Kassie Wesley DePaiva&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">    </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1990</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">    </span><span class="err">...</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="p">]</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<p>En el caso de tener una clave compuesta de ordenación, le pasaremos como parámetro una lista de tuplas clave/criterio:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:3"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><input id="__tabbed_9_3" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">PyMongo</label><label for="__tabbed_9_2">Agregación</label><label for="__tabbed_9_3">Salida</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">sorted_cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<span class="linenos" data-linenos="2 "></span>    <span class="p">{</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="s2">&quot;Tom Hanks&quot;</span> <span class="p">},</span>
<span class="linenos" data-linenos="3 "></span>    <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="hll"><span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">ASCENDING</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">ASCENDING</span><span class="p">)])</span>
</span><span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">sorted_cursor</span><span class="p">:</span>
<span class="linenos" data-linenos="7 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="p">{</span> <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="s2">&quot;Tom Hanks&quot;</span> <span class="p">}</span> <span class="p">},</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="p">{</span> <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="hll"><span class="linenos" data-linenos=" 4 "></span>    <span class="p">{</span> <span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">ASCENDING</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">ASCENDING</span> <span class="p">}</span> <span class="p">}</span>
</span><span class="linenos" data-linenos=" 5 "></span><span class="p">]</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">sorted_aggregation</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span> <span class="n">pipeline</span> <span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">sorted_aggregation</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="s2">&quot;Tom Hanks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">        </span><span class="s2">&quot;Daryl Hannah&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="s2">&quot;Eugene Levy&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="s2">&quot;John Candy&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Splash&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1984</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">        </span><span class="s2">&quot;Tom Hanks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">        </span><span class="s2">&quot;Jackie Gleason&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="s2">&quot;Eva Marie Saint&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">        </span><span class="s2">&quot;Hector Elizondo&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Nothing in Common&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">    </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1986</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">    </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">        </span><span class="s2">&quot;Tom Hanks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">        </span><span class="s2">&quot;Elizabeth Perkins&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">        </span><span class="s2">&quot;Robert Loggia&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">        </span><span class="s2">&quot;John Heard&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Big&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">    </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1988</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">    </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">        </span><span class="s2">&quot;Sally Field&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">        </span><span class="s2">&quot;Tom Hanks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">        </span><span class="s2">&quot;John Goodman&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="37 "></span><span class="w">        </span><span class="s2">&quot;Mark Rydell&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="38 "></span><span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="39 "></span><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Punchline&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="40 "></span><span class="w">    </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1988</span><span class="w"></span>
<span class="linenos" data-linenos="41 "></span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="42 "></span><span class="err">...</span><span class="w"></span>
<span class="linenos" data-linenos="43 "></span><span class="p">]</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="saltando">Saltando<a class="headerlink" href="#saltando" title="Permanent link">&para;</a></h3>
<p>Cuando paginamos los resultados, para saltar los documentos, haremos uso del método <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/cursor.html#pymongo.cursor.Cursor.skip"><code>.skip()</code></a>, el cual es similar a la operación <code>$skip</code>.</p>
<p>Por ejemplo, la siguiente consulta devuelve 13 documentos, de manera que al saltarnos 12, sólo nos devolverá uno:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:3"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><input id="__tabbed_10_3" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">PyMongo</label><label for="__tabbed_10_2">Agregación</label><label for="__tabbed_10_3">Salida</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">skipped_sorted_cursor</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<span class="linenos" data-linenos="2 "></span>    <span class="p">{</span> <span class="s2">&quot;directors&quot;</span><span class="p">:</span> <span class="s2">&quot;Sam Raimi&quot;</span> <span class="p">},</span>
<span class="linenos" data-linenos="3 "></span>    <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> 
<span class="hll"><span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">ASCENDING</span><span class="p">)</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span><span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">skipped_sorted_cursor</span><span class="p">:</span>
<span class="linenos" data-linenos="7 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="p">{</span> <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;directors&quot;</span><span class="p">:</span> <span class="s2">&quot;Sam Raimi&quot;</span> <span class="p">}</span> <span class="p">},</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="p">{</span> <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="p">{</span> <span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">ASCENDING</span> <span class="p">}</span> <span class="p">},</span>
<span class="hll"><span class="linenos" data-linenos=" 5 "></span>    <span class="p">{</span> <span class="s2">&quot;$skip&quot;</span><span class="p">:</span> <span class="mi">12</span> <span class="p">}</span>
</span><span class="linenos" data-linenos=" 6 "></span><span class="p">]</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">sorted_skipped_aggregation</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span> <span class="n">pipeline</span> <span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">sorted_skipped_aggregation</span><span class="p">:</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">        </span><span class="nt">&quot;cast&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">            </span><span class="s2">&quot;James Franco&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">            </span><span class="s2">&quot;Mila Kunis&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">            </span><span class="s2">&quot;Rachel Weisz&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">            </span><span class="s2">&quot;Michelle Williams&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Oz the Great and Powerful&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">        </span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2013</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">]</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="crud">CRUD<a class="headerlink" href="#crud" title="Permanent link">&para;</a></h2>
<p>Para estas operaciones, vamos a trabajar con la colección <code>iabd.people</code> que utilizamos en la <a href="02mongo.html#hola-mongodb">primera sesión de <em>MongoDB</em></a>.</p>
<h3 id="insercion">Inserción<a class="headerlink" href="#insercion" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">cliente</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s2">&quot;mongodb+srv://iabd:iabdiabd@cluster0.4hm7u8y.mongodb.net/?retryWrites=true&amp;w=majority&quot;</span><span class="p">,</span> <span class="n">server_api</span><span class="o">=</span><span class="n">ServerApi</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">))</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">bd</span> <span class="o">=</span> <span class="n">cliente</span><span class="o">.</span><span class="n">iabd</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">people</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">people</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">yo</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;nombre&quot;</span><span class="p">:</span> <span class="s2">&quot;Aitor Medrano&quot;</span><span class="p">,</span> <span class="s2">&quot;edad&quot;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="s2">&quot;profesion&quot;</span><span class="p">:</span> <span class="s2">&quot;Profesor&quot;</span> <span class="p">}</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">resultado</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="nb">print</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">acknowledged</span><span class="p">)</span>   <span class="c1"># True</span>
<span class="linenos" data-linenos="12 "></span><span class="nb">print</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>    <span class="c1"># 6366b5c85afaf1b75dc90a20</span>
</code></pre></div>
<p>Tras realizar una operación de inserción con <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.insert_one"><code>insert_one</code></a>, obtenemos un objeto <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/results.html#pymongo.results.InsertOneResult"><code>InsertOneResult</code></a> del cual cabe destacar dos campos:</p>
<ul>
<li><code>acknowledged</code>: un campo booleano que nos indica si la operación ha sido exitosa, o <code>False</code> cuando indicamos un <code>WriteConcern(w=0)</code>, es decir, es escritura <em>fire-and-forget</em>.</li>
<li><code>inserted_id</code>: valor del <code>ObjectId</code>.</li>
</ul>
<p>Si queremos insertar más de una documento a la vez, usaremos <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.insert_many"><code>insert_many</code></a>, el cual devuelve un objeto <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/results.html#pymongo.results.InsertManyResult"><code>InsertManyResult</code></a>.</p>
<h4 id="join">Join<a class="headerlink" href="#join" title="Permanent link">&para;</a></h4>
<p>Ya hemos estudiado que al insertar un documento que está relacionado con otro, necesitamos que los campos contengan el mismo valor (normalmente, el <code>ObjectId</code>)</p>
<p>Por ejemplo, si queremos añadir un comentario a una película, hemos de unir el identificador de la película en cada comentario haciendo uso de objeto <a href="https://pymongo.readthedocs.io/en/stable/api/bson/objectid.html#bson.objectid.ObjectId"><code>ObjectId</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="n">comments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">comments</span>
<span class="linenos" data-linenos="4 "></span><span class="n">comment_doc</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">usuario</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">usuario</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<span class="linenos" data-linenos="5 "></span>                <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">movie_id</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">comentario</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">fecha</span><span class="p">}</span>
<span class="linenos" data-linenos="6 "></span><span class="n">comments</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">comment_doc</span><span class="p">))</span>
</code></pre></div>
<h4 id="gestion-de-errores">Gestión de errores<a class="headerlink" href="#gestion-de-errores" title="Permanent link">&para;</a></h4>
<p>A la hora de insertar un documento se puede dar el caso de lanzar un <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/errors.html#pymongo.errors.DuplicateKeyError"><code>DuplicateKeyError</code></a>, ya sea por el atributo identificador o por un índice de tipo único. En dicho caso, podemos capturar la excepción y ajustar el comportamiento o informar al usuario, dependiendo de la gravedad del error.</p>
<p>Por ejemplo, si insertamos una persona con un <code>_id</code> que ya existe:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="s2">&quot;nombre&quot;</span><span class="p">:</span> <span class="s2">&quot;Aitor Medrano&quot;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="p">}</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">result</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>
<span class="hll"><span class="linenos" data-linenos=" 9 "></span><span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">DuplicateKeyError</span><span class="p">:</span>
</span><span class="linenos" data-linenos="10 "></span>    <span class="n">usuario_id</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;El usuario #</span><span class="si">{</span><span class="n">usuario_id</span><span class="si">}</span><span class="s2"> ya existe en el sistema.&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="borrado">Borrado<a class="headerlink" href="#borrado" title="Permanent link">&para;</a></h3>
<p>El borrado de documento es similar a la creación, pudiendo utilizar <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.delete_one"><code>delete_one</code></a> para borrar el primer documento encontrado, o <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.delete_many"><code>delete_many</code></a> para borrar todos los documentos encontrados:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">resultado</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span> <span class="s2">&quot;edad&quot;</span> <span class="p">:</span> <span class="mi">45</span><span class="p">})</span>
<span class="linenos" data-linenos="2 "></span><span class="nb">print</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">deleted_count</span><span class="p">)</span>
</code></pre></div>
<p>En ambas operaciones, obtenemos un objeto <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/results.html#pymongo.results.DeleteResult"><code>DeleteResult</code></a> del cual destacamos la propiedad <code>deleted_count</code> para averiguar cuantos documentos han sido eliminados.</p>
<div class="admonition tip">
<p class="admonition-title">Borrado de colecciones</p>
<p>Para vaciar una colección, podemos borrar todos los documentos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">people</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span>
</code></pre></div>
<p>Aunque es mejor borrar la colección entera:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">people</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
</code></pre></div>
</div>
<h3 id="modificacion">Modificación<a class="headerlink" href="#modificacion" title="Permanent link">&para;</a></h3>
<p>De forma similar a como lo hemos realizado mediante <em>mongosh</em>, para modificar documentos emplearemos los métodos <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.update_one"><code>update_one</code></a> y <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.update_many"><code>update_many</code></a>, los cuales devuelve un objeto <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/results.html#pymongo.results.UpdateResult"><code>UpdateResult</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">resultado</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Aitor Medrano&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:{</span><span class="s2">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Marina Medrano&quot;</span><span class="p">,</span> <span class="s2">&quot;salario&quot;</span><span class="p">:</span> <span class="mi">123456</span><span class="p">}})</span>
<span class="linenos" data-linenos="2 "></span><span class="nb">print</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">matched_count</span><span class="p">)</span>  <span class="c1"># (1)!</span>
<span class="linenos" data-linenos="3 "></span><span class="nb">print</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="p">)</span> <span class="c1"># (2)!</span>
</code></pre></div>
<ol>
<li><code>matched_count</code> nos devuelve la cantidad de documentos encontrados</li>
<li><code>modified_count</code> nos devuelve la cantidad de documentos modificados</li>
</ol>
<p>Tal como vimos, en las operaciones <em>update</em>, le podemos pasar un tercer parámetro (opcional) con <code>upsert=False</code> (valor por defecto) op <code>True</code>, cuando queramos que se inserte un nuevo documento si no encuentra ninguno. En este caso, <code>modified_count</code> y <code>matched_count</code> serán 0.</p>
<p>Otro argumento opcional que conviene conocer es <code>bypass_document_validation=False</code> (valor por defecto), el cual, si lo ponemos a <code>True</code> ignorará las validaciones (si hay alguna) para los documentos que modifiquemos.</p>
<div class="admonition caution">
<p class="admonition-title">Operador</p>
<p>Recuerda utilizar un operador de modificación en el segundo parámetro. Si no, el documento del segundo parámetro sustituirá por completo al documento encontrado.</p>
</div>
<h2 id="operaciones-consistentes">Operaciones consistentes<a class="headerlink" href="#operaciones-consistentes" title="Permanent link">&para;</a></h2>
<h3 id="preferencias-de-lectura">Preferencias de lectura<a class="headerlink" href="#preferencias-de-lectura" title="Permanent link">&para;</a></h3>
<p>Para realizar lecturas consistentes podemos configurar la preferencias de lectura, tal como vimos en la <a href="06replicacion.html#preferencias-de-lectura">sesión anterior</a>.</p>
<p>Para ello, <em>PyMongo</em> ofrece un conjunto de clases para indicar las <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/read_preferences.html">preferencias de lectura</a>, las cuales podemos configurar a nivel de cliente:</p>
<div class="admonition tip inline end">
<p class="admonition-title">Niveles de lectura</p>
<p>Los diferentes niveles vienen definidos en el objeto <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/read_preferences.html#pymongo.read_preferences.ReadPreference"><code>ReadPreference</code></a> el cual ofrece los valores estudiados en la sesión anterior: <code>PRIMARY</code>, <code>PRIMARY_PREFERRED</code>, <code>SECONDARY</code>, <code>SECONDARY_PREFERRED</code> y <code>NEAREST</code>.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span>
<span class="linenos" data-linenos="2 "></span>    <span class="s1">&#39;localhost:27017&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="3 "></span>    <span class="n">replicaSet</span><span class="o">=</span><span class="s1">&#39;iabd&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="4 "></span>    <span class="n">readPreference</span><span class="o">=</span><span class="s1">&#39;secondaryPreferred&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Si en vez de indicar la preferencia a nivel de cliente, lo queremos realizar a nivel de base de datos o de colección, hemos de emplear los métodos <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/mongo_client.html#pymongo.mongo_client.MongoClient.get_database">get_database</a> y <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/database.html#pymongo.database.Database.get_collection">get_collection</a> pasándole un segundo parámetro con la opción deseada:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">ReadPreference</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">read_preference</span><span class="p">)</span>   <span class="c1"># SecondaryPreferred(tag_sets=None)</span>
<span class="linenos" data-linenos="4 "></span>
<span class="linenos" data-linenos="5 "></span><span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_database</span><span class="p">(</span><span class="s1">&#39;iabd&#39;</span><span class="p">,</span> <span class="n">read_preference</span><span class="o">=</span><span class="n">ReadPreference</span><span class="o">.</span><span class="n">SECONDARY</span><span class="p">)</span>
<span class="linenos" data-linenos="6 "></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">read_preference</span><span class="p">)</span>       <span class="c1"># Secondary(tag_sets=None)</span>
<span class="linenos" data-linenos="7 "></span>
<span class="linenos" data-linenos="8 "></span><span class="n">coll</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;people&#39;</span><span class="p">,</span> <span class="n">read_preference</span><span class="o">=</span><span class="n">ReadPreference</span><span class="o">.</span><span class="n">PRIMARY</span><span class="p">)</span>
<span class="linenos" data-linenos="9 "></span><span class="nb">print</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">read_preference</span><span class="p">)</span>     <span class="c1"># Primary()</span>
</code></pre></div>
<p>Finalmente, si en cualquier momento queremos cambiar las preferencias a nivel de colección, podemos emplear el método <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.with_options">with_options</a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">coll2</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">read_preference</span><span class="o">=</span><span class="n">ReadPreference</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">)</span>
<span class="linenos" data-linenos="2 "></span><span class="nb">print</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">read_preference</span><span class="p">)</span>     <span class="c1"># Primary()</span>
<span class="linenos" data-linenos="3 "></span><span class="nb">print</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">read_preference</span><span class="p">)</span>     <span class="c1"># Nearest(tag_sets=None)</span>
</code></pre></div>
<h3 id="escrituras-consistentes">Escrituras consistentes<a class="headerlink" href="#escrituras-consistentes" title="Permanent link">&para;</a></h3>
<p>Tal como vimos en la sesión anterior, para indicar la consistencia en la escritura, haremos uso de la propiedad <code>write_concern</code>. Para ello, de la misma forma que hemos indicado la preferencia de lectura, hacemos uso del método <code>with_options</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">coll</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">write_concern</span><span class="o">=</span><span class="n">WriteConcern</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="s2">&quot;majority&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
<span class="linenos" data-linenos="2 "></span>    <span class="s2">&quot;nombre&quot;</span><span class="p">:</span> <span class="n">nombre</span><span class="p">,</span>
<span class="linenos" data-linenos="3 "></span>    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
<span class="linenos" data-linenos="4 "></span>    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">hashed_pw</span>
<span class="linenos" data-linenos="5 "></span><span class="p">})</span>
</code></pre></div>
<p>Si tenemos una aplicación crítica, no nos podemos permitir perder los datos. Por ello, necesitamos que las escritura se propaguen a la mayoría de los nodos con la opción <code>w: majority</code> para asegurarnos que las escrituras se propagan a la mayoría de nodos del conjunto de nodos.</p>
<p>Si sucede un problema en los nodos secundarios, puede ser que el primario no reciba los ACK necesarios. Si llegan más escrituras que lecturas, puede llegar el momento en que se produzca un atasco.</p>
<p>Para evitar esto, para cada escritura que realicemos con la mayoría de los nodos, siempre hay que indicar un <em>timeout</em>. La longitud del <em>timeout</em> vendrá determinada por la red y el hardware que dispongamos, pero siempre hemos de indicarlo.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">coll</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">write_concern</span><span class="o">=</span><span class="n">WriteConcern</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="s2">&quot;majority&quot;</span><span class="p">,</span> <span class="n">wtimeout</span><span class="o">=</span><span class="s2">&quot;2500&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
<span class="linenos" data-linenos="2 "></span>    <span class="s2">&quot;nombre&quot;</span><span class="p">:</span> <span class="n">nombre</span><span class="p">,</span>
<span class="linenos" data-linenos="3 "></span>    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
<span class="linenos" data-linenos="4 "></span>    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">hashed_pw</span>
<span class="linenos" data-linenos="5 "></span><span class="p">})</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Bulk writes</p>
<p>En ocasiones necesitamos ejecutar una bateria de operaciones a granel (<em>bulk</em>) las cuales se ejecutan como un proceso <em>batch</em>. Para ello se emplea el método <a href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html#pymongo.collection.Collection.bulk_write"><code>bulk_write</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">array_operaciones</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="transacciones">Transacciones<a class="headerlink" href="#transacciones" title="Permanent link">&para;</a></h2>
<!--
<https://learning.oreilly.com/library/view/mongodb-the-definitive/9781491954454/ch08.html#idm45882358635912>

<https://learning.oreilly.com/library/view/mastering-mongodb-6-x/9781803243863/B18155_06.xhtml#_idParaDest-111>
-->

<p>Ya hemos comentado en numerosas ocasiones toda operación en un único documento es atómica, de ahí embeber documentos y arrays para modelar las relaciones de datos en un sólo documento cubre la mayoría de los casos de usos transaccionales.</p>
<p>Cuando necesitamos atomicidad de lecturas y escrituras entre varios documentos (en una o más colecciones), <a href="https://www.mongodb.com/docs/manual/core/transactions/"><em>MongoDB</em> soporta transacciones</a> multidocumento. Mediante las transacciones distribuidas, las transacciones puede operar entre varias operaciones, colecciones, bases de datos, documentos y particiones (<em>shards</em>).</p>
<h3 id="tipos-de-api">Tipos de API<a class="headerlink" href="#tipos-de-api" title="Permanent link">&para;</a></h3>
<p><em>MongoDB</em> ofrece dos API para utilizar transacciones. La primera, conocida como <a href="https://www.mongodb.com/docs/manual/core/transactions-in-applications/#core-api"><em>Core API</em></a>, disponible desde la versión 4.0 de <em>MongoDB</em>, tiene una sintaxis similar a las bases de datos relacionales (por ejemplo, con operaciones como <code>start_transaction</code> y <code>commit_transaction</code>), y la segunda se conoce como <a href="https://www.mongodb.com/docs/manual/core/transactions-in-applications/#callback-api"><em>Callback API</em></a>, desde la versión 4.2, el cual es el enfoque actualmente recomendado.</p>
<p>El <em>Core API</em> no ofrece lógica de reintentos para la mayoría de errores y necesita que el desarrollador programe la lógica de las operaciones, la función transaccional que realiza <em>commit</em> y la lógica de errores y reintentos necesaria.</p>
<p>En cambio, el <em>Callback API</em> ofrece una única función que engloba un alto grado de funcionalidad comparadas con el <em>Core API</em>, incluyendo el inicio de una transacción asociada a una sesión lógica, ejecutar la función definida como <em>callback</em> y realizando el <em>commit</em> de la transacción (o abortándola en caso de error). Esta función también incluye la lógica de reintentos para manejar los errores al hacer <em>commit</em>.</p>
<p>En ambas APIs, el desarrollador se responsabiliza de iniciar la sesión lógica que se utilizará en la transacción. Ambas APIs requieren que las operaciones transaccionales se asocien a ésta sesión lógica (pasándola como parámetro a cada operación). Cada sesión lógica en <em>MongoDB</em> registra el tiempo y la secuencia de las operaciones en el contexto completo del despliegue de <em>MongoDB</em>.</p>
<h3 id="hola-mundo-callback-api">Hola Mundo Callback API<a class="headerlink" href="#hola-mundo-callback-api" title="Permanent link">&para;</a></h3>
<p>Vamos a simular que tenemos una aplicación de gestión de un almacén, en la cual tenemos que realizar las siguientes operaciones dentro de una transacción:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">pedidos</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&quot;producto&quot;</span><span class="p">:</span> <span class="s2">&quot;ps5&quot;</span><span class="p">,</span> <span class="s2">&quot;cantidad&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="n">session</span><span class="o">=</span><span class="n">miSesion</span><span class="p">)</span>
<span class="linenos" data-linenos="2 "></span><span class="n">inventario</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;producto&quot;</span><span class="p">:</span> <span class="s2">&quot;ps5&quot;</span><span class="p">,</span> <span class="s2">&quot;cantidad&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}},</span>
<span class="linenos" data-linenos="3 "></span>                      <span class="p">{</span><span class="s2">&quot;$inc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cantidad&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">}},</span> <span class="n">session</span><span class="o">=</span><span class="n">miSesion</span><span class="p">)</span>
</code></pre></div>
<p>Veamos mediante un ejemplo el flujo del código transaccional haciendo uso del <em>Callback API</em>.</p>
<div class="highlight"><span class="filename">almacenTransaccional.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span><span class="p">,</span> <span class="n">ReadPreference</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">pymongo.write_concern</span> <span class="kn">import</span> <span class="n">WriteConcern</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">pymongo.read_concern</span> <span class="kn">import</span> <span class="n">ReadConcern</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">uriString</span> <span class="o">=</span> <span class="s1">&#39;mongodb+srv://iabd:iabdiabd@cluster0.4hm7u8y.mongodb.net/?retryWrites=true&amp;w=majority&#39;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">cliente</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">uriString</span><span class="p">)</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">miWCMajority</span> <span class="o">=</span> <span class="n">WriteConcern</span><span class="p">(</span><span class="s1">&#39;majority&#39;</span><span class="p">,</span> <span class="n">wtimeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># Paso 0: Creamos dos colecciones e insertamos un documento en cada una</span>
<span class="linenos" data-linenos="10 "></span><span class="n">bd</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_database</span><span class="p">(</span> <span class="s2">&quot;iabd&quot;</span><span class="p">,</span> <span class="n">write_concern</span><span class="o">=</span><span class="n">miWCMajority</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span><span class="n">bd</span><span class="o">.</span><span class="n">pedidos</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&quot;producto&quot;</span><span class="p">:</span> <span class="s2">&quot;ps5&quot;</span><span class="p">,</span> <span class="s2">&quot;cantidad&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
<span class="linenos" data-linenos="12 "></span><span class="n">bd</span><span class="o">.</span><span class="n">inventario</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&quot;producto&quot;</span><span class="p">:</span> <span class="s2">&quot;ps5&quot;</span><span class="p">,</span> <span class="s2">&quot;cantidad&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># Paso 1: Definir el callback que indica la secuencia de las operaciones a realizar dentro de la transacción</span>
<span class="linenos" data-linenos="15 "></span><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">miSesion</span><span class="p">):</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">pedidos</span> <span class="o">=</span> <span class="n">miSesion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">iabd</span><span class="o">.</span><span class="n">pedidos</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">inventario</span> <span class="o">=</span> <span class="n">miSesion</span><span class="o">.</span><span class="n">cliente</span><span class="o">.</span><span class="n">iabd</span><span class="o">.</span><span class="n">inventario</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span>    <span class="c1"># Importante: Debemos pasarle la sesión a cada operación</span>
<span class="linenos" data-linenos="20 "></span>    <span class="n">pedidos</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&quot;producto&quot;</span><span class="p">:</span> <span class="s2">&quot;ps5&quot;</span><span class="p">,</span> <span class="s2">&quot;cantidad&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="n">session</span><span class="o">=</span><span class="n">miSesion</span><span class="p">)</span>
<span class="linenos" data-linenos="21 "></span>    <span class="n">inventario</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;producto&quot;</span><span class="p">:</span> <span class="s2">&quot;ps5&quot;</span><span class="p">,</span> <span class="s2">&quot;cantidad&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}},</span>
<span class="linenos" data-linenos="22 "></span>                          <span class="p">{</span><span class="s2">&quot;$inc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cantidad&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">}},</span> <span class="n">session</span><span class="o">=</span><span class="n">miSesion</span><span class="p">)</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span><span class="c1"># Paso 2: Iniciar una sesión de cliente.</span>
<span class="linenos" data-linenos="25 "></span><span class="k">with</span> <span class="n">cliente</span><span class="o">.</span><span class="n">start_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos="26 "></span>    <span class="c1"># Paso 3: Empleamos with_transaction para iniciar la transacción, ejecutar el callback y realizar el commit (o abortar en caso de error).</span>
<span class="linenos" data-linenos="27 "></span>    <span class="n">session</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">(</span>
<span class="linenos" data-linenos="28 "></span>        <span class="n">callback</span><span class="p">,</span>
<span class="linenos" data-linenos="29 "></span>        <span class="n">read_concern</span><span class="o">=</span><span class="n">ReadConcern</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos="30 "></span>        <span class="n">write_concern</span><span class="o">=</span><span class="n">miWCMajority</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>        <span class="n">read_preference</span><span class="o">=</span><span class="n">ReadPreference</span><span class="o">.</span><span class="n">PRIMARY</span><span class="p">,</span>
<span class="linenos" data-linenos="32 "></span>    <span class="p">)</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">PyMODM</p>
<p><a href="https://github.com/mongodb/pymodm">PyMODM</a> es una librería ODM que abstrae el acceso a <em>MongoDB</em> mediante un mapeo objeto-documento. De forma similar a los frameworks ORM en los entornos relacionales, como son <em>Hibernate</em> (<em>Java</em>), <em>Doctrine</em>/<em>Eloquent</em> (<em>PHP</em>) o el ORM de <em>Django</em>, abstrae y simplifica el acceso a la base de datos.</p>
<p>Un ejemplo de definición de un objeto y su persistencia sería:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">MongoModel</span><span class="p">):</span>
<span class="linenos" data-linenos="2 "></span>    <span class="c1"># Utiliza el &#39;email&#39;como campo &#39;_id&#39;</span>
<span class="linenos" data-linenos="3 "></span>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos" data-linenos="4 "></span>    <span class="n">nombre</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
<span class="linenos" data-linenos="5 "></span>    <span class="n">apellido</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
<span class="linenos" data-linenos="6 "></span>
<span class="linenos" data-linenos="7 "></span><span class="n">usuario</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s1">&#39;a.medrano@edu.gva.es&#39;</span><span class="p">,</span> <span class="s1">&#39;Aitor&#39;</span><span class="p">,</span> <span class="s1">&#39;Medrano&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div>
<p>Hemos decidido no profundizar en su conocimiento ya que el equipo de <em>MongoDB</em> ha pausado su mantenimiento desde hace ya dos años.    </p>
</div>
<h2 id="caso-de-uso-pia-login">Caso de uso - PIA: Login<a class="headerlink" href="#caso-de-uso-pia-login" title="Permanent link">&para;</a></h2>
<p>El siguiente proyecto se basa inicialmente en el artículo <a href="https://www.digitalocean.com/community/tutorials/how-to-add-authentication-to-your-app-with-flask-login"><em>How To Add Authentication to Your App with Flask-Login</em></a>.</p>
<p>A partir de él, vamos a crear una aplicación en <em>Flask</em> que ataca a una base de datos de <em>MongoDB</em> para almacenar la información del proyecto PIA Lara.</p>
<p>Esta primera versión de la aplicación únicamente se centra en la gestión de los usuarios, distinguiendo entre los diferentes roles:</p>
<ul>
<li><code>Administrador</code>: superusuario, puede crear, editar y eliminar todo tipo de usuarios.</li>
<li><code>Técnico</code>: usuario que supervisará a los clientes, el cual, más adelante, puede llegar a crear textos predefinidos para los clientes.</li>
<li><code>Cliente</code>: usuario final de la aplicación que, más adelante, grabará los audios.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Simplicidad</p>
<p>El presente caso de uso se ha organizado para intentar simplificar al máximo el código y preparar un esqueleto que facilite el crecimiento de la aplicación. Aún así, una solución basada en <em>Django</em> o el uso de herramientas de mapeo entre los datos y los objetos del dominio serían un punto de partida para siguientes fases del proyecto.</p>
</div>
<h3 id="estructura">Estructura<a class="headerlink" href="#estructura" title="Permanent link">&para;</a></h3>
<p>Una vez <a href="resources/piafplogin.zip">descargado el proyecto</a> y tras descomprimirlo, o clonado desde <a href="https://github.com/aitor-medrano/piafplogin">https://github.com/aitor-medrano/piafplogin</a>, veremos que tiene la siguiente estructura:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>PIAFPLOGIN/
<span class="linenos" data-linenos=" 2 "></span>├── migrations/
<span class="linenos" data-linenos=" 3 "></span>│   └── user_migration.py
<span class="linenos" data-linenos=" 4 "></span>├── project/
<span class="linenos" data-linenos=" 5 "></span>│   ├── static/
<span class="linenos" data-linenos=" 6 "></span>│   │   ├── pialara.js
<span class="linenos" data-linenos=" 7 "></span>│   │   └── pialara.png
<span class="linenos" data-linenos=" 8 "></span>│   ├── templates/
<span class="linenos" data-linenos=" 9 "></span>│   │   ├── base.html
<span class="linenos" data-linenos="10 "></span>│   │   ├── index.html
<span class="linenos" data-linenos="11 "></span>│   │   ├── login.html
<span class="linenos" data-linenos="12 "></span>│   │   └── profile.html
<span class="linenos" data-linenos="13 "></span>│   ├── __init__.py
<span class="linenos" data-linenos="14 "></span>│   ├── auth.py
<span class="linenos" data-linenos="15 "></span>│   ├── db.py
<span class="linenos" data-linenos="16 "></span>│   ├── main.py
<span class="linenos" data-linenos="17 "></span>│   └── models.py
<span class="linenos" data-linenos="18 "></span>├── .ini
<span class="linenos" data-linenos="19 "></span>└── requirements.txt
</code></pre></div>
<p>El primer paso es crear un entorno virtual:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>python3 -m venv app-env
</code></pre></div>
<p>Y activarlo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nb">source</span> app-env/bin/activate
</code></pre></div>
<p>A continuación instalaremos las dependencias mediante:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip3 install -r requirements.txt
</code></pre></div>
<h3 id="configuracion">Configuración<a class="headerlink" href="#configuracion" title="Permanent link">&para;</a></h3>
<p>Para configurar el proyecto, partimos del fichero <code>.ini</code> que reside en la raíz del mismo y contiene los datos de configuración a <em>MongoDB</em> y la clave secreta que utiliza <em>Flask</em> para encriptar la sesión:</p>
<div class="highlight"><span class="filename">.ini</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">[PROD]</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="na">SECRET_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">eac5e91171438960ddec0c9c469a4c3dd42e96aea462afc5ab830f78527ad80e</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="na">PIALARA_DB_URI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">mongodb+srv://usuario:contraseña@cluster0.xyz.mongodb.net</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="na">PIALARA_DB_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pialara</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="k">[LOCAL]</span><span class="w"></span>
<span class="linenos" data-linenos="7 "></span><span class="na">SECRET_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">eac5e91171438960ddec0c9c469a4c3dd42e96aea462afc5ab830f78527ad80e</span><span class="w"></span>
<span class="linenos" data-linenos="8 "></span><span class="na">PIALARA_DB_URI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">localhost</span><span class="w"></span>
<span class="linenos" data-linenos="9 "></span><span class="na">PIALARA_DB_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pialara</span><span class="w"></span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Secret Key</p>
<p>Para generar una clave secreta, tal como indica la <a href="https://flask.palletsprojects.com/en/latest/quickstart/#sessions">documentación de Flask</a>, podemos ejecutar el siguiente comando:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>python3 -c <span class="s1">&#39;import secrets; print(secrets.token_hex())&#39;</span>
</code></pre></div>
</div>
<p>Una vez ya hemos configurado la conexión y antes de arrancar la aplicación, vamos a cargar unos datos básicos con usuarios. Para ello, en la carpeta <code>migrations</code> tenemos el archivo <code>users_migration.py</code>, el cual lee la configuración del archivo anterior, y crea tres usuarios:</p>
<div class="highlight"><span class="filename">users_migration.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">import</span> <span class="nn">configparser</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.ini&quot;</span><span class="p">)))</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">DB_URI</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROD&#39;</span><span class="p">][</span><span class="s1">&#39;PIALARA_DB_URI&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="10 "></span><span class="n">DB_NAME</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROD&#39;</span><span class="p">][</span><span class="s1">&#39;PIALARA_DB_NAME&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="11 "></span><span class="c1"># DB_URI = config[&#39;LOCAL&#39;][&#39;PIALARA_DB_URI&#39;]</span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># DB_NAME = config[&#39;LOCAL&#39;][&#39;PIALARA_DB_NAME&#39;]</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="n">db</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">DB_URI</span><span class="p">)[</span><span class="n">DB_NAME</span><span class="p">]</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span><span class="n">usuarios</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="17 "></span>    <span class="p">{</span><span class="s2">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Admin&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;admin@admin.com&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s2">&quot;rol&quot;</span><span class="p">:</span><span class="s2">&quot;Administrador&quot;</span><span class="p">},</span>
<span class="linenos" data-linenos="18 "></span>    <span class="p">{</span><span class="s2">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Alumno&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;alumno@alumno.com&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="s2">&quot;alumno&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s2">&quot;rol&quot;</span><span class="p">:</span><span class="s2">&quot;Técnico&quot;</span><span class="p">},</span>
<span class="linenos" data-linenos="19 "></span>    <span class="p">{</span><span class="s2">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Severo Ochoa&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;s8a@s8a.com&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="s2">&quot;s8a&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s2">&quot;rol&quot;</span><span class="p">:</span><span class="s2">&quot;Cliente&quot;</span><span class="p">,</span> <span class="s2">&quot;parent&quot;</span><span class="p">:</span><span class="s2">&quot;alumno@alumno.com&quot;</span><span class="p">},</span>
<span class="linenos" data-linenos="20 "></span><span class="p">]</span>
<span class="linenos" data-linenos="21 "></span>
<span class="linenos" data-linenos="22 "></span><span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos="23 "></span>    <span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">usuarios</span><span class="p">)</span>
<span class="linenos" data-linenos="24 "></span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos="25 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div>
<p>Destacar que al definir los documentos con los usuarios, encriptamos la contraseña mediante la función <a href="https://tedboy.github.io/flask/generated/werkzeug.generate_password_hash.html"><code>generate_password_hash</code></a> para no almacenarla en la base de datos en texto plano.</p>
<p>Así pues, ejecutamos la migración:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>python3 migrations/users_migration.py
</code></pre></div>
<p>Finalmente podemos arrancar la aplicación:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>flask --app project --debug run
</code></pre></div>
<p>Y acceder a la aplicación a través de <code>http://127.0.0.1:5000/</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:2"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><input id="__tabbed_11_2" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">Versión escritorio</label><label for="__tabbed_11_2">Versión móvil</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><figure style="align: center;">
    <img src="images/07pialara-index.png" width="500px" style="border: 1px solid grey">
    <figcaption>PIA Lara - Index</figcaption>
</figure></p>
</div>
<div class="tabbed-block">
<p><figure style="align: center;">
    <img src="images/07pialara-index-mobile.png" width="300px" style="border: 1px solid grey">
    <figcaption>PIA Lara - Index en móvil</figcaption>
</figure></p>
</div>
</div>
</div>
<p>Una vez que un usuario ha entrado a la aplicación, por ejemplo, si es un administrador, dispondrá de las opciones que hemos comentado anteriormente:</p>
<figure style="align: center;">
    <img src="images/07pialara-admin.png" width="600px" style="border: 1px solid grey">
    <figcaption>PIA Lara - Administrador</figcaption>
</figure>

<h3 id="blueprints">Blueprints<a class="headerlink" href="#blueprints" title="Permanent link">&para;</a></h3>
<p>El archivo .ini que hemos configurado previamente define unos valores que la aplicación va a cargar desde el archivo <code>__init__.py</code>, el cual actúa como factoría de la aplicación y le indica a <em>Flask</em> los <em>blueprints</em> a utilizar:</p>
<div class="highlight"><span class="filename">__init__.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">LoginManager</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">db</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos" data-linenos=" 6 "></span><span class="kn">import</span> <span class="nn">configparser</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.ini&quot;</span><span class="p">)))</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span>    <span class="c1"># cargamos la configuración</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PIALARA_DB_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;LOCAL&#39;</span><span class="p">][</span><span class="s1">&#39;PIALARA_DB_URI&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PIALARA_DB_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;LOCAL&#39;</span><span class="p">][</span><span class="s1">&#39;PIALARA_DB_NAME&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;LOCAL&#39;</span><span class="p">][</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span>    <span class="c1"># configuramos flask-login con la ruta del login</span>
<span class="linenos" data-linenos="20 "></span>    <span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
<span class="linenos" data-linenos="21 "></span>    <span class="n">login_manager</span><span class="o">.</span><span class="n">login_view</span> <span class="o">=</span> <span class="s1">&#39;auth.login&#39;</span>
<span class="linenos" data-linenos="22 "></span>    <span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span>    <span class="c1"># función que utiliza flask-login para recuperar el usuario</span>
<span class="linenos" data-linenos="25 "></span>    <span class="nd">@login_manager</span><span class="o">.</span><span class="n">user_loader</span>
<span class="linenos" data-linenos="26 "></span>    <span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<span class="linenos" data-linenos="27 "></span>        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="linenos" data-linenos="28 "></span>
<span class="linenos" data-linenos="29 "></span>    <span class="c1"># blueprint para las rutas de autenticación</span>
<span class="linenos" data-linenos="30 "></span>    <span class="kn">from</span> <span class="nn">.auth</span> <span class="kn">import</span> <span class="n">auth</span> <span class="k">as</span> <span class="n">auth_blueprint</span>
<span class="linenos" data-linenos="31 "></span>    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">auth_blueprint</span><span class="p">)</span>
<span class="linenos" data-linenos="32 "></span>
<span class="linenos" data-linenos="33 "></span>    <span class="c1"># blueprint para la aplicación</span>
<span class="linenos" data-linenos="34 "></span>    <span class="kn">from</span> <span class="nn">.main</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">main_blueprint</span>
<span class="linenos" data-linenos="35 "></span>    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">main_blueprint</span><span class="p">)</span>
<span class="linenos" data-linenos="36 "></span>
<span class="linenos" data-linenos="37 "></span>    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Un <a href="https://flask.palletsprojects.com/en/2.2.x/blueprints/"><strong><em>blueprint</em></strong></a> permite organizar un grupo de vistas y código en módulos. En vez de registrar las vistas y el resto de código en la aplicación, se registran en el blueprint, y éste es que se registra en la aplicación en la función <code>create_app</code>.</p>
<p>En nuestro caso, vamos a empezar con dos <em>blueprints</em>, uno para las funciones de autenticación, y otra para las funciones de gestión de usuarios. El código de cada <em>blueprint</em> irá en un módulo separado. Como la gestión de usuarios necesita primero la autenticación, vamos a ver cómo funciona.</p>
<h3 id="login">Login<a class="headerlink" href="#login" title="Permanent link">&para;</a></h3>
<p>Para la gestión de la autenticación, nos hemos apoyado en la librería <a href="https://flask-login.readthedocs.io/en/latest/">Flask-login</a> que facilita la gestión la sesión del usuario.</p>
<p>En archivo <code>auth.py</code> contiene la lógica del <em>login</em> y el <em>logout</em>:</p>
<div class="highlight"><span class="filename">auth.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">flash</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">login_user</span><span class="p">,</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">current_user</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">check_password_hash</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">db</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="n">auth</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>
</span><span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="nd">@auth</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
<span class="linenos" data-linenos="10 "></span>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="nd">@auth</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="13 "></span><span class="k">def</span> <span class="nf">login_post</span><span class="p">():</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">remember</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remember&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
<span class="linenos" data-linenos="17 "></span>
<span class="hll"><span class="linenos" data-linenos="18 "></span>    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class="linenos" data-linenos="19 "></span>    <span class="c1"># comprobamos si el usuario existe</span>
<span class="linenos" data-linenos="20 "></span>    <span class="c1"># cogemos la contraseña, la hasheamos y la comparamos con la contraseña hasheada</span>
<span class="linenos" data-linenos="21 "></span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="linenos" data-linenos="22 "></span>        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Por favor, comprueba tus datos y vuélvelo a intentar.&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="23 "></span>        <span class="c1"># si el usuario no existe, o está mal la contraseña, recargamos la página</span>
<span class="linenos" data-linenos="24 "></span>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;auth.login&#39;</span><span class="p">))</span> 
<span class="linenos" data-linenos="25 "></span>
<span class="linenos" data-linenos="26 "></span>    <span class="c1"># marcamos al usuario como autenticado en flask_login </span>
<span class="hll"><span class="linenos" data-linenos="27 "></span>    <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">remember</span><span class="o">=</span><span class="n">remember</span><span class="p">)</span> 
</span><span class="linenos" data-linenos="28 "></span>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.profile&#39;</span><span class="p">,</span> <span class="n">nombre</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">nombre</span><span class="p">))</span>
<span class="linenos" data-linenos="29 "></span>
<span class="linenos" data-linenos="30 "></span><span class="nd">@auth</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="31 "></span><span class="nd">@login_required</span>
<span class="linenos" data-linenos="32 "></span><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
<span class="linenos" data-linenos="33 "></span>    <span class="n">logout_user</span><span class="p">()</span>
<span class="linenos" data-linenos="34 "></span>    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Sesión cerrada con éxito&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="35 "></span>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;auth.login&#39;</span><span class="p">))</span>
</code></pre></div>
<p>Los usuarios van a entrar al sistema mediante su email y una contraseña. Así pues, una vez hayamos recuperado un usuario por dicho email, creamos el <em>hash</em> de la contraseña recibida, y vemos si comprueba con la recuperada de la base de datos.</p>
<p>El método <code>login_user</code> de la línea 27 pertenece a la librería <em>Flask-Login</em> y se utiliza para indicar que el usuario ha sido autenticado, de manera que lo almacena en la sesión. La variable <code>user</code> es una clase propia que hemos definido nosotros con los atributos básicos de un usuario,el cual se encuentra en el archivo <code>models.py</code>:</p>
<div class="highlight"><span class="filename">models.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">UserMixin</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">):</span>
<span class="hll"><span class="linenos" data-linenos=" 4 "></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">nombre</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span class="linenos" data-linenos=" 5 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">nombre</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">rol</span> <span class="o">=</span> <span class="n">rol</span>
<span class="linenos" data-linenos="10 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos" data-linenos="13 "></span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div>
<p>Como se puede observar, la clase define los atributos básicos de un usuario. El atributo <code>parent</code> lo vamos a emplear para que los clientes almacenen el email del técnico que tienen asignado.</p>
<h3 id="plantillas">Plantillas<a class="headerlink" href="#plantillas" title="Permanent link">&para;</a></h3>
<p>Las diferentes plantillas heredan de una plantilla <code>base.html</code>, la cual emplea el framework <a href="https://bulma.io/"><em>Bulma</em></a> para la apariencia de la web. Su funcionamiento es muy similar a Bootstrap.</p>
<p>Por ejemplo, vamos a revisar un fragmento de la plantilla base para ver cómo gestionamos la visualización del menú dependiendo del rol del usuario:</p>
<div class="highlight"><span class="filename">base.html</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>...
<span class="linenos" data-linenos=" 2 "></span><span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;hero is-white is-fullheight&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="p">&lt;</span><span class="nt">nav</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar is-transparent&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos=" 4 "></span>        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-brand&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos=" 5 "></span>            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://piafplara.es&quot;</span><span class="p">&gt;</span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span>            <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;static&#39;, filename=&#39;pialara.png&#39;) }}&quot;</span> <span class="na">alt</span><span class="o">=</span><span class="s">&quot;PIA Lara: un proyecto que habla por ti&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;112&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;28&quot;</span><span class="p">&gt;</span>
</span><span class="linenos" data-linenos=" 7 "></span>            <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-burger burger&quot;</span> <span class="na">data-target</span><span class="o">=</span><span class="s">&quot;navbarPIALara&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="10 "></span>            <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="11 "></span>            <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="12 "></span>            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="13 "></span>        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span>        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;navbarPIALara&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-menu&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="16 "></span>            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-start&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="17 "></span>            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;main.index&#39;) }}&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="18 "></span>                Inicio
<span class="linenos" data-linenos="19 "></span>            <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="hll"><span class="linenos" data-linenos="20 "></span>            {% if not current_user.is_authenticated %}
</span><span class="linenos" data-linenos="21 "></span>                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;auth.login&#39;) }}&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="22 "></span>                    Login
<span class="linenos" data-linenos="23 "></span>                <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="24 "></span>            {% endif %}
<span class="linenos" data-linenos="25 "></span>            {% if current_user.is_authenticated %}
<span class="linenos" data-linenos="26 "></span>                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;main.profile&#39;) }}&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="27 "></span>                    Perfil
<span class="linenos" data-linenos="28 "></span>                <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="hll"><span class="linenos" data-linenos="29 "></span>                {% if current_user.rol == &quot;Administrador&quot; %}
</span><span class="linenos" data-linenos="30 "></span>                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item has-dropdown is-hoverable&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="31 "></span>                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-link&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="32 "></span>                    Usuarios
<span class="linenos" data-linenos="33 "></span>                <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="34 "></span>                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-dropdown is-hidden-mobile is-boxed&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="35 "></span>                    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;main.user_create&#39;) }}&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="36 "></span>                    Alta
<span class="linenos" data-linenos="37 "></span>                    <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="38 "></span>                    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;main.user_list&#39;) }}&quot;</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="39 "></span>                    Listado
<span class="linenos" data-linenos="40 "></span>                    <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="41 "></span>                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="42 "></span>                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="linenos" data-linenos="43 "></span>                {% endif %}         
<span class="linenos" data-linenos="44 "></span>...
</code></pre></div>
<p>En la línea 6 utilizamos la función <code>url_for</code> con el parámetro <code>static</code> para indicarle que cargue la imagen con el logo del proyecto desde la carpeta <code>static</code>.</p>
<p>Al utilizar la librería <em>Flask Login</em>, tendremos siempre disponible el usuario logueado en la variable <code>current_user</code>. Además de las propiedades que hayamos definido en la clase, disponemos de la función <code>is_authenticated</code> para comprobar si está autenticado (línea 20). De igual forma, podemos comprobar el rol y condicionar el contenido dependiendo de si es <code>Administrador</code>, <code>Técnico</code> o <code>Cliente</code> (línea 24).</p>
<h3 id="acceso-a-los-datos">Acceso a los datos<a class="headerlink" href="#acceso-a-los-datos" title="Permanent link">&para;</a></h3>
<p>Todo el acceso a los datos los hemos encapsulado en el archivo <code>db.py</code>:</p>
<div class="highlight"><span class="filename">db.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">ASCENDING</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">g</span>
<span class="linenos" data-linenos=" 5 "></span><span class="kn">from</span> <span class="nn">werkzeug.local</span> <span class="kn">import</span> <span class="n">LocalProxy</span>
<span class="linenos" data-linenos=" 6 "></span><span class="kn">from</span> <span class="nn">project.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">def</span> <span class="nf">get_db</span><span class="p">():</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos" data-linenos="10 "></span><span class="sd">    Método de configuración para obtener una instancia de db</span>
<span class="linenos" data-linenos="11 "></span><span class="sd">    &quot;&quot;&quot;</span>
<span class="hll"><span class="linenos" data-linenos="12 "></span>    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;_database&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">PIALARA_DB_URI</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PIALARA_DB_URI&quot;</span><span class="p">]</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">PIALARA_DB_DB_NAME</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PIALARA_DB_NAME&quot;</span><span class="p">]</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span>    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="hll"><span class="linenos" data-linenos="18 "></span>        <span class="n">db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span>
</span><span class="linenos" data-linenos="19 "></span>            <span class="n">PIALARA_DB_URI</span><span class="p">,</span>
<span class="linenos" data-linenos="20 "></span>            <span class="n">maxPoolSize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span>            <span class="n">timeoutMS</span><span class="o">=</span><span class="mi">2500</span>
<span class="linenos" data-linenos="22 "></span>       <span class="p">)[</span><span class="n">PIALARA_DB_DB_NAME</span><span class="p">]</span>
<span class="linenos" data-linenos="23 "></span>    <span class="k">return</span> <span class="n">db</span>
<span class="linenos" data-linenos="24 "></span>
<span class="linenos" data-linenos="25 "></span><span class="c1"># Utilizamos LocalProxy para leer la variable global usando sólo db</span>
<span class="hll"><span class="linenos" data-linenos="26 "></span><span class="n">db</span> <span class="o">=</span> <span class="n">LocalProxy</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
</span></code></pre></div>
<p>La función <code>get_db</code> utiliza el objeto <a href="https://flask.palletsprojects.com/en/2.2.x/api/#flask.g"><code>g</code></a>, el cual en Flask, es un objeto especial que es único para cada petición. Se utiliza para almacenar datos que serán accesibles desde múltiples funciones durante el <code>request</code>. Así pues, almacenamos la conexión, mejor dicho, el pool de conexiones a MongoDB en vez de crear un nuevo pool cada vez que queramos obtener acceso a la base de datos.</p>
<p>A continuación, creamos un <a href="https://werkzeug.palletsprojects.com/en/2.2.x/local/#werkzeug.local.LocalProxy"><code>LocalProxy</code></a> para leer la variable global usando sólo la referencia <code>db</code>, de manera que internamente cada referencia a <code>db</code> realmente está llamando a <code>get_db()</code>.</p>
<p>A continuación, mostramos un par de métodos del mismo archivo que muestran cómo obtenemos datos desde <em>MongoDB</em> haciendo uso de <em>PyMongo</em>:</p>
<div class="highlight"><span class="filename">db.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="k">def</span> <span class="nf">get_all_users</span><span class="p">():</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="sd">    Devuelve una lista con todos los usuarios del sistema</span>
<span class="linenos" data-linenos=" 4 "></span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="k">try</span><span class="p">:</span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;nombre&quot;</span><span class="p">,</span> <span class="n">ASCENDING</span><span class="p">))</span>
</span><span class="linenos" data-linenos=" 7 "></span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">return</span> <span class="n">e</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="k">def</span> <span class="nf">get_user_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
<span class="linenos" data-linenos="11 "></span>    <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos" data-linenos="12 "></span><span class="sd">    Devuelve un objeto User a partir de su id</span>
<span class="linenos" data-linenos="13 "></span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos" data-linenos="14 "></span>    <span class="k">try</span><span class="p">:</span>
<span class="hll"><span class="linenos" data-linenos="15 "></span>        <span class="n">usuario</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span><span class="n">ObjectId</span><span class="p">(</span><span class="nb">id</span><span class="p">)})</span>
</span><span class="linenos" data-linenos="16 "></span>
<span class="hll"><span class="linenos" data-linenos="17 "></span>        <span class="n">usuario_obj</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span> <span class="nb">id</span><span class="o">=</span><span class="n">usuario</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span>
</span><span class="linenos" data-linenos="18 "></span>                            <span class="n">email</span><span class="o">=</span><span class="n">usuario</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos="19 "></span>                            <span class="n">nombre</span><span class="o">=</span><span class="n">usuario</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nombre&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos="20 "></span>                            <span class="n">password</span><span class="o">=</span><span class="n">usuario</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos="21 "></span>                            <span class="n">rol</span><span class="o">=</span><span class="n">usuario</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rol&quot;</span><span class="p">),</span>
<span class="linenos" data-linenos="22 "></span>                            <span class="n">parent</span><span class="o">=</span><span class="n">usuario</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span>        <span class="k">return</span> <span class="n">usuario_obj</span>
<span class="linenos" data-linenos="25 "></span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos="26 "></span>        <span class="k">return</span> <span class="n">e</span>
<span class="linenos" data-linenos="27 "></span><span class="o">...</span>
</code></pre></div>
<p>Cuando recuperamos un usuario por su <code>id</code>, lo convertimos en un objeto <code>User</code> para que <em>Flask Login</em> falicita la gestión de la autenticación. En cambio, en el listado de todos los usuarios, vamos a acceder al cursor de usuarios que ofrece <em>MongoDB</em>.</p>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://pymongo.readthedocs.io/en/stable/tutorial.html">Tutorial oficial de PyMongo</a></li>
<li><a href="https://www.mongodb.com/developer/languages/python/python-acid-transactions/">Introduction to Multi-Document ACID Transactions in Python</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-transactions-in-mongodb">How To Use Transactions in MongoDB</a></li>
</ul>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>(<abbr title="Gestiona y almacena datos facilitando la búsqueda de respuestas en grandes conjuntos de datos.">RA5074.3</abbr> / <abbr title="Se han desarrollado sistemas de gestión, almacenamiento y procesamiento de grandes volúmenes de datos de manera eficiente y segura, teniendo en cuenta la normativa existente.">CE4.3d</abbr> / 4p) A partir del caso de uso de PIA Login, se pide:</p>
<ul>
<li>(0.25) Configurar la URI de Mongo Atlas para atacar vuestra propia base de datos.</li>
<li>(0.25) Modificar la migración para introducir más usuarios (al menos uno más de cada rol)</li>
<li>(0.75) Cuando un usuario pulsa sobre su nombre, actualmente aparece un formulario para editar sus datos, pero no puede cambiar la contraseña. Modifica (o crea) el/los formulario/s adecuado/s para que cada usuario pueda cambiar su propia contraseña.</li>
<li>(0.75) Desde el rol <code>Administrador</code>, al crear un usuario, si es un cliente, debe mostrar un desplegable con todos los técnicos disponibles.</li>
<li>(1) Tanto el <code>Técnico</code> como el <code>Cliente</code>, al dar de alta o editar un cliente, almacenarán datos necesarios para el proyecto, como son el sexo, la fecha de nacimiento y la patología.</li>
<li>(1) Cuando un <code>Técnico</code> visualiza el listado de sus clientes, debe recuperar únicamente el nombre, el sexo, la edad y su patología.</li>
</ul>
</li>
</ol>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        ¿Ha sido útil está página?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Sí, ha sido util" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="La página es mejorable" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
                Gracias por tu colaboración!
              
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
                Gracias por tu colaboración! Ayúdame a mejorarla enviandome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
              
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Pie" >
      
        
        <a href="06replicacion.html" class="md-footer__link md-footer__link--prev" aria-label="Anterior: S28.- Replicación y Particionado" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              S28.- Replicación y Particionado
            </div>
          </div>
        </a>
      
      
        
        <a href="../hadoop/index.html" class="md-footer__link md-footer__link--next" aria-label="Siguiente: Unidad de Trabajo 5.- Ecosistema Hadoop" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              Unidad de Trabajo 5.- Ecosistema Hadoop
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        <label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>