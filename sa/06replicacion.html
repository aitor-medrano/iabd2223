
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Replicación y particionado (sharding) en MongoDB. Trabajando con conjuntos de réplicas, preferencias de lectura, consistencia en la lectura y en la escritura. Particionado de los datos (sharded cluster) y elección de la shard key/clave de particionado.">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/sa/06replicacion.html">
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.10">
    
    
      
        <title>Replicación y particionado (sharding) en MongoDB. - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Replicación y particionado (sharding) en MongoDB. - Inteligencia Artificial y Big Data" >
      
        <meta  property="og:description"  content="Replicación y particionado (sharding) en MongoDB. Trabajando con conjuntos de réplicas, preferencias de lectura, consistencia en la lectura y en la escritura. Particionado de los datos (sharded cluster) y elección de la shard key/clave de particionado." >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/06replicacion.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/sa/06replicacion.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Replicación y particionado (sharding) en MongoDB. - Inteligencia Artificial y Big Data" >
      
        <meta  name="twitter:description"  content="Replicación y particionado (sharding) en MongoDB. Trabajando con conjuntos de réplicas, preferencias de lectura, consistencia en la lectura y en la escritura. Particionado de los datos (sharded cluster) y elección de la shard key/clave de particionado." >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/06replicacion.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#replicacion" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Replicación y particionado (sharding) en MongoDB.
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo día"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Cambiar a modo día" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">UT2.- Sistemas de almacenamiento</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT2.- Sistemas de almacenamiento" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          UT2.- Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01nosql.html" class="md-nav__link">
        S18.- Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02mongo.html" class="md-nav__link">
        S19.- MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="03modelado.html" class="md-nav__link">
        S21.- Modelado de datos NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="05agregaciones.html" class="md-nav__link">
        S25.- Agregaciones
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          S28.- Replicación y Particionado
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="06replicacion.html" class="md-nav__link md-nav__link--active">
        S28.- Replicación y Particionado
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#replicacion" class="md-nav__link">
    Replicación
  </a>
  
    <nav class="md-nav" aria-label="Replicación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conjunto-de-replicas" class="md-nav__link">
    Conjunto de réplicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creando-un-conjunto-de-replicas" class="md-nav__link">
    Creando un conjunto de réplicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trabajando-con-las-replicas" class="md-nav__link">
    Trabajando con las réplicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preferencias-de-lectura" class="md-nav__link">
    Preferencias de lectura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-en-la-escritura" class="md-nav__link">
    Consistencia en la escritura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-en-la-lectura" class="md-nav__link">
    Consistencia en la lectura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tolerancia-a-fallos" class="md-nav__link">
    Tolerancia a fallos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#particionado" class="md-nav__link">
    Particionado
  </a>
  
    <nav class="md-nav" aria-label="Particionado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sharded-cluster" class="md-nav__link">
    Sharded Cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shard-key" class="md-nav__link">
    Shard key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#particionado-con-docker" class="md-nav__link">
    Particionado con Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conexion-al-router" class="md-nav__link">
    Conexión al router
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#habilitando-el-sharding" class="md-nav__link">
    Habilitando el Sharding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trabajando-con-particiones" class="md-nav__link">
    Trabajando con particiones
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="07pymongo.html" class="md-nav__link">
        S30.- MongoDB y Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../hadoop/index.html">UT5.- Ecosistema Hadoop</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT5.- Ecosistema Hadoop" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          UT5.- Ecosistema Hadoop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/01arq.html" class="md-nav__link">
        S36.- Arquitecturas Big Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/02etl.html" class="md-nav__link">
        S36.- Ingesta de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/03hadoop.html" class="md-nav__link">
        S38.- Hadoop
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04hdfs.html" class="md-nav__link">
        S39.- HDFS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hadoop/04formatos.html" class="md-nav__link">
        S39.- Formatos de datos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../cloud/index.html">UT6.- Datos en el cloud</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT6.- Datos en el cloud" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          UT6.- Datos en el cloud
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/01cloud.html" class="md-nav__link">
        S33.- Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/02aws.html" class="md-nav__link">
        S33.- AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cloud/03s3.html" class="md-nav__link">
        S40.- S3
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        UT7.- PIAFP Lara
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#replicacion" class="md-nav__link">
    Replicación
  </a>
  
    <nav class="md-nav" aria-label="Replicación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conjunto-de-replicas" class="md-nav__link">
    Conjunto de réplicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creando-un-conjunto-de-replicas" class="md-nav__link">
    Creando un conjunto de réplicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trabajando-con-las-replicas" class="md-nav__link">
    Trabajando con las réplicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preferencias-de-lectura" class="md-nav__link">
    Preferencias de lectura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-en-la-escritura" class="md-nav__link">
    Consistencia en la escritura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-en-la-lectura" class="md-nav__link">
    Consistencia en la lectura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tolerancia-a-fallos" class="md-nav__link">
    Tolerancia a fallos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#particionado" class="md-nav__link">
    Particionado
  </a>
  
    <nav class="md-nav" aria-label="Particionado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sharded-cluster" class="md-nav__link">
    Sharded Cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shard-key" class="md-nav__link">
    Shard key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#particionado-con-docker" class="md-nav__link">
    Particionado con Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conexion-al-router" class="md-nav__link">
    Conexión al router
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#habilitando-el-sharding" class="md-nav__link">
    Habilitando el Sharding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trabajando-con-particiones" class="md-nav__link">
    Trabajando con particiones
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>S28.- Replicación y Particionado</h1>

<h2 id="replicacion">Replicación<a class="headerlink" href="#replicacion" title="Permanent link">&para;</a></h2>
<p>Un aspecto muy importante de <em>MongoDB</em> es que soporta la replicación de los datos de forma nativa mediante el uso de conjuntos de réplicas.</p>
<h3 id="conjunto-de-replicas">Conjunto de réplicas<a class="headerlink" href="#conjunto-de-replicas" title="Permanent link">&para;</a></h3>
<p>En MongoDB se replican los datos mediante un conjunto de réplicas  (<em>Replica Set</em>), el cual es un grupo de servidores (nodos <em>mongod</em>) donde uno de ellos ejerce la función de primario y por tanto recibe las peticiones de los clientes, y el resto de servidores hace de secundarios, manteniendo copias de los datos del primario.</p>
<figure style="align: center;">
    <img src="images/06replication.png">
    <figcaption>Conjunto de Réplicas en MongoDB</figcaption>
</figure>

<p>Si el nodo primario se cae, los secundarios eligen un nuevo primario entre ellos mismos, en un proceso que se conoce como votación. La aplicación se conectará al nuevo primario de manera transparente. Cuando el antiguo nodo primario vuelva en sí, será un nuevo nodo secundario.</p>
<p>Al usar replicación, si un servidor se cae, siempre vamos a poder obtener los datos a partir de otros servidores del conjunto. Si los datos de un servidor se dañan o son inaccesibles, podemos crear una nueva copia desde uno de los miembros del conjunto.</p>
<h4 id="elementos-de-un-conjunto-de-replicas">Elementos de un conjunto de réplicas<a class="headerlink" href="#elementos-de-un-conjunto-de-replicas" title="Permanent link">&para;</a></h4>
<p>Los tipos de nodos que podemos encontrar en un conjunto de réplica son:</p>
<ul>
<li><strong>Regular</strong>: Es el tipo de nodo más común.</li>
<li><strong>Primario</strong>: Acepta todas las operaciones de escritura de los clientes. Cada conjunto de réplicas tendrá sólo un primario, y como sólo un miembro acepta operaciones de escritura, ofrece consistencia estricta para todas las lecturas realizadas desde él.</li>
<li>
<p><strong>Secundario</strong>: Los secundarios replican el <em>oplog</em> primario y aplican las operaciones a sus conjuntos de datos. De este modo, los nodos secundarios son un espejo del primario. Si el primario deja de estar disponible, el conjunto de réplica elegirá a un secundario para que sea el nuevo primario, mediante un proceso de votación.</p>
<p>Por defecto, los clientes realizan las lecturas desde el nodo primario. Sin embargo, los clientes pueden indicar que quieren realizar lecturas desde los nodos secundarios.</p>
<div class="admonition danger">
<p class="admonition-title">Consistencia eventual</p>
<p>Es posible que al realizar lecturas de un nodo secundario la información que se obtenga no refleje el estado del nodo primario.</p>
</div>
</li>
<li>
<p><strong>Árbitro</strong>: se emplea sólo para votar. No contiene copia de los datos y no se puede convertir en primario. Los conjuntos de réplica pueden tener árbitros para añadir votos en las elecciones de un nuevo primario. Siempre tienen un voto, y permiten que los conjuntos de réplica tengan un número impar de nodos, sin la necesidad de tener un miembro que replique los datos. Además, no requieren hardware dedicado.</p>
<div class="admonition important">
<p class="admonition-title">A tener en cuenta</p>
<ul>
<li>No ejecutar un árbitro en sistemas que también ejecutan los miembros primarios y secundarios del conjunto de réplicas.</li>
<li>Sólo añadir un árbitro a un conjunto con un número par de miembros.</li>
<li>Si se añade un árbitro a un conjunto con un número impar de miembros, el conjunto puede sufrir un empate.</li>
</ul>
</div>
</li>
<li>
<p><strong>Retrasado</strong> (<em>delayed</em>): nodo que se emplea para la recuperación del sistema ante un fallo. Para ello, hay que asignar la propiedad <code>priority:0</code>. Este nodo nunca será un nodo primario.</p>
</li>
<li>
<p><strong>Oculto</strong>: empleado para analíticas del sistema.</p>
</li>
</ul>
<h5 id="oplog">oplog<a class="headerlink" href="#oplog" title="Permanent link">&para;</a></h5>
<p>Para soportar la replicación, el nodo primario almacena todos los cambios en su <a href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/"><em>oplog</em></a>.</p>
<p>De manera simplificada, el <em>oplog</em> es un diario de todos los cambios que la instancia principal realiza en las bases de datos con el propósito de replicar dichos cambios en un nodo secundario para asegurar que las dos bases de datos sean idénticas.</p>
<p>El servidor principal mantiene el <em>oplog</em>, y el secundario consulta al principal por nuevas entradas que aplicar a sus propias copias de las bases de datos replicadas. Este proceso se realiza de manera asíncrona, de manera que todos los miembros del conjunto de réplicas contienen una copia del <em>oplog</em>.</p>
<p>El oplog crea un <em>timestamp</em> para cada entrada. Esto permite que un secundario controle la cantidad de información que se ha modificado desde una lectura anterior, y qué entradas necesita transferir para ponerse al día. Si paramos un secundario y lo reiniciamos más adelante, utilizará el <em>oplog</em> para obtener todos los cambios que ha perdido mientras estaba offline.</p>
<p>El <em>oplog</em> se almacena en una colección limitada (<em>capped</em>) y ordenada de un tamaño determinado. La opción <code>oplogSize</code> define en MB el tamaño del archivo. Para un sistema de 64 bits con comportamiento de lectura/escritura normales, el <code>oplogSize</code> debería ser de al menos un 5% del espacio de disco disponible. Si el sistema tiene más escrituras que lecturas, puede que necesitemos incrementar este tamaño para asegurar que cualquier nodo secundario pueda estar <em>offline</em> una cantidad de tiempo razonable sin perder información.</p>
<h3 id="creando-un-conjunto-de-replicas">Creando un conjunto de réplicas<a class="headerlink" href="#creando-un-conjunto-de-replicas" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Replicación y particionado en MongoAtlas</p>
<p>El cluster gratuito de MongoAtlas ya ofrece replicación de los datos, pero no nos permite administrarlo, al tratarse de un clúster compartido.</p>
</div>
<p>Para poder probar tanto la replicación como el particionado, necesitamos tener control sobre los servidores. Por ello, en esta sesión vamos a utilizar <em>Docker</em> para montar la infraestructura.</p>
<p>Para ello, vamos a partir del archivo de <a href="resources/docker-compose-replicaset.yml">docker-compose-replicaset.yml</a> donde creamos tres contenedores (siendo <code>mongo1</code> el nodo principal y <code>mongo2</code> y <code>mongo3</code> los secundarios) dentro de una misma red y que pertenecen al conjunto de réplicas <code>iabdrs</code>:</p>
<div class="highlight"><span class="filename">docker-compose-replicaset.yml</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nt">services</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="nt">mongo1</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo1</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./rs-init.sh:/scripts/rs-init.sh</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./init.js:/scripts/init.js</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017:27017</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo2</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo3</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nt">links</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo2</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo3</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;iabdrs&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="nt">mongo2</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo2</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27018:27017</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;iabdrs&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span>
<span class="linenos" data-linenos="29 "></span><span class="w">  </span><span class="nt">mongo3</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo3</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27019:27017</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;iabdrs&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="linenos" data-linenos="37 "></span>
<span class="linenos" data-linenos="38 "></span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="39 "></span><span class="w">  </span><span class="nt">mongo-network</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="40 "></span><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span><span class="w"></span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Despliegue</p>
<p>Normalmente, cada instancia <code>mongod</code> se coloca en un servidor físico y todos en el puerto estándar (27017).</p>
<p>En nuestro caso, vamos a crear un conjunto de tres réplicas, y en vez de hacerlo en tres máquinas distintas, como los tres contenedores residen en la misma máquina, lo haremos en tres puertos diferentes (del 27017 al 27019)</p>
</div>
<p>El nodo principal necesita un <em>script</em> para inicializarse, el cual cargamos en el volumen como <a href="resources/rs-init.sh"><code>rs-init.sh</code></a>. En dicho fichero definimos un documento con la configuración del clúster, donde el <code>_id</code> tiene que ser igual al usado al crear la réplica, y el array de <code>members</code> contiene las réplicas creadas donde los puertos han de coincidir. Dicho documento se pasará como parámetro a la operación <a href="https://www.mongodb.com/docs/manual/reference/method/rs.initiate/"><code>rs.initiate</code></a>:</p>
<div class="highlight"><span class="filename">rs-init.sh</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="ch">#!/bin/bash</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="nv">DELAY</span><span class="o">=</span><span class="m">25</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span>mongosh <span class="s">&lt;&lt;EOF</span>
<span class="linenos" data-linenos=" 6 "></span><span class="s">var config = {</span>
<span class="linenos" data-linenos=" 7 "></span><span class="s">    &quot;_id&quot;: &quot;iabdrs&quot;,</span>
<span class="linenos" data-linenos=" 8 "></span><span class="s">    &quot;version&quot;: 1,</span>
<span class="linenos" data-linenos=" 9 "></span><span class="s">    &quot;members&quot;: [</span>
<span class="linenos" data-linenos="10 "></span><span class="s">        {</span>
<span class="linenos" data-linenos="11 "></span><span class="s">            &quot;_id&quot;: 1,</span>
<span class="linenos" data-linenos="12 "></span><span class="s">            &quot;host&quot;: &quot;mongo1:27017&quot;,</span>
<span class="linenos" data-linenos="13 "></span><span class="s">            &quot;priority&quot;: 2</span>
<span class="linenos" data-linenos="14 "></span><span class="s">        },</span>
<span class="linenos" data-linenos="15 "></span><span class="s">        {</span>
<span class="linenos" data-linenos="16 "></span><span class="s">            &quot;_id&quot;: 2,</span>
<span class="linenos" data-linenos="17 "></span><span class="s">            &quot;host&quot;: &quot;mongo2:27017&quot;,</span>
<span class="linenos" data-linenos="18 "></span><span class="s">            &quot;priority&quot;: 1</span>
<span class="linenos" data-linenos="19 "></span><span class="s">        },</span>
<span class="linenos" data-linenos="20 "></span><span class="s">        {</span>
<span class="linenos" data-linenos="21 "></span><span class="s">            &quot;_id&quot;: 3,</span>
<span class="linenos" data-linenos="22 "></span><span class="s">            &quot;host&quot;: &quot;mongo3:27017&quot;,</span>
<span class="linenos" data-linenos="23 "></span><span class="s">            &quot;priority&quot;: 1</span>
<span class="linenos" data-linenos="24 "></span><span class="s">        }</span>
<span class="linenos" data-linenos="25 "></span><span class="s">    ]</span>
<span class="linenos" data-linenos="26 "></span><span class="s">};</span>
<span class="linenos" data-linenos="27 "></span><span class="s">rs.initiate(config, { force: true });</span>
<span class="linenos" data-linenos="28 "></span><span class="s">EOF</span>
<span class="linenos" data-linenos="29 "></span>
<span class="linenos" data-linenos="30 "></span><span class="nb">echo</span> <span class="s2">&quot;****** Esperando </span><span class="si">${</span><span class="nv">DELAY</span><span class="si">}</span><span class="s2"> segundos a que se apliquen la configuración del conjunto de réplicas ******&quot;</span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span>sleep <span class="nv">$DELAY</span>
<span class="linenos" data-linenos="33 "></span>
<span class="linenos" data-linenos="34 "></span>mongosh &lt; /scripts/init.js
</code></pre></div>
<p>Finalmente, mediante el archivo <a href="resources/init.js"><code>init.js</code></a> comprobamos el estado de la réplica y creamos el usuario administrador:</p>
<div class="highlight"><span class="filename">init.js</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">();</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">createUser</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">pwd</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">roles</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]});</span><span class="w"></span>
</code></pre></div>
<p>Así pues, una vez tenemos los tres archivos en la misma carpeta, ya podemos lanzar <em>Docker Compose</em> para crear los contenedores:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker-compose --file docker-compose-replicaset.yml --project-name iabd-mongodb-replica up -d
</code></pre></div>
<p>Ya sólo nos queda ejecutar el <em>script</em> de inicialización sobre el nodo principal:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker <span class="nb">exec</span> mongo1 sh /scripts/rs-init.sh
</code></pre></div>
<p>Al ejecutarse el script, se inicializa el conjunto de réplicas y se obtiene su estado (mediante <code>rs.status()</code>) el cual se muestra por consola y podemos observar como ha creado los tres nodos, diferenciando el nodo principal de los secundarios:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="  1 "></span><span class="err">iabdrs</span><span class="w"> </span><span class="p">[</span><span class="err">direc</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">primary</span><span class="p">]</span><span class="w"> </span><span class="kc">test</span><span class="err">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="  2 "></span><span class="w">  </span><span class="err">se</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;iabdrs&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="  3 "></span><span class="w">  </span><span class="err">da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:42.137Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  4 "></span><span class="w">  </span><span class="err">myS</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  5 "></span><span class="w">  </span><span class="kc">ter</span><span class="err">m</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  6 "></span><span class="w">  </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  7 "></span><span class="w">  </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  8 "></span><span class="w">  </span><span class="err">hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">I</span><span class="kc">nter</span><span class="err">valMillis</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;2000&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  9 "></span><span class="w">  </span><span class="err">majori</span><span class="kc">t</span><span class="err">yVo</span><span class="kc">te</span><span class="err">Cou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 10 "></span><span class="w">  </span><span class="err">wri</span><span class="kc">te</span><span class="err">Majori</span><span class="kc">t</span><span class="err">yCou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 11 "></span><span class="w">  </span><span class="err">vo</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">gMembersCou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 12 "></span><span class="w">  </span><span class="err">wri</span><span class="kc">ta</span><span class="err">bleVo</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">gMembersCou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 13 "></span><span class="w">  </span><span class="err">op</span><span class="kc">t</span><span class="err">imes</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 14 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Commi</span><span class="kc">tte</span><span class="err">dOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 15 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Commi</span><span class="kc">tte</span><span class="err">dWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 16 "></span><span class="w">    </span><span class="err">readCo</span><span class="kc">n</span><span class="err">cer</span><span class="kc">n</span><span class="err">Majori</span><span class="kc">t</span><span class="err">yOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 17 "></span><span class="w">    </span><span class="err">appliedOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 18 "></span><span class="w">    </span><span class="err">durableOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 19 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 20 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 21 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 22 "></span><span class="w">  </span><span class="err">las</span><span class="kc">t</span><span class="err">S</span><span class="kc">ta</span><span class="err">bleRecoveryTimes</span><span class="kc">ta</span><span class="err">mp</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778030</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 23 "></span><span class="w">  </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Ca</span><span class="kc">n</span><span class="err">dida</span><span class="kc">te</span><span class="err">Me</span><span class="kc">tr</span><span class="err">ics</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 24 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Reaso</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Timeou</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 25 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:10.197Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 26 "></span><span class="w">    </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Term</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 27 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Commi</span><span class="kc">tte</span><span class="err">dOpTimeA</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666777979</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;-1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 28 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">See</span><span class="kc">n</span><span class="err">OpTimeA</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666777979</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;-1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 29 "></span><span class="w">    </span><span class="kc">nu</span><span class="err">mVo</span><span class="kc">tes</span><span class="err">Needed</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 30 "></span><span class="w">    </span><span class="err">priori</span><span class="kc">t</span><span class="err">yA</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 31 "></span><span class="w">    </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Timeou</span><span class="kc">t</span><span class="err">Millis</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;10000&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 32 "></span><span class="w">    </span><span class="kc">nu</span><span class="err">mCa</span><span class="kc">t</span><span class="err">chUpOps</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 33 "></span><span class="w">    </span><span class="kc">ne</span><span class="err">wTermS</span><span class="kc">tart</span><span class="err">Da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:10.363Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 34 "></span><span class="w">    </span><span class="err">wMajori</span><span class="kc">t</span><span class="err">yWri</span><span class="kc">te</span><span class="err">Availabili</span><span class="kc">t</span><span class="err">yDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:11.139Z&quot;</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 35 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 36 "></span><span class="w">  </span><span class="err">members</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 37 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 38 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 39 "></span><span class="w">      </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">1</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 40 "></span><span class="w">      </span><span class="err">heal</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 41 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 42 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="err">S</span><span class="kc">tr</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;PRIMARY&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 43 "></span><span class="w">      </span><span class="err">up</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="mi">129</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 44 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 45 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 46 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 47 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 48 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 49 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 50 "></span><span class="w">      </span><span class="err">i</span><span class="kc">nf</span><span class="err">oMessage</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Could</span><span class="w"> </span><span class="kc">n</span><span class="err">o</span><span class="kc">t</span><span class="w"> </span><span class="kc">f</span><span class="err">i</span><span class="kc">n</span><span class="err">d</span><span class="w"> </span><span class="err">member</span><span class="w"> </span><span class="kc">t</span><span class="err">o</span><span class="w"> </span><span class="err">sy</span><span class="kc">n</span><span class="err">c</span><span class="w"> </span><span class="kc">fr</span><span class="err">om&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 51 "></span><span class="w">      </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Time</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666777990</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 52 "></span><span class="w">      </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:10.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 53 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 54 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igTerm</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 55 "></span><span class="w">      </span><span class="err">sel</span><span class="kc">f</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 56 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Message</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="w"></span>
<span class="linenos" data-linenos=" 57 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 58 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 59 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 60 "></span><span class="w">      </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">2</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 61 "></span><span class="w">      </span><span class="err">heal</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 62 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 63 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="err">S</span><span class="kc">tr</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;SECONDARY&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 64 "></span><span class="w">      </span><span class="err">up</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 65 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 66 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurable</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 67 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 68 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurableDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 69 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 70 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 71 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.322Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 72 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Recv</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:41.327Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 73 "></span><span class="w">      </span><span class="err">pi</span><span class="kc">n</span><span class="err">gMs</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 74 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Message</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 75 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">1</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 76 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 77 "></span><span class="w">      </span><span class="err">i</span><span class="kc">nf</span><span class="err">oMessage</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 78 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 79 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igTerm</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos" data-linenos=" 80 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 81 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 82 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 83 "></span><span class="w">      </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">3</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 84 "></span><span class="w">      </span><span class="err">heal</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 85 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 86 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="err">S</span><span class="kc">tr</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;SECONDARY&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 87 "></span><span class="w">      </span><span class="err">up</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 88 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 89 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurable</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 90 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 91 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurableDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 92 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 93 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 94 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.322Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 95 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Recv</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:41.326Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 96 "></span><span class="w">      </span><span class="err">pi</span><span class="kc">n</span><span class="err">gMs</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 97 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Message</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 98 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">1</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 99 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="100 "></span><span class="w">      </span><span class="err">i</span><span class="kc">nf</span><span class="err">oMessage</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="101 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="102 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igTerm</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos" data-linenos="103 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="104 "></span><span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="105 "></span><span class="w">  </span><span class="err">ok</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="106 "></span><span class="w">  </span><span class="err">&#39;$clus</span><span class="kc">ter</span><span class="err">Time&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="107 "></span><span class="w">    </span><span class="err">clus</span><span class="kc">ter</span><span class="err">Time</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="108 "></span><span class="w">    </span><span class="err">sig</span><span class="kc">nature</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="109 "></span><span class="w">      </span><span class="err">hash</span><span class="p">:</span><span class="w"> </span><span class="err">Bi</span><span class="kc">nar</span><span class="err">y(Bu</span><span class="kc">ffer</span><span class="err">.</span><span class="kc">fr</span><span class="err">om(</span><span class="s2">&quot;0000000000000000000000000000000000000000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hex&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="110 "></span><span class="w">      </span><span class="err">keyId</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos="111 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="112 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="113 "></span><span class="w">  </span><span class="err">opera</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Time</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos="114 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Una vez que ya hemos arrancando todo, podemos conectarnos a nuestro conjunto de réplica mediante <code>mongosh</code> (si no le pasamos ningún parámetro, se conecta automáticamente a <code>localhost</code> y al puerto 27017). Dentro del shell, los comandos que trabajan con réplicas comienzan por el prefijo <strong><code>rs</code></strong>. Por ejemplo, mediante <code>rs.help()</code> obtendremos la ayuda de los métodos disponibles:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>&gt; mongosh
<span class="hll"><span class="linenos" data-linenos=" 2 "></span>iabdrs <span class="o">[</span>direct: primary<span class="o">]</span> test&gt; rs.help<span class="o">()</span>
</span><span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span>  Replica Set Class:
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span>    initiate                                   Initiates the replica set.
<span class="linenos" data-linenos=" 7 "></span>    config                                     Returns a document that contains the current replica <span class="nb">set</span> configuration.
<span class="linenos" data-linenos=" 8 "></span>    conf                                       Calls replSetConfig
<span class="linenos" data-linenos=" 9 "></span>    reconfig                                   Reconfigures an existing replica set, overwriting the existing replica <span class="nb">set</span> configuration.
<span class="linenos" data-linenos="10 "></span>    reconfigForPSASet                          Reconfigures an existing replica set, overwriting the existing replica <span class="nb">set</span> configuration, <span class="k">if</span> the reconfiguration is a transition from a Primary-Arbiter to a Primary-Secondary-Arbiter set.
<span class="linenos" data-linenos="11 "></span>    status                                     Calls replSetGetStatus
<span class="linenos" data-linenos="12 "></span>    isMaster                                   Calls isMaster
<span class="linenos" data-linenos="13 "></span>    hello                                      Calls hello
<span class="linenos" data-linenos="14 "></span>    printSecondaryReplicationInfo              Calls db.printSecondaryReplicationInfo
<span class="linenos" data-linenos="15 "></span>    printSlaveReplicationInfo                  DEPRECATED. Use rs.printSecondaryReplicationInfo
<span class="linenos" data-linenos="16 "></span>    printReplicationInfo                       Calls db.printReplicationInfo
<span class="linenos" data-linenos="17 "></span>    add                                        Adds replica <span class="nb">set</span> member to replica set.
<span class="linenos" data-linenos="18 "></span>    addArb                                     Calls rs.add with <span class="nv">arbiterOnly</span><span class="o">=</span><span class="nb">true</span>
<span class="linenos" data-linenos="19 "></span>    remove                                     Removes a replica <span class="nb">set</span> member.
<span class="linenos" data-linenos="20 "></span>    freeze                                     Prevents the current member from seeking election as primary <span class="k">for</span> a period of time. Uses the replSetFreeze <span class="nb">command</span>
<span class="linenos" data-linenos="21 "></span>    stepDown                                   Causes the current primary to become a secondary which forces an election. If no stepDownSecs is provided, uses <span class="m">60</span> seconds. 
<span class="linenos" data-linenos="22 "></span>Uses the replSetStepDown <span class="nb">command</span>
<span class="linenos" data-linenos="23 "></span>    syncFrom                                   Sets the member that this replica <span class="nb">set</span> member will sync from, overriding the default sync target selection logic.
<span class="linenos" data-linenos="24 "></span>    secondaryOk                                This method is deprecated. Use db.getMongo<span class="o">()</span>.setReadPref<span class="o">()</span> instead
<span class="linenos" data-linenos="25 "></span>
<span class="linenos" data-linenos="26 "></span>  For more information on usage: https://docs.mongodb.com/manual/reference/method/js-replication/
</code></pre></div>
<p>La próxima vez que lancemos las réplicas ya no deberemos configurarlas. Así pues, el proceso de enlazar e iniciar las réplicas sólo se realiza una vez.</p>
<h3 id="trabajando-con-las-replicas">Trabajando con las réplicas<a class="headerlink" href="#trabajando-con-las-replicas" title="Permanent link">&para;</a></h3>
<p>Una vez que hemos visto que las tres réplicas están funcionando, vamos a comprobar cómo podemos trabajar con ellas.</p>
<p>Ya hemos comprobado cómo al conectarnos al clúster, nos aparece como símbolo del <em>shell</em> el nombre del conjunto de la réplica seguido de dos puntos y <code>primary</code> si nos hemos conectado al nodo principal, o <code>secondary</code> en caso contrario.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>iabdrs <span class="o">[</span>direct: primary<span class="o">]</span> test&gt; 
</code></pre></div>
<p>Para saber si nos hemos conectado al nodo correcto, mediante <a href="https://www.mongodb.com/docs/upcoming/reference/command/hello/#hello"><code>db.hello()</code></a> obtendremos el tipo del nodo (propiedad <code>isWritablePrimary</code>) e información sobre el resto de nodos (antes se utilizaba el método <code>isMaster</code> el cual se ha marcado como <em>deprecated</em>):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">iabdrs</span><span class="w"> </span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">primary</span><span class="p">]</span><span class="w"> </span><span class="nx">test</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">hello</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nx">topologyVersion</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635a9dbbc752fabab79400d6&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nx">counter</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="nx">hosts</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;mongo1:27017&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;mongo2:27017&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;mongo3:27017&#39;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="nx">setName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdrs&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="nx">setVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="nx">isWritablePrimary</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="nx">secondary</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="nx">primary</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;mongo1:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="nx">me</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;mongo1:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="nx">electionId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;7fffffff0000000000000001&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="nx">lastWrite</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nx">opTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666883479</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="nx">lastWriteDate</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-10-27T15:11:19.000Z&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="nx">majorityOpTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666883479</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="nx">majorityWriteDate</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-10-27T15:11:19.000Z&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">  </span><span class="nx">maxBsonObjectSize</span><span class="o">:</span><span class="w"> </span><span class="mf">16777216</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">  </span><span class="nx">maxMessageSizeBytes</span><span class="o">:</span><span class="w"> </span><span class="mf">48000000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">  </span><span class="nx">maxWriteBatchSize</span><span class="o">:</span><span class="w"> </span><span class="mf">100000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">  </span><span class="nx">localTime</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-10-27T15:11:20.366Z&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">  </span><span class="nx">logicalSessionTimeoutMinutes</span><span class="o">:</span><span class="w"> </span><span class="mf">30</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">  </span><span class="nx">connectionId</span><span class="o">:</span><span class="w"> </span><span class="mf">48</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">  </span><span class="nx">minWireVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">  </span><span class="nx">maxWireVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">17</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">  </span><span class="nx">readOnly</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">  </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">  </span><span class="s1">&#39;$clusterTime&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">    </span><span class="nx">clusterTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666883479</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">    </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">      </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="nx">Binary</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;0000000000000000000000000000000000000000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hex&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">      </span><span class="nx">keyId</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="37 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="38 "></span><span class="w">  </span><span class="nx">operationTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666883479</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos="39 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Ahora que sabemos que estamos en el nodo principal, vamos a añadir datos.</p>
<p>Para ello, vamos a insertar 1.000 documentos en la colección <code>pruebas</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">&lt;</span><span class="mf">1000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">pruebas</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="nx">num</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Estos 1.000 documentos se han insertado en el nodo principal, y se han replicado a los secundarios. Para comprobar la replicación, abrimos un nuevo terminal y nos conectamos a un nodo secundario:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>$ mongosh --port <span class="m">27018</span>
<span class="linenos" data-linenos="2 "></span>iabdrs <span class="o">[</span>direct: secondary<span class="o">]</span> test&gt;
</code></pre></div>
<p>Si desde el nodo secundario intentamos consultar el total de documentos de la colección obtendremos un error:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>iabdrs <span class="o">[</span>direct: secondary<span class="o">]</span> test&gt; db.pruebas.countDocuments<span class="o">()</span>
<span class="linenos" data-linenos="2 "></span>MongoServerError: not primary and <span class="nv">secondaryOk</span><span class="o">=</span><span class="nb">false</span> - consider using db.getMongo<span class="o">()</span>.setReadPref<span class="o">()</span> or readPreference <span class="k">in</span> the connection string
</code></pre></div>
<p>El error indica que no somos un nodo primario y por lo tanto no podemos leer de él. Para permitir lecturas en los nodos secundarios, mediante <code>db.getMongo().setReadPref('secondary')</code> le decimos a <code>mongosh</code> que sabemos que nos hemos conectado a un secundario y admitimos la posibilidad de obtener datos obsoletos.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>iabdrs <span class="o">[</span>direct: secondary<span class="o">]</span> test&gt; db.getMongo<span class="o">()</span>.setReadPref<span class="o">(</span><span class="s1">&#39;secondary&#39;</span><span class="o">)</span>
<span class="linenos" data-linenos="2 "></span>iabdrs <span class="o">[</span>direct: secondary<span class="o">]</span> test&gt; db.pruebas.countDocuments<span class="o">()</span>
<span class="linenos" data-linenos="3 "></span><span class="m">1000</span>
</code></pre></div>
<p>Pero que podamos leer no significa que podamos escribir. Si intentamos escribir en un nodo secundario obtendremos un error:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>iabdrs <span class="o">[</span>direct: secondary<span class="o">]</span> test&gt; db.pruebas.insertOne<span class="o">({</span>num : <span class="m">1001</span><span class="o">})</span>
<span class="linenos" data-linenos="2 "></span>MongoServerError: not primary
</code></pre></div>
<h3 id="preferencias-de-lectura">Preferencias de lectura<a class="headerlink" href="#preferencias-de-lectura" title="Permanent link">&para;</a></h3>
<p>En el ejemplo anterior hemos visto cómo hemos cambiado las preferencias de lectura para permitir hacerlo desde los nodos secundarios. Así pues, las <a href="https://www.mongodb.com/docs/upcoming/core/read-preference/">preferencias de lectura</a> definen el modo en el que MongoDB enruta las lecturas realizadas a los miembros del conjunto de réplicas.</p>
<figure style="align: center;">
    <img src="images/06replica-set-read-preference.svg">
    <figcaption>Preferencias de lectura</figcaption>
</figure>

<p>Por defecto, las aplicaciones dirigen las operaciones de consulta al miembro principal (con el modo de lectura <code>primary</code>, el cual es el modo por defecto). Pero los clientes puede indicar otras preferencias:</p>
<ul>
<li><code>primaryPreferred</code>: si está disponible, las lecturas se realizan en el nodo primario, pero si no estuviera en pie, habilita las lecturas de los secundarios.</li>
<li><code>secondary</code>: todas las operaciones de lectura se realizan en nodos secundarios.</li>
<li><code>secondaryPreferred</code>: primero prueba con los secundarios, y si no hay ninguno disponible, la lectura la realiza del primario.</li>
<li><code>nearest</code>: las lecturas se realizan del nodo más cercano en base a la latencia, independientemente que el nodo sea primario o secundario.</li>
</ul>
<p>Para indicar la preferencia de lectura, ya hemos visto que lo haremos con la función <a href="https://www.mongodb.com/docs/manual/reference/method/Mongo.setReadPref/">Mongo.setReadPref()</a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>iabdrs <span class="o">[</span>direct: secondary<span class="o">]</span> test&gt; db.getMongo<span class="o">()</span>.setReadPref<span class="o">(</span><span class="s1">&#39;nearest&#39;</span><span class="o">)</span>
</code></pre></div>
<h3 id="consistencia-en-la-escritura">Consistencia en la escritura<a class="headerlink" href="#consistencia-en-la-escritura" title="Permanent link">&para;</a></h3>
<p>Por defecto, tanto las lecturas como las escrituras se realizan de manera predeterminada en el nodo principal.</p>
<p>Las aplicaciones pueden decidir que las escrituras vayan al nodo primario pero las lecturas al secundario. Esto puede provocar que haya lecturas caducadas, con datos obsoletos. Este hecho, que en sistemas relacionales es inadmisible, en sistemas NoSQL ofrece como beneficio que podamos escalar el sistema.</p>
<p>La replicación es un proceso asíncrono. En el período de tiempo en el que el sistema de votación sucede, no se completa ninguna escritura.</p>
<p><em>MongoDB</em> garantiza la <a href="https://docs.mongodb.com/manual/reference/write-concern/">consistencia en la escritura (Write Concern)</a>, lo que implica que sea un sistema consistente. Para ello, ofrece un mecanismo que garantiza que una escritura ha sido exitosa. Dependiendo del nivel de configuración de la consistencia, las inserciones, modificaciones y borrados pueden tardar más o menos. Si reducimos el nivel de consistencia, el rendimiento será mejor, a costa de poder obtener datos obsoletos u perder datos que no se han terminado de serializar en disco. Con un nivel de consistencia más alto, los clientes esperan tras enviar una operación de escritura a que <em>MongoDB</em> les confirme la operación.</p>
<p>Los valores que podemos configurar se realizan mediante las siguientes opciones:</p>
<ul>
<li><code>w</code>: indica el número de servidores que se han de replicar para que la inserción devuelva un ACK.</li>
<li><code>j</code>: indica si las escrituras se tienen que trasladar a un diario de bitácora (<em>journal</em>)</li>
<li><code>wtimeout</code>: indica el límite de tiempo a esperar como máximo, para prevenir que una escritura se bloquee indefinidamente.</li>
</ul>
<h4 id="niveles-de-consistencia-de-escritura">Niveles de consistencia de escritura<a class="headerlink" href="#niveles-de-consistencia-de-escritura" title="Permanent link">&para;</a></h4>
<p>Con estas opciones, podemos configurar diferentes niveles de consistencia son:</p>
<ul>
<li>Sin confirmación: <code>w:0</code>, también conocido como <em>fire-and-forget</em>, ya que no se espera ningún tipo de confirmación.</li>
<li>Con confirmación: <code>w:1</code>, el cual es el modo por defecto, y sólo espera confirmación del nodo principal.</li>
<li>Con diario: <code>w:1</code>, <code>j:true</code>. Cada inserción primero se escribe en el diario y posteriormente en el directorio de datos.</li>
<li>Con confirmación de la mayoría: <code>w: "majority"</code>, es decir, confirman la mitad + 1 de los nodos de la réplica. Hasta que no han confirmado todos los nodos secundarios necesarios, el principal no envía el ACK a la aplicación cliente.</li>
</ul>
<figure style="align: center;">
    <img src="images/06write-majority.png" width="600px">
    <figcaption>Consistencia en la escritura con confirmación de la mayoría</figcaption>
</figure>

<p>Estas opciones se indican como parámetro final en las operaciones de inserción y modificación de datos. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">pruebas</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">num</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1002</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="p">{</span><span class="nx">writeConcern</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;majority&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">wtimeout</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="p">}}</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>En resumen, a mayor cantidad de nodos, mayor es la tolerancia a fallos pero cada operación necesita más tiempo y recursos para realizar la persistencia de los datos.</p>
<h3 id="consistencia-en-la-lectura">Consistencia en la lectura<a class="headerlink" href="#consistencia-en-la-lectura" title="Permanent link">&para;</a></h3>
<p>De igual manera que podemos decidir en cuantos nodos se deben propagar las escrituras, podemos indicar cuantos nodos debemos leer para dar un dato como válido. Para ello, <em>MongoDB</em> da soporte a diferentes niveles de <a href="https://www.mongodb.com/docs/manual/reference/read-concern/">consistencia en la lectura (Read Concern)</a>:</p>
<ul>
<li><code>local</code>: devuelve el dato más reciente en el cluster. Cualquier dato que haya sido escrito en el nodo primario puede ser elegido para devolverse. Sin embargo, no se garantiza que este dato sea replicado a los miembros del conjunto en caso de fallo. Este es el nivel por defecto en las operaciones de lectura contra el nodo primario.</li>
<li><code>available</code>: equivalente de <code>local</code> cuando las operaciones de lectura se efectúan contra un nodo secundario.</li>
<li><code>majority</code>: únicamente devuelve datos que hayan sido confirmados en una mayoría de nodos dentro del conjunto.</li>
<li><code>linearizable</code>: devuelve datos que hayan sido confirmados por una mayoría de nodos, pero permite al desarrollador establecer su propia funcionalidad.</li>
<li><code>snapshot</code>: sólo disponible para transacciones multi-documento, realiza una "foto" de los datos al inicio de la transacción.</li>
</ul>
<p>Imaginemos un escenario en el cual recibimos la confirmación de escritura desde el nodo primario. Inmediatamente efectuamos una operación de lectura, el nodo devuelve el dato, pero éste nodo falla antes de replicar la operación de escritura a los nodos secundarios. Sobre esta operación se efectuará un proceso de <em>rollback</em> en el momento que el nodo primario vuelva a estar disponible, por lo que ese dato realmente no existirá en el conjunto replicado. Es decir, la aplicación actualmente tiene un dato que no existe en el conjunto de réplicas.</p>
<p>Mediante la consistencia en la lectura, podemos obtener unas mínimas garantías de que el dato que estamos leyendo es correcto y durable. Cuando se utiliza, únicamente devolverá datos cuya grabación haya sido confirmada por el número de nodos especificados en sus opciones. Se puede escoger entre devolver el dato más reciente que exista en el clúster, o el dato recibido por una mayoría de miembros en el cluster.</p>
<p>El hecho de que un documento no se considere correcto, no quiere decir necesariamente que se haya perdido, sino que en el momento de su lectura, no ha cumplido las condiciones necesarias de durabilidad para ser devuelto. Puede ser que la lectura se esté produciendo antes de que el dato haya sido propagado al número mínimo de nodos necesario, y por eso no se obtenga, pero en lecturas sucesivas sí pueda aparecer.</p>
<h3 id="tolerancia-a-fallos">Tolerancia a fallos<a class="headerlink" href="#tolerancia-a-fallos" title="Permanent link">&para;</a></h3>
<p>Cuando un nodo primario no se comunica con otros miembros del conjunto durante más de 10 segundos, el conjunto de réplicas intentará, de entre los secundarios, que otro miembro se convierta en el nuevo primario.</p>
<p>Para ello se realiza un proceso de votación, de modo que el nodo que obtenga el mayor número de votos se erigirá en primario. Este proceso de votación se realiza bastante rápido (menos de 3 segundos), durante el cual no existe ningún nodo primario y por tanto la réplica no acepta escrituras y todos los miembros se convierten en nodos de sólo-lectura.</p>
<figure style="align: center;">
    <img src="images/06replica-set-election.png">
    <figcaption>Elección de un nuevo primario</figcaption>
</figure>

<h4 id="proceso-de-votacion">Proceso de votación<a class="headerlink" href="#proceso-de-votacion" title="Permanent link">&para;</a></h4>
<p>Cuando un nodo secundario no puede contactar con su nodo primario, contactará con el resto de miembros y les indicará que quiere ser elegido como primario. Es decir, cada nodo que no encuentre un primario se nominará como posible primario, de modo que un nodo no nomina a otro a ser primario, únicamente vota sobre una nominación ya existente.</p>
<p>Antes de dar su voto, el resto de nodos comprobarán:</p>
<ul>
<li>si ellos tienen conectividad con el primario</li>
<li>si el nodo que solicita ser primario tienen una réplica actualizada de los datos. Todas las operaciones replicadas están ordenadas por el <em>timestamp</em> ascendentemente, de modo que los candidatos deben tener operaciones posteriores o iguales a cualquier miembro con el que tengan conectividad.</li>
<li>si existe algún nodo con una prioridad mayor que debería ser elegido.</li>
</ul>
<p>Si algún miembro que quiere ser primario recibe una mayoría de "sís" se convertirá en el nuevo primario, siempre y cuando no haya un servidor que vete la votación. Si un miembro la veta es porque conoce alguna razón por la que el nodo que quiere ser primario no debería serlo, es decir, ha conseguido contactar con el antiguo primario.</p>
<p>Una vez un candidato recibe una mayoría de "sís", su estado pasará a ser primario.</p>
<h4 id="configuracion-recomendada">Configuración recomendada<a class="headerlink" href="#configuracion-recomendada" title="Permanent link">&para;</a></h4>
<div class="admonition info">
<p class="admonition-title">Cantidad de elementos</p>
<p>En la votación, se necesita una mayoría de nodos para elegir un primario, ya que una escritura se considera segura cuando ha alcanzado a la mayoría de los nodos.<br />
Esta mayoría se define como más de la mitad de todos los nodos del conjunto.<br />
Hay que destacar que la mayoría no se basa en los elementos que queden en pie o estén disponibles, sino en el conjunto definido en la configuración del conjunto.</p>
</div>
<p>Se recomiendan dos configuraciones:</p>
<ol>
<li>Mediante una mayoría del conjunto en un centro de datos. Este planteamiento es bueno si tenemos un <em>data center</em> donde queremos que siempre se aloje el nodo primario de la réplica. Siempre que el centro de datos funcione normalmente, habrá un nodo primario. Sin embargo, si el centro primario pierde la conectividad, el centro de datos secundario no podrá elegir un nuevo primario.</li>
<li>Mediante el mismo número de servidores en cada centro de datos, más un servidor que rompe la igualdad en una tercera localización. Este diseño es conveniente cuando ambos centros de datos tienen el mismo grado de confiabilidad y robustez.</li>
</ol>
<h4 id="comprobando-la-tolerancia">Comprobando la tolerancia<a class="headerlink" href="#comprobando-la-tolerancia" title="Permanent link">&para;</a></h4>
<p>Para comprobar la tolerancia a fallos, desde el nodo primario vamos a detenerlo:</p>
<p>Si nos hemos conectados desde dentro del contenedor a <code>localhost</code> con la opción <code>--host "127.0.0.1</code>, vamos a poder detenerlo mediante el comando <a href="https://www.mongodb.com/docs/manual/reference/command/shutdown/"><code>shutdown</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>iabdrs <span class="o">[</span>direct: primary<span class="o">]</span> test&gt; db.adminCommand<span class="o">({</span><span class="s2">&quot;shutdown&quot;</span> : <span class="m">1</span><span class="o">})</span>
</code></pre></div>
<p>Otra posibilidad en vez de detenerlo es degradarlo a nodo secundario mediante <a href="https://www.mongodb.com/docs/manual/reference/method/rs.stepDown/">rs.stepDown()</a> y forzar un proceso de votación entre el resto de nodos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>iabdrs <span class="o">[</span>direct: primary<span class="o">]</span> test&gt; rs.stepDown<span class="o">()</span>
<span class="linenos" data-linenos=" 2 "></span><span class="o">{</span>
<span class="linenos" data-linenos=" 3 "></span>  ok: <span class="m">1</span>,
<span class="linenos" data-linenos=" 4 "></span>  <span class="s1">&#39;$clusterTime&#39;</span>: <span class="o">{</span>
<span class="linenos" data-linenos=" 5 "></span>    clusterTime: Timestamp<span class="o">({</span> t: <span class="m">1666885736</span>, i: <span class="m">1</span> <span class="o">})</span>,
<span class="linenos" data-linenos=" 6 "></span>    signature: <span class="o">{</span>
<span class="linenos" data-linenos=" 7 "></span>      hash: Binary<span class="o">(</span>Buffer.from<span class="o">(</span><span class="s2">&quot;0000000000000000000000000000000000000000&quot;</span>, <span class="s2">&quot;hex&quot;</span><span class="o">)</span>, <span class="m">0</span><span class="o">)</span>,
<span class="linenos" data-linenos=" 8 "></span>      keyId: Long<span class="o">(</span><span class="s2">&quot;0&quot;</span><span class="o">)</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="o">}</span>
<span class="linenos" data-linenos="10 "></span>  <span class="o">}</span>,
<span class="linenos" data-linenos="11 "></span>  operationTime: Timestamp<span class="o">({</span> t: <span class="m">1666885736</span>, i: <span class="m">1</span> <span class="o">})</span>
<span class="linenos" data-linenos="12 "></span><span class="o">}</span>
<span class="linenos" data-linenos="13 "></span>iabdrs <span class="o">[</span>direct: secondary<span class="o">]</span> test&gt;
</code></pre></div>
<p>Si pasamos al <em>shell</em> del antiguo nodo secundario, y le preguntamos si es el principal, veremos que ahora indica que la propiedad <code>isWritablePrimary</code> es <code>true</code> y que ahora el <em>primary</em> es <code>mongo2:27017</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="err">iabdrs</span><span class="w"> </span><span class="p">[</span><span class="err">direc</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">primary</span><span class="p">]</span><span class="w"> </span><span class="kc">test</span><span class="err">&gt;</span><span class="w"> </span><span class="err">rs.hello()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="kc">t</span><span class="err">opologyVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="err">processId</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;635ab0cb3f36955c651fa584&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="err">cou</span><span class="kc">nter</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;7&quot;</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="err">hos</span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">1</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">2</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">3</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="err">se</span><span class="kc">t</span><span class="err">Name</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;iabdrs&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="err">se</span><span class="kc">t</span><span class="err">Versio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="err">isWri</span><span class="kc">ta</span><span class="err">blePrimary</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="err">seco</span><span class="kc">n</span><span class="err">dary</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="err">primary</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">2</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">2</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="err">...</span><span class="w"></span>
</code></pre></div>
<h4 id="recuperacion-del-sistema">Recuperación del sistema<a class="headerlink" href="#recuperacion-del-sistema" title="Permanent link">&para;</a></h4>
<p>Si en un conjunto de réplicas se cae el primario y hay escrituras que se han pasado al <code>oplog</code> y tenemos que otros nodos no las han replicado, cuando el nodo primario vuelva en sí como secundario y se sincronice con el nuevo primario, se dará cuenta que hay operaciones de escritura pendientes y las pasará a <em>rollback</em>, para que si se desean se apliquen manualmente.</p>
<p>Para evitar este escenario, se necesita emplear consistencia en la escritura, de manera que hasta que la escritura no se haya replicado en la mayoría de los nodos no se considere como una escritura exitosa.</p>
<h2 id="particionado">Particionado<a class="headerlink" href="#particionado" title="Permanent link">&para;</a></h2>
<p>Ya vimos en la primera sesión que dentro del entorno de las bases de datos, particionar consiste en dividir los datos entre múltiples máquinas. Al poner un subconjunto de los datos en cada máquina, vamos a poder almacenar más información y soportar más carga sin necesidad de máquinas más potentes, sino una mayor cantidad de máquinas más modestas (y mucho más baratas).</p>
<p>El <em>Sharding</em> es una técnica que fragmenta los datos de la base de datos horizontalmente agrupándolos de algún modo que tenga sentido y que permita un direccionamiento más rápido.</p>
<figure style="align: center;">
    <img src="images/06sharded-collection.png">
    <figcaption>Sharding</figcaption>
</figure>

<p>Por lo tanto, estos <em>shards</em> (fragmentos) pueden estar localizados en diferentes bases de datos y localizaciones físicas.</p>
<p>El <em>Sharding</em> no tiene por qué estar basado únicamente en una colección y un campo, puede ser a nivel de todas las colecciones. Por ejemplo podríamos decir "<em>todos los datos de usuarios cuyo perfil esté en los Estados Unidos los redirigimos a la base de datos del servidor en Estados Unidos, y todos los de Asia van a la base de datos de Asia</em>".</p>
<p><em>MongoDB</em> implementa el <em>sharding</em> de forma nativa y automática (de ahí el término de <em>auto-sharding</em>), siguiendo un enfoque basado en rangos.</p>
<p>Para ello, divide una colección entre diferentes servidores, utilizando <code>mongos</code> como router de las peticiones entre los <em>sharded clusters</em>.
Esto favorece que el desarrollador ignore que la aplicación no se comunica con un único servidor, balanceando de manera automática los datos y permitiendo incrementar o reducir la capacidad del sistema a conveniencia.</p>
<div class="admonition tip">
<p class="admonition-title">Paciencia...</p>
<p>Antes de plantearse hacer <em>auto-sharding</em> sobre nuestros datos, es conveniente dominar cómo se trabaja con <em>MongoDB</em> y el uso de conjuntos de réplica.</p>
</div>
<h3 id="sharded-cluster">Sharded Cluster<a class="headerlink" href="#sharded-cluster" title="Permanent link">&para;</a></h3>
<p>El particionado de MongoDB permite crear un cluster de muchas máquinas, dividiendo a nivel de colección y poniendo un subconjunto de los datos de la colección en cada uno de los fragmentos.</p>
<p>Los componentes de un <em>sharded cluster</em> son:</p>
<ul>
<li><strong><em>Shards</em></strong> (Fragmentos): Cada una de las máquinas del cluster, que almacena un subconjunto de los datos de la colección. Cada <em>shard</em> es una instancia de <em>mongod</em> o un conjunto de réplicas. En un entorno de producción, todos los <em>shards</em> son conjuntos de réplica.</li>
<li>
<p><strong>Servidores de Configuración</strong>: Cada servidor de configuración es una instancia de <code>mongod</code> que almacena metadatos sobre el cluster. Los metadatos mapean los trozos con los shards, definiendo qué rangos de datos definen un trozo (<em>chunk</em>) de la colección, y qué trozos se encuentran en un determinado <em>shard</em>.<br />
    En entornos de producción se aconseja tener 3 servidores de configuración (uno primario y dos secundarios) ya que si sólo tuviésemos uno, al producirse una caída el cluster quedaría inaccesible.</p>
</li>
<li>
<p><strong>Enrutadores</strong>: Cada router es una instancia <code>mongos</code> que enruta las lecturas y escrituras de las aplicaciones a los <em>shards</em>. Las aplicaciones no acceden directamente a los <em>shards</em>, sino al router. Estos enrutadores funcionan de manera similar a una tabla de contenidos, indicándonos dónde se encuentran los datos. Una vez recopilados los datos de los diferentes <em>shards</em>, se fusionan y se encarga de devolverlos a la aplicación.</p>
<p>En entornos de producción es común tener varios routers para balancear la carga de los clientes.</p>
</li>
</ul>
<figure style="align: center;">
    <img src="images/06sharded-cluster.png">
    <figcaption>Componentes de un Sharded cluster</figcaption>
</figure>

<div class="admonition question">
<p class="admonition-title">Autoevaluación</p>
<p>Supongamos que queremos ejecutar múltiples routers <code>mongos</code> para soportar la redundancia. ¿Qué elemento asegurará la tolerancia a fallos y cambiará de un <code>mongos</code> a otro dentro de tu aplicación? <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
<ul>
<li><code>mongod</code></li>
<li><code>mongos</code></li>
<li>Driver</li>
<li>Los servidores de configuración de <em>sharding</em></li>
</ul>
</div>
<h3 id="shard-key">Shard key<a class="headerlink" href="#shard-key" title="Permanent link">&para;</a></h3>
<p>Para que <em>MongoDB</em> sepa cómo dividir una colección entre rangos no solapados hay que elegir una <a href="https://www.mongodb.com/docs/manual/core/sharding-shard-key/"><em>shard key</em></a>, normalmente el identificador del documento, por ejemplo, <code>student_id</code>. Este identificador (o su <em>hash</em>) es la clave del <em>chunk</em> (por lo hace la misma función que una clave primaria).</p>
<p>La <em>shard key</em> puede ser un campo sencillo o compuesto el cual debe estar indexado, y que va a determinar la distribución de los documentos entre los fragmentos del clúster.</p>
<figure style="align: center;">
    <img src="images/06shard-key.avif">
    <figcaption>Fragmentación por la shard-key</figcaption>
</figure>

<p>Para las búsquedas, borrados y actualizaciones, al emplear la <em>shard key</em>, <code>mongos</code> sabe a que <em>shard</em> enviar la petición. En cambio, si la operación no la indica, se hará un <em>broadcast</em> a todas los <em>shards</em> para averiguar donde se encuentra.</p>
<p>Entre los aspectos a tener en cuenta a la hora de <a href="https://www.mongodb.com/docs/manual/core/sharding-choose-a-shard-key">elegir una <em>shard key</em></a> cabe destacar que debe:</p>
<ul>
<li>Tener una alta cardinalidad, para asegurar que los documentos puedan dividirse en los distintos fragmentos. Por ejemplo, si elegimos un <em>shard key</em> que solo tiene 3 valores posibles y tenemos 5 fragmentos, <em>MongoDB</em> no sabrá como separar los documentos en los 5 fragmentos. Cuantos más valores posibles pueda tener la clave de fragmentación, más eficiente será la división de los trozos entre los fragmentos disponibles.</li>
<li>Tener un alto nivel de aleatoriedad. Si utilizamos una clave que siga un patrón incremental como una fecha o un ID, conllevará que al insertar documentos, el mismo fragmento estará siendo utilizando constantemente durante el rango de valores definido para él. Esto provoca que los datos estén separados de una manera óptima, pero pondrá siempre bajo estrés a un fragmento en períodos de tiempo mientras que los otros posiblemente queden con muy poca actividad (comportamiento conocido como <em>hotspotting</em>).<br />
    Una solución a las claves que siguen patrones incrementales es aplicar una función <em>hash</em> y crear una clave <em>hasheada</em> que si tiene un alto nivel de aleatoriedad.</li>
<li>Considerar los patrones de las consultas, ya que si elegimos una buena clave, al realizar consultas por la clave, todos los datos se encontrarán en el mismo fragmento.</li>
</ul>
<h3 id="particionado-con-docker">Particionado con Docker<a class="headerlink" href="#particionado-con-docker" title="Permanent link">&para;</a></h3>
<p>Para este caso, vamos a crear dos conjuntos de réplicas de dos nodos cada una, y a su vez, particionaremos los datos en dos <em>shards</em>.</p>
<p>Además, vamos a añadir un único router y un servidor de configuración (aunque lo ideal sería crear un conjunto de réplicas de servidores de configuración).</p>
<p>Así pues, crearemos:</p>
<ul>
<li>un contenedor para el router (<code>router1</code>) el cual ejecuta el servicio <code>mongos</code> y que va a conectar con el servidor de configuración.</li>
<li>un contenedor para el servidor de configuración (<code>configsvr1</code>) indicándole mediante el parámetro <code>--configsvr</code> su propósito, así como la réplica a la que pertenece (todo servidor de configuración debe pertenecer a una réplica, aunque en nuestro caso sólo hemos creado uno)</li>
<li>dos nodos (<code>mongo-shard1a</code> y <code>mongo-shard1b</code>) para el primer shard (parámetro <code>--shardsvr</code>) que pertenecen al conjunto de réplicas <code>iabdshard1</code>.</li>
<li>dos nodos más (<code>mongo-shard2a</code> y <code>mongo-shard2b</code>) para el segundo shard (parámetro <code>--shardsvr</code>) que pertenecen al conjunto de réplicas <code>iabdshard2</code>.</li>
</ul>
<p>Para ello, hemos definido el archivo <a href="resources/docker-compose-replicaset-sharded.yml">docker-compose-replicaset-sharded.yml</a> con la definición de los contenedores:</p>
<div class="highlight"><span class="filename">docker-compose-replicaset-sharded.yml</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nt">services</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nt">router1</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">router1</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./router-init.js:/scripts/router-init.js</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network-sharded</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27117:27017</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongos&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--port&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--configdb&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;rs-config-server/configsvr1:27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
</span><span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="nt">configsvr1</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configsvr1</span><span class="w"> </span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./configserver-init.js:/scripts/configserver-init.js</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network-sharded</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27118:27017</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="23 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--port&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--configsvr&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;rs-config-server&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
</span><span class="linenos" data-linenos="24 "></span><span class="w">    </span><span class="nt">links</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-shard1a</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-shard2a</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span>
<span class="linenos" data-linenos="28 "></span><span class="w">  </span><span class="nt">mongo-shard1a</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-shard1a</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./shard1-init.js:/scripts/shard1-init.js</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network-sharded</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27119:27017</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="37 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--port&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--shardsvr&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;iabdshard1&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
</span><span class="linenos" data-linenos="38 "></span>
<span class="linenos" data-linenos="39 "></span><span class="w">  </span><span class="nt">mongo-shard1b</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="40 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-shard1b</span><span class="w"></span>
<span class="linenos" data-linenos="41 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos="42 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="43 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network-sharded</span><span class="w"></span>
<span class="linenos" data-linenos="44 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="45 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27120:27017</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="46 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--port&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--shardsvr&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;iabdshard1&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
</span><span class="linenos" data-linenos="47 "></span>
<span class="linenos" data-linenos="48 "></span><span class="w">  </span><span class="nt">mongo-shard2a</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="49 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-shard2a</span><span class="w"></span>
<span class="linenos" data-linenos="50 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos="51 "></span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="52 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./shard2-init.js:/scripts/shard2-init.js</span><span class="w"></span>
<span class="linenos" data-linenos="53 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="54 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network-sharded</span><span class="w"></span>
<span class="linenos" data-linenos="55 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="56 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27121:27017</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="57 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--port&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--shardsvr&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;iabdshard2&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
</span><span class="linenos" data-linenos="58 "></span>
<span class="linenos" data-linenos="59 "></span><span class="w">  </span><span class="nt">mongo-shard2b</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="60 "></span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-shard2b</span><span class="w"></span>
<span class="linenos" data-linenos="61 "></span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span><span class="w"></span>
<span class="linenos" data-linenos="62 "></span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="63 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-network-sharded</span><span class="w"></span>
<span class="linenos" data-linenos="64 "></span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="65 "></span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27122:27017</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="66 "></span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/usr/bin/mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--port&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--shardsvr&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;iabdshard2&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
</span><span class="linenos" data-linenos="67 "></span>
<span class="linenos" data-linenos="68 "></span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="69 "></span><span class="w">  </span><span class="nt">mongo-network-sharded</span><span class="p">:</span><span class="w"></span>
<span class="linenos" data-linenos="70 "></span><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span><span class="w"></span>
</code></pre></div>
<p>Y lanzamos los contenedores mediante <em>docker-compose</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker-compose --file docker-compose-replicaset-sharded.yml --project-name iabd-mongodb-replica-sharded up -d
</code></pre></div>
<h4 id="inicializar-los-servidores-de-configuracion">Inicializar los servidores de configuración<a class="headerlink" href="#inicializar-los-servidores-de-configuracion" title="Permanent link">&para;</a></h4>
<p>El primer paso es inicializar los servidores de configuración mediante el script <a href="resources/configserver-init.js"><code>configserver-init.js</code></a>:</p>
<div class="highlight"><span class="filename">configserver-init.js</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">initiate</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;rs-config-server&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">configsvr</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">members</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;configsvr1:27017&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
</code></pre></div>
<p>Y lo lanzamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker <span class="nb">exec</span> configsvr1 sh -c <span class="s2">&quot;mongosh &lt; /scripts/configserver-init.js&quot;</span>
</code></pre></div>
<h4 id="configurar-el-conjunto-de-replicas">Configurar el conjunto de réplicas<a class="headerlink" href="#configurar-el-conjunto-de-replicas" title="Permanent link">&para;</a></h4>
<p>Para cada uno de los conjuntos de réplicas (<code>iabdshard1</code> y <code>iabdshard2</code>) que van a contener los datos, hemos de configurar sus nodos, haciendo uso de los scripts <a href="resources/shard1-init.js"><code>shard1-init.js</code></a> y <a href="resources/shard2-init.js"><code>shard2-init.js</code></a>:</p>
<div class="highlight"><span class="filename">shard1-init.js</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">initiate</span><span class="p">(</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">     </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;iabdshard1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">     </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">     </span><span class="nx">members</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongo-shard1a:27017&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongo-shard1b:27017&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">     </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><span class="filename">shard2-init.js</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">initiate</span><span class="p">(</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">     </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;iabdshard2&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">     </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">     </span><span class="nx">members</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongo-shard2a:27017&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongo-shard2b:27017&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">     </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>E inicializamos los conjunto de réplicas:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker <span class="nb">exec</span> mongo-shard1a sh -c <span class="s2">&quot;mongosh &lt; /scripts/shard1-init.js&quot;</span>
<span class="linenos" data-linenos="2 "></span>docker <span class="nb">exec</span> mongo-shard2a sh -c <span class="s2">&quot;mongosh &lt; /scripts/shard2-init.js&quot;</span>
</code></pre></div>
<h4 id="configurar-el-router">Configurar el router<a class="headerlink" href="#configurar-el-router" title="Permanent link">&para;</a></h4>
<p>Finalmente, configuramos el <em>router</em> a partir del <em>script</em> <a href="resources/router-init.js"><code>router-init.js</code></a> donde estamos indicándole al <em>router</em> qué nodos forman parte del particionado:</p>
<div class="highlight"><span class="filename">router-init.js</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShard</span><span class="p">(</span><span class="s2">&quot;iabdshard1/mongo-shard1a:27017&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShard</span><span class="p">(</span><span class="s2">&quot;iabdshard1/mongo-shard1b:27017&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShard</span><span class="p">(</span><span class="s2">&quot;iabdshard2/mongo-shard2a:27017&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShard</span><span class="p">(</span><span class="s2">&quot;iabdshard2/mongo-shard2b:27017&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Y lo ejecutamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker <span class="nb">exec</span> router1 sh -c <span class="s2">&quot;mongosh &lt; /scripts/router-init.js&quot;</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">sh</p>
<p>De manera similar que hemos visto que con el conjunto de réplicas se emplean el prefijo <code>rs</code>, para interactuar con los componentes implicados en el sharding se emplea <code>sh</code>, pero únicamente desde el nodo que hace de <em>router</em>.
Por ejemplo, mediante <code>sh.help()</code> obtendremos la ayuda de los métodos disponibles.</p>
</div>
<h3 id="conexion-al-router">Conexión al router<a class="headerlink" href="#conexion-al-router" title="Permanent link">&para;</a></h3>
<p>El router es un nodo de <em>MongoDB</em> que se va a encargar de aceptar las peticiones de los clientes y enrutarlas al <em>shard</em> adecuado. Para ello, podemos:</p>
<ul>
<li>
<p>Conectarnos al contenedor y abrimos un terminal y veremos como en el <em>prompt</em> aparece <code>mongos</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker <span class="nb">exec</span> -it router1 bash
<span class="linenos" data-linenos="2 "></span>mongosh
<span class="linenos" data-linenos="3 "></span><span class="o">[</span>direct: mongos<span class="o">]</span> test&gt; 
</code></pre></div>
</li>
<li>
<p>O abrir directamente un sesión al puerto 27117, que es donde habíamos colocado nuestro router:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>mongosh <span class="m">127</span>.0.0.1:27117
<span class="linenos" data-linenos="2 "></span><span class="o">[</span>direct: mongos<span class="o">]</span> test&gt;
</code></pre></div>
</li>
</ul>
<p>Si comprobamos el estado del <em>shard</em> veremos que tenemos dos <em>shards</em>, cada uno replicado en dos nodos, con sus identificadores y <em>hosts</em>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">test</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="nx">shardingVersion</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="nx">minCompatibleVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="nx">currentVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">6</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="nx">clusterId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;6363af7bfab6e20f2a7c1409&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">---</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="nx">shards</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1/mongo-shard1a:27017,mongo-shard1b:27017&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nx">topologyTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1667477424</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">6</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard2&#39;</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="20 "></span><span class="w">    </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard2/mongo-shard2a:27017,mongo-shard2b:27017&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">    </span><span class="nx">topologyTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1667477424</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">12</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="p">...</span><span class="w"></span>
</code></pre></div>
<p>En un entorno de producción, en vez de tener dos <em>shards</em> en dos nodos, habrá un conjunto de réplicas para asegurar la alta disponibilidad. Además, tendremos tres servidores de configuración para asegurar la disponibilidad de éstos. Del mismo modo, habrá tantos procesos <code>mongos</code> creados como conexiones de clientes:</p>
<figure style="align: center;">
    <img src="images/06sharding-production.png">
    <figcaption>Sharding en un entorno de Producción</figcaption>
</figure>

<h3 id="habilitando-el-sharding">Habilitando el Sharding<a class="headerlink" href="#habilitando-el-sharding" title="Permanent link">&para;</a></h3>
<p>Una vez hemos creado la estructura necesaria para soportar el particionado vamos a insertar un conjunto de datos para posteriormente particionarlos.</p>
<p>Para ello, vamos a insertar diez mil usuarios en una colección:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">test</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">iabd</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="nx">switched</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="nx">iabd</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="o">=</span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">&lt;</span><span class="mf">10000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="s2">&quot;login&quot;</span><span class="o">:</span><span class="s2">&quot;usuario&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;nombre&quot;</span><span class="o">:</span><span class="s2">&quot;nombre&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="o">*</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fcreacion&quot;</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()},</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">writeConcern</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">w</span><span class="o">:</span><span class="s2">&quot;0&quot;</span><span class="p">}});</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Una vez creados, comprobamos que se han insertado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="mf">10000</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">findOne</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;6363edb79f30da8391b700c4&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="w">  </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usuario0&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="7 "></span><span class="w">  </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;nombre0&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="8 "></span><span class="w">  </span><span class="nx">fcreacion</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-11-03T16:35:03.184Z&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="9 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Como podemos observar, interactuar con <code>mongos</code> es igual a hacerlo con <code>mongosh</code>.</p>
<p>Ahora mismo no sabemos en cuál de los dos <em>shards</em> se han almacenado los datos. Además, estos datos no están particionados, es decir residen en sólo uno de los shards.</p>
<p>Para habilitar el <em>sharding</em> a nivel de base de datos y que los datos se repartan entre los fragmentos disponibles, ejecutaremos el comando <a href="https://www.mongodb.com/docs/manual/reference/method/sh.enableSharding/"><code>sh.enableSharding(&lt;nombreDB&gt;)</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sh</span><span class="p">.</span><span class="nx">enableSharding</span><span class="p">(</span><span class="s2">&quot;iabd&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="s1">&#39;$clusterTime&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nx">clusterTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1667493383</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="nx">Binary</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;0000000000000000000000000000000000000000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hex&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">      </span><span class="nx">keyId</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="nx">operationTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1667480498</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Si volvemos a comprobar el estado del <em>shard</em>, tenemos que se ha creado la nueva base de datos y nos indica cual es su fragmento primario.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">...</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="o">---</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="nx">databases</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="nx">database</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">primary</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">partitioned</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nx">collections</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">      </span><span class="s1">&#39;config.system.sessions&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">        </span><span class="nx">shardKey</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">        </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">        </span><span class="nx">balancing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">        </span><span class="nx">chunkMetadata</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">shard</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">nChunks</span><span class="o">:</span><span class="w"> </span><span class="mf">512</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">shard</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">nChunks</span><span class="o">:</span><span class="w"> </span><span class="mf">512</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">        </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">          </span><span class="s1">&#39;too many chunks to print, use verbose if you want to force print&#39;</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">        </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">    </span><span class="nx">database</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="26 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabd&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="27 "></span><span class="w">      </span><span class="nx">primary</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="28 "></span><span class="w">      </span><span class="nx">partitioned</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">        </span><span class="nx">uuid</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">UUID</span><span class="p">(</span><span class="s2">&quot;84bce0ad-38a4-4b72-a377-350272542657&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1667493302</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">        </span><span class="nx">lastMod</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">    </span><span class="nx">collections</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="37 "></span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>Antes de habilitar el <em>sharding</em> para una determinada colección, tenemos que crear un índice sobre la <em>shard key</em> (si la colección estuviera vacía, no necesitamos crear el índice, ya que al indicar la <em>shard key</em>, <em>MongoDB</em> automáticamente creará el índice por nosotros):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;login&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span><span class="w"></span>
</code></pre></div>
<p>Una vez habilitado el <em>shard</em> ya podemos fragmentar la colección:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="s2">&quot;iabd.usuarios&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">},</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>El método <a href="https://www.mongodb.com/docs/manual/reference/method/sh.shardCollection/">shardCollection</a> particiona una colección a partir de una <em>shard key</em>, ya sea mediante claves <em>hashes</em> o utilizando rangos. En nuestro caso, al indicarle <code>{"login": "hashed"}</code> particionará los datos repartiéndolos de manera equitativa entre los fragmentos.</p>
<p>Para ello, recibe tres parámetros:</p>
<ul>
<li>nombre de la colección, con nomenclatura de <code>nombreBD.nombreColección</code></li>
<li>nombre del campo para fragmentar la colección, es decir, el <em>shard key</em>. Uno de los requisitos es que esta clave tenga una alta cardinalidad. Si quisiéramos indicar que queremos utilizar una clave <em>hasheada</em>, lo haríamos indicando como valor <code>hashed</code>, por ejemplo, <code>{"login": "hashed"}</code>. Si queremos utilizar rangos, lo indicamos con valor <code>1</code>, por ejemplo, <code>{"login": 1}</code>.</li>
<li><em>booleano</em> que indica si el valor utilizado como <em>shard key</em> es único. Para ello, el índice que se crea sobre el campo debe ser del tipo <em>unique</em>.</li>
</ul>
<p>Este comando divide la colección en fragmentos (<em>chunks</em>), la cual es la unidad que utiliza <em>MongoDB</em> para mover los datos. Una vez que se ha ejecutado, <em>MongoDB</em> comenzará a balancear la colección entre los <em>shards</em> del cluster. Este proceso no es instantáneo. Si la colección contiene un gran conjunto de datos puede llevar horas completar el balanceo.</p>
<p>Si ahora volvemos a comprobar el estado del <em>shard</em> obtendremos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">...</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="nx">databases</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nx">database</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">primary</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">partitioned</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nx">database</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabd&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">      </span><span class="nx">primary</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">      </span><span class="nx">partitioned</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">        </span><span class="nx">uuid</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">UUID</span><span class="p">(</span><span class="s2">&quot;9e694228-600c-4a50-b11c-174f846a3c64&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1667489404</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">        </span><span class="nx">lastMod</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">    </span><span class="nx">collections</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">      </span><span class="s1">&#39;iabd.usuarios&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">        </span><span class="nx">shardKey</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;hashed&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// (1)!</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">        </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">        </span><span class="nx">balancing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">        </span><span class="nx">chunkMetadata</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">shard</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">nChunks</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">        </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w">               </span><span class="c1">// (2)!</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// (3)!</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">            </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">            </span><span class="s1">&#39;on shard&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">            </span><span class="s1">&#39;last modified&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">        </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Muestra que la <em>shard key</em> se basa en rangos</li>
<li>la propiedad <code>chunks</code> muestra la cantidad de trozos que alberga cada partición. Así, pues en este momento tenemos un único <em>chunk</em></li>
<li>Para cada uno de los fragmentos se muestra el rango de valores que alberga cada chunk, así como en que <em>shard</em> se ubica. Las funciones <code>MinKey()</code> y <code>MinKey()</code> son similares a menos infinito y más infinito, es decir, no hay ningún valor por debajo ni por encima de ellos. Es decir, indican los topes de la colección.</li>
</ol>
<h3 id="trabajando-con-particiones">Trabajando con particiones<a class="headerlink" href="#trabajando-con-particiones" title="Permanent link">&para;</a></h3>
<p>En este momento, el <em>shard</em> está creado pero todos los nodos residen en un único fragmento dentro de una partición. Para obtener esta información, podemos ver el estado del <em>sharding</em> o consultar la distribución de una colección mediante el método <a href="https://www.mongodb.com/docs/manual/reference/method/db.collection.getShardDistribution/"><code>getShardDistribution</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">getShardDistribution</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="nx">Shard</span><span class="w"> </span><span class="nx">iabdshard1</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">iabdshard1</span><span class="o">/</span><span class="nx">mongo</span><span class="o">-</span><span class="nx">shard1a</span><span class="o">:</span><span class="mf">27017</span><span class="p">,</span><span class="nx">mongo</span><span class="o">-</span><span class="nx">shard1b</span><span class="o">:</span><span class="mf">27017</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;852KiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="s1">&#39;estimated data per chunk&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;852KiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="s1">&#39;estimated docs per chunk&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="o">---</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="nx">Totals</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;852KiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="s1">&#39;Shard iabdshard1&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="s1">&#39;100 % data&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="s1">&#39;100 % docs in cluster&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="s1">&#39;87B avg obj size on shard&#39;</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Vamos a volver a insertar 10.000 usuarios más a ver qué sucede:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="o">=</span><span class="mf">10000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">&lt;</span><span class="mf">20000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="s2">&quot;login&quot;</span><span class="o">:</span><span class="s2">&quot;usuario&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;nombre&quot;</span><span class="o">:</span><span class="s2">&quot;nombre&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="o">*</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fcreacion&quot;</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()},</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">writeConcern</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">w</span><span class="o">:</span><span class="s2">&quot;0&quot;</span><span class="p">}});</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="mf">20000</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Forzando el <em>split</em></p>
<p>Si al insertar más datos no se reparten los datos de forma automática, podemos forzarlo mediante las operaciones <a href="https://www.mongodb.com/docs/manual/reference/method/sh.splitAt"><code>sh.splitAt</code></a>, donde le indicamos el valor donde el fragmento en dos, y <a href="https://www.mongodb.com/docs/manual/reference/method/sh.splitFind"><code>sh.splitFind</code></a> que realiza la división por la mediana, de manera que ambos fragmentos deberían ser semejantes.</p>
<p>Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">splitFind</span><span class="p">(</span><span class="s2">&quot;iabd.usuarios&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="o">:</span><span class="mf">1</span><span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p>Si ahora comprobamos el estado del <em>shard</em>, los datos se deberían haber repartido entre los <em>shards</em> disponibles:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">mongos</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nx">collections</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">      </span><span class="s1">&#39;iabd.usuarios&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="nx">shardKey</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="nx">balancing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="nx">chunkMetadata</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="10 "></span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">shard</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">nChunks</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="11 "></span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">shard</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">nChunks</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos="12 "></span><span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">        </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="14 "></span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usuario18999&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;on shard&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;last modified&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="15 "></span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usuario18999&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="nx">MaxKey</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;on shard&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iabdshard1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;last modified&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">        </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>Si volvemos a comprobar la distribución, ahora vemos como ha repartido los documentos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span><span class="nx">direct</span><span class="o">:</span><span class="w"> </span><span class="nx">mongos</span><span class="p">]</span><span class="w"> </span><span class="nx">iabd</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">getShardDistribution</span><span class="p">()</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 2 "></span><span class="nx">Shard</span><span class="w"> </span><span class="nx">iabdshard1</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">iabdshard1</span><span class="o">/</span><span class="nx">mongo</span><span class="o">-</span><span class="nx">shard1a</span><span class="o">:</span><span class="mf">27017</span><span class="p">,</span><span class="nx">mongo</span><span class="o">-</span><span class="nx">shard1b</span><span class="o">:</span><span class="mf">27017</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 3 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1.68MiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="mf">20000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="s1">&#39;estimated data per chunk&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1.68MiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="s1">&#39;estimated docs per chunk&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">20000</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="o">---</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="11 "></span><span class="nx">Shard</span><span class="w"> </span><span class="nx">iabdshard2</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">iabdshard2</span><span class="o">/</span><span class="nx">mongo</span><span class="o">-</span><span class="nx">shard2a</span><span class="o">:</span><span class="mf">27017</span><span class="p">,</span><span class="nx">mongo</span><span class="o">-</span><span class="nx">shard2b</span><span class="o">:</span><span class="mf">27017</span><span class="w"></span>
</span><span class="linenos" data-linenos="12 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;866KiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="s1">&#39;estimated data per chunk&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;866KiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="s1">&#39;estimated docs per chunk&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="o">---</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="nx">Totals</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2.52MiB&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">  </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="mf">30000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">  </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">  </span><span class="s1">&#39;Shard iabdshard1&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">    </span><span class="s1">&#39;66.51 % data&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">    </span><span class="s1">&#39;66.66 % docs in cluster&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">    </span><span class="s1">&#39;88B avg obj size on shard&#39;</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">  </span><span class="s1">&#39;Shard iabdshard2&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">    </span><span class="s1">&#39;33.48 % data&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">    </span><span class="s1">&#39;33.33 % docs in cluster&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">    </span><span class="s1">&#39;88B avg obj size on shard&#39;</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.mongodb.com/basics/replication">Replicación en MongoDB</a></li>
<li><a href="https://www.mongodb.com/basics/sharding">Particionado en MongoDB</a></li>
<li><a href="https://blog.devgenius.io/how-to-deploy-a-mongodb-replicaset-using-docker-compose-a538100db471">How to deploy a MongoDB replica set using docker-compose</a></li>
<li><a href="https://github.com/minhhungit/mongodb-cluster-docker-compose">Demo MongoDB (6.0.1) Sharded Cluster with Docker Compose</a></li>
<li>Ejemplos de código sobre <a href="https://www.mongodb.com/developer/products/mongodb/cheat-sheet/#replica-set">replicación</a> y <a href="https://www.mongodb.com/developer/products/mongodb/cheat-sheet/#sharded-cluster">particionado</a>.</li>
</ul>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>(<abbr title="Gestiona sistemas de almacenamiento y el amplio ecosistema alrededor de ellos facilitando el procesamiento de grandes cantidades de datos sin fallos y de forma rápida.">RA5075.2</abbr> / <abbr title="Se ha comprobado el poder de procesamiento de su modelo de computación distribuida.">CE5.2b</abbr>, <abbr title="Se ha probado la tolerancia a fallos de los sistemas.">CE5.2c</abbr> / 2p) Se pide crear una conjunto de 4 réplicas de nombre <code>iabdrs4</code> en la cual insertaremos los datos de <a href="resources/1000cities.json">1000 ciudades</a>, los cuales deberás <a href="02mongo.html#mongodb-database-tools">importar a una base de datos</a>.</p>
<p>Una vez creado, se pide:</p>
<ol>
<li>Obtener el estado del conjunto de réplicas</li>
<li>Consultar una ciudad en un nodo secundario.</li>
<li>Habilitar las lecturas en los nodos secundarios.</li>
<li>Volver a consultar la ciudad en el nodo secundario.</li>
<li>Insertar una ciudad en el nodo secundario.</li>
<li>Degradar el nodo primario</li>
<li>Averiguar cual es el nuevo nodo primario.</li>
</ol>
<p>Adjunta un documento con los scripts de creación, comandos empleados y las salidas generadas.</p>
</li>
<li>
<p>(<abbr title="Gestiona sistemas de almacenamiento y el amplio ecosistema alrededor de ellos facilitando el procesamiento de grandes cantidades de datos sin fallos y de forma rápida.">RA5075.2</abbr> / <abbr title="Se ha comprobado el poder de procesamiento de su modelo de computación distribuida.">CE5.2b</abbr> / 2p) Se pide crear un clúster de MongoDB con tres nodos y tres particiones y volver a importar las <a href="resources/1000cities.json">1000 ciudades</a>.</p>
<p>Una vez creado, se pide:</p>
<ol>
<li>Particionar los datos por el nombre de la ciudad.</li>
<li>Una vez cargado los datos, obtener el estado del <em>sharding</em>.</li>
<li>Si los datos no están particionados, forzar el <em>split</em> de los mismos.</li>
<li>Tras ello, vaciar la colección y volver a importar los datos. Una vez importados, obtener de nuevo el estado del sharding.</li>
</ol>
<p>Adjunta un documento con los scripts de creación, los comandos empleados y las salidas generadas.</p>
</li>
</ol>
<!--
https://www.mongodb.com/developer/products/mongodb/cheat-sheet/#sharded-cluster

FIXME: revisar métodos splitAt, splitFind... rangos con tag, zonas, etc..
-->

<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>El driver se encarga de manera transparente de conectar al router adecuado, y cambiar un router por otro si al que estamos conectado se cae&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        ¿Ha sido útil está página?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Sí, ha sido util" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="La página es mejorable" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
                Gracias por tu colaboración!
              
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
                Gracias por tu colaboración! Ayúdame a mejorarla enviandome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
              
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Pie" >
      
        
        <a href="05agregaciones.html" class="md-footer__link md-footer__link--prev" aria-label="Anterior: S25.- Agregaciones" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              S25.- Agregaciones
            </div>
          </div>
        </a>
      
      
        
        <a href="07pymongo.html" class="md-footer__link md-footer__link--next" aria-label="Siguiente: S30.- MongoDB y Python" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              S30.- MongoDB y Python
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  


<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        <label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);console.log(new FormData(form)),__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
    
  </body>
</html>