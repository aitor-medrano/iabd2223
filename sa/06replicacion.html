
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Replicación y particionado (sharding) en MongoDB.">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/sa/06replicacion.html">
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.6">
    
    
      
        <title>Replicación y particionado (sharding) en MongoDB. - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Replicación y particionado (sharding) en MongoDB. - Inteligencia Artificial y Big Data" >
      
        <meta  property="og:description"  content="Replicación y particionado (sharding) en MongoDB." >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/06replicacion.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/sa/06replicacion.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Replicación y particionado (sharding) en MongoDB. - Inteligencia Artificial y Big Data" >
      
        <meta  name="twitter:description"  content="Replicación y particionado (sharding) en MongoDB." >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/06replicacion.png" >
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#replicacion" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Replicación y particionado (sharding) en MongoDB.
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          UF1 - Toma de decisiones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="UF1 - Toma de decisiones" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          UF1 - Toma de decisiones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">UT2.- Sistemas de almacenamiento</a>
          
            <label for="__nav_2_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT2.- Sistemas de almacenamiento" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          UT2.- Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01nosql.html" class="md-nav__link">
        S18.- Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02mongo.html" class="md-nav__link">
        S19.- MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="03modelado.html" class="md-nav__link">
        S21.- Modelado de datos NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="04formatos.html" class="md-nav__link">
        S21.- Formatos de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="05agregaciones.html" class="md-nav__link">
        S26.- Agregaciones
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        UT7.- PIAFP Lara
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#replicacion" class="md-nav__link">
    Replicación
  </a>
  
    <nav class="md-nav" aria-label="Replicación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conjunto-de-replicas" class="md-nav__link">
    Conjunto de réplicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-en-la-escritura" class="md-nav__link">
    Consistencia en la escritura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#niveles-de-consistencia" class="md-nav__link">
    Niveles de consistencia
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#particionado-sharding" class="md-nav__link">
    Particionado (Sharding)
  </a>
  
    <nav class="md-nav" aria-label="Particionado (Sharding)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#particionando-con-mongodb" class="md-nav__link">
    Particionando con MongoDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparando-el-sharding-con-mongodb" class="md-nav__link">
    Preparando el Sharding con MongoDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trabajando-con-el-sharding" class="md-nav__link">
    Trabajando con el Sharding
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Replicación y particionado (sharding) en MongoDB.</h1>

<h2 id="replicacion">Replicación<a class="headerlink" href="#replicacion" title="Permanent link">&para;</a></h2>
<p>https://www.mongodb.com/basics/replication</p>
<p>Un aspecto muy importante de MongoDB es que soporta la replicación de los datos de forma nativa mediante el uso de conjuntos de réplicas.</p>
<h3 id="conjunto-de-replicas">Conjunto de réplicas<a class="headerlink" href="#conjunto-de-replicas" title="Permanent link">&para;</a></h3>
<p>En MongoDB se replican los datos mediante un conjunto de réplicas  (<em>Replica Set</em>), el cual es un grupo de servidores (nodos <em>mongod</em>) donde uno de ellos ejerce la función de primario y por tanto recibe las peticiones de los clientes, y el resto de servidores hace de secundarios, manteniendo copias de los datos del primario.</p>
<figure style="align: center;">
    <img src="images/06replication.png">
    <figcaption>Conjunto de Réplicas en MongoDB</figcaption>
</figure>

<p>Si el nodo primario se cae, los secundarios eligen un nuevo primario entre ellos mismos, en un proceso que se conoce como votación. La aplicación se conectará al nuevo primario de manera transparente. Cuando el antiguo nodo primario vuelva en sí, será un nuevo nodo secundario.</p>
<p>Al usar replicación, si un servidor se cae, siempre vamos a poder obtener los datos a partir de otros servidores del conjunto. Si los datos de un servidor se dañan o son inaccesibles, podemos crear una nueva copia desde uno de los miembros del conjunto.</p>
<h4 id="elementos-de-un-conjunto-de-replicas">Elementos de un conjunto de réplicas<a class="headerlink" href="#elementos-de-un-conjunto-de-replicas" title="Permanent link">&para;</a></h4>
<p>Los tipos de nodos que podemos encontrar en un conjunto de réplica son:</p>
<ul>
<li>Regular: Es el tipo de nodo más común.</li>
<li>Primario: Acepta todas las operaciones de escritura de los clientes. Cada conjunto de réplicas tendrá sólo un primario, y como sólo un miembro acepta operaciones de escritura, ofrece consistencia estricta para todas las lecturas realizadas desde él.</li>
<li>
<p>Secundario: Los secundarios replican el <em>oplog</em> primario y aplican las operaciones a sus conjuntos de datos. De este modo, los nodos secundarios son un espejo del primario. Si el primario deja de estar disponible, el conjunto de réplica elegirá a un secundario para que sea el nuevo primario, mediante un proceso de votación.</p>
<p>Por defecto, los clientes realizan las lecturas desde el nodo primario. Sin embargo, los clientes pueden indicar que quieren realizar lecturas desde los nodos secundarios.</p>
<div class="admonition danger">
<p class="admonition-title">Consistencia eventual</p>
<p>Es posible que al realizar lecturas de un nodo secundario la información que se obtenga no refleje el estado del nodo primario.</p>
</div>
</li>
<li>
<p>Árbitro: se emplea sólo para votar. No contiene copia de los datos y no se puede convertir en primario. Los conjuntos de réplica pueden tener árbitros para añadir votos en las elecciones de un nuevo primario. Siempre tienen un voto, y permiten que los conjuntos de réplica tengan un número impar de nodos, sin la necesidad de tener un miembro que replique los datos. Además, no requieren hardware dedicado.</p>
<div class="admonition important">
<p class="admonition-title">A tener en cuenta</p>
<ul>
<li>No ejecutar un árbitro en sistemas que también ejecutan los miembros primarios y secundarios del conjunto de réplicas.</li>
<li>Sólo añadir un árbitro a un conjunto con un número par de miembros.</li>
<li>Si se añade un árbitro a un conjunto con un número impar de miembros, el conjunto puede sufrir un empate.</li>
</ul>
</div>
</li>
<li>
<p>Retrasado (delayed): nodo que se emplea para la recuperación del sistema ante un fallo. Para ello, hay que asignar la propiedad <code>priority:0</code>. Este nodo nunca será un nodo primario.</p>
</li>
<li>
<p>Oculto: empleado para analíticas del sistema.</p>
</li>
</ul>
<h5 id="oplog">oplog<a class="headerlink" href="#oplog" title="Permanent link">&para;</a></h5>
<p>Para soportar la replicación, el nodo primario almacena todos los cambios en su <a href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/"><em>oplog</em></a>.</p>
<p>De manera simplificada, el <em>oplog</em> es un diario de todos los cambios que la instancia principal realiza en las bases de datos con el propósito de replicar dichos cambios en un nodo secundario para asegurar que las dos bases de datos sean idénticas.</p>
<p>El servidor principal mantiene el <em>oplog</em>, y el secundario consulta al principal por nuevas entradas que aplicar a sus propias copias de las bases de datos replicadas. Este proceso se realiza de manera asíncrona, de manera que todos los miembros del conjunto de réplicas contienen una copia del <em>oplog</em>.</p>
<p>El oplog crea un <em>timestamp</em> para cada entrada. Esto permite que un secundario controle la cantidad de información que se ha modificado desde una lectura anterior, y qué entradas necesita transferir para ponerse al día. Si paramos un secundario y lo reiniciamos más adelante, utilizará el <em>oplog</em> para obtener todos los cambios que ha perdido mientras estaba offline.</p>
<p>El <em>oplog</em> se almacena en una colección limitada (<em>capped</em>) y ordenada de un tamaño determinado. La opción <code>oplogSize</code> define en MB el tamaño del archivo. Para un sistema de 64 bits con comportamiento de lectura/escritura normales, el <code>oplogSize</code> debería ser de al menos un 5% del espacio de disco disponible. Si el sistema tiene más escrituras que lecturas, puede que necesitemos incrementar este tamaño para asegurar que cualquier nodo secundario pueda estar <em>offline</em> una cantidad de tiempo razonable sin perder información.</p>
<h4 id="creando-un-conjunto-de-replicas">Creando un conjunto de réplicas<a class="headerlink" href="#creando-un-conjunto-de-replicas" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">Replicación y particionado en MongoAtlas</p>
<p>El cluster gratuito de MongoAtlas ya ofrece replicación de los datos, pero no nos permite administrarlo, al tratarse de un clúster compartido.</p>
</div>
<p>Para poder probar tanto la replicación como el particionado, necesitamos tener control sobre los servidores. Por ello, en esta sesión vamos a utilizar <em>Docker</em> para montar la infraestructura.</p>
<p>Para ello, vamos a partir del archivo de <a href="resources/docker-compose-replicaset.yml">docker-compose-replicaset.yml</a> donde creamos tres contenedores (siendo <code>mongo1</code> el nodo principal y <code>mongo2</code> y <code>mongo3</code> los secundarios) dentro de una misma red y que pertenecen al conjunto de réplicas <code>iabdrs</code>:</p>
<div class="highlight"><span class="filename">docker-compose-replicaset.yml</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>services:
<span class="linenos" data-linenos=" 2 "></span>  mongo1:
<span class="linenos" data-linenos=" 3 "></span>    container_name: mongo1
<span class="linenos" data-linenos=" 4 "></span>    image: mongo
<span class="linenos" data-linenos=" 5 "></span>    volumes:
<span class="linenos" data-linenos=" 6 "></span>      - ./rs-init.sh:/scripts/rs-init.sh
<span class="linenos" data-linenos=" 7 "></span>      - ./init.js:/scripts/init.js
<span class="linenos" data-linenos=" 8 "></span>    networks:
<span class="linenos" data-linenos=" 9 "></span>      - mongo-network
<span class="linenos" data-linenos="10 "></span>    ports:
<span class="linenos" data-linenos="11 "></span>      - 27017:27017
<span class="linenos" data-linenos="12 "></span>    depends_on:
<span class="linenos" data-linenos="13 "></span>      - mongo2
<span class="linenos" data-linenos="14 "></span>      - mongo3
<span class="linenos" data-linenos="15 "></span>    links:
<span class="linenos" data-linenos="16 "></span>      - mongo2
<span class="linenos" data-linenos="17 "></span>      - mongo3
<span class="linenos" data-linenos="18 "></span>    restart: always
<span class="linenos" data-linenos="19 "></span>    entrypoint: [ &quot;/usr/bin/mongod&quot;, &quot;--bind_ip_all&quot;, &quot;--replSet&quot;, &quot;iabdrs&quot; ]
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span>  mongo2:
<span class="linenos" data-linenos="22 "></span>    container_name: mongo2
<span class="linenos" data-linenos="23 "></span>    image: mongo
<span class="linenos" data-linenos="24 "></span>    networks:
<span class="linenos" data-linenos="25 "></span>      - mongo-network
<span class="linenos" data-linenos="26 "></span>    ports:
<span class="linenos" data-linenos="27 "></span>      - 27018:27017
<span class="linenos" data-linenos="28 "></span>    restart: always
<span class="linenos" data-linenos="29 "></span>    entrypoint: [ &quot;/usr/bin/mongod&quot;, &quot;--bind_ip_all&quot;, &quot;--replSet&quot;, &quot;iabdrs&quot; ]
<span class="linenos" data-linenos="30 "></span>
<span class="linenos" data-linenos="31 "></span>  mongo3:
<span class="linenos" data-linenos="32 "></span>    container_name: mongo3
<span class="linenos" data-linenos="33 "></span>    image: mongo
<span class="linenos" data-linenos="34 "></span>    networks:
<span class="linenos" data-linenos="35 "></span>      - mongo-network
<span class="linenos" data-linenos="36 "></span>    ports:
<span class="linenos" data-linenos="37 "></span>      - 27019:27017
<span class="linenos" data-linenos="38 "></span>    restart: always
<span class="linenos" data-linenos="39 "></span>    entrypoint: [ &quot;/usr/bin/mongod&quot;, &quot;--bind_ip_all&quot;, &quot;--replSet&quot;, &quot;iabdrs&quot; ]
<span class="linenos" data-linenos="40 "></span>
<span class="linenos" data-linenos="41 "></span>networks:
<span class="linenos" data-linenos="42 "></span>  mongo-network:
<span class="linenos" data-linenos="43 "></span>    driver: bridge
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Despliegue</p>
<p>Normalmente, cada instancia <code>mongod</code> se coloca en un servidor físico y todos en el puerto estándar.</p>
<p>En nuestro caso, vamos a crear un conjunto de tres réplicas, y en vez de hacerlo en tres máquinas distintas, como los tres contenedores residen en la misma máquina, lo haremos en tres puertos diferentes (del 27017 al 27019)</p>
</div>
<p>El nodo principal necesita cargar un <em>script</em> para inicializarse, el cual cargamos en el volumen como <code>rs-init.sh</code>:</p>
<div class="highlight"><span class="filename">rs-init.sh</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="ch">#!/bin/bash</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="nv">DELAY</span><span class="o">=</span><span class="m">25</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span>mongosh <span class="s">&lt;&lt;EOF</span>
<span class="linenos" data-linenos=" 6 "></span><span class="s">var config = {</span>
<span class="linenos" data-linenos=" 7 "></span><span class="s">    &quot;_id&quot;: &quot;iabdrs&quot;,</span>
<span class="linenos" data-linenos=" 8 "></span><span class="s">    &quot;version&quot;: 1,</span>
<span class="linenos" data-linenos=" 9 "></span><span class="s">    &quot;members&quot;: [</span>
<span class="linenos" data-linenos="10 "></span><span class="s">        {</span>
<span class="linenos" data-linenos="11 "></span><span class="s">            &quot;_id&quot;: 1,</span>
<span class="linenos" data-linenos="12 "></span><span class="s">            &quot;host&quot;: &quot;mongo1:27017&quot;,</span>
<span class="linenos" data-linenos="13 "></span><span class="s">            &quot;priority&quot;: 2</span>
<span class="linenos" data-linenos="14 "></span><span class="s">        },</span>
<span class="linenos" data-linenos="15 "></span><span class="s">        {</span>
<span class="linenos" data-linenos="16 "></span><span class="s">            &quot;_id&quot;: 2,</span>
<span class="linenos" data-linenos="17 "></span><span class="s">            &quot;host&quot;: &quot;mongo2:27017&quot;,</span>
<span class="linenos" data-linenos="18 "></span><span class="s">            &quot;priority&quot;: 1</span>
<span class="linenos" data-linenos="19 "></span><span class="s">        },</span>
<span class="linenos" data-linenos="20 "></span><span class="s">        {</span>
<span class="linenos" data-linenos="21 "></span><span class="s">            &quot;_id&quot;: 3,</span>
<span class="linenos" data-linenos="22 "></span><span class="s">            &quot;host&quot;: &quot;mongo3:27017&quot;,</span>
<span class="linenos" data-linenos="23 "></span><span class="s">            &quot;priority&quot;: 1</span>
<span class="linenos" data-linenos="24 "></span><span class="s">        }</span>
<span class="linenos" data-linenos="25 "></span><span class="s">    ]</span>
<span class="linenos" data-linenos="26 "></span><span class="s">};</span>
<span class="linenos" data-linenos="27 "></span><span class="s">rs.initiate(config, { force: true });</span>
<span class="linenos" data-linenos="28 "></span><span class="s">EOF</span>
<span class="linenos" data-linenos="29 "></span>
<span class="linenos" data-linenos="30 "></span><span class="nb">echo</span> <span class="s2">&quot;****** Esperando </span><span class="si">${</span><span class="nv">DELAY</span><span class="si">}</span><span class="s2"> segundos a que se apliquen la configuración del conjunto de réplicas ******&quot;</span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span>sleep <span class="nv">$DELAY</span>
<span class="linenos" data-linenos="33 "></span>
<span class="linenos" data-linenos="34 "></span>mongosh &lt; /scripts/init.js
</code></pre></div>
<p>Finalmente, mediante el archivo <a href="resources/init.js"><code>init.js</code></a> comprobamos el estado de la réplica y creamos el usuario administrador:</p>
<div class="highlight"><span class="filename">rs-init.sh</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">();</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">createUser</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">pwd</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">roles</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]});</span><span class="w"></span>
</code></pre></div>
<p>Así pues, una vez tenemos los tres archivos en la misma carpeta, ya podemos lanzar <em>Docker Compose</em> para crear los contenedores:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker-compose --file docker-compose-replicaset.yml --project-name iabd-mongodb-replica up -d
</code></pre></div>
<p>Y finalmente, sólo nos queda ejecutar el <em>script</em> de inicialización sobre el nodo principal:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker <span class="nb">exec</span> mongo1 /scripts/rs-init.sh
</code></pre></div>
<p>Al ejecutarse el script, se inicializa el conjunto de replicas y se obtiene su estado (mediante <code>rs.status()</code>) el cual se muestra por consola:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="  1 "></span><span class="err">iabdrs</span><span class="w"> </span><span class="p">[</span><span class="err">direc</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">primary</span><span class="p">]</span><span class="w"> </span><span class="kc">test</span><span class="err">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="  2 "></span><span class="w">  </span><span class="err">se</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;iabdrs&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos="  3 "></span><span class="w">  </span><span class="err">da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:42.137Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  4 "></span><span class="w">  </span><span class="err">myS</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  5 "></span><span class="w">  </span><span class="kc">ter</span><span class="err">m</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  6 "></span><span class="w">  </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  7 "></span><span class="w">  </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  8 "></span><span class="w">  </span><span class="err">hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">I</span><span class="kc">nter</span><span class="err">valMillis</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;2000&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  9 "></span><span class="w">  </span><span class="err">majori</span><span class="kc">t</span><span class="err">yVo</span><span class="kc">te</span><span class="err">Cou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 10 "></span><span class="w">  </span><span class="err">wri</span><span class="kc">te</span><span class="err">Majori</span><span class="kc">t</span><span class="err">yCou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 11 "></span><span class="w">  </span><span class="err">vo</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">gMembersCou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 12 "></span><span class="w">  </span><span class="err">wri</span><span class="kc">ta</span><span class="err">bleVo</span><span class="kc">t</span><span class="err">i</span><span class="kc">n</span><span class="err">gMembersCou</span><span class="kc">nt</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 13 "></span><span class="w">  </span><span class="err">op</span><span class="kc">t</span><span class="err">imes</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 14 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Commi</span><span class="kc">tte</span><span class="err">dOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 15 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Commi</span><span class="kc">tte</span><span class="err">dWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 16 "></span><span class="w">    </span><span class="err">readCo</span><span class="kc">n</span><span class="err">cer</span><span class="kc">n</span><span class="err">Majori</span><span class="kc">t</span><span class="err">yOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 17 "></span><span class="w">    </span><span class="err">appliedOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 18 "></span><span class="w">    </span><span class="err">durableOpTime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 19 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 20 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 21 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 22 "></span><span class="w">  </span><span class="err">las</span><span class="kc">t</span><span class="err">S</span><span class="kc">ta</span><span class="err">bleRecoveryTimes</span><span class="kc">ta</span><span class="err">mp</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778030</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 23 "></span><span class="w">  </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Ca</span><span class="kc">n</span><span class="err">dida</span><span class="kc">te</span><span class="err">Me</span><span class="kc">tr</span><span class="err">ics</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 24 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Reaso</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Timeou</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 25 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:10.197Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 26 "></span><span class="w">    </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Term</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 27 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">Commi</span><span class="kc">tte</span><span class="err">dOpTimeA</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666777979</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;-1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 28 "></span><span class="w">    </span><span class="err">las</span><span class="kc">t</span><span class="err">See</span><span class="kc">n</span><span class="err">OpTimeA</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666777979</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;-1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 29 "></span><span class="w">    </span><span class="kc">nu</span><span class="err">mVo</span><span class="kc">tes</span><span class="err">Needed</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 30 "></span><span class="w">    </span><span class="err">priori</span><span class="kc">t</span><span class="err">yA</span><span class="kc">t</span><span class="err">Elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 31 "></span><span class="w">    </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Timeou</span><span class="kc">t</span><span class="err">Millis</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;10000&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 32 "></span><span class="w">    </span><span class="kc">nu</span><span class="err">mCa</span><span class="kc">t</span><span class="err">chUpOps</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 33 "></span><span class="w">    </span><span class="kc">ne</span><span class="err">wTermS</span><span class="kc">tart</span><span class="err">Da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:10.363Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 34 "></span><span class="w">    </span><span class="err">wMajori</span><span class="kc">t</span><span class="err">yWri</span><span class="kc">te</span><span class="err">Availabili</span><span class="kc">t</span><span class="err">yDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:11.139Z&quot;</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 35 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 36 "></span><span class="w">  </span><span class="err">members</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 37 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 38 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 39 "></span><span class="w">      </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">1</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 40 "></span><span class="w">      </span><span class="err">heal</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 41 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 42 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="err">S</span><span class="kc">tr</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;PRIMARY&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 43 "></span><span class="w">      </span><span class="err">up</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="mi">129</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 44 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 45 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 46 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 47 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 48 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 49 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 50 "></span><span class="w">      </span><span class="err">i</span><span class="kc">nf</span><span class="err">oMessage</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Could</span><span class="w"> </span><span class="kc">n</span><span class="err">o</span><span class="kc">t</span><span class="w"> </span><span class="kc">f</span><span class="err">i</span><span class="kc">n</span><span class="err">d</span><span class="w"> </span><span class="err">member</span><span class="w"> </span><span class="kc">t</span><span class="err">o</span><span class="w"> </span><span class="err">sy</span><span class="kc">n</span><span class="err">c</span><span class="w"> </span><span class="kc">fr</span><span class="err">om&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 51 "></span><span class="w">      </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Time</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666777990</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 52 "></span><span class="w">      </span><span class="err">elec</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Da</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:53:10.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 53 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 54 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igTerm</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 55 "></span><span class="w">      </span><span class="err">sel</span><span class="kc">f</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 56 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Message</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="w"></span>
<span class="linenos" data-linenos=" 57 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 58 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 59 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 60 "></span><span class="w">      </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">2</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 61 "></span><span class="w">      </span><span class="err">heal</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 62 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 63 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="err">S</span><span class="kc">tr</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;SECONDARY&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 64 "></span><span class="w">      </span><span class="err">up</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 65 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 66 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurable</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 67 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 68 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurableDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 69 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 70 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 71 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.322Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 72 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Recv</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:41.327Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 73 "></span><span class="w">      </span><span class="err">pi</span><span class="kc">n</span><span class="err">gMs</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 74 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Message</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 75 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">1</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 76 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 77 "></span><span class="w">      </span><span class="err">i</span><span class="kc">nf</span><span class="err">oMessage</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 78 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 79 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igTerm</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos" data-linenos=" 80 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 81 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 82 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 83 "></span><span class="w">      </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">3</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 84 "></span><span class="w">      </span><span class="err">heal</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 85 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 86 "></span><span class="w">      </span><span class="err">s</span><span class="kc">tate</span><span class="err">S</span><span class="kc">tr</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;SECONDARY&#39;</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 87 "></span><span class="w">      </span><span class="err">up</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 88 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 89 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurable</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">ts</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778070</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;1&quot;</span><span class="err">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 90 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 91 "></span><span class="w">      </span><span class="err">op</span><span class="kc">t</span><span class="err">imeDurableDa</span><span class="kc">te</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:30.000Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 92 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">AppliedWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 93 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">DurableWallTime</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.457Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 94 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:40.322Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 95 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Recv</span><span class="p">:</span><span class="w"> </span><span class="err">ISODa</span><span class="kc">te</span><span class="err">(</span><span class="s2">&quot;2022-10-26T09:54:41.326Z&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 96 "></span><span class="w">      </span><span class="err">pi</span><span class="kc">n</span><span class="err">gMs</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 97 "></span><span class="w">      </span><span class="err">las</span><span class="kc">t</span><span class="err">Hear</span><span class="kc">t</span><span class="err">bea</span><span class="kc">t</span><span class="err">Message</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 98 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceHos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;mo</span><span class="kc">n</span><span class="err">go</span><span class="mi">1</span><span class="p">:</span><span class="mi">27017</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 99 "></span><span class="w">      </span><span class="err">sy</span><span class="kc">n</span><span class="err">cSourceId</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="100 "></span><span class="w">      </span><span class="err">i</span><span class="kc">nf</span><span class="err">oMessage</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="101 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="102 "></span><span class="w">      </span><span class="err">co</span><span class="kc">nf</span><span class="err">igTerm</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos" data-linenos="103 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="104 "></span><span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="105 "></span><span class="w">  </span><span class="err">ok</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="106 "></span><span class="w">  </span><span class="err">&#39;$clus</span><span class="kc">ter</span><span class="err">Time&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="107 "></span><span class="w">    </span><span class="err">clus</span><span class="kc">ter</span><span class="err">Time</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="108 "></span><span class="w">    </span><span class="err">sig</span><span class="kc">nature</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="109 "></span><span class="w">      </span><span class="err">hash</span><span class="p">:</span><span class="w"> </span><span class="err">Bi</span><span class="kc">nar</span><span class="err">y(Bu</span><span class="kc">ffer</span><span class="err">.</span><span class="kc">fr</span><span class="err">om(</span><span class="s2">&quot;0000000000000000000000000000000000000000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hex&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="110 "></span><span class="w">      </span><span class="err">keyId</span><span class="p">:</span><span class="w"> </span><span class="err">Lo</span><span class="kc">n</span><span class="err">g(</span><span class="s2">&quot;0&quot;</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos="111 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="112 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="113 "></span><span class="w">  </span><span class="err">opera</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">Time</span><span class="p">:</span><span class="w"> </span><span class="err">Times</span><span class="kc">ta</span><span class="err">mp(</span><span class="p">{</span><span class="w"> </span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">1666778080</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="err">)</span><span class="w"></span>
<span class="linenos" data-linenos="114 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Una vez que ya hemos arrancando todo, podemos conectarnos a nuestro conjunto de réplica mediante <code>mongosh</code> (si no le pasamos ningún parámetro, se conecta automáticamente a <code>localhost</code> y al puerto 27017). Dentro del shell, los comandos que trabajan con réplicas comienzan por el prefijo <strong><code>rs</code></strong>. Por ejemplo, mediante <code>rs.help()</code> obtendremos la ayuda de los métodos disponibles:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>&gt; mongosh
<span class="linenos" data-linenos=" 2 "></span>iabdrs <span class="o">[</span>direct: primary<span class="o">]</span> test&gt; rs.help<span class="o">()</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span>  Replica Set Class:
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span>    initiate                                   Initiates the replica set.
<span class="linenos" data-linenos=" 7 "></span>    config                                     Returns a document that contains the current replica <span class="nb">set</span> configuration.
<span class="linenos" data-linenos=" 8 "></span>    conf                                       Calls replSetConfig
<span class="linenos" data-linenos=" 9 "></span>    reconfig                                   Reconfigures an existing replica set, overwriting the existing replica <span class="nb">set</span> configuration.
<span class="linenos" data-linenos="10 "></span>    reconfigForPSASet                          Reconfigures an existing replica set, overwriting the existing replica <span class="nb">set</span> configuration, <span class="k">if</span> the reconfiguration is a transition from a Primary-Arbiter to a Primary-Secondary-Arbiter set.
<span class="linenos" data-linenos="11 "></span>    status                                     Calls replSetGetStatus
<span class="linenos" data-linenos="12 "></span>    isMaster                                   Calls isMaster
<span class="linenos" data-linenos="13 "></span>    hello                                      Calls hello
<span class="linenos" data-linenos="14 "></span>    printSecondaryReplicationInfo              Calls db.printSecondaryReplicationInfo
<span class="linenos" data-linenos="15 "></span>    printSlaveReplicationInfo                  DEPRECATED. Use rs.printSecondaryReplicationInfo
<span class="linenos" data-linenos="16 "></span>    printReplicationInfo                       Calls db.printReplicationInfo
<span class="linenos" data-linenos="17 "></span>    add                                        Adds replica <span class="nb">set</span> member to replica set.
<span class="linenos" data-linenos="18 "></span>    addArb                                     Calls rs.add with <span class="nv">arbiterOnly</span><span class="o">=</span><span class="nb">true</span>
<span class="linenos" data-linenos="19 "></span>    remove                                     Removes a replica <span class="nb">set</span> member.
<span class="linenos" data-linenos="20 "></span>    freeze                                     Prevents the current member from seeking election as primary <span class="k">for</span> a period of time. Uses the replSetFreeze <span class="nb">command</span>
<span class="linenos" data-linenos="21 "></span>    stepDown                                   Causes the current primary to become a secondary which forces an election. If no stepDownSecs is provided, uses <span class="m">60</span> seconds. 
<span class="linenos" data-linenos="22 "></span>Uses the replSetStepDown <span class="nb">command</span>
<span class="linenos" data-linenos="23 "></span>    syncFrom                                   Sets the member that this replica <span class="nb">set</span> member will sync from, overriding the default sync target selection logic.
<span class="linenos" data-linenos="24 "></span>    secondaryOk                                This method is deprecated. Use db.getMongo<span class="o">()</span>.setReadPref<span class="o">()</span> instead
<span class="linenos" data-linenos="25 "></span>
<span class="linenos" data-linenos="26 "></span>  For more information on usage: https://docs.mongodb.com/manual/reference/method/js-replication/
</code></pre></div>
<p>https://blog.devgenius.io/how-to-deploy-a-mongodb-replicaset-using-docker-compose-a538100db471</p>
<p>https://github.com/minhhungit/mongodb-cluster-docker-compose</p>
<p>. Mediante,
A continuación, crearemos un documento con la configuración donde el _id tiene que ser igual al usado al crear la réplica, y el array de members contiene las replicas creadas donde los puertos han de coincidir.</p>
<p>Configurando el conjunto de réplicas</p>
<blockquote>
<p>config = { _id: "replicaExperto", members:[
{_id : 0, host : "localhost:27017"},
  { _id : 1, host : "localhost:27018"},
{_id : 2, host : "localhost:27019"}
]};
Si en los miembros ponemos slaveDelay: numSeg podemos retrasar un nodo respecto al resto (también deberemos indicar que priority : 0 para que no sea un nodo principal). Más información en <a href="http://docs.mongodb.org/manual/core/replica-set-delayed-member/">http://docs.mongodb.org/manual/core/replica-set-delayed-member/</a>
Tras crear el documento de configuración, podemos iniciar el conjunto mediante:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">rs</span><span class="p">.</span><span class="nx">initiate</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="s2">&quot;info&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Config now saved locally.  Should come online in about a minute.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="s2">&quot;ok&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Si ahora volvemos a consultar el estado de la réplica tendremos:</p>
<p>replicaExperto:PRIMARY&gt; rs.status()
{
  "set" : "replicaExperto",
  "date" : ISODate("2016-02-09T17:57:52.273Z"),
  "myState" : 1,
  "term" : NumberLong(1),
  "heartbeatIntervalMillis" : NumberLong(2000),
  "members" : [
   {
      "_id" : 0,
      "name" : "localhost:27017",
      "health" : 1,
      "state" : 1,
      "stateStr" : "PRIMARY",
      "uptime" : 89,
      "optime" : {
        "ts" : Timestamp(1455040665, 2),
        "t" : NumberLong(1)
      },
      "optimeDate" : ISODate("2016-02-09T17:57:45Z"),
      "infoMessage" : "could not find member to sync from",
      "electionTime" : Timestamp(1455040665, 1),
      "electionDate" : ISODate("2016-02-09T17:57:45Z"),
      "configVersion" : 1,
      "self" : true
    },
   {
      "_id" : 1,
      "name" : "localhost:27018",
      "health" : 1,
      "state" : 2,
      "stateStr" : "SECONDARY",
      "uptime" : 17,
      "optime" : {
        "ts" : Timestamp(1455040665, 2),
        "t" : NumberLong(1)
      },
      "optimeDate" : ISODate("2016-02-09T17:57:45Z"),
      "lastHeartbeat" : ISODate("2016-02-09T17:57:51.287Z"),
      "lastHeartbeatRecv" : ISODate("2016-02-09T17:57:47.860Z"),
      "pingMs" : NumberLong(0),
      "syncingTo" : "localhost:27017",
      "configVersion" : 1
   },
   {
      "_id" : 2,
      "name" : "localhost:27019",
      "health" : 1,
      "state" : 2,
      "stateStr" : "SECONDARY",
      "uptime" : 17,
      "optime" : {
        "ts" : Timestamp(1455040665, 2),
        "t" : NumberLong(1)
      },
      "optimeDate" : ISODate("2016-02-09T17:57:45Z"),
      "lastHeartbeat" : ISODate("2016-02-09T17:57:51.287Z"),
      "lastHeartbeatRecv" : ISODate("2016-02-09T17:57:47.869Z"),
      "pingMs" : NumberLong(1),
      "syncingTo" : "localhost:27017",
      "configVersion" : 1
   }
  ],
  "ok" : 1
}
La próxima vez que lancemos las réplicas ya no deberemos configurarlas. Así pues, el proceso de enlazar e iniciar las réplicas sólo se realiza una vez.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="  1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="  2 "></span><span class="o">&lt;</span><span class="w"> </span><span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="  3 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="  4 "></span><span class="w">  </span><span class="nx">set</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;atlas-4wikkb-shard-0&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  5 "></span><span class="w">  </span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">51.267</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  6 "></span><span class="w">  </span><span class="nx">myState</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  7 "></span><span class="w">  </span><span class="nx">term</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="  8 "></span><span class="w">  </span><span class="nx">syncSourceHost</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="  9 "></span><span class="w">  </span><span class="nx">syncSourceId</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 10 "></span><span class="w">  </span><span class="nx">heartbeatIntervalMillis</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;2000&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 11 "></span><span class="w">  </span><span class="nx">majorityVoteCount</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 12 "></span><span class="w">  </span><span class="nx">writeMajorityCount</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 13 "></span><span class="w">  </span><span class="nx">votingMembersCount</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 14 "></span><span class="w">  </span><span class="nx">writableVotingMembersCount</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 15 "></span><span class="w">  </span><span class="nx">optimes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 16 "></span><span class="w">    </span><span class="nx">lastCommittedOpTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287770</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 17 "></span><span class="w">    </span><span class="nx">lastCommittedWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 18 "></span><span class="w">    </span><span class="nx">readConcernMajorityOpTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287770</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 19 "></span><span class="w">    </span><span class="nx">appliedOpTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287770</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 20 "></span><span class="w">    </span><span class="nx">durableOpTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287770</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 21 "></span><span class="w">    </span><span class="nx">lastAppliedWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 22 "></span><span class="w">    </span><span class="nx">lastDurableWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="w"></span>
<span class="linenos" data-linenos=" 23 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 24 "></span><span class="w">  </span><span class="nx">lastStableRecoveryTimestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287740</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos=" 25 "></span><span class="w">  </span><span class="nx">electionCandidateMetrics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 26 "></span><span class="w">    </span><span class="nx">lastElectionReason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stepUpRequestSkipDryRun&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 27 "></span><span class="w">    </span><span class="nx">lastElectionDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">14</span><span class="nx">T19</span><span class="o">:</span><span class="mf">15</span><span class="o">:</span><span class="mf">57.110</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 28 "></span><span class="w">    </span><span class="nx">electionTerm</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 29 "></span><span class="w">    </span><span class="nx">lastCommittedOpTimeAtElection</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1665774957</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;21&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 30 "></span><span class="w">    </span><span class="nx">lastSeenOpTimeAtElection</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1665774957</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;21&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 31 "></span><span class="w">    </span><span class="nx">numVotesNeeded</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 32 "></span><span class="w">    </span><span class="nx">priorityAtElection</span><span class="o">:</span><span class="w"> </span><span class="mf">7</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 33 "></span><span class="w">    </span><span class="nx">electionTimeoutMillis</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;5000&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 34 "></span><span class="w">    </span><span class="nx">priorPrimaryMemberId</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 35 "></span><span class="w">    </span><span class="nx">numCatchUpOps</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 36 "></span><span class="w">    </span><span class="nx">newTermStartDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">14</span><span class="nx">T19</span><span class="o">:</span><span class="mf">15</span><span class="o">:</span><span class="mf">57.214</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 37 "></span><span class="w">    </span><span class="nx">wMajorityWriteAvailabilityDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">14</span><span class="nx">T19</span><span class="o">:</span><span class="mf">15</span><span class="o">:</span><span class="mf">58.574</span><span class="nx">Z</span><span class="w"></span>
<span class="linenos" data-linenos=" 38 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 39 "></span><span class="w">  </span><span class="nx">members</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 40 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 41 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 42 "></span><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ac-opunia9-shard-00-00.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 43 "></span><span class="w">      </span><span class="nx">health</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 44 "></span><span class="w">      </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 45 "></span><span class="w">      </span><span class="nx">stateStr</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SECONDARY&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 46 "></span><span class="w">      </span><span class="nx">uptime</span><span class="o">:</span><span class="w"> </span><span class="mf">512912</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 47 "></span><span class="w">      </span><span class="nx">optime</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nb">Object</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 48 "></span><span class="w">      </span><span class="nx">optimeDurable</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nb">Object</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 49 "></span><span class="w">      </span><span class="nx">optimeDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.000</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 50 "></span><span class="w">      </span><span class="nx">optimeDurableDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.000</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 51 "></span><span class="w">      </span><span class="nx">lastAppliedWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 52 "></span><span class="w">      </span><span class="nx">lastDurableWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 53 "></span><span class="w">      </span><span class="nx">lastHeartbeat</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.357</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 54 "></span><span class="w">      </span><span class="nx">lastHeartbeatRecv</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.646</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 55 "></span><span class="w">      </span><span class="nx">pingMs</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 56 "></span><span class="w">      </span><span class="nx">lastHeartbeatMessage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 57 "></span><span class="w">      </span><span class="nx">syncSourceHost</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ac-opunia9-shard-00-02.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 58 "></span><span class="w">      </span><span class="nx">syncSourceId</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 59 "></span><span class="w">      </span><span class="nx">infoMessage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 60 "></span><span class="w">      </span><span class="nx">configVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 61 "></span><span class="w">      </span><span class="nx">configTerm</span><span class="o">:</span><span class="w"> </span><span class="mf">22</span><span class="w"></span>
<span class="linenos" data-linenos=" 62 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 63 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 64 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 65 "></span><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ac-opunia9-shard-00-01.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 66 "></span><span class="w">      </span><span class="nx">health</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 67 "></span><span class="w">      </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 68 "></span><span class="w">      </span><span class="nx">stateStr</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SECONDARY&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 69 "></span><span class="w">      </span><span class="nx">uptime</span><span class="o">:</span><span class="w"> </span><span class="mf">512651</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 70 "></span><span class="w">      </span><span class="nx">optime</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nb">Object</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 71 "></span><span class="w">      </span><span class="nx">optimeDurable</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nb">Object</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 72 "></span><span class="w">      </span><span class="nx">optimeDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">49.000</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 73 "></span><span class="w">      </span><span class="nx">optimeDurableDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">49.000</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 74 "></span><span class="w">      </span><span class="nx">lastAppliedWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 75 "></span><span class="w">      </span><span class="nx">lastDurableWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 76 "></span><span class="w">      </span><span class="nx">lastHeartbeat</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">49.935</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 77 "></span><span class="w">      </span><span class="nx">lastHeartbeatRecv</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">51.180</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 78 "></span><span class="w">      </span><span class="nx">pingMs</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 79 "></span><span class="w">      </span><span class="nx">lastHeartbeatMessage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 80 "></span><span class="w">      </span><span class="nx">syncSourceHost</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ac-opunia9-shard-00-02.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 81 "></span><span class="w">      </span><span class="nx">syncSourceId</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 82 "></span><span class="w">      </span><span class="nx">infoMessage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 83 "></span><span class="w">      </span><span class="nx">configVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 84 "></span><span class="w">      </span><span class="nx">configTerm</span><span class="o">:</span><span class="w"> </span><span class="mf">22</span><span class="w"></span>
<span class="linenos" data-linenos=" 85 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 86 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 87 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 88 "></span><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ac-opunia9-shard-00-02.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 89 "></span><span class="w">      </span><span class="nx">health</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 90 "></span><span class="w">      </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 91 "></span><span class="w">      </span><span class="nx">stateStr</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 92 "></span><span class="w">      </span><span class="nx">uptime</span><span class="o">:</span><span class="w"> </span><span class="mf">512922</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 93 "></span><span class="w">      </span><span class="nx">optime</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nb">Object</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 94 "></span><span class="w">      </span><span class="nx">optimeDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.000</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 95 "></span><span class="w">      </span><span class="nx">lastAppliedWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 96 "></span><span class="w">      </span><span class="nx">lastDurableWallTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">42</span><span class="o">:</span><span class="mf">50.864</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 97 "></span><span class="w">      </span><span class="nx">syncSourceHost</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 98 "></span><span class="w">      </span><span class="nx">syncSourceId</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 99 "></span><span class="w">      </span><span class="nx">infoMessage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="100 "></span><span class="w">      </span><span class="nx">electionTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1665774957</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos="101 "></span><span class="w">      </span><span class="nx">electionDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">14</span><span class="nx">T19</span><span class="o">:</span><span class="mf">15</span><span class="o">:</span><span class="mf">57.000</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="102 "></span><span class="w">      </span><span class="nx">configVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="103 "></span><span class="w">      </span><span class="nx">configTerm</span><span class="o">:</span><span class="w"> </span><span class="mf">22</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="104 "></span><span class="w">      </span><span class="nx">self</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="105 "></span><span class="w">      </span><span class="nx">lastHeartbeatMessage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"></span>
<span class="linenos" data-linenos="106 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="107 "></span><span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="108 "></span><span class="w">  </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="109 "></span><span class="w">  </span><span class="s1">&#39;$clusterTime&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="110 "></span><span class="w">    </span><span class="nx">clusterTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287770</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos="111 "></span><span class="w">    </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="112 "></span><span class="w">      </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="nx">Binary</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;ee0dfe4005d204a45bbc1ee1fa92de822cfd48c2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hex&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="113 "></span><span class="w">      </span><span class="nx">keyId</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;7098414637623803905&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="114 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="115 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="116 "></span><span class="w">  </span><span class="nx">operationTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287770</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos="117 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Podemos comprobar si un nodo es el principal mediante rs.isMaster():</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">isMaster</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nx">topologyVersion</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;6349b501e763f7899c34bae7&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nx">counter</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="nx">hosts</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="s1">&#39;ac-opunia9-shard-00-00.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="s1">&#39;ac-opunia9-shard-00-01.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="s1">&#39;ac-opunia9-shard-00-02.dfaz5er.mongodb.net:27017&#39;</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="nx">setName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;atlas-4wikkb-shard-0&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="nx">setVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="nx">ismaster</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="nx">secondary</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="nx">primary</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ac-opunia9-shard-00-02.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="nx">workloadType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OPERATIONAL&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AWS&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">    </span><span class="nx">region</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;EU_WEST_3&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="nx">nodeType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ELECTABLE&#39;</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">  </span><span class="nx">me</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ac-opunia9-shard-00-02.dfaz5er.mongodb.net:27017&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">  </span><span class="nx">electionId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;7fffffff0000000000000016&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">  </span><span class="nx">lastWrite</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">    </span><span class="nx">opTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287857</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">    </span><span class="nx">lastWriteDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">44</span><span class="o">:</span><span class="mf">17.000</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">    </span><span class="nx">majorityOpTime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287857</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">    </span><span class="nx">majorityWriteDate</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">44</span><span class="o">:</span><span class="mf">17.000</span><span class="nx">Z</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">  </span><span class="nx">maxBsonObjectSize</span><span class="o">:</span><span class="w"> </span><span class="mf">16777216</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">  </span><span class="nx">maxMessageSizeBytes</span><span class="o">:</span><span class="w"> </span><span class="mf">48000000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">  </span><span class="nx">maxWriteBatchSize</span><span class="o">:</span><span class="w"> </span><span class="mf">100000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">  </span><span class="nx">localTime</span><span class="o">:</span><span class="w"> </span><span class="mf">2022</span><span class="o">-</span><span class="mf">10</span><span class="o">-</span><span class="mf">20</span><span class="nx">T17</span><span class="o">:</span><span class="mf">44</span><span class="o">:</span><span class="mf">17.555</span><span class="nx">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">  </span><span class="nx">logicalSessionTimeoutMinutes</span><span class="o">:</span><span class="w"> </span><span class="mf">30</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">  </span><span class="nx">connectionId</span><span class="o">:</span><span class="w"> </span><span class="mf">131669</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="37 "></span><span class="w">  </span><span class="nx">minWireVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="38 "></span><span class="w">  </span><span class="nx">maxWireVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">13</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="39 "></span><span class="w">  </span><span class="nx">readOnly</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="40 "></span><span class="w">  </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="41 "></span><span class="w">  </span><span class="s1">&#39;$clusterTime&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="42 "></span><span class="w">    </span><span class="nx">clusterTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287857</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos="43 "></span><span class="w">    </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="44 "></span><span class="w">      </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="nx">Binary</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;7221a4b1c5ea0867cc6930eae945434bd9b68a17&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hex&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="45 "></span><span class="w">      </span><span class="nx">keyId</span><span class="o">:</span><span class="w"> </span><span class="nx">Long</span><span class="p">(</span><span class="s2">&quot;7098414637623803905&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="46 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="47 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="48 "></span><span class="w">  </span><span class="nx">operationTime</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">1666287857</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="linenos" data-linenos="49 "></span><span class="w">  </span><span class="nx">isWritablePrimary</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="linenos" data-linenos="50 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>FIXME: esto es importante</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">initiate</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;replicaTest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nx">members</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;127.0.0.1:27017&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;127.0.0.1:27018&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;127.0.0.1:27019&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">arbiterOnly</span><span class="o">:</span><span class="kc">true</span><span class="w"> </span><span class="p">}]</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;mongodbd1.example.net:27017&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">addArb</span><span class="p">(</span><span class="s2">&quot;mongodbd2.example.net:27017&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;mongodbd1.example.net:27017&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">conf</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">isMaster</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">printReplicationInfo</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">printSlaveReplicationInfo</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">reconfig</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">valid_conf</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">slaveOk</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="nx">rs</span><span class="p">.</span><span class="nx">stepDown</span><span class="p">(</span><span class="mf">20</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="c1">// (stepDownSecs, secondaryCatchUpPeriodSecs)</span><span class="w"></span>
</code></pre></div>
<h4 id="trabajando-con-las-replicas">Trabajando con las réplicas<a class="headerlink" href="#trabajando-con-las-replicas" title="Permanent link">&para;</a></h4>
<p>Una vez que hemos visto que las tres réplicas están funcionando, vamos a comprobar como podemos trabajar con ellas.</p>
<p>Para ello, nos conectamos al nodo principal (al ser el puerto predeterminado, podemos omitirlo):</p>
<p>$ mongosh --port 27017
Al conectarnos al nodo principal, nos aparece como símbolo del shell el nombre del conjunto de la réplica seguido de dos puntos y PRIMARY si nos hemos conectado al nodo principal, o SECONDARY en caso contrario.</p>
<p>replicaExperto:PRIMARY&gt;
Para saber si nos hemos conectado al nodo correcto, mediante rs.isMaster() obtendremos el tipo del nodo (propiedad ismaster) e información sobre el resto de nodos:</p>
<p>replicaExperto:PRIMARY&gt; rs.isMaster()
{
  "hosts" : [
    "localhost:27017",
    "localhost:27018",
    "localhost:27019"
  ],
  "setName" : "replicaExperto",
  "setVersion" : 1,
  "ismaster" : true,
  "secondary" : false,
  "primary" : "localhost:27017",
  "me" : "localhost:27017",
  "electionId" : ObjectId("56ba28990000000000000001"),
  "maxBsonObjectSize" : 16777216,
  "maxMessageSizeBytes" : 48000000,
  "maxWriteBatchSize" : 1000,
  "localTime" : ISODate("2016-02-09T18:00:46.397Z"),
  "maxWireVersion" : 4,
  "minWireVersion" : 0,
  "ok" : 1
}
Ahora que sabemos que estamos en el nodo principal, vamos a insertar datos.</p>
<p>Para ello, vamos a insertar 100 documentos:</p>
<p>Insertamos 100 documentos sobre replicaExperto:PRIMARY
for (i=0; i&lt;1000; i++) {
  db.pruebas.insert({num: i})
}
Estos 1000 documentos se han insertado en el nodo principal, y se han replicado a los secundarios. Para comprobar la replicación, abrimos un nuevo terminal y nos conectamos a un nodo secundario:</p>
<p>$ mongosh --port 27018
replicaExperto:SECONDARY&gt;
Si desde el nodo secundario intentamos consultar el total de documentos de la colección obtendremos un error:</p>
<p>replicaExperto:SECONDARY&gt; db.pruebas.count()
count failed: { "ok" : 0, "errmsg" : "not master and slaveOk=false", "code" : 13435 }
El error indica que no somos un nodo primario y por lo tanto no podemos leer de él. Para permitir lecturas en los nodos secundarios, mediante rs.slaveOk() le decimos a mongosh que sabemos que nos hemos conectado a un secundairo y admitimos la posibilidad de obtener datos obsoletos.</p>
<p>replicaExperto:SECONDARY&gt; rs.slaveOk()
replicaExperto:SECONDARY&gt; db.pruebas.count()
1000
Pero que podamos leer no significa que podamos escribir. Si intentamos escribir en un nodo secundario obtendremos un error:</p>
<p>replicaExperto:SECONDARY&gt; db.pruebas.insert({num : 1001})
WriteResult({ "writeError" : { "code" : 10107, "errmsg" : "not master" } }</p>
<h4 id="tolerancia-a-fallos">Tolerancia a fallos<a class="headerlink" href="#tolerancia-a-fallos" title="Permanent link">&para;</a></h4>
<p>Cuando un nodo primario no se comunica con otros miembros del conjunto durante más de 10 segundos, el conjunto de réplicas intentará, de entre los secundarios, que un miembro se convierta en el nuevo primario.</p>
<p>Para ello se realiza un proceso de votación, de modo que el nodo que obtenga el mayor número de votos se erigirá en primario. Este proceso de votación se realiza bastante rápido (menos de 3 segundos), durante el cual no existe ningún nodo primario y por tanto la réplica no acepta escrituras y todos los miembros se convierten en nodos de sólo-lectura.</p>
<p>Elección de un nuevo primario
Figure 4. Elección de un nuevo primario
Proceso de votación
Cuando un nodo secundario no puede contactar con su nodo primario, contactará con el resto de miembros y les indicará que quiere ser elegido como primario. Es decir, cada nodo que no encuentre un primario se nominará como posible primario, de modo que un nodo no nomina a otro a ser primario, únicamente vota sobre una nominación ya existente.</p>
<p>Antes de dar su voto, el resto de nodos comprobarán:</p>
<p>si ellos tienen conectividad con el primario</p>
<p>si el nodo que solicita ser primario tienen una réplica actualizada de los datos. Todas las operaciones replicadas están ordenadas por el timestamp ascendentemente, de modo los candidatos deben tener operaciones posteriores o iguales a cualquier miembro con el que tengan conectividad.</p>
<p>si existe algún nodo con una prioridad mayor que debería ser elegido.</p>
<p>Si algún miembro que quiere ser primario recibe una mayoría de "sís" se convertirá en el nuevo primario, siempre y cuando no haya un servidor que vete la votación. Si un miembro la veta es porque conoce alguna razón por la que el nodo que quiere ser primario no debería serlo, es decir, ha conseguido contactar con el antiguo primario.</p>
<p>Una vez un candidato recibe una mayoría de "sís", su estado pasará a ser primario.</p>
<p>Cantidad de elementos
En la votación, se necesita una mayoría de nodos para elegir un primario, ya que una escritura se considera segura cuando ha alcanzado a la mayoría de los nodos. Esta mayoría se define como más de la mitad de todos los nodos del conjunto. Hay que destacar que la mayoría no se basa en los elementos que queden en pie o estén disponibles, sino en el conjunto definido en la configuración del conjunto.</p>
<p>Por lo tanto, es importante configurar el conjunto de una manera que siempre se puede elegir un nodo primario. Por ejemplo, en un conjunto de cinco nodos, si los nodos 1, 2 y 3 están en un centro de datos y los miembros 4 y 5 en otro, debería haber casi siempre una mayoría disponible en el primer centro de datos (es más probable que se pierda la conexión de red entre centros de datos que dentro de ellos).</p>
<p>Elección de un nuevo primario
Figure 5. Elección de un nuevo primario
Por lo tanto, una configuración que hay que evitar es aquella compuesta por dos elementos: uno primario y uno secundario. Si uno de los dos miembros deja de estar disponible, el otro miembro no puede verlo. En esta situación, ninguna parte de la partición de red tiene una mayoría, con lo que acabaríamos con dos secundarios.</p>
<p>Por ello, el número mínimo de nodos es 3, para que al realizar una nueva elección se pueda elegir un nuevo nodo.</p>
<p>Comprobando la tolerancia
Para comprobar esto, desde el nodo primario vamos a detenerlo:</p>
<p>replicaExperto:PRIMARY&gt; db.adminCommand({"shutdown" : 1})
Otra posibilidad en vez de detenerlo es degradarlo a nodo secundario:</p>
<p>replicaExperto:PRIMARY&gt; rs.stepDown()
Si pasamos al antiguo nodo secundario, y le preguntamos si es el principal obtendremos:</p>
<p>replicaExperto:SECONDARY&gt; rs.isMaster()
{
  "setName" : "replicaExperto",
  "setVersion" : 1,
  "ismaster" : false,
  "secondary" : true,
  "hosts" : [
    "localhost:27018",
    "localhost:27019",
    "localhost:27017"
  ],
  "primary" : "localhost:27019",
  "me" : "localhost:27018",
  "maxBsonObjectSize" : 16777216,
  "maxMessageSizeBytes" : 48000000,
  "maxWriteBatchSize" : 1000,
  "localTime" : ISODate("2015-03-24T21:55:27.382Z"),
  "maxWireVersion" : 2,
  "minWireVersion" : 0,
  "ok" : 1
}
Si nos fijamos en la propiedad primary, veremos que tenemos un nuevo primario.</p>
<p>Configuración recomendada
Se recomiendan dos configuraciones:</p>
<p>Mediante una mayoría del conjunto en un centro de datos. Este planteamiento es bueno si tenemos un data center donde queremos que siempre se aloje el nodo primario de la réplica. Siempre que el centro de datos funcione normalmente, habrá un nodo primario. Sin embargo, si el centro primario pierde la conectividad, el centro de datos secundario no podrá elegir un nuevo primario.</p>
<p>Mediante el mismo número de servidores en cada centro de datos, más un servidor que rompe la igualdad en una tercera localización. Este diseño es conveniente cuando ambos centros de datos tienen el mismo grado de confiabilidad y robustez.</p>
<h4 id="recuperacion-del-sistema">Recuperación del sistema<a class="headerlink" href="#recuperacion-del-sistema" title="Permanent link">&para;</a></h4>
<p>Si en un conjunto de réplicas se cae el primario y hay escrituras que se han pasado al oplog de modo que los otros nodos no las han replicado, cuando el nodo primario vuelva en sí como secundario y se sincronice con el primario, se dará cuenta que hay operaciones de escritura pendientes y las pasará a rollback, para que si se desean se apliquen manualmente.</p>
<p>Para evitar este escenario, se necesita emplear consistencia en la escritura, de manera que hasta que la escritura no se haya replicado en la mayoría de los nodos no se considere como una escritura exitosa.</p>
<h3 id="consistencia-en-la-escritura">Consistencia en la escritura<a class="headerlink" href="#consistencia-en-la-escritura" title="Permanent link">&para;</a></h3>
<p>Ya hemos visto que tanto las lecturas como las escrituras se realizan de manera predeterminada en el nodo primario.</p>
<p>Las aplicaciones pueden decidir que las escrituras vayan al nodo primario pero las lecturas al secundario. Esto puede provocar que haya lecturas caducas, con datos obsoletos, pero como beneficio podemos escalar el sistema.</p>
<p>La replicación es un proceso asíncrono. En el período de tiempo en el que el sistema de votación sucede, no se completa ninguna escritura.</p>
<p>MongoDB garantiza la consistencia en la escritura, haciendo que sea un sistema consistente. Para ello, ofrece un sistema que garantiza que una escritura ha sido exitosa. Dependiendo del nivel de configuración de la consistencia, las inserciones, modificaciones y borrados pueden tardar más o menos. Si reducimos el nivel de consistencia, el rendimiento será mejor, a costa de poder obtener datos obsoletos u perder datos que no se han terminado de serializar en disco. Con un nivel de consistencia más alto, los clientes esperan tras enviar una operación de escritura a que MongoDB les confirme la operación.</p>
<p>Los valores que podemos configurar se realizan mediante las siguientes opciones:</p>
<ul>
<li><code>w</code>: indica el número de servidores que se han de replicar para que la inserción devuelva un ACK.</li>
<li><code>j</code>: indica si las escrituras se tienen que trasladar a un diario de bitácora (journal)</li>
<li><code>wtimeout</code>: indica el límite de tiempo a esperar como máximo, para prevenir que una escritura se bloquee indefinidamente.</li>
</ul>
<h3 id="niveles-de-consistencia">Niveles de consistencia<a class="headerlink" href="#niveles-de-consistencia" title="Permanent link">&para;</a></h3>
<p>Con estas opciones, podemos configurar diferentes niveles de consistencia son:</p>
<ul>
<li>Sin confirmación: <code>w:0</code>, también conocido como <em>fire-and-forget</em>.</li>
<li>Con confirmación: <code>w:1</code>, el cual es el modo por defecto.</li>
<li>Con diario: <code>w:1</code>, <code>j:true</code>. Cada inserción primero se escribe en el diario y posteriormente en el directorio de datos.</li>
<li>Con confirmación de la mayoría: <code>w: "majority"</code>, es decir, confirman la mitad + 1 de los nodos de la replica.</li>
</ul>
<p>Estas opciones se indican como parámetro final en las operaciones de inserción y modificación de datos. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">pruebas</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">num</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1002</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="p">{</span><span class="nx">writeConcern</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;majority&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">wtimeout</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="p">}}</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>En resumen, a mayor cantidad de nodos, mayor es la tolerancia a fallos pero cada operación necesita más tiempo y recursos para realizar la persistencia de los datos.</p>
<p>Más información en <a href="http://docs.mongodb.org/manual/core/write-concern/">http://docs.mongodb.org/manual/core/write-concern/</a> y <a href="https://www.youtube.com/watch?v=49BPAY1Yb5w">https://www.youtube.com/watch?v=49BPAY1Yb5w</a></p>
<p>FIXME: Revisar notebook curso MongoDB_PYTHON</p>
<h2 id="particionado-sharding">Particionado (Sharding)<a class="headerlink" href="#particionado-sharding" title="Permanent link">&para;</a></h2>
<p>https://www.mongodb.com/basics/sharding</p>
<p><a href="https://www.digitalocean.com/community/tutorials/understanding-database-sharding">https://www.digitalocean.com/community/tutorials/understanding-database-sharding</a></p>
<p>Ya vimos en la primera sesión que dentro del entorno de las bases de datos, particionar consiste en dividir los datos entre múltiples máquinas. Al poner un subconjunto de los datos en cada máquina, vamos a poder almacenar más información y soportar más carga sin necesidad de máquinas más potentes, sino una mayor cantidad de máquinas más modestas (y mucho más baratas).</p>
<p>El <em>Sharding</em> es una técnica que fragmenta los datos de la base de datos horizontalmente agrupándolos de algún modo que tenga sentido y que permita un direccionamiento más rápido.</p>
<figure style="align: center;">
    <img src="images/05sharded-collection.png">
    <figcaption>Sharding</figcaption>
</figure>

<p>Por lo tanto, estos shards (fragmentos) pueden estar localizados en diferentes bases de datos y localizaciones físicas.</p>
<p>El <em>Sharding</em> no tiene por qué estar basado únicamente en una colección y un campo, puede ser a nivel de todas las colecciones. Por ejemplo podríamos decir "todos los datos de usuarios cuyo perfil esté en los Estados Unidos los redirigimos a la base de datos del servidor en Estados Unidos, y todos los de Asia van a la base de datos de Asia".</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShard</span><span class="p">(</span><span class="s2">&quot;rs1/mongodbd1.example.net:27017&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">zipcode</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">moveChunk</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">zipcode</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;53187&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;shard0019&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">splitAt</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="mf">70</span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">splitFind</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="mf">70</span><span class="p">})</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">disableAutoSplit</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">enableAutoSplit</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">startBalancer</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">stopBalancer</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">disableBalancing</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">enableBalancing</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">getBalancerState</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">setBalancerState</span><span class="p">(</span><span class="kc">true</span><span class="o">/</span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">isBalancerRunning</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addTagRange</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;NY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">zip</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;NY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">zip</span><span class="o">:</span><span class="w"> </span><span class="nx">MaxKey</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;NY&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">removeTagRange</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;NY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">zip</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;NY&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">zip</span><span class="o">:</span><span class="w"> </span><span class="nx">MaxKey</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;NY&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShardTag</span><span class="p">(</span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NYC&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">removeShardTag</span><span class="p">(</span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NYC&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShardToZone</span><span class="p">(</span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;JFK&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">removeShardFromZone</span><span class="p">(</span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NYC&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="nx">sh</span><span class="p">.</span><span class="nx">removeRangeFromZone</span><span class="p">(</span><span class="s2">&quot;mydb.coll&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">})</span><span class="w"></span>
</code></pre></div>
<h3 id="particionando-con-mongodb">Particionando con MongoDB<a class="headerlink" href="#particionando-con-mongodb" title="Permanent link">&para;</a></h3>
<p><em>MongoDB</em> implementa el <em>sharding</em> de forma nativa y automática (de ahí el término de <em>auto-sharding</em>), siguiendo un enfoque basado en rangos.</p>
<p>Para ello, divide una colección entre diferentes servidores, utilizando <code>mongos</code> como router de las peticiones entre los sharded clusters.</p>
<p>Esto favorece que el desarrollador ignore que la aplicación no se comunica con un único servidor, balanceando de manera automática los datos y permitiendo incrementar o reducir la capacidad del sistema a conveniencia.</p>
<p>Antes de plantearse hacer auto-sharding sobre nuestros datos, es conveniente dominar cómo se trabaja con MongoDB y el uso de conjuntos de réplica.</p>
<h4 id="sharded-cluster">Sharded Cluster<a class="headerlink" href="#sharded-cluster" title="Permanent link">&para;</a></h4>
<p>El particionado de MongoDB permite crear un cluster de muchas máquinas, dividiendo a nivel de colección y poniendo un subconjunto de los datos de la colección en cada uno de los fragmentos.</p>
<p>Los componentes de un sharded clusters son:</p>
<ul>
<li><strong><em>Shards</em></strong> (Fragmentos): Cada una de las máquinas del cluster, que almacena un subconjunto de los datos de la colección. Cada shard es una instancia de mongod o un conjunto de réplicas. En un entorno de producción, todos los shards son conjuntos de réplica.</li>
<li>
<p><strong>Servidores de Configuracion</strong>: Cada servidor de configuración es una instancia de mongod que almacena metadatos sobre el cluster. Los metadatos mapean los trozos con los shards, definiendo qué rangos de datos definen un trozo (chunk) de la colección, y qué trozos se encuentran en un determinado shard.<br />
    En entornos de producción se aconseja tener 3 servidores de configuración ya que si sólo tuviésemos uno, al producirse una caída el cluster quedaría inaccesible.</p>
</li>
<li>
<p><strong>Enrutadores</strong>: Cada router es una instancia mongos que enruta las lecturas y escrituras de las aplicaciones a los shards. Las aplicaciones no acceden directamente a los shards, sino al router. Estos enrutadores funcionan de manera similar a una tabla de contenidos, que nos indica donde se encuentran los datos. Una vez recopilados los datos de los diferentes shards, se fusionan y se encarga de devolverlos a la aplicación.</p>
</li>
</ul>
<p>En entornos de producción es común tener varios routers para balancear la carga de los clientes.</p>
<figure style="align: center;">
    <img src="images/05sharded-cluster.png">
    <figcaption>Componentes de un Sharded cluster</figcaption>
</figure>

<div class="admonition question">
<p class="admonition-title">Autoevaluación</p>
<p>Supongamos que queremos ejecutar múltiples routers mongos para soportar la redundancia. ¿Qué elemento asegurará la tolerancia a fallos y cambiará de un mongos a otro dentro de tu aplicación?</p>
<ul>
<li>mongod</li>
<li>mongos</li>
<li>Driver</li>
<li>Los servidores de configuración de sharding</li>
</ul>
</div>
<h4 id="shard-key">Shard key<a class="headerlink" href="#shard-key" title="Permanent link">&para;</a></h4>
<p>Para que MongoDB sepa cómo dividir una colección en trozos, hay que elegir una shard key, normalmente el identificador del documento, por ejemplo, student_id. Este identificador es la clave del chunk (por lo hace la misma función que una clave primaria).</p>
<p>Para las búsquedas, borrados y actualizaciones, al emplear la shard key, mongos sabe a que shard enviar la petición. En cambio, si la operación no la indica, se hará un broadcast a todas los shards para averiguar donde se encuentra.</p>
<p>Por eso, toda inserción debe incluir la <em>shard key</em>. En el caso de tratarse de una clave compuesta, la inserción debe contener la clave completa.</p>
<p>Entre los aspectos a tener en cuenta a la hora de elegir una shard key cabe destacar que debe:</p>
<ul>
<li>Tener una alta cardinalidad, para asegurar que los documentos puedan dividirse en los distintos fragmentos. Por ejemplo, si elegimos un shard key que solo tiene 3 valores posibles y tenemos 5 fragmentos, no podríamos separar los documentos en los 5 fragmentos al solo tener 3 valores posibles para separar. Cuantos más valores posibles pueda tener la clave de fragmentación, más eficiente será la división de los trozos entre los fragmentos disponibles.</li>
<li>Tener un alto nivel de aleatoriedad. Si utilizamos una clave que siga un patrón incremental como una fecha o un ID, conllevará que al insertar documentos, el mismo fragmento estará siendo utilizando constantemente durante el rango de valores definido para él. Esto provoca que los datos estén separados de una manera óptima, pero pondrá siempre bajo estrés a un fragmento en períodos de tiempo mientras que los otros posiblemente queden con muy poca actividad (comportamiento conocido como hotspotting).</li>
</ul>
<p>Una solución a las claves que siguen patrones incrementales es aplicar una funcion hash y crear una clave hasheada que si tiene un alto nivel de aleatoriedad.</p>
<p>Más consejos sobre como elegir la shard key en <a href="http://techinsides.blogspot.com.es/2013/09/keynote-concerns-how-to-choose-mongodb.html">http://techinsides.blogspot.com.es/2013/09/keynote-concerns-how-to-choose-mongodb.html</a>
Finalmente, destacar que toda shard key debe tener un índice asociado.</p>
<h3 id="preparando-el-sharding-con-mongodb">Preparando el Sharding con MongoDB<a class="headerlink" href="#preparando-el-sharding-con-mongodb" title="Permanent link">&para;</a></h3>
<p>Para comenzar, vamos a crear un particionado en dos instancias en las carpetas /data/s1/db y /data/s2/db. Los logs los colocaremos en /data/logs y crearemos un servidor para la configuración de los metadatos del shard en /data/con1/db:</p>
<p>mkdir -p /data/s1/db /data/s2/db /data/logs /data/conf1/db
chown <code>id -u</code> /data/s1/db /data/s2/db /data/logs /data/conf1/db
A continuación, arrancaremos un proceso mongod por cada uno de los shards (con la opción --shardsvr) y un tercero para la base de datos de configuración (con la opción --configsvr). Finalmente, también lanzaremos un proceso mongos:</p>
<p>Script de creación del Shard - (creaShard.sh)
mongod --shardsvr --dbpath  /data/s1/db --port 27000 --logpath /data/logs/sh1.log --smallfiles --oplogSize 128 --fork
mongod --shardsvr --dbpath  /data/s2/db --port 27001 --logpath /data/logs/sh2.log --smallfiles --oplogSize 128 --fork
mongod --configsvr --dbpath  /data/conf1/db --port 25000 --logpath  /data/logs/config.log --fork
mongos --configdb localhost:25000 --logpath  /data/logs/mongos.log --fork
El cual lanzaremos mediante</p>
<p>bash &lt; creaShard.sh
Una vez creado, arrancaremos un shell del mongo, y observaremos como se lanza mongos:</p>
<p>$ mongo
MongoDB shell version: 3.2.1
connecting to: test
mongos&gt;
Finalmente, configuraremos el shard mediante el método sh.addShard(URI), obteniendo confirmación tras cada cada uno:</p>
<p>mongos&gt; sh.addShard("localhost:27000")
{ "shardAdded" : "shard0000", "ok" : 1 }<br />
mongos&gt; sh.addShard("localhost:27001")
{ "shardAdded" : "shard0001", "ok" : 1 }
El valor de la propiedad shardAdded nos devuelve el identificado unívoco de cada shard.
De manera similar que con el conjunto de réplicas se emplean el prefijo rs, para interactuar con los componentes implicados en el sharding se emplea sh. Por ejemplo, mediante sh.help() obtendremos la ayuda de los métodos disponibles.
Así pues, en este momento tenemos montada un shard con:</p>
<p>dos instancias de mongod para almacenar datos en los puertos 27000 y 27001 (shards)</p>
<p>una instancia monogd en el puerto 25000 (servidor de configuración) encargada de almacenar los metadatos del shard, a la cual sólo se deberían conectar el proceso mongos o los drivers para obtener información sobre el shard y la shard key</p>
<p>y un proceso mongos (enrutador), encargado de aceptar las peticiones de los clientes y enrutar las peticiones al shard adecuado.</p>
<p>Shard con dos máquinas
Figure 8. Shard con dos máquinas
Si comprobamos el estado del shard podremos comprobar como tenemos dos shards, con sus identificadores y URIs:</p>
<p>mongos&gt; sh.status()
--- Sharding Status ---
sharding version: {
  "_id" : 1,
  "minCompatibleVersion" : 5,
  "currentVersion" : 6,
  "clusterId" : ObjectId("56bc7054ba6728d2673a1755")
}
shards:
  {  "_id" : "shard0000",  "host" : "localhost:27000" }
  {  "_id" : "shard0001",  "host" : "localhost:27001" }
active mongoses:
  "3.2.1" : 1
balancer:
  Currently enabled:  yes
  Currently running:  no
  Failed balancer rounds in last 5 attempts:  0
  Migration Results for the last 24 hours:
    No recent migrations
databases:
En un entorno de producción, en vez de tener dos shards, habrá un conjunto de réplicas para asegurar la alta disponibilidad. Además, tendremos tres servidores de configuración para asegurar la disponibilidad de éstos. Del mismo modo, habrá tantos procesos mongos creados para un shard como conexiones de clientes.</p>
<p>Sharding en un entorno de Producción
Figure 9. Sharding en un entorno de producción
En init_sharded_replica.sh podéis comprobar como crear sharding sobre un conjunto de réplicas.
4.6.3. Habilitando el Sharding
Una vez hemos creado la estructura necesaria para soportar el sharding vamos a insertar un conjunto de datos para posteriormente particionarlos.</p>
<p>Para ello, vamos a insertar cien mil usuarios en una colección:</p>
<p>mongos&gt; use expertojava
switched to db expertojava
mongos&gt; for (var i=0; i&lt;100000; i++) {
  db.usuarios.insert({"login":"usu" + i,"nombre":"nom" + i*2, "fcreacion": new Date()});
}
mongos&gt; db.usuarios.count()
100000
Como podemos observar, interactuar con mongos es igual a hacerlo con mongo.</p>
<p>Ahora mismo no sabemos en qué cual de los dos shards se han almacenado los datos. Además, estos datos no están particionados, es decir residen en sólo uno de los shards.</p>
<p>Para habilitar el sharding a nivel de base de datos y que los datos se repartan entre los fragmentos disponibles, ejecutaremos el comando sh.enableSharding(nombreDB) :</p>
<p>mongos&gt; sh.enableSharding("expertojava")
Si volvemos a comprobar el estado del shard, tenemos que se ha creado la nueva base de datos que contiene la propiedad "partitioned" : true, la cual nos informa que esta fragmentada.</p>
<p>Antes de habilitar el sharding para una determinada colección, tenemos que crear un índice sobre la shard key:</p>
<p>mongos&gt; db.usuarios.createIndex({"login": 1})
{
  "raw" : {
    "localhost:27000" : {
      "createdCollectionAutomatically" : false,
      "numIndexesBefore" : 1,
      "numIndexesAfter" : 2,
      "ok" : 1
      }
    },
  "ok" : 1
}
Una vez habilitado el shard ya podemos fragmentar la colección:</p>
<p>mongos&gt; sh.shardCollection("expertojava.usuarios", {"login": 1}, false)
El método shardCollection particiona una colección a partir de una shard key. Para ello, recibe tres parámetros:</p>
<p>nombre de la colección, con nomenclatura de nombreBD.nombreColección</p>
<p>nombre del campo para fragmentar la colección, es decir, el shard key. Uno de los requisitos es que esta clave tengo una alta cardinalidad. Si tenemos una propiedad con una cardinalidad baja, podemos hacer un hash de la propiedad mediante {"login": "hashed"}. Como en nuestro caso hemos utilizado un campo con valores únicos hemos puesto {"login": 1}.</p>
<p>booleano que indica si el valor utilizado como shard key es único. Para ello, el índice que se crea sobre el campo debe ser del tipo unique.</p>
<p>Este comando divide la colección en chunks, la cual es la unidad que utiliza MongoDB para mover los datos. Una vez que se ha ejecutado, MongoDB comenzará a balancear la colección entre los shards del cluster. Este proceso no es instantáneo. Si la colección contiene un gran conjunto de datos puede llevar horas completar el balanceo.</p>
<p>Si ahora volvemos a comprobar el estado del shard obtendremos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">mongos</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="o">---</span><span class="w"> </span><span class="nx">Sharding</span><span class="w"> </span><span class="nx">Status</span><span class="w"> </span><span class="o">---</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="nx">sharding</span><span class="w"> </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="s2">&quot;minCompatibleVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="s2">&quot;currentVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">6</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="s2">&quot;clusterId&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;56bc7054ba6728d2673a1755&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="nx">shards</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;host&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;localhost:27000&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0001&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;host&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;localhost:27001&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="nx">active</span><span class="w"> </span><span class="nx">mongoses</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="s2">&quot;3.2.1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="nx">balancer</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">   </span><span class="nx">Currently</span><span class="w"> </span><span class="nx">enabled</span><span class="o">:</span><span class="w">  </span><span class="nx">yes</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">   </span><span class="nx">Currently</span><span class="w"> </span><span class="nx">running</span><span class="o">:</span><span class="w">  </span><span class="nx">no</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">   </span><span class="nx">Failed</span><span class="w"> </span><span class="nx">balancer</span><span class="w"> </span><span class="nx">rounds</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="nx">attempts</span><span class="o">:</span><span class="w">  </span><span class="mf">0</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">   </span><span class="nx">Migration</span><span class="w"> </span><span class="nx">Results</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="nx">hours</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="nx">No</span><span class="w"> </span><span class="nx">recent</span><span class="w"> </span><span class="nx">migrations</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="nx">databases</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="p">{</span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;expertojava&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;primary&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;partitioned&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">      </span><span class="nx">expertojava</span><span class="p">.</span><span class="nx">usuarios</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">        </span><span class="nx">shard</span><span class="w"> </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;login&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">        </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">        </span><span class="nx">balancing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">        </span><span class="nx">chunks</span><span class="o">:</span><span class="w">  </span>
<span class="linenos" data-linenos="27 "></span><span class="w">          </span><span class="nx">shard0000</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;login&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;$minKey&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">--&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;login&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;$maxKey&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">shard0000</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>la propiedad chunks muestra la cantidad de trozos que alberga cada partición. Así, pues en este momento tenemos 1 chunk
Para cada uno de los fragmentos se muestra el rango de valores que alberga cada chunk, así como en que shard se ubica.
Las claves $minKey y $maxKey son similares a menos infinito y más infinito, es decir, no hay ningún valor por debajo ni por encima de ellos. Es decir, indican los topes de la colección.</p>
<h3 id="trabajando-con-el-sharding">Trabajando con el Sharding<a class="headerlink" href="#trabajando-con-el-sharding" title="Permanent link">&para;</a></h3>
<p>En este momento, el shard esta creado pero todos los nodos residen en un único fragmento dentro de un partición. Vamos a volver a insertar 100.000 usuarios más a ver que sucede.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">mongos</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="o">=</span><span class="mf">100000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">&lt;</span><span class="mf">200000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="s2">&quot;login&quot;</span><span class="o">:</span><span class="s2">&quot;usu&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="s2">&quot;nombre&quot;</span><span class="o">:</span><span class="s2">&quot;nom&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="o">*</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fcreacion&quot;</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()});</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="nx">mongos</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="mf">200000</span><span class="w"></span>
</code></pre></div>
<p>Si ahora comprobamos el estado del shard, los datos se deberían haber repartido entre los shards disponibles:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">mongos</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="o">---</span><span class="w"> </span><span class="nx">Sharding</span><span class="w"> </span><span class="nx">Status</span><span class="w"> </span><span class="o">---</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="nx">sharding</span><span class="w"> </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="s2">&quot;minCompatibleVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="s2">&quot;currentVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">6</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="s2">&quot;clusterId&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;56bc7054ba6728d2673a1755&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="nx">shards</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;host&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;localhost:27000&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0001&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;host&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;localhost:27001&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="nx">active</span><span class="w"> </span><span class="nx">mongoses</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="s2">&quot;3.2.1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="nx">balancer</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="nx">Currently</span><span class="w"> </span><span class="nx">enabled</span><span class="o">:</span><span class="w">  </span><span class="nx">yes</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="nx">Currently</span><span class="w"> </span><span class="nx">running</span><span class="o">:</span><span class="w">  </span><span class="nx">no</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="nx">Failed</span><span class="w"> </span><span class="nx">balancer</span><span class="w"> </span><span class="nx">rounds</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="nx">attempts</span><span class="o">:</span><span class="w">  </span><span class="mf">0</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">  </span><span class="nx">Migration</span><span class="w"> </span><span class="nx">Results</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="nx">hours</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="mf">31</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Success</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="nx">databases</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">  </span><span class="p">{</span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;expertojava&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;primary&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;partitioned&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">    </span><span class="nx">expertojava</span><span class="p">.</span><span class="nx">usuarios</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">      </span><span class="nx">shard</span><span class="w"> </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;login&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">      </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">      </span><span class="nx">balancing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">      </span><span class="nx">chunks</span><span class="o">:</span><span class="w">  </span>
<span class="linenos" data-linenos="27 "></span><span class="w">        </span><span class="nx">shard0000</span><span class="w"> </span><span class="mf">32</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">        </span><span class="nx">shard0001</span><span class="w"> </span><span class="mf">31</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">      </span><span class="nx">too</span><span class="w"> </span><span class="nx">many</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">print</span><span class="p">,</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">verbose</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">want</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">force</span><span class="w"> </span><span class="nx">print</span><span class="w"></span>
</code></pre></div>
<p>Con estos datos se ha forzado a balancear los mismos entre los dos fragmentos, habiendo en cada uno de ellos 32 y 31 trozos respectivamente
Si ahora realizamos una consulta y obtenemos su plan de ejecución veremos como se trata de una consulta que se ejecuta en paralelo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">mongos</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s2">&quot;login&quot;</span><span class="o">:</span><span class="s2">&quot;usu12345&quot;</span><span class="p">}).</span><span class="nx">explain</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="s2">&quot;queryPlanner&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="s2">&quot;mongosPlannerVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="s2">&quot;winningPlan&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SINGLE_SHARD&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="s2">&quot;shards&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">          </span><span class="s2">&quot;shardName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0001&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">          </span><span class="s2">&quot;connectionString&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;localhost:27001&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">          </span><span class="s2">&quot;serverInfo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">            </span><span class="s2">&quot;host&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">            </span><span class="s2">&quot;port&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">27001</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">            </span><span class="s2">&quot;version&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;3.2.1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">            </span><span class="s2">&quot;gitVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">          </span><span class="s2">&quot;plannerVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">          </span><span class="s2">&quot;namespace&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;expertojava.usuarios&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">          </span><span class="s2">&quot;indexFilterSet&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">          </span><span class="s2">&quot;parsedQuery&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">            </span><span class="s2">&quot;login&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">              </span><span class="s2">&quot;$eq&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;usu12345&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">          </span><span class="s2">&quot;winningPlan&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">            </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;FETCH&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">            </span><span class="s2">&quot;inputStage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">              </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SHARDING_FILTER&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">              </span><span class="s2">&quot;inputStage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">                  </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;IXSCAN&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">                  </span><span class="s2">&quot;keyPattern&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">                    </span><span class="s2">&quot;login&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">                </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">                </span><span class="s2">&quot;indexName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;login_1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">                </span><span class="s2">&quot;isMultiKey&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">                </span><span class="s2">&quot;isUnique&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="37 "></span><span class="w">                </span><span class="s2">&quot;isSparse&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="38 "></span><span class="w">                </span><span class="s2">&quot;isPartial&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="39 "></span><span class="w">                </span><span class="s2">&quot;indexVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="40 "></span><span class="w">                </span><span class="s2">&quot;direction&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;forward&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="41 "></span><span class="w">                </span><span class="s2">&quot;indexBounds&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="42 "></span><span class="w">                  </span><span class="s2">&quot;login&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos="43 "></span><span class="w">                    </span><span class="s2">&quot;[\&quot;usu12345\&quot;, \&quot;usu12345\&quot;]&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="44 "></span><span class="w">                  </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="45 "></span><span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="46 "></span><span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="47 "></span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="48 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="49 "></span><span class="w">          </span><span class="s2">&quot;rejectedPlans&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="50 "></span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="51 "></span><span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="52 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="53 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="54 "></span><span class="w">  </span><span class="s2">&quot;ok&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="55 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Podemos observar como se ha realizado una fase SINGLE_SHARD de manera que ha accedido únicamente al shard0001, y posteriormente una fase de SHARDING_FILTER en la cual ha empleado un índice para el escaneo (IXSCAN).</p>
<p>Si en vez de obtener un documento concreto, obtenemos el plan de ejecución de obtener todos los documentos tendremos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">mongos</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">usuarios</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">explain</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="s2">&quot;queryPlanner&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="s2">&quot;mongosPlannerVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="s2">&quot;winningPlan&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SHARD_MERGE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="s2">&quot;shards&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">          </span><span class="s2">&quot;shardName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0000&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">          </span><span class="s2">&quot;connectionString&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;localhost:27000&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">          </span><span class="s2">&quot;serverInfo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">            </span><span class="s2">&quot;host&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">            </span><span class="s2">&quot;port&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">27000</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">            </span><span class="s2">&quot;version&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;3.2.1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">            </span><span class="s2">&quot;gitVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">          </span><span class="s2">&quot;plannerVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">          </span><span class="s2">&quot;namespace&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;expertojava.usuarios&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">          </span><span class="s2">&quot;indexFilterSet&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">          </span><span class="s2">&quot;parsedQuery&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="22 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="23 "></span><span class="w">          </span><span class="s2">&quot;winningPlan&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="24 "></span><span class="w">            </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SHARDING_FILTER&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="25 "></span><span class="w">            </span><span class="s2">&quot;inputStage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="26 "></span><span class="w">              </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;COLLSCAN&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="27 "></span><span class="w">              </span><span class="s2">&quot;filter&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="28 "></span><span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="29 "></span><span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="30 "></span><span class="w">              </span><span class="s2">&quot;direction&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;forward&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="31 "></span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="32 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="33 "></span><span class="w">          </span><span class="s2">&quot;rejectedPlans&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="34 "></span><span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="35 "></span><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="36 "></span><span class="w">          </span><span class="s2">&quot;shardName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard0001&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="37 "></span><span class="w">          </span><span class="s2">&quot;connectionString&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;localhost:27001&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="38 "></span><span class="w">          </span><span class="s2">&quot;serverInfo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="39 "></span><span class="w">            </span><span class="s2">&quot;host&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="40 "></span><span class="w">            </span><span class="s2">&quot;port&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">27001</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="41 "></span><span class="w">            </span><span class="s2">&quot;version&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;3.2.1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="42 "></span><span class="w">            </span><span class="s2">&quot;gitVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="43 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="44 "></span><span class="w">          </span><span class="s2">&quot;plannerVersion&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="45 "></span><span class="w">          </span><span class="s2">&quot;namespace&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;expertojava.usuarios&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="46 "></span><span class="w">          </span><span class="s2">&quot;indexFilterSet&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="47 "></span><span class="w">          </span><span class="s2">&quot;parsedQuery&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="48 "></span><span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="49 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="50 "></span><span class="w">          </span><span class="s2">&quot;winningPlan&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="51 "></span><span class="w">            </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SHARDING_FILTER&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="52 "></span><span class="w">            </span><span class="s2">&quot;inputStage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="53 "></span><span class="w">              </span><span class="s2">&quot;stage&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;COLLSCAN&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="54 "></span><span class="w">              </span><span class="s2">&quot;filter&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="55 "></span><span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="56 "></span><span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="57 "></span><span class="w">              </span><span class="s2">&quot;direction&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;forward&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="58 "></span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="59 "></span><span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="60 "></span><span class="w">          </span><span class="s2">&quot;rejectedPlans&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="61 "></span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="62 "></span><span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="linenos" data-linenos="63 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="64 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="65 "></span><span class="w">  </span><span class="s2">&quot;ok&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="linenos" data-linenos="66 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Así pues, si en una consulta no le enviamos la shard key como criterio, mongos enviará la consulta a cada shard y realizará un SHARD_MERGE con la información devuelta de cada shard. Si la consulta contiene la shard key, la consulta se enruta directamente al shard apropiado.</p>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li>asd</li>
</ul>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<p><a href="https://docs.mongodb.com/manual/reference/write-concern/">https://docs.mongodb.com/manual/reference/write-concern/</a>
<a href="https://docs.mongodb.com/manual/reference/read-concern/">https://docs.mongodb.com/manual/reference/read-concern/</a>
<a href="https://docs.mongodb.com/manual/core/read-preference/">https://docs.mongodb.com/manual/core/read-preference/</a></p>
<!--
RDBMS Index vs. MongoDB Index

In RDBMS, indexes are built on any number of columns in a table.

In MongoDB, because there is far less need to bring data together, indexes are mainly used for filtering and sorting, rarely for joining. This leads to lower memory usage for indexes.

Building an index on a set of fields in a collection is the equivalent of having an index that would be built on a set of columns in a table.

And as for traditional relational databases, indexes in MongoDB are also the most important thing to look for to ensure excellent performance.

-->


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        ¿Ha sido útil está página?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Sí, ha sido util" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="La página es mejorable" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
                Gracias por tu colaboración!
              
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
                Gracias por tu colaboración! Ayúdame a mejorarla enviandome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
              
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  

<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input type="checkbox" class="md-toggle" id="__settings">
<div class="md-consent__settings">
  <ul class="task-list">
    
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        <label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);console.log(new FormData(form)),__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow"], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>