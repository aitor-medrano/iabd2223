
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Framework de agregación en MongoDB">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/iabd2223/sa/05agregaciones.html">
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.6">
    
    
      
        <title>Framework de agregación en MongoDB - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-MFP4QLMMV7"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-MFP4QLMMV7",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-MFP4QLMMV7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Framework de agregación en MongoDB - Inteligencia Artificial y Big Data" >
      
        <meta  property="og:description"  content="Framework de agregación en MongoDB" >
      
        <meta  property="og:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/05agregaciones.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://aitor-medrano.github.io/iabd2223/sa/05agregaciones.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Framework de agregación en MongoDB - Inteligencia Artificial y Big Data" >
      
        <meta  name="twitter:description"  content="Framework de agregación en MongoDB" >
      
        <meta  name="twitter:image"  content="https://aitor-medrano.github.io/iabd2223/assets/images/social/sa/05agregaciones.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pipeline-de-agregacion" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Framework de agregación en MongoDB
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="light-blue"  aria-label="Cambiar a modo día"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Cambiar a modo día" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../images/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          UF1 - Toma de decisiones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="UF1 - Toma de decisiones" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          UF1 - Toma de decisiones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">UT2.- Sistemas de almacenamiento</a>
          
            <label for="__nav_2_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="UT2.- Sistemas de almacenamiento" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          UT2.- Sistemas de almacenamiento
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01nosql.html" class="md-nav__link">
        S18.- Almacenamiento de datos. NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02mongo.html" class="md-nav__link">
        S19.- MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="03modelado.html" class="md-nav__link">
        S21.- Modelado de datos NoSQL
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          S25.- Agregaciones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="05agregaciones.html" class="md-nav__link md-nav__link--active">
        S25.- Agregaciones
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-de-agregacion" class="md-nav__link">
    Pipeline de agregación
  </a>
  
    <nav class="md-nav" aria-label="Pipeline de agregación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operadores-del-pipeline" class="md-nav__link">
    Operadores del pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#group" class="md-nav__link">
    $group
  </a>
  
    <nav class="md-nav" aria-label="$group">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acumuladores" class="md-nav__link">
    Acumuladores
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sum" class="md-nav__link">
    $sum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avg" class="md-nav__link">
    $avg
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addtoset" class="md-nav__link">
    $addToSet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#push" class="md-nav__link">
    $push
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max-y-min" class="md-nav__link">
    $max y $min
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#doble-group" class="md-nav__link">
    Doble $group
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first-y-last" class="md-nav__link">
    $first y $last
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project" class="md-nav__link">
    $project
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#match" class="md-nav__link">
    $match
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sort" class="md-nav__link">
    $sort
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skip-y-limit" class="md-nav__link">
    $skip y $limit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unwind" class="md-nav__link">
    $unwind
  </a>
  
    <nav class="md-nav" aria-label="$unwind">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#doble-unwind" class="md-nav__link">
    Doble $unwind
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lookup" class="md-nav__link">
    $lookup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistiendo-los-resultados" class="md-nav__link">
    Persistiendo los resultados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#de-sql-al-pipeline-de-agregaciones" class="md-nav__link">
    De SQL al Pipeline de agregaciones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limitaciones" class="md-nav__link">
    Limitaciones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agregaciones-con-compass" class="md-nav__link">
    Agregaciones con Compass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="06replicacion.html" class="md-nav__link">
        S28.- Replicación y Particionado
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://aitor-medrano.github.io/pia2223/" class="md-nav__link">
        UT7.- PIAFP Lara
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-de-agregacion" class="md-nav__link">
    Pipeline de agregación
  </a>
  
    <nav class="md-nav" aria-label="Pipeline de agregación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operadores-del-pipeline" class="md-nav__link">
    Operadores del pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#group" class="md-nav__link">
    $group
  </a>
  
    <nav class="md-nav" aria-label="$group">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acumuladores" class="md-nav__link">
    Acumuladores
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sum" class="md-nav__link">
    $sum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avg" class="md-nav__link">
    $avg
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addtoset" class="md-nav__link">
    $addToSet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#push" class="md-nav__link">
    $push
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max-y-min" class="md-nav__link">
    $max y $min
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#doble-group" class="md-nav__link">
    Doble $group
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first-y-last" class="md-nav__link">
    $first y $last
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project" class="md-nav__link">
    $project
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#match" class="md-nav__link">
    $match
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sort" class="md-nav__link">
    $sort
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skip-y-limit" class="md-nav__link">
    $skip y $limit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unwind" class="md-nav__link">
    $unwind
  </a>
  
    <nav class="md-nav" aria-label="$unwind">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#doble-unwind" class="md-nav__link">
    Doble $unwind
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lookup" class="md-nav__link">
    $lookup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistiendo-los-resultados" class="md-nav__link">
    Persistiendo los resultados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#de-sql-al-pipeline-de-agregaciones" class="md-nav__link">
    De SQL al Pipeline de agregaciones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limitaciones" class="md-nav__link">
    Limitaciones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agregaciones-con-compass" class="md-nav__link">
    Agregaciones con Compass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>S25.- Agregaciones</h1>

<p>Para poder agrupar datos y realizar cálculos sobre éstos, <em>MongoDB</em> ofrece diferentes alternativas:</p>
<ol>
<li>
<p>Mediante operaciones <em>Map-reduce</em> con la operación <a href="https://www.mongodb.com/docs/manual/core/map-reduce/"><code>mapreduce()</code></a> cuyo uso está <em>deprecated</em> desde <em>MongoBD 5.0</em>.</p>
</li>
<li>
<p>Mediante el uso conjunto de <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/function/"><code>$function</code></a> y <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/accumulator/"><code>$accumulator</code></a> que permiten definir expresiones de agregación mediante <em>JavaScript</em>.</p>
</li>
<li>
<p>Mediante operaciones de agrupación sencilla, como pueden ser las operaciones <code>count()</code> o <code>distinct()</code>.</p>
</li>
<li>
<p>Mediante el uso del <strong>Aggregation Framework</strong>, basado en el uso de <em>pipelines</em>, el cual permite realizar diversas operaciones sobre los datos. Este framework es el mecanismo más eficiente y usable para la realización de agregaciones, y por tanto, en el que nos vamos a centrar en esta sesión.</p>
<p>Para ello, a partir de una colección, mediante el método <a href="https://www.mongodb.com/docs/manual/reference/method/db.collection.aggregate/"><code>aggregate</code></a> le pasaremos un array con las fases a realizar:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="s2">&quot;$fabricante&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">numProductos</span><span class="o">:</span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="p">}}</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$sort</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">numProductos</span><span class="o">:-</span><span class="mf">1</span><span class="p">}}</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="p">])</span><span class="w"></span>
</code></pre></div>
</li>
</ol>
<h2 id="pipeline-de-agregacion">Pipeline de agregación<a class="headerlink" href="#pipeline-de-agregacion" title="Permanent link">&para;</a></h2>
<p>Las agregaciones usan un <em>pipeline</em>, conocido como <strong><em>Aggregation Pipeline</em></strong>, de ahí el uso de un array con <code>[ ]</code> donde cada elemento es una fase del <em>pipeline</em>, de modo que la salida de una fase es la entrada de la siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">coleccion</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="nx">op1</span><span class="p">,</span><span class="w"> </span><span class="nx">op2</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nx">opN</span><span class="p">])</span><span class="w"></span>
</code></pre></div>
<div class="admonition caution">
<p class="admonition-title">Cuidado con el tamaño</p>
<p>El resultado del <em>pipeline</em> es un documento y por lo tanto está sujeto a la restricción de BSON, que limita su tamaño a 16MB.</p>
</div>
<p>En la siguiente imagen se resumen los pasos de una agrupación donde primero se eligen los elementos que vamos a agrupar mediante <code>$match</code>, el resultado saliente se agrupan con <code>$group</code>, y sobre los agrupado mediante <code>$sum</code> se calcula el total:</p>
<figure style="align: center;">
    <img src="images/05aggregation-pipeline.png">
    <figcaption>Ejemplo de pipeline con $match y $group</figcaption>
</figure>

<p>Al realizar un <em>pipeline</em> dividimos las consultas en fases, donde cada fase utiliza un operador para realizar una transformación. Aunque no hay límite en el número de fases en una consulta, es importante destacar que <strong>el orden importa</strong>, y que hay optimizaciones para ayudar a que el <em>pipeline</em> tenga un mejor rendimiento (por ejemplo, hacer un <code>$match</code> al principio para reducir la cantidad de datos)</p>
<h3 id="operadores-del-pipeline">Operadores del pipeline<a class="headerlink" href="#operadores-del-pipeline" title="Permanent link">&para;</a></h3>
<p>Antes de nada destacar que las fases se pueden repetir, por lo que una consulta puede repetir <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/">operadores</a>.</p>
<p>A continuación vamos a estudiar todos estos operadores:</p>
<table>
<thead>
<tr>
<th>Operador</th>
<th>Descripción</th>
<th>Cardinalidad</th>
</tr>
</thead>
<tbody>
<tr>
<td>$project</td>
<td>Proyección de campos, es decir, propiedades en las que estamos interesados. También nos permite modificar un documento, o crear un subdocumento (reshape)</td>
<td>1:1</td>
</tr>
<tr>
<td>$match</td>
<td>Filtrado de campos, similar a where</td>
<td>N:1</td>
</tr>
<tr>
<td>$group</td>
<td>Para agrupar los datos, similar a group by</td>
<td>N:1</td>
</tr>
<tr>
<td>$sort</td>
<td>Ordenar</td>
<td>1:1</td>
</tr>
<tr>
<td>$skip</td>
<td>Saltar</td>
<td>N:1</td>
</tr>
<tr>
<td>$limit</td>
<td>Limitar los resultados</td>
<td>N:1</td>
</tr>
<tr>
<td>$unwind</td>
<td>Separa los datos que hay dentro de un array</td>
<td>1:N</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Preparando los ejemplos</p>
<p>Para los siguientes ejemplos, vamos a utilizar una colección de productos (<a href="resources/productos.js">productos.js</a>) de un tienda de electrónica con las características y precios de los mismos.</p>
<p>Un ejemplo de un producto sería:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">findOne</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;5345afc1176f38ea4eda4787&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="s2">&quot;nombre&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;iPad 16GB Wifi&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="w">  </span><span class="s2">&quot;fabricante&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Apple&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="w">  </span><span class="s2">&quot;categoria&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Tablets&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="7 "></span><span class="w">  </span><span class="s2">&quot;precio&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">499</span><span class="w"></span>
<span class="linenos" data-linenos="8 "></span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Para cargar este archivo desde la consola nos podemos conectar a nuestro cluster y realizar la carga:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>mongosh mongodb+srv://iabd:iabdiabd@cluster0.dfaz5er.mongodb.net/iabd &lt; productos.js
</code></pre></div>
<p>O si ya nos hemos conectado previamente:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">load</span><span class="p">(</span><span class="s2">&quot;productos.js&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<h2 id="group">$group<a class="headerlink" href="#group" title="Permanent link">&para;</a></h2>
<p>La fase <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/group/"><code>group</code></a> agrupa los documentos con el propósito de calcular valores agregados de una colección de documentos. Por ejemplo, podemos usar <code>$group</code> para calcular la media de páginas visitas de manera diaria.</p>
<div class="admonition caution">
<p class="admonition-title">Cuidado</p>
<p>La salida de <code>$group</code> esta desordenada</p>
</div>
<p>La salida de <code>$group</code> depende de cómo se definan los grupos. Se empieza especificando un identificador (por ejemplo, un campo <code>_id</code>) para el grupo que creamos con el <em>pipeline</em>. Para este campo <code>_id</code>, podemos especificar varias expresiones, incluyendo un único campo proveniente de un documento del <em>pipeline</em>, un valor calculado de una fase anterior, un documento con muchos campos y otras expresiones válidas, tales como constantes o campos de subdocumentos. También podemos usar operadores de <code>$project</code> para el campo <code>_id</code>.</p>
<p>Cuando referenciemos al valor de un campo lo haremos poniendo entre comillas un <code>$</code> delante del nombre del campo. Así pues, para referenciar al fabricante de un producto lo haremos mediante <code>$fabricante</code>.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$fabricante&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Si lo que queremos es que el valor del identificador contenga un objeto, lo podemos hacer asociandolo como valor:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$fabricante&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="o">&lt;</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>También podemos agrupar más de un atributo, de tal modo que tengamos un <code>_id</code> compuesto. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$fabricante&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 5 "></span><span class="w">        </span><span class="s2">&quot;tipo&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$categoria&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Smartphones&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Siempre <code>_id</code></p>
<p>Cada expresión de <code>$group</code> debe especificar un campo <code>_id</code>.</p>
</div>
<h3 id="acumuladores">Acumuladores<a class="headerlink" href="#acumuladores" title="Permanent link">&para;</a></h3>
<p>Además del campo <code>_id</code>, la expresión <code>$group</code> puede incluir campos calculados. Estos otros campos deben utilizar uno de los siguientes <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/group/#accumulator-operator">acumuladores</a>.</p>
<table>
<thead>
<tr>
<th>Nombre</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$addToSet</code></td>
<td>Devuelve un array con todos los valores únicos para los campos seleccionados entre cada documento del grupo (sin repeticiones)</td>
</tr>
<tr>
<td><code>$first</code></td>
<td>Devuelve el primer valor del grupo. Se suele usar después de ordenar.</td>
</tr>
<tr>
<td><code>$last</code></td>
<td>Devuelve el último valor del grupo. Se suele usar después de ordenar.</td>
</tr>
<tr>
<td><code>$max</code></td>
<td>Devuelve el mayor valor de un grupo</td>
</tr>
<tr>
<td><code>$min</code></td>
<td>Devuelve el menor valor de un grupo.</td>
</tr>
<tr>
<td><code>$avg</code></td>
<td>Devuelve el promedio de todos los valores de un grupo</td>
</tr>
<tr>
<td><code>$push</code></td>
<td>Devuelve un array con todos los valores del campo seleccionado entre cada documento del grupo (puede haber repeticiones)</td>
</tr>
<tr>
<td><code>$sum</code></td>
<td>Devuelve la suma de todos los valores del grupo</td>
</tr>
</tbody>
</table>
<p>A continuación vamos a ver ejemplos de cada uno de estos acumuladores.</p>
<h3 id="sum">$sum<a class="headerlink" href="#sum" title="Permanent link">&para;</a></h3>
<p>El operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/sum/"><code>$sum</code></a> acumula los valores y devuelve la suma.</p>
<p>Por ejemplo, para obtener el montante total de los productos agrupados por fabricante, haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$fabricante&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="s2">&quot;$precio&quot;</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">2296</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">1014.98</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">499</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">199</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">328</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="avg">$avg<a class="headerlink" href="#avg" title="Permanent link">&para;</a></h3>
<p>Mediante <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/avg/"><code>$avg</code></a> podemos obtener el promedio de los valores de un campo numérico.</p>
<p>Por ejemplo, para obtener el precio medio de los productos agrupados por categoría, haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="s2">&quot;categoria&quot;</span><span class="o">:</span><span class="s2">&quot;$categoria&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$avg</span><span class="o">:</span><span class="s2">&quot;$precio&quot;</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Smartphones&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">563.99</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">499</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">396.4271428571428</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="addtoset">$addToSet<a class="headerlink" href="#addtoset" title="Permanent link">&para;</a></h3>
<p>Mediante <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/addToSet/"><code>$addToSet</code></a>  obtendremos un array con todos los valores únicos para los campos seleccionados entre cada documento del grupo (sin repeticiones).</p>
<p>Por ejemplo, para obtener para cada empresa las categorías en las que tienen productos, haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="s2">&quot;fabricante&quot;</span><span class="o">:</span><span class="s2">&quot;$fabricante&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$addToSet</span><span class="o">:</span><span class="s2">&quot;$categoria&quot;</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Smartphones&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="push">$push<a class="headerlink" href="#push" title="Permanent link">&para;</a></h3>
<p>Mediante <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/push/"><code>$push</code></a> también obtendremos un array con todos los valores para los campos seleccionados entre cada documento del grupo, pero con repeticiones. Es decir, funciona de manera similar a <code>$addToSet</code> pero permitiendo elementos repetidos.</p>
<p>Por ello, si reescribimos la consulta anterior pero haciendo uso de <code>$push</code> obtendremos categorías repetidas:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="s2">&quot;$fabricante&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$push</span><span class="o">:</span><span class="s2">&quot;$categoria&quot;</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Smartphones&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">categorias</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="max-y-min">$max y $min<a class="headerlink" href="#max-y-min" title="Permanent link">&para;</a></h3>
<p>Los operadores <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/max/"><code>$max</code></a> y <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/min/"><code>$min</code></a> permiten obtener el mayor y el menor valor, respectivamente, del campo por el que se agrupan los documentos.</p>
<p>Por ejemplo, para obtener el precio del producto más caro que tiene cada empresa haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="s2">&quot;$fabricante&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nx">precioMaximo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$max</span><span class="o">:</span><span class="s2">&quot;$precio&quot;</span><span class="p">},</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="nx">precioMinimo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$min</span><span class="o">:</span><span class="s2">&quot;$precio&quot;</span><span class="p">},</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;empresa&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Amazon&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;precioMaximo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">199</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;precioMinimo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">129</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;empresa&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Sony&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;precioMaximo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">499</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;precioMinimo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">499</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;empresa&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Samsung&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;precioMaximo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">563.99</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;precioMinimo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">450.99</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;empresa&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Google&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;precioMaximo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">199</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;precioMinimo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">199</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;empresa&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Apple&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;precioMaximo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">699</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;precioMinimo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">499</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="doble-group">Doble $group<a class="headerlink" href="#doble-group" title="Permanent link">&para;</a></h3>
<p>Si queremos obtener el resultado de una agrupación podemos aplicar el operador <code>$group</code> sobre otro <code>$group</code>.</p>
<p>Por ejemplo, para obtener el precio medio de los precios medios de los tipos de producto por empresa haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="s2">&quot;$fabricante&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">        </span><span class="s2">&quot;categoria&quot;</span><span class="o">:</span><span class="s2">&quot;$categoria&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$avg</span><span class="o">:</span><span class="s2">&quot;$precio&quot;</span><span class="p">}</span><span class="w"> </span><span class="c1">// (1)!</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="linenos" data-linenos="11 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$_id.empresa&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">      </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$avg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$precioMedio&quot;</span><span class="p">}</span><span class="w"> </span><span class="c1">// (2)!</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">199</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">499</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">507.49</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">549</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">precioMedio</span><span class="o">:</span><span class="w"> </span><span class="mf">164</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Precio medio por empresa y categoría</li>
<li>Precio medio por empresa en base al precio medio anterior</li>
</ol>
<h3 id="first-y-last">$first y $last<a class="headerlink" href="#first-y-last" title="Permanent link">&para;</a></h3>
<p>Estos operadores devuelven el valor resultante de aplicar la expresión al primer (<a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/first">$first</a>) y/o último (<a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/last">$last</a>) elemento de un grupo de documentos que comparten el mismo grupo por clave.</p>
<p>Por ejemplo, para obtener para cada empresa, cual es el tipo de producto que más tiene y la cantidad de dicho tipo haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$fabricante&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">      </span><span class="s2">&quot;tipo&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$categoria&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$sort</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="o">:-</span><span class="mf">1</span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="s2">&quot;$_id.empresa&quot;</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="12 "></span><span class="w">      </span><span class="nx">producto</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$first</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$_id.tipo&quot;</span><span class="p">},</span><span class="w">  </span><span class="c1">// (1)!</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="13 "></span><span class="w">      </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$first</span><span class="o">:</span><span class="s2">&quot;$total&quot;</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sony&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">producto</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Portátiles&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">producto</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">producto</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">producto</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="21 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">producto</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Al agrupar por empresa, elegimos la categoría de producto que tiene más unidades</li>
</ol>
<h2 id="project">$project<a class="headerlink" href="#project" title="Permanent link">&para;</a></h2>
<p>Si queremos realizar una proyección sobre el conjunto de resultados y quedarnos con un subconjunto de los campos usaremos el operador <code>[</code>$project`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/). Como resultado obtendremos el mismo número de documentos, y en el orden indicado en la proyección.</p>
<p>La proyección dentro del framework de agregación es mucho más potente que dentro de las consultas normales. Se emplea para:</p>
<ul>
<li>renombrar campos.</li>
<li>introducir campos calculados en el documento resultante mediante <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/add/"><code>$add</code></a>, <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/subtract/"><code>$substract</code></a>, <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/multiply/"><code>$multiply</code></a>, <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/divide/"><code>$divide</code></a> o <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/mod/"><code>$mod</code></a></li>
<li>transformar campos a mayúsculas <code>$toUpper</code> o minúsculas <code>$toLower</code>, concatenar campos mediante <code>$concat</code> u obtener subcadenas con <code>$substr</code>.</li>
<li>transformar campos en base a valores obtenidos a partir de una condición mediante expresiones lógicas con los operadores de comparación vistos en las consultas.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$project</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// (1)!</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">      </span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;$toUpper&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$fabricante&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// (2)!</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="s2">&quot;detalles&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)!</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="s2">&quot;categoria&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$categoria&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="s2">&quot;precio&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;$multiply&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;$precio&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.1</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// (4)!</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">      </span><span class="s2">&quot;elemento&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$nombre&quot;</span><span class="w"> </span><span class="c1">// (5)!</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPLE&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nx">detalles</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="mf">548.9000000000001</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nx">elemento</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iPad 16GB Wifi&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPLE&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="nx">detalles</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="mf">658.9000000000001</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="nx">elemento</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iPad 32GB Wifi&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="20 "></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Ocultamos el campo <code>_id</code></li>
<li>Transforma un campo y lo pasa a mayúsculas</li>
<li>Crea un documento anidado</li>
<li>Incrementa el precio el 10%</li>
<li>Renombra el campo</li>
</ol>
<h2 id="match">$match<a class="headerlink" href="#match" title="Permanent link">&para;</a></h2>
<p>El operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/match/"><code>$match</code></a> se utiliza principalmente para filtrar los documentos que pasarán a la siguiente etapa del <em>pipeline</em> o a la salida final.</p>
<p>Por ejemplo, para seleccionar sólo las tablets haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="nx">$match</span><span class="o">:</span><span class="p">{</span><span class="nx">categoria</span><span class="o">:</span><span class="s2">&quot;Tablets&quot;</span><span class="p">}}])</span><span class="w"></span>
</code></pre></div>
<p>Aparte de igualar un valor a un campo, podemos emplear los operadores usuales de consulta, como <code>$gt</code>, <code>$lt</code>, <code>$in</code>, etc…​</p>
<p>Se recomienda poner el operador <code>match</code> al principio del pipeline para limitar los documentos a procesar en siguientes fases. Si usamos este operador como primera fase podremos hacer uso de los indices de la colección de una manera eficiente.</p>
<p>Así pues, para obtener la cantidad de Tablets de menos de 500 euros haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="p">{</span><span class="nx">$match</span><span class="o">:</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="p">{</span><span class="nx">categoria</span><span class="o">:</span><span class="s2">&quot;Tablets&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$lt</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">}}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="s2">&quot;$fabricante&quot;</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="p">}}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">cantidad</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h2 id="sort">$sort<a class="headerlink" href="#sort" title="Permanent link">&para;</a></h2>
<p>El operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/sort/"><code>$sort</code></a> ordena los documentos recibidos por el campo, y el orden indicado por la expresión indicada al pipeline.</p>
<p>Por ejemplo, para ordenar los productos por precio descendentemente haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">({</span><span class="nx">$sort</span><span class="o">:</span><span class="p">{</span><span class="nx">precio</span><span class="o">:-</span><span class="mf">1</span><span class="p">}})</span><span class="w"></span>
</code></pre></div>
<p>El operador <code>$sort</code> ordena los datos en memoria, por lo que hay que tener cuidado con el tamaño de los datos. Por ello, se emplea en las últimas fases del pipeline, cuando el conjunto de resultados es el menor posible.</p>
<p>Si retomamos el ejemplo anterior, y ordenamos los datos por el precio total tenemos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="p">{</span><span class="nx">$match</span><span class="o">:</span><span class="p">{</span><span class="nx">categoria</span><span class="o">:</span><span class="s2">&quot;Tablets&quot;</span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;empresa&quot;</span><span class="o">:</span><span class="s2">&quot;$fabricante&quot;</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">      </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="s2">&quot;$precio&quot;</span><span class="p">}}</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">{</span><span class="nx">$sort</span><span class="o">:</span><span class="p">{</span><span class="nx">totalPrecio</span><span class="o">:-</span><span class="mf">1</span><span class="p">}}</span><span class="w">   </span><span class="c1">// (1)!</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">1797</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">450.99</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amazon&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">328</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">empresa</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Google&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">totalPrecio</span><span class="o">:</span><span class="w"> </span><span class="mf">199</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Al ordenar los datos, referenciamos al campo que hemos creado en la fase de $group</li>
</ol>
<p>FIXME: sortByCount</p>
<h2 id="skip-y-limit">$skip y $limit<a class="headerlink" href="#skip-y-limit" title="Permanent link">&para;</a></h2>
<p>El operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/limit/"><code>$limit</code></a> únicamente limita el número de documentos que pasan a través del pipeline.</p>
<p>El operador recibe un número como parámetro:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="nx">$limit</span><span class="o">:</span><span class="mf">3</span><span class="p">}])</span><span class="w"></span>
</code></pre></div>
<p>Este operador no modifica los documentos, sólo restringe quien pasa a la siguiente fase.</p>
<p>De manera similar, con el operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/skip/"><code>$skip</code></a>, saltamos un número determinado de documentos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="nx">$skip</span><span class="o">:</span><span class="mf">3</span><span class="p">}])</span><span class="w"></span>
</code></pre></div>
<p>El orden en el que empleemos estos operadores importa, y mucho, ya que no es lo mismo saltar y luego limitar, donde la cantidad de elementos la fija <code>$limit</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="nx">$skip</span><span class="o">:</span><span class="mf">2</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nx">$limit</span><span class="o">:</span><span class="mf">3</span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635194b32e6059646a8e7fee&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iPad 64GB Wifi&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="mf">699</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635194b32e6059646a8e7fef&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Galaxy S3&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Smartphones&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="mf">563.99</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635194b32e6059646a8e7ff0&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Galaxy Tab 10&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="mf">450.99</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>En cambio, si primero limitamos y luego saltamos, la cantidad de elementos se obtiene de la diferencia entre el límite y el salto:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span><span class="nx">$limit</span><span class="o">:</span><span class="mf">3</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nx">$skip</span><span class="o">:</span><span class="mf">2</span><span class="p">}])</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635194b32e6059646a8e7fee&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;iPad 64GB Wifi&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="nx">categoria</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tablets&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="w">    </span><span class="nx">fabricante</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="w">    </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="mf">699</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">$sample</p>
<p>Si tenemos un dataset muy grande, y queremos probar las consultas con un número reducido de documentos, podemos emplear el operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/sample/"><code>$sample</code></a> y reducir la cantidad de documentos de manera aleatoria:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">productos</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$sample</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">])</span><span class="w"></span>
</code></pre></div>
</div>
<h2 id="unwind">$unwind<a class="headerlink" href="#unwind" title="Permanent link">&para;</a></h2>
<p>El operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/unwind/"><code>$unwind</code></a> es muy interesante y se utiliza solo con operadores array. Al usarlo con un campo array de tamaño N en un documento, lo transforma en N documentos con el campo tomando el valor individual de cada uno de los elementos del array.</p>
<p>Si retomamos el ejemplo de la sesión donde actualizábamos una colección de enlaces, teníamos un enlace con la siguiente información:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">enlaces</span><span class="p">.</span><span class="nx">findOne</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635533668420cd585aac88f3&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;www.google.es&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;mapas&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;videos&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;blog&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;calendario&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;email&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;mapas&#39;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Podemos observar como el campo <code>tags</code> contiene 6 valores dentro del array (con un valor repetido). A continuación vamos a desenrollar el array:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">enlaces</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$match</span><span class="o">:</span><span class="p">{</span><span class="nx">titulo</span><span class="o">:</span><span class="s2">&quot;www.google.es&quot;</span><span class="p">}},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span><span class="s2">&quot;$tags&quot;</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 4 "></span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635533668420cd585aac88f3&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;www.google.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;mapas&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635533668420cd585aac88f3&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;www.google.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;videos&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635533668420cd585aac88f3&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;www.google.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;blog&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635533668420cd585aac88f3&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;www.google.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;calendario&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635533668420cd585aac88f3&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;www.google.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;email&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;635533668420cd585aac88f3&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;www.google.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;mapas&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Así pues hemos obtenido 6 documentos con el mismo <code>_id</code> y <code>titulo</code>, es decir, un documento por elemento del array.</p>
<p>De este modo, podemos realizar consultas que sumen/cuenten los elementos del array. Por ejemplo, si queremos obtener las 3 etiquetas que más aparecen en todos los enlaces haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">enlaces</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="s2">&quot;$unwind&quot;</span><span class="o">:</span><span class="s2">&quot;$tags&quot;</span><span class="p">},</span><span class="w"></span>
</span><span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">   </span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;$tags&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="s2">&quot;total&quot;</span><span class="o">:</span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">{</span><span class="s2">&quot;$sort&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="o">:-</span><span class="mf">1</span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">{</span><span class="s2">&quot;$limit&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;mapas&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;blog&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;calendario&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="doble-unwind">Doble $unwind<a class="headerlink" href="#doble-unwind" title="Permanent link">&para;</a></h3>
<p>Si trabajamos con documentos que tienen varios arrays, podemos necesitar desenrollar los dos array. Al hacer un doble unwind se crea un producto cartesiano entre los elementos de los 2 arrays.</p>
<p>Supongamos que tenemos los datos del siguiente inventario de ropa:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">inventario</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">inventario</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="s1">&#39;nombre&#39;</span><span class="o">:</span><span class="s2">&quot;Camiseta&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">                           </span><span class="s1">&#39;tallas&#39;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;L&quot;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">                           </span><span class="s1">&#39;colores&#39;</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;azul&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;blanco&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;naranja&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;rojo&#39;</span><span class="p">]})</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">inventario</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="s1">&#39;nombre&#39;</span><span class="o">:</span><span class="s2">&quot;Jersey&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">                           </span><span class="s1">&#39;tallas&#39;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;L&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;XL&quot;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">                           </span><span class="s1">&#39;colores&#39;</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;azul&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;negro&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;naranja&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;rojo&#39;</span><span class="p">]})</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">inventario</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="s1">&#39;nombre&#39;</span><span class="o">:</span><span class="s2">&quot;Pantalones&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">                           </span><span class="s1">&#39;tallas&#39;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;32x32&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;32x30&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;36x32&quot;</span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">                           </span><span class="s1">&#39;colores&#39;</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;azul&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;blanco&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;naranja&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;negro&#39;</span><span class="p">]})</span><span class="w"></span>
</code></pre></div>
<p>Para obtener un listado de cantidad de pares talla/color haríamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">inventario</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$tallas&quot;</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$colores&quot;</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;talla&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$tallas&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$colores&#39;</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="s1">&#39;total&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;$sum&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">])</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;talla&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;XL&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;color&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;rojo&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;total&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;talla&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;XL&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;color&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;negro&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;total&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;talla&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;L&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;color&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;negro&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;total&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;talla&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;color&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;negro&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;total&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="p">...</span><span class="w"></span>
</code></pre></div>
<h2 id="lookup">$lookup<a class="headerlink" href="#lookup" title="Permanent link">&para;</a></h2>
<p>Si necesitamos unir los datos de dos colecciones, emplearemos el operador <a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/">$lookup</a>, el cual realiza un <em>left outer join</em> a una colección de la misma base de datos para filtrar los documentos de la colección <em>joineada</em>.</p>
<p>El resultado es un nuevo campo array para cada documento de entrada, el cual contiene los documentos que cumplen el criterio del <em>join</em>.</p>
<p>El operador <code>$lookup</code> utiliza cuatro parámetros:</p>
<ul>
<li><code>from</code>: colección con la que se realiza el <em>join</em>.</li>
<li><code>localField</code>: campo de la colección origen (sería la clave ajena).</li>
<li><code>foreignField</code>: campo en la colección destino que permite la unión (sería la clave primaria de la otra colección).</li>
<li><code>as</code>: nombre del array que contendrá los documentos enlazados.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Preparando los datos</p>
<p>Vamos a utilizar la colección <code>zips</code> empleada en anteriores sesiones la cual tiene una estructura similar a:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;5c8eccc1caa187d17ca6ed18&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="err">ci</span><span class="kc">t</span><span class="err">y</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;ACMAR&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">  </span><span class="err">zip</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">35004</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">  </span><span class="err">loc</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">y</span><span class="p">:</span><span class="w"> </span><span class="mf">33.584132</span><span class="p">,</span><span class="w"> </span><span class="err">x</span><span class="p">:</span><span class="w"> </span><span class="mf">86.51557</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="w">  </span><span class="err">pop</span><span class="p">:</span><span class="w"> </span><span class="mi">6055</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="w">  </span><span class="err">s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;AL&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>A continuación vamos a crear una nueva colección llamada <code>state</code> con el nombre de los estados (<a href="resources/states.js">states.js</a>), la cual cargaremos en la base de datos <code>sample_training</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">insertMany</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Alabama&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="s2">&quot;abbreviation&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;AL&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">      </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Alaska&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">      </span><span class="s2">&quot;abbreviation&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;AK&quot;</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="p">])</span><span class="w"></span>
</code></pre></div>
</div>
<p>Vamos a estudiar como funciona el operador <code>$lookup</code> mediante un ejemplo. Primero vamos a recuperar los tres estados más poblados. Para ello, podríamos hacer la siguiente consulta agregada:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Consulta</label><label for="__tabbed_1_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">zips</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$state&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">      </span><span class="s2">&quot;totalPoblacion&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="s2">&quot;$pop&quot;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="5 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos="6 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$sort</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;totalPoblacion&quot;</span><span class="o">:-</span><span class="mf">1</span><span class="p">}}</span><span class="w"> </span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="7 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$limit</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">}</span><span class="w">  </span>
<span class="linenos" data-linenos="8 "></span><span class="p">])</span><span class="w"></span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;CA&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">29760021</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;NY&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">17990455</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;TX&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">16986510</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<p>Si ahora queremos recuperar el nombre de esos tres estados, añadimos una nueva fase:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">zips</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$state&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="s2">&quot;totalPoblacion&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="s2">&quot;$pop&quot;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$sort</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;totalPoblacion&quot;</span><span class="o">:-</span><span class="mf">1</span><span class="p">}}</span><span class="w"> </span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$limit</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$lookup</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;states&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nx">localField</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="nx">foreignField</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;abbreviation&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="kr">as</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;estados&quot;</span><span class="w"></span>
</span><span class="hll"><span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">}},</span><span class="w">    </span>
</span><span class="linenos" data-linenos="14 "></span><span class="p">])</span><span class="w"></span>
</code></pre></div>
<p>Y ahora obtenemos para cada documento, un array con los documentos que coinciden (en este caso es una relación 1:1, y por eso cada array sólo contiene un elemento):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;CA&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">29760021</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="err">es</span><span class="kc">ta</span><span class="err">dos</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">   </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;63565cd82889ecee358e0cd5&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">       </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Cali</span><span class="kc">f</span><span class="err">or</span><span class="kc">n</span><span class="err">ia&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">       </span><span class="err">abbrevia</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;CA&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;NY&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">17990455</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="err">es</span><span class="kc">ta</span><span class="err">dos</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos="10 "></span><span class="w">   </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;63565cd82889ecee358e0cf4&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">       </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;New</span><span class="w"> </span><span class="err">York&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">       </span><span class="err">abbrevia</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;NY&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;TX&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">16986510</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="err">es</span><span class="kc">ta</span><span class="err">dos</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos="16 "></span><span class="w">   </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;63565cd82889ecee358e0d02&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">       </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Texas&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">       </span><span class="err">abbrevia</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;TX&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Como la relación siempre va a provocar la creación de un array, mediante <code>$unwind</code>, lo podemos deshacer:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Consulta</label><label for="__tabbed_2_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">zips</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$state&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="s2">&quot;totalPoblacion&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="s2">&quot;$pop&quot;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$sort</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;totalPoblacion&quot;</span><span class="o">:-</span><span class="mf">1</span><span class="p">}}</span><span class="w"> </span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$limit</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$lookup</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;states&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="nx">localField</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="nx">foreignField</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;abbreviation&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="kr">as</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;estados&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">}},</span><span class="w">    </span>
<span class="hll"><span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span><span class="s2">&quot;$estados&quot;</span><span class="p">}</span><span class="w"></span>
</span><span class="linenos" data-linenos="15 "></span><span class="p">])</span><span class="w"></span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;CA&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">29760021</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="err">es</span><span class="kc">ta</span><span class="err">dos</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;63565cd82889ecee358e0cd5&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Cali</span><span class="kc">f</span><span class="err">or</span><span class="kc">n</span><span class="err">ia&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="err">abbrevia</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;CA&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;NY&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">17990455</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="err">es</span><span class="kc">ta</span><span class="err">dos</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;63565cd82889ecee358e0cf4&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;New</span><span class="w"> </span><span class="err">York&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="err">abbrevia</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;NY&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;TX&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="kc">t</span><span class="err">o</span><span class="kc">tal</span><span class="err">Poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">16986510</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="err">es</span><span class="kc">ta</span><span class="err">dos</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;63565cd82889ecee358e0d02&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Texas&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="err">abbrevia</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;TX&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
<p>Así pues, para finalmente obtener el nombre de cada estado, mediante <code>$project</code> recuperamos el campo <code>name</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="err">db.zips.aggrega</span><span class="kc">te</span><span class="err">(</span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="err">$group</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$state&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="nt">&quot;totalPoblacion&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">$sum</span><span class="p">:</span><span class="s2">&quot;$pop&quot;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">{</span><span class="err">$sor</span><span class="kc">t</span><span class="p">:{</span><span class="nt">&quot;totalPoblacion&quot;</span><span class="p">:</span><span class="mi">-1</span><span class="p">}}</span><span class="w"> </span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">{</span><span class="err">$limi</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">},</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">{</span><span class="err">$lookup</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="kc">fr</span><span class="err">om</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;states&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="err">localField</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="kc">f</span><span class="err">oreig</span><span class="kc">n</span><span class="err">Field</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abbreviation&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="err">as</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;estados&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="p">{</span><span class="err">$u</span><span class="kc">n</span><span class="err">wi</span><span class="kc">n</span><span class="err">d</span><span class="p">:</span><span class="s2">&quot;$estados&quot;</span><span class="p">},</span><span class="w">  </span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="p">{</span><span class="err">$projec</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="nt">&quot;estado&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$estados.name&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="nt">&quot;poblacion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$totalPoblacion&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="18 "></span><span class="w">  </span><span class="p">}}</span><span class="w">    </span>
<span class="linenos" data-linenos="19 "></span><span class="p">]</span><span class="err">)</span><span class="w"></span>
</code></pre></div>
<p>Obteniendo el resultado deseado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;CA&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">es</span><span class="kc">ta</span><span class="err">do</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Cali</span><span class="kc">f</span><span class="err">or</span><span class="kc">n</span><span class="err">ia&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">29760021</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;NY&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">es</span><span class="kc">ta</span><span class="err">do</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;New</span><span class="w"> </span><span class="err">York&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">17990455</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;TX&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">es</span><span class="kc">ta</span><span class="err">do</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Texas&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">poblacio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="mi">16986510</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h2 id="persistiendo-los-resultados">Persistiendo los resultados<a class="headerlink" href="#persistiendo-los-resultados" title="Permanent link">&para;</a></h2>
<p>Una vez hemos realizado nuestras consultas mediante el framework de agregación, es muy posible que queramos almacenar el resultado en una nueva colección para poder volver a consultar el resultado sin necesidad de ejecutar todas las fases.</p>
<p>Para ello, podemos emplear los operadores:</p>
<ul>
<li><a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/out/"><code>$out</code></a> recoge los documentos de una agregación y los persiste en una colección, sobrescribiendo los datos existentes.</li>
<li><a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation/merge/"><code>$merge</code></a> similar a <code>$out</code>, pero permite añadir el resultado a la misma colección y además soporta trabajar con colecciones particionadas.</li>
</ul>
<p>Por ejemplo, vamos a basarnos en las consultas con <em>join</em>, para crear una nueva colección con la población total de todos dos estados, y la vamos a almacenar en una nueva colección denominada <code>states_population</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="err">db.zips.aggrega</span><span class="kc">te</span><span class="err">(</span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="err">$group</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$state&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="nt">&quot;totalPoblacion&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">$sum</span><span class="p">:</span><span class="s2">&quot;$pop&quot;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">{</span><span class="err">$lookup</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="kc">fr</span><span class="err">om</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;states&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="err">localField</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="kc">f</span><span class="err">oreig</span><span class="kc">n</span><span class="err">Field</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abbreviation&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="err">as</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;estados&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="err">$u</span><span class="kc">n</span><span class="err">wi</span><span class="kc">n</span><span class="err">d</span><span class="p">:</span><span class="s2">&quot;$estados&quot;</span><span class="p">},</span><span class="w">  </span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="err">$projec</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="nt">&quot;estado&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$estados.name&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nt">&quot;poblacion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$totalPoblacion&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="hll"><span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="p">{</span><span class="err">$ou</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;states_population&quot;</span><span class="p">}</span><span class="w">    </span>
</span><span class="linenos" data-linenos="18 "></span><span class="p">]</span><span class="err">)</span><span class="w"></span>
</code></pre></div>
<p>Tras su ejecución, podemos recuperar los datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">states_population</span><span class="p">.</span><span class="nx">findOne</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;WY&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">estado</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Wyoming&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">poblacion</span><span class="o">:</span><span class="w"> </span><span class="mf">453588</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h2 id="de-sql-al-pipeline-de-agregaciones">De SQL al Pipeline de agregaciones<a class="headerlink" href="#de-sql-al-pipeline-de-agregaciones" title="Permanent link">&para;</a></h2>
<p>Ya hemos visto que el pipeline ofrece operadores para realizar la misma funcionalidad de agrupación que ofrece SQL.</p>
<p>Si relacionamos los comandos SQL con el pipeline de agregaciones tenemos las siguientes equivalencias:</p>
<table>
<thead>
<tr>
<th>SQL</th>
<th>Pipeline de Agregaciones</th>
</tr>
</thead>
<tbody>
<tr>
<td>WHERE</td>
<td>$match</td>
</tr>
<tr>
<td>GROUP BY</td>
<td>$group</td>
</tr>
<tr>
<td>HAVING</td>
<td>$match</td>
</tr>
<tr>
<td>SELECT</td>
<td>$project</td>
</tr>
<tr>
<td>ORDER BY</td>
<td>$sort</td>
</tr>
<tr>
<td>LIMIT</td>
<td>$limit</td>
</tr>
<tr>
<td>SUM()</td>
<td>$sum</td>
</tr>
<tr>
<td>COUNT()</td>
<td>$sum / $sortByCount</td>
</tr>
<tr>
<td>join</td>
<td>$lookup</td>
</tr>
</tbody>
</table>
<p>Podemos encontrar ejemplos de consultas SQL transformadas al pipeline en <a href="https://www.mongodb.com/docs/manual/reference/sql-aggregation-comparison/">https://www.mongodb.com/docs/manual/reference/sql-aggregation-comparison/</a></p>
<h2 id="limitaciones">Limitaciones<a class="headerlink" href="#limitaciones" title="Permanent link">&para;</a></h2>
<p>Hay que tener en cuenta las siguiente limitaciones:</p>
<ul>
<li>En versiones anteriores a la 2.6, el pipeline devolvía en cada fase un objeto BSON, y por tanto, el resultado estaba limitado a 16MB</li>
<li>Actualmente, sólo cada documento que forme parte del resultado final debe ocupar menos de 16MB.</li>
<li>Las fases tienen un límite de 100MB en memoria. Si una fase excede dicho límite, se producirá un error. En este caso, hay que habilitar el uso de disco mediante <code>allowDiskUse</code> en las opciones de la agregación.</li>
</ul>
<p>Más información en <a href="https://www.mongodb.com/docs/manual/core/aggregation-pipeline-limits/">https://www.mongodb.com/docs/manual/core/aggregation-pipeline-limits/</a></p>
<h2 id="agregaciones-con-compass">Agregaciones con Compass<a class="headerlink" href="#agregaciones-con-compass" title="Permanent link">&para;</a></h2>
<p>MongoDB Compass nos ofrece la herramienta <a href="https://docs.mongodb.com/compass/master/aggregation-pipeline-builder/">Aggregation Pipeline Builder</a> para crear, borrar y reorganizar fácilmente fases en un pipeline, así como evaluar los documento resultantes en tiempo real.</p>
<p>Vamos a practicar con la colección de <code>zips</code>:</p>
<figure style="align: center;">
    <img src="images/05compass-aggregations.png">
    <figcaption>Agregaciones en MongoDB Compass</figcaption>
</figure>

<p>Y vamos a reproducir la consulta con <code>$lookup</code> que acabamos de realizar, pero en nuestro caso, iremos paso a paso:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="err">db.zips.aggrega</span><span class="kc">te</span><span class="err">(</span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="err">$group</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">      </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$state&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">      </span><span class="nt">&quot;totalPoblacion&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">$sum</span><span class="p">:</span><span class="s2">&quot;$pop&quot;</span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="p">{</span><span class="err">$lookup</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="kc">fr</span><span class="err">om</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;states&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="err">localField</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="kc">f</span><span class="err">oreig</span><span class="kc">n</span><span class="err">Field</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abbreviation&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="err">as</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;estados&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="p">{</span><span class="err">$u</span><span class="kc">n</span><span class="err">wi</span><span class="kc">n</span><span class="err">d</span><span class="p">:</span><span class="s2">&quot;$estados&quot;</span><span class="p">},</span><span class="w">  </span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="p">{</span><span class="err">$projec</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="nt">&quot;estado&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$estados.name&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="nt">&quot;poblacion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$totalPoblacion&quot;</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="p">}}</span><span class="w"> </span>
<span class="linenos" data-linenos="17 "></span><span class="p">]</span><span class="err">)</span><span class="w"></span>
</code></pre></div>
<p>Para ello, pulsamos sobre el botón de <em>Add Stage</em>, seleccionamos el operador <code>$group</code> y escribimos la expresión de agrupación. Al hacerlo, en el panel anexo aparecerán 10 documentos de muestra con el resultado de ejecutar dicha fase:</p>
<figure style="align: center;">
    <img src="images/05compass-group.gif">
    <figcaption>$group en MongoDB Compass</figcaption>
</figure>

<p>Paso a paso, iremos añadiendo el resto de fases hasta tenerlas todas, pudiendo ver los datos que va generando cada fase:</p>
<figure style="align: center;">
    <img src="images/05compass-result.gif">
    <figcaption>Resultado en MongoDB Compass</figcaption>
</figure>

<p>Una vez tenemos nuestra agregación, podemos obtener una versión del <em>pipeline</em> en Python, Java, C# o Node.js, mediante la opción <a href="https://docs.mongodb.com/compass/master/export-pipeline-to-language"><em>Export-to-Language</em></a>.</p>
<figure style="align: center;">
    <img src="images/05compass-export.png">
    <figcaption>Exportando la agregación a PyMongo</figcaption>
</figure>

<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li>Documentación oficial del <a href="https://www.mongodb.com/docs/manual/core/aggregation-pipeline/">Aggregation Framework</a>.</li>
<li>Curso <a href="https://university.mongodb.com/courses/M121/about">M121: The MongoDB Aggregation Framework</a> de la Mongo University.</li>
<li>Libro <a href="https://www.practical-mongodb-aggregations.com/"><em>Practical MongoDB Aggregations</em></a></li>
</ul>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<p>Para las siguientes actividades, vamos a utilizar la base de datos <code>sample_mflix</code>, y en concreto, las colecciones <code>movies</code> . Un documento de ejemplo sería similar a:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">movies</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">Objec</span><span class="kc">t</span><span class="err">Id(</span><span class="s2">&quot;573a1390f29313caabcd548c&quot;</span><span class="err">)</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="err">plo</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;The</span><span class="w"> </span><span class="err">Civil</span><span class="w"> </span><span class="err">War</span><span class="w"> </span><span class="err">divides</span><span class="w"> </span><span class="err">...&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="err">ge</span><span class="kc">nres</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">&#39;Drama&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;His</span><span class="kc">t</span><span class="err">ory&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;Roma</span><span class="kc">n</span><span class="err">ce&#39;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="err">ru</span><span class="kc">nt</span><span class="err">ime</span><span class="p">:</span><span class="w"> </span><span class="mi">165</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="err">ra</span><span class="kc">te</span><span class="err">d</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;NOT</span><span class="w"> </span><span class="err">RATED&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="err">cas</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="err">&#39;Lillia</span><span class="kc">n</span><span class="w"> </span><span class="err">Gish&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="err">&#39;Mae</span><span class="w"> </span><span class="err">Marsh&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="err">&#39;He</span><span class="kc">nr</span><span class="err">y</span><span class="w"> </span><span class="err">B.</span><span class="w"> </span><span class="err">Wal</span><span class="kc">t</span><span class="err">hall&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="err">&#39;Miriam</span><span class="w"> </span><span class="err">Cooper&#39;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="err">pos</span><span class="kc">ter</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;h</span><span class="kc">tt</span><span class="err">ps</span><span class="p">:</span><span class="c1">//m.media-amazon.com/images/M/MV5BYTM4ZDhiYTQtYzExNC00YjVlLTg2YWYtYTk3NTAzMzcwNTExXkEyXkFqcGdeQXVyNjU0OTQ0OTY@._V1_SY1000_SX677_AL_.jpg&#39;,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="kc">t</span><span class="err">i</span><span class="kc">tle</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;The</span><span class="w"> </span><span class="err">Bir</span><span class="kc">t</span><span class="err">h</span><span class="w"> </span><span class="err">o</span><span class="kc">f</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">Na</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="kc">full</span><span class="err">plo</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Two</span><span class="w"> </span><span class="err">bro</span><span class="kc">t</span><span class="err">hers...&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="err">cou</span><span class="kc">ntr</span><span class="err">ies</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">&#39;USA&#39;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="w">  </span><span class="err">released</span><span class="p">:</span><span class="w"> </span><span class="mi">1915-03-03</span><span class="err">T</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.000</span><span class="err">Z</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="16 "></span><span class="w">  </span><span class="err">direc</span><span class="kc">t</span><span class="err">ors</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">&#39;D.W.</span><span class="w"> </span><span class="err">Gri</span><span class="kc">ff</span><span class="err">i</span><span class="kc">t</span><span class="err">h&#39;</span><span class="w"> </span><span class="p">],</span><span class="w"></span>
<span class="linenos" data-linenos="17 "></span><span class="w">  </span><span class="err">wri</span><span class="kc">ters</span><span class="p">:</span><span class="w"> </span>
<span class="linenos" data-linenos="18 "></span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="err">&#39;Thomas</span><span class="w"> </span><span class="err">Dixo</span><span class="kc">n</span><span class="w"> </span><span class="err">Jr.</span><span class="w"> </span><span class="err">(adap</span><span class="kc">te</span><span class="err">d</span><span class="w"> </span><span class="kc">fr</span><span class="err">om</span><span class="w"> </span><span class="err">...&quot;)&#39;,</span>
<span class="linenos" data-linenos="19 "></span><span class="err">    &#39;Thomas Dixon Jr. (play)&#39;,</span>
<span class="linenos" data-linenos="20 "></span><span class="err">    &#39;Thomas Dixon Jr. (novel)&#39;,</span>
<span class="linenos" data-linenos="21 "></span><span class="err">    &#39;D.W. Griffith&#39;,</span>
<span class="linenos" data-linenos="22 "></span><span class="err">    &#39;Frank E. Woods&#39; ],</span>
<span class="linenos" data-linenos="23 "></span><span class="err">  awards: { wins: 2, nominations: 0, text: &#39;2 wins.&#39; },</span>
<span class="linenos" data-linenos="24 "></span><span class="err">  lastupdated: &#39;2015-09-11 00:32:27.763000000&#39;,</span>
<span class="linenos" data-linenos="25 "></span><span class="err">  year: 1915,</span>
<span class="linenos" data-linenos="26 "></span><span class="err">  imdb: { rating: 6.8, votes: 15715, id: 4972 },</span>
<span class="linenos" data-linenos="27 "></span><span class="err">  type: &#39;movie&#39;,</span>
<span class="linenos" data-linenos="28 "></span><span class="err">  tomatoes: </span>
<span class="linenos" data-linenos="29 "></span><span class="err">  { viewer: { rating: 3.2, numReviews: 4358, meter: 57 },</span>
<span class="linenos" data-linenos="30 "></span><span class="err">    dvd: 2004-06-29T00:00:00.000Z,</span>
<span class="linenos" data-linenos="31 "></span><span class="err">    critic: { rating: 8, numReviews: 38, meter: 100 },</span>
<span class="linenos" data-linenos="32 "></span><span class="err">    lastUpdated: 2015-09-10T18:30:23.000Z,</span>
<span class="linenos" data-linenos="33 "></span><span class="err">    consensus: &#39;Racial depictions aside...&#39;,</span>
<span class="linenos" data-linenos="34 "></span><span class="err">    rotten: 0,</span>
<span class="linenos" data-linenos="35 "></span><span class="err">    production: &#39;Gravitas&#39;,</span>
<span class="linenos" data-linenos="36 "></span><span class="err">    fresh: 38 },</span>
<span class="linenos" data-linenos="37 "></span><span class="err">  num_mflix_comments: 0 }</span>
</code></pre></div>
</div>
</div>
</div>
<ol>
<li>
<p>(<abbr title="Gestiona soluciones a problemas propuestos, utilizando sistemas de almacenamiento y herramientas asociadas al centro de datos.">RA5075.1</abbr> / <abbr title="Se han procesado los datos almacenados">CE5.1d</abbr> / 3p) Haciendo uso del framework de agregación y el shell de MongoDB, resuelve las siguientes consultas:</p>
<ol>
<li>(0.5) Encuentra todas las películas que entre sus géneros (<code>genres</code>) se encuentre el <code>Drama</code>. Sólo queremos recuperar el título y la calificación (<code>rating</code>) de IMDB.</li>
<li>(0.5) Recupera los títulos de las tres películas románticas (<code>Romance</code>) con mayor calificación en IMDB que se lanzaron (<code>released</code>) antes del 2001.</li>
<li>(0.5) Averigua la cantidad de películas que hay de cada categoría de calificación (<code>rated</code>).</li>
<li>
<p>(0.5) Teniendo en cuenta las películas anteriores al año 2001, para cada género, recupera la media y la máxima calificación en IMDB así como el tiempo ajustado (con <em>trailers</em>, los cuales duran 12 minutos) de la película más larga, ordenando los géneros por popularidad.</p>
<p>El resultado será similar a:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Film</span><span class="mi">-</span><span class="err">Noir&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="err">_media</span><span class="p">:</span><span class="w"> </span><span class="mf">7.62</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="err">mejor_</span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="p">:</span><span class="w"> </span><span class="mf">8.3</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="kc">t</span><span class="err">iempo_ajus</span><span class="kc">ta</span><span class="err">do</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Docume</span><span class="kc">ntar</span><span class="err">y&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="err">_media</span><span class="p">:</span><span class="w"> </span><span class="mf">7.555313351498638</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="err">mejor_</span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="p">:</span><span class="w"> </span><span class="mf">9.4</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="kc">t</span><span class="err">iempo_ajus</span><span class="kc">ta</span><span class="err">do</span><span class="p">:</span><span class="w"> </span><span class="mi">1152</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Shor</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="err">_media</span><span class="p">:</span><span class="w"> </span><span class="mf">7.386</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="err">mejor_</span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="p">:</span><span class="w"> </span><span class="mf">8.6</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="kc">t</span><span class="err">iempo_ajus</span><span class="kc">ta</span><span class="err">do</span><span class="p">:</span><span class="w"> </span><span class="mi">56</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="err">...</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>(0.5) Sobre la consulta anterior, además de la información ya recuperada, queremos buscar qué película recomendar de cada categoría siempre y cuando duren un máximo de 218 minutos y tengan al menos una calificación de 7.  (pista: necesitas utilizar <code>$first</code>)</p>
<p>El resultado será similar a:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Docume</span><span class="kc">ntar</span><span class="err">y&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="kc">t</span><span class="err">i</span><span class="kc">tul</span><span class="err">o_recome</span><span class="kc">n</span><span class="err">dado</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Cosmos&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="err">_recome</span><span class="kc">n</span><span class="err">dado</span><span class="p">:</span><span class="w"> </span><span class="mf">9.3</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="kc">t</span><span class="err">iempo_recome</span><span class="kc">n</span><span class="err">dado</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="err">popularidad</span><span class="p">:</span><span class="w"> </span><span class="mf">7.69695945945946</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">  </span><span class="err">mejor_</span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="p">:</span><span class="w"> </span><span class="mf">9.3</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="kc">t</span><span class="err">iempo_ajus</span><span class="kc">ta</span><span class="err">do_maslargo</span><span class="p">:</span><span class="w"> </span><span class="mi">212</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">{</span><span class="w"> </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Sci</span><span class="mi">-</span><span class="err">Fi&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="kc">t</span><span class="err">i</span><span class="kc">tul</span><span class="err">o_recome</span><span class="kc">n</span><span class="err">dado</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Blade</span><span class="w"> </span><span class="err">Ru</span><span class="kc">nner</span><span class="err">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="10 "></span><span class="w">  </span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="err">_recome</span><span class="kc">n</span><span class="err">dado</span><span class="p">:</span><span class="w"> </span><span class="mf">8.2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="w">  </span><span class="kc">t</span><span class="err">iempo_recome</span><span class="kc">n</span><span class="err">dado</span><span class="p">:</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="12 "></span><span class="w">  </span><span class="err">popularidad</span><span class="p">:</span><span class="w"> </span><span class="mf">7.3999999999999995</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="13 "></span><span class="w">  </span><span class="err">mejor_</span><span class="kc">n</span><span class="err">o</span><span class="kc">ta</span><span class="p">:</span><span class="w"> </span><span class="mf">8.2</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="14 "></span><span class="w">  </span><span class="kc">t</span><span class="err">iempo_ajus</span><span class="kc">ta</span><span class="err">do_maslargo</span><span class="p">:</span><span class="w"> </span><span class="mi">209</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="linenos" data-linenos="15 "></span><span class="err">...</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>(0.5) Recupera las 5 películas más comentadas (los comentarios se almacenan en la colección <code>comments</code>), devolviendo el título, su género y la cantidad de comentarios. Además, queremos almacenar el resultado en la colección <code>movies_most_commented</code>.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&gt;</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">most_commented_movies</span><span class="p">.</span><span class="nx">findOne</span><span class="p">()</span><span class="w"></span>
<span class="linenos" data-linenos="2 "></span><span class="o">&lt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;573a13bff29313caabd5e91e&quot;</span><span class="p">),</span><span class="w"></span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="nx">sumComments</span><span class="o">:</span><span class="w"> </span><span class="mf">161</span><span class="p">,</span><span class="w"></span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="nx">movie</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">imdb</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="mf">6.4</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;The Taking of Pelham 1 2 3&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>(<abbr title="Gestiona soluciones a problemas propuestos, utilizando sistemas de almacenamiento y herramientas asociadas al centro de datos.">RA5075.1</abbr> / <abbr title="Se han procesado los datos almacenados">CE5.1d</abbr> / 1p) Haciendo uso de <em>MongoDBCompass</em>, mejora la siguiente consulta que obtiene los tres documentales más premiados, siempre y cuando hayan ganado algún premio:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">var</span><span class="w"> </span><span class="nx">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$sort</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;awards.wins&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">}},</span><span class="w"> </span><span class="c1">// Ordenamos por premios ganados</span><span class="w"></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$match</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;awards.wins&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$gte</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">}}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$limit</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="p">},</span><span class="w"> </span><span class="c1">// Obtenemos las 20 películas que han ganado más de un premio</span><span class="w"></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$match</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">      </span><span class="nx">genres</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">$in</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Documentary&quot;</span><span class="p">]},</span><span class="w"> </span><span class="c1">// Nos quedamos con los documentales</span><span class="w"></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">  </span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$project</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">genres</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">awards</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">}},</span><span class="w"></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$limit</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">},</span><span class="w"> </span>
<span class="linenos" data-linenos="10 "></span><span class="p">];</span><span class="w"></span>
<span class="linenos" data-linenos="11 "></span><span class="nx">db</span><span class="p">.</span><span class="nx">movies</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Adjunta una captura inicial y otra final, y la exportación de la agregación a Python.</p>
</li>
</ol>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        ¿Ha sido útil está página?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Sí, ha sido util" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="La página es mejorable" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
                Gracias por tu colaboración!
              
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
                Gracias por tu colaboración! Ayúdame a mejorarla enviandome un mail a <a href="mailto:a.medrano@edu.gva.es">a.medrano@edu.gva.es</a> con tus comentarios.
              
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Pie" >
      
        
        <a href="03modelado.html" class="md-footer__link md-footer__link--prev" aria-label="Anterior: S21.- Modelado de datos NoSQL" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              S21.- Modelado de datos NoSQL
            </div>
          </div>
        </a>
      
      
        
        <a href="06replicacion.html" class="md-footer__link md-footer__link--next" aria-label="Siguiente: S28.- Replicación y Particionado" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              S28.- Replicación y Particionado
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022-2023 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  




  

<h4>Consentimiento de cookie</h4>
<p>Esta página de apuntes utiliza cookies para reconocer las visitas, medir la efectividad de la documentación y averiguar si encuentras aquello que buscas o cómo has llegado a estos apuntes. Con tu consentimiento, me ayudas a mejorar estos materiales.</p>
<input type="checkbox" class="md-toggle" id="__settings">
<div class="md-consent__settings">
  <ul class="task-list">
    
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        <label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Aceptar</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Gestionar cookies</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);console.log(new FormData(form)),__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "navigation.indexes", "content.code.annotate", "announce.dismiss", "toc.follow"], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>